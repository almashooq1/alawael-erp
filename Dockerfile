# Multi-stage Docker build for ERP System\n\n# Stage 1: Dependencies\nFROM node:18-alpine AS dependencies\nWORKDIR /app\n\n# Install production dependencies\nCOPY package*.json ./\nRUN npm ci --only=production\n\n# Copy production dependencies aside\nRUN cp -R node_modules /prod_node_modules\n\n# Install all dependencies (for build)\nRUN npm ci\n\n# Stage 2: Build\nFROM node:18-alpine AS builder\nWORKDIR /app\n\nCOPY --from=dependencies /app/node_modules ./node_modules\nCOPY package*.json ./\nCOPY . .\n\n# Build Phase 10-13 components\nRUN npm run build\nRUN npm test\n\n# Stage 3: Runtime\nFROM node:18-alpine\n\nWORKDIR /app\n\n# Install dumb-init for proper signal handling\nRUN apk add --no-cache dumb-init\n\n# Create non-root user\nRUN addgroup -g 1001 -S nodejs\nRUN adduser -S nodejs -u 1001\n\n# Copy production dependencies from Stage 1\nCOPY --from=dependencies /prod_node_modules ./node_modules\n\n# Copy built application from Stage 2\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/package.json ./\nCOPY --from=builder /app/public ./public\n\n# Set environment\nENV NODE_ENV=production\nENV PORT=3000\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \\\n  CMD node healthcheck.js\n\n# Change ownership\nRUN chown -R nodejs:nodejs /app\nUSER nodejs\n\nEXPOSE 3000\n\n# Use dumb-init to run Node\nENTRYPOINT [\"/usr/sbin/dumb-init\", \"--\"]\nCMD [\"node\", \"dist/index.js\"]\n