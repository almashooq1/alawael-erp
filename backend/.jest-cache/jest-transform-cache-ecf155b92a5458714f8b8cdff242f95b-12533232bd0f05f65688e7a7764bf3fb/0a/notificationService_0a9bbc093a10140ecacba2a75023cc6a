0ec3f61b5cfeaae4ef9451ccfc461747
/**
 * Notification Service - Multi-channel Notifications
 */

const {
  sendEmail
} = require('./emailService');
const {
  sendSMS
} = require('./smsService');
const {
  sendPush
} = require('./pushService');
const User = require('../models/User');
class NotificationService {
  static notifications = [];
  static emailService = null;
  static smsService = null;
  static pushService = null;

  /**
   * Initialize notification service with configuration
   */
  static initialize(config = {}) {
    this.emailService = {
      config: config.email || {},
      send: async mailOptions => ({
        success: true
      })
    };
    this.smsService = {
      config: config.sms || {},
      send: async smsOptions => ({
        success: true
      })
    };
    this.pushService = {
      config: config.push || {},
      send: async pushOptions => ({
        success: true
      })
    };
    return this;
  }

  /**
   * إرسال إشعار
   */
  static async sendNotification(userId, notificationData) {
    try {
      const notif = {
        id: `notif_${Date.now()}`,
        userId,
        title: notificationData.title,
        message: notificationData.message,
        channels: notificationData.channels || ['in-app'],
        priority: notificationData.priority || 'normal',
        createdAt: new Date(),
        sent: true,
        deliveryStatus: {}
      };

      // إرسال عبر القنوات المطلوبة

      // جلب بيانات المستخدم (للحصول على البريد، الجوال، fcmTokens)
      let user = notificationData.userObj;
      if (!user) {
        user = await User.findById(userId).lean();
      }
      for (const channel of notif.channels) {
        if (channel === 'email') {
          const to = notificationData.email || user && user.email || 'test@example.com';
          const subject = notif.title;
          const text = notif.message;
          const result = await sendEmail({
            to,
            subject,
            text
          });
          notif.deliveryStatus.email = result.success ? 'sent' : 'failed';
        } else if (channel === 'sms') {
          const to = notificationData.phone || user && user.phone || '+201234567890';
          const message = notif.message;
          const result = await sendSMS({
            to,
            message
          });
          notif.deliveryStatus.sms = result.success ? 'sent' : 'failed';
        } else if (channel === 'push') {
          const tokens = user && user.fcmTokens || [];
          if (tokens.length > 0) {
            const result = await sendPush({
              tokens,
              title: notif.title,
              body: notif.message
            });
            notif.deliveryStatus.push = result.success ? 'sent' : 'failed';
          } else {
            notif.deliveryStatus.push = 'no-tokens';
          }
        } else if (channel === 'in-app') {
          notif.deliveryStatus.inApp = 'delivered';
        }
      }
      this.notifications.push(notif);
      return {
        success: true,
        notificationId: notif.id,
        sentTo: notif.channels,
        deliveryStatus: notif.deliveryStatus,
        timestamp: new Date()
      };
    } catch (err) {
      throw new Error(`Notification send failed: ${err.message}`);
    }
  }

  /**
   * الحصول على إشعارات المستخدم
   */
  static async getNotifications(userId, limit = 50, unreadOnly = false) {
    try {
      let userNotifs = this.notifications.filter(n => n.userId === userId);
      if (unreadOnly) {
        userNotifs = userNotifs.filter(n => !n.read);
      }
      return {
        success: true,
        count: userNotifs.length,
        notifications: userNotifs.slice(-limit),
        timestamp: new Date()
      };
    } catch (err) {
      throw new Error(`Get notifications failed: ${err.message}`);
    }
  }

  /**
   * وضع علامة على الإشعار كمقروء
   */
  static async markAsRead(notificationId) {
    try {
      const notif = this.notifications.find(n => n.id === notificationId);
      if (notif) {
        notif.read = true;
      }
      return {
        success: true,
        message: 'Marked as read'
      };
    } catch (err) {
      throw new Error(`Mark as read failed: ${err.message}`);
    }
  }

  /**
   * حذف الإشعار
   */
  static async deleteNotification(notificationId) {
    try {
      this.notifications = this.notifications.filter(n => n.id !== notificationId);
      return {
        success: true,
        message: 'Notification deleted'
      };
    } catch (err) {
      throw new Error(`Delete notification failed: ${err.message}`);
    }
  }

  /**
   * حذف جميع إشعارات المستخدم
   */
  static async deleteAllNotifications(userId) {
    try {
      const countBefore = this.notifications.length;
      this.notifications = this.notifications.filter(n => n.userId !== userId);
      const deletedCount = countBefore - this.notifications.length;
      return {
        success: true,
        message: `${deletedCount} notifications deleted`
      };
    } catch (err) {
      throw new Error(`Delete all notifications failed: ${err.message}`);
    }
  }

  /**
   * جدولة إشعار (محاكاة)
   */
  static async scheduleNotification(userId, notificationData, scheduleTime) {
    try {
      return {
        success: true,
        message: 'Notification scheduled',
        scheduledFor: scheduleTime,
        userId,
        status: 'pending'
      };
    } catch (err) {
      throw new Error(`Schedule notification failed: ${err.message}`);
    }
  }

  // Helper Methods
  static _simulateDelivery(channels) {
    const delivery = {};
    channels.forEach(channel => {
      delivery[channel] = {
        status: 'delivered',
        timestamp: new Date(),
        attempts: 1
      };
    });
    return delivery;
  }
}
module.exports = NotificationService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzZW5kRW1haWwiLCJyZXF1aXJlIiwic2VuZFNNUyIsInNlbmRQdXNoIiwiVXNlciIsIk5vdGlmaWNhdGlvblNlcnZpY2UiLCJub3RpZmljYXRpb25zIiwiZW1haWxTZXJ2aWNlIiwic21zU2VydmljZSIsInB1c2hTZXJ2aWNlIiwiaW5pdGlhbGl6ZSIsImNvbmZpZyIsImVtYWlsIiwic2VuZCIsIm1haWxPcHRpb25zIiwic3VjY2VzcyIsInNtcyIsInNtc09wdGlvbnMiLCJwdXNoIiwicHVzaE9wdGlvbnMiLCJzZW5kTm90aWZpY2F0aW9uIiwidXNlcklkIiwibm90aWZpY2F0aW9uRGF0YSIsIm5vdGlmIiwiaWQiLCJEYXRlIiwibm93IiwidGl0bGUiLCJtZXNzYWdlIiwiY2hhbm5lbHMiLCJwcmlvcml0eSIsImNyZWF0ZWRBdCIsInNlbnQiLCJkZWxpdmVyeVN0YXR1cyIsInVzZXIiLCJ1c2VyT2JqIiwiZmluZEJ5SWQiLCJsZWFuIiwiY2hhbm5lbCIsInRvIiwic3ViamVjdCIsInRleHQiLCJyZXN1bHQiLCJwaG9uZSIsInRva2VucyIsImZjbVRva2VucyIsImxlbmd0aCIsImJvZHkiLCJpbkFwcCIsIm5vdGlmaWNhdGlvbklkIiwic2VudFRvIiwidGltZXN0YW1wIiwiZXJyIiwiRXJyb3IiLCJnZXROb3RpZmljYXRpb25zIiwibGltaXQiLCJ1bnJlYWRPbmx5IiwidXNlck5vdGlmcyIsImZpbHRlciIsIm4iLCJyZWFkIiwiY291bnQiLCJzbGljZSIsIm1hcmtBc1JlYWQiLCJmaW5kIiwiZGVsZXRlTm90aWZpY2F0aW9uIiwiZGVsZXRlQWxsTm90aWZpY2F0aW9ucyIsImNvdW50QmVmb3JlIiwiZGVsZXRlZENvdW50Iiwic2NoZWR1bGVOb3RpZmljYXRpb24iLCJzY2hlZHVsZVRpbWUiLCJzY2hlZHVsZWRGb3IiLCJzdGF0dXMiLCJfc2ltdWxhdGVEZWxpdmVyeSIsImRlbGl2ZXJ5IiwiZm9yRWFjaCIsImF0dGVtcHRzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIm5vdGlmaWNhdGlvblNlcnZpY2UuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIE5vdGlmaWNhdGlvbiBTZXJ2aWNlIC0gTXVsdGktY2hhbm5lbCBOb3RpZmljYXRpb25zXHJcbiAqL1xyXG5cclxuY29uc3QgeyBzZW5kRW1haWwgfSA9IHJlcXVpcmUoJy4vZW1haWxTZXJ2aWNlJyk7XHJcbmNvbnN0IHsgc2VuZFNNUyB9ID0gcmVxdWlyZSgnLi9zbXNTZXJ2aWNlJyk7XHJcbmNvbnN0IHsgc2VuZFB1c2ggfSA9IHJlcXVpcmUoJy4vcHVzaFNlcnZpY2UnKTtcclxuY29uc3QgVXNlciA9IHJlcXVpcmUoJy4uL21vZGVscy9Vc2VyJyk7XHJcblxyXG5jbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcclxuICBzdGF0aWMgbm90aWZpY2F0aW9ucyA9IFtdO1xyXG4gIHN0YXRpYyBlbWFpbFNlcnZpY2UgPSBudWxsO1xyXG4gIHN0YXRpYyBzbXNTZXJ2aWNlID0gbnVsbDtcclxuICBzdGF0aWMgcHVzaFNlcnZpY2UgPSBudWxsO1xyXG5cclxuICAvKipcclxuICAgKiBJbml0aWFsaXplIG5vdGlmaWNhdGlvbiBzZXJ2aWNlIHdpdGggY29uZmlndXJhdGlvblxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbml0aWFsaXplKGNvbmZpZyA9IHt9KSB7XHJcbiAgICB0aGlzLmVtYWlsU2VydmljZSA9IHtcclxuICAgICAgY29uZmlnOiBjb25maWcuZW1haWwgfHwge30sXHJcbiAgICAgIHNlbmQ6IGFzeW5jIChtYWlsT3B0aW9ucykgPT4gKHsgc3VjY2VzczogdHJ1ZSB9KSxcclxuICAgIH07XHJcbiAgICB0aGlzLnNtc1NlcnZpY2UgPSB7XHJcbiAgICAgIGNvbmZpZzogY29uZmlnLnNtcyB8fCB7fSxcclxuICAgICAgc2VuZDogYXN5bmMgKHNtc09wdGlvbnMpID0+ICh7IHN1Y2Nlc3M6IHRydWUgfSksXHJcbiAgICB9O1xyXG4gICAgdGhpcy5wdXNoU2VydmljZSA9IHtcclxuICAgICAgY29uZmlnOiBjb25maWcucHVzaCB8fCB7fSxcclxuICAgICAgc2VuZDogYXN5bmMgKHB1c2hPcHRpb25zKSA9PiAoeyBzdWNjZXNzOiB0cnVlIH0pLFxyXG4gICAgfTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog2KXYsdiz2KfZhCDYpdi02LnYp9ixXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHNlbmROb3RpZmljYXRpb24odXNlcklkLCBub3RpZmljYXRpb25EYXRhKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBub3RpZiA9IHtcclxuICAgICAgICBpZDogYG5vdGlmXyR7RGF0ZS5ub3coKX1gLFxyXG4gICAgICAgIHVzZXJJZCxcclxuICAgICAgICB0aXRsZTogbm90aWZpY2F0aW9uRGF0YS50aXRsZSxcclxuICAgICAgICBtZXNzYWdlOiBub3RpZmljYXRpb25EYXRhLm1lc3NhZ2UsXHJcbiAgICAgICAgY2hhbm5lbHM6IG5vdGlmaWNhdGlvbkRhdGEuY2hhbm5lbHMgfHwgWydpbi1hcHAnXSxcclxuICAgICAgICBwcmlvcml0eTogbm90aWZpY2F0aW9uRGF0YS5wcmlvcml0eSB8fCAnbm9ybWFsJyxcclxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgc2VudDogdHJ1ZSxcclxuICAgICAgICBkZWxpdmVyeVN0YXR1czoge30sXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyDYpdix2LPYp9mEINi52KjYsSDYp9mE2YLZhtmI2KfYqiDYp9mE2YXYt9mE2YjYqNipXHJcblxyXG4gICAgICAvLyDYrNmE2Kgg2KjZitin2YbYp9iqINin2YTZhdiz2KrYrtiv2YUgKNmE2YTYrdi12YjZhCDYudmE2Ykg2KfZhNio2LHZitiv2Iwg2KfZhNis2YjYp9mE2IwgZmNtVG9rZW5zKVxyXG4gICAgICBsZXQgdXNlciA9IG5vdGlmaWNhdGlvbkRhdGEudXNlck9iajtcclxuICAgICAgaWYgKCF1c2VyKSB7XHJcbiAgICAgICAgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKS5sZWFuKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGZvciAoY29uc3QgY2hhbm5lbCBvZiBub3RpZi5jaGFubmVscykge1xyXG4gICAgICAgIGlmIChjaGFubmVsID09PSAnZW1haWwnKSB7XHJcbiAgICAgICAgICBjb25zdCB0byA9IG5vdGlmaWNhdGlvbkRhdGEuZW1haWwgfHwgKHVzZXIgJiYgdXNlci5lbWFpbCkgfHwgJ3Rlc3RAZXhhbXBsZS5jb20nO1xyXG4gICAgICAgICAgY29uc3Qgc3ViamVjdCA9IG5vdGlmLnRpdGxlO1xyXG4gICAgICAgICAgY29uc3QgdGV4dCA9IG5vdGlmLm1lc3NhZ2U7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kRW1haWwoeyB0bywgc3ViamVjdCwgdGV4dCB9KTtcclxuICAgICAgICAgIG5vdGlmLmRlbGl2ZXJ5U3RhdHVzLmVtYWlsID0gcmVzdWx0LnN1Y2Nlc3MgPyAnc2VudCcgOiAnZmFpbGVkJztcclxuICAgICAgICB9IGVsc2UgaWYgKGNoYW5uZWwgPT09ICdzbXMnKSB7XHJcbiAgICAgICAgICBjb25zdCB0byA9IG5vdGlmaWNhdGlvbkRhdGEucGhvbmUgfHwgKHVzZXIgJiYgdXNlci5waG9uZSkgfHwgJysyMDEyMzQ1Njc4OTAnO1xyXG4gICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5vdGlmLm1lc3NhZ2U7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kU01TKHsgdG8sIG1lc3NhZ2UgfSk7XHJcbiAgICAgICAgICBub3RpZi5kZWxpdmVyeVN0YXR1cy5zbXMgPSByZXN1bHQuc3VjY2VzcyA/ICdzZW50JyA6ICdmYWlsZWQnO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY2hhbm5lbCA9PT0gJ3B1c2gnKSB7XHJcbiAgICAgICAgICBjb25zdCB0b2tlbnMgPSAodXNlciAmJiB1c2VyLmZjbVRva2VucykgfHwgW107XHJcbiAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VuZFB1c2goeyB0b2tlbnMsIHRpdGxlOiBub3RpZi50aXRsZSwgYm9keTogbm90aWYubWVzc2FnZSB9KTtcclxuICAgICAgICAgICAgbm90aWYuZGVsaXZlcnlTdGF0dXMucHVzaCA9IHJlc3VsdC5zdWNjZXNzID8gJ3NlbnQnIDogJ2ZhaWxlZCc7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub3RpZi5kZWxpdmVyeVN0YXR1cy5wdXNoID0gJ25vLXRva2Vucyc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaGFubmVsID09PSAnaW4tYXBwJykge1xyXG4gICAgICAgICAgbm90aWYuZGVsaXZlcnlTdGF0dXMuaW5BcHAgPSAnZGVsaXZlcmVkJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKG5vdGlmKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBub3RpZmljYXRpb25JZDogbm90aWYuaWQsXHJcbiAgICAgICAgc2VudFRvOiBub3RpZi5jaGFubmVscyxcclxuICAgICAgICBkZWxpdmVyeVN0YXR1czogbm90aWYuZGVsaXZlcnlTdGF0dXMsXHJcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90aWZpY2F0aW9uIHNlbmQgZmFpbGVkOiAke2Vyci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog2KfZhNit2LXZiNmEINi52YTZiSDYpdi02LnYp9ix2KfYqiDYp9mE2YXYs9iq2K7Yr9mFXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGdldE5vdGlmaWNhdGlvbnModXNlcklkLCBsaW1pdCA9IDUwLCB1bnJlYWRPbmx5ID0gZmFsc2UpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCB1c2VyTm90aWZzID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbHRlcihuID0+IG4udXNlcklkID09PSB1c2VySWQpO1xyXG5cclxuICAgICAgaWYgKHVucmVhZE9ubHkpIHtcclxuICAgICAgICB1c2VyTm90aWZzID0gdXNlck5vdGlmcy5maWx0ZXIobiA9PiAhbi5yZWFkKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgIGNvdW50OiB1c2VyTm90aWZzLmxlbmd0aCxcclxuICAgICAgICBub3RpZmljYXRpb25zOiB1c2VyTm90aWZzLnNsaWNlKC1saW1pdCksXHJcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgR2V0IG5vdGlmaWNhdGlvbnMgZmFpbGVkOiAke2Vyci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog2YjYtti5INi52YTYp9mF2Kkg2LnZhNmJINin2YTYpdi02LnYp9ixINmD2YXZgtix2YjYoVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBtYXJrQXNSZWFkKG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBub3RpZiA9IHRoaXMubm90aWZpY2F0aW9ucy5maW5kKG4gPT4gbi5pZCA9PT0gbm90aWZpY2F0aW9uSWQpO1xyXG4gICAgICBpZiAobm90aWYpIHtcclxuICAgICAgICBub3RpZi5yZWFkID0gdHJ1ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ01hcmtlZCBhcyByZWFkJyB9O1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWFyayBhcyByZWFkIGZhaWxlZDogJHtlcnIubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqINit2LDZgSDYp9mE2KXYtNi52KfYsVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBkZWxldGVOb3RpZmljYXRpb24obm90aWZpY2F0aW9uSWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXMubm90aWZpY2F0aW9ucyA9IHRoaXMubm90aWZpY2F0aW9ucy5maWx0ZXIobiA9PiBuLmlkICE9PSBub3RpZmljYXRpb25JZCk7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdOb3RpZmljYXRpb24gZGVsZXRlZCcgfTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERlbGV0ZSBub3RpZmljYXRpb24gZmFpbGVkOiAke2Vyci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog2K3YsNmBINis2YXZiti5INil2LTYudin2LHYp9iqINin2YTZhdiz2KrYrtiv2YVcclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgZGVsZXRlQWxsTm90aWZpY2F0aW9ucyh1c2VySWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGNvdW50QmVmb3JlID0gdGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aDtcclxuICAgICAgdGhpcy5ub3RpZmljYXRpb25zID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbHRlcihuID0+IG4udXNlcklkICE9PSB1c2VySWQpO1xyXG4gICAgICBjb25zdCBkZWxldGVkQ291bnQgPSBjb3VudEJlZm9yZSAtIHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGg7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgbWVzc2FnZTogYCR7ZGVsZXRlZENvdW50fSBub3RpZmljYXRpb25zIGRlbGV0ZWRgLFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGVsZXRlIGFsbCBub3RpZmljYXRpb25zIGZhaWxlZDogJHtlcnIubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqINis2K/ZiNmE2Kkg2KXYtNi52KfYsSAo2YXYrdin2YPYp9ipKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBzY2hlZHVsZU5vdGlmaWNhdGlvbih1c2VySWQsIG5vdGlmaWNhdGlvbkRhdGEsIHNjaGVkdWxlVGltZSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdOb3RpZmljYXRpb24gc2NoZWR1bGVkJyxcclxuICAgICAgICBzY2hlZHVsZWRGb3I6IHNjaGVkdWxlVGltZSxcclxuICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgc3RhdHVzOiAncGVuZGluZycsXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTY2hlZHVsZSBub3RpZmljYXRpb24gZmFpbGVkOiAke2Vyci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gSGVscGVyIE1ldGhvZHNcclxuICBzdGF0aWMgX3NpbXVsYXRlRGVsaXZlcnkoY2hhbm5lbHMpIHtcclxuICAgIGNvbnN0IGRlbGl2ZXJ5ID0ge307XHJcbiAgICBjaGFubmVscy5mb3JFYWNoKGNoYW5uZWwgPT4ge1xyXG4gICAgICBkZWxpdmVyeVtjaGFubmVsXSA9IHtcclxuICAgICAgICBzdGF0dXM6ICdkZWxpdmVyZWQnLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcclxuICAgICAgICBhdHRlbXB0czogMSxcclxuICAgICAgfTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRlbGl2ZXJ5O1xyXG4gIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBOb3RpZmljYXRpb25TZXJ2aWNlO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNO0VBQUVBO0FBQVUsQ0FBQyxHQUFHQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDL0MsTUFBTTtFQUFFQztBQUFRLENBQUMsR0FBR0QsT0FBTyxDQUFDLGNBQWMsQ0FBQztBQUMzQyxNQUFNO0VBQUVFO0FBQVMsQ0FBQyxHQUFHRixPQUFPLENBQUMsZUFBZSxDQUFDO0FBQzdDLE1BQU1HLElBQUksR0FBR0gsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBRXRDLE1BQU1JLG1CQUFtQixDQUFDO0VBQ3hCLE9BQU9DLGFBQWEsR0FBRyxFQUFFO0VBQ3pCLE9BQU9DLFlBQVksR0FBRyxJQUFJO0VBQzFCLE9BQU9DLFVBQVUsR0FBRyxJQUFJO0VBQ3hCLE9BQU9DLFdBQVcsR0FBRyxJQUFJOztFQUV6QjtBQUNGO0FBQ0E7RUFDRSxPQUFPQyxVQUFVQSxDQUFDQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUU7SUFDN0IsSUFBSSxDQUFDSixZQUFZLEdBQUc7TUFDbEJJLE1BQU0sRUFBRUEsTUFBTSxDQUFDQyxLQUFLLElBQUksQ0FBQyxDQUFDO01BQzFCQyxJQUFJLEVBQUUsTUFBT0MsV0FBVyxLQUFNO1FBQUVDLE9BQU8sRUFBRTtNQUFLLENBQUM7SUFDakQsQ0FBQztJQUNELElBQUksQ0FBQ1AsVUFBVSxHQUFHO01BQ2hCRyxNQUFNLEVBQUVBLE1BQU0sQ0FBQ0ssR0FBRyxJQUFJLENBQUMsQ0FBQztNQUN4QkgsSUFBSSxFQUFFLE1BQU9JLFVBQVUsS0FBTTtRQUFFRixPQUFPLEVBQUU7TUFBSyxDQUFDO0lBQ2hELENBQUM7SUFDRCxJQUFJLENBQUNOLFdBQVcsR0FBRztNQUNqQkUsTUFBTSxFQUFFQSxNQUFNLENBQUNPLElBQUksSUFBSSxDQUFDLENBQUM7TUFDekJM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LENBQUM3QyxNQUFNLEVBQUU7SUFDMUMsSUFBSTtNQUNGLE1BQU04QyxXQUFXLEdBQUcsSUFBSSxDQUFDN0QsYUFBYSxDQUFDd0MsTUFBTTtNQUM3QyxJQUFJLENBQUN4QyxhQUFhLEdBQUcsSUFBSSxDQUFDQSxhQUFhLENBQUNvRCxNQUFNLENBQUNDLENBQUMsSUFBSUEsQ0FBQyxDQUFDdEMsTUFBTSxLQUFLQSxNQUFNLENBQUM7TUFDeEUsTUFBTStDLFlBQVksR0FBR0QsV0FBVyxHQUFHLElBQUksQ0FBQzdELGFBQWEsQ0FBQ3dDLE1BQU07TUFFNUQsT0FBTztRQUNML0IsT0FBTyxFQUFFLElBQUk7UUFDYmEsT0FBTyxFQUFFLEdBQUd3QyxZQUFZO01BQzFCLENBQUM7SUFDSCxDQUFDLENBQUMsT0FBT2hCLEdBQUcsRUFBRTtNQUNaLE1BQU0sSUFBSUMsS0FBSyxDQUFDLG9DQUFvQ0QsR0FBRyxDQUFDeEIsT0FBTyxFQUFFLENBQUM7SUFDcEU7RUFDRjs7RUFFQTtBQUNGO0FBQ0E7RUFDRSxhQUFheUMsb0JBQW9CQSxDQUFDaEQsTUFBTSxFQUFFQyxnQkFBZ0IsRUFBRWdELFlBQVksRUFBRTtJQUN4RSxJQUFJO01BQ0YsT0FBTztRQUNMdkQsT0FBTyxFQUFFLElBQUk7UUFDYmEsT0FBTyxFQUFFLHdCQUF3QjtRQUNqQzJDLFlBQVksRUFBRUQsWUFBWTtRQUMxQmpELE1BQU07UUFDTm1ELE1BQU0sRUFBRTtNQUNWLENBQUM7SUFDSCxDQUFDLENBQUMsT0FBT3BCLEdBQUcsRUFBRTtNQUNaLE1BQU0sSUFBSUMsS0FBSyxDQUFDLGlDQUFpQ0QsR0FBRyxDQUFDeEIsT0FBTyxFQUFFLENBQUM7SUFDakU7RUFDRjs7RUFFQTtFQUNBLE9BQU82QyxpQkFBaUJBLENBQUM1QyxRQUFRLEVBQUU7SUFDakMsTUFBTTZDLFFBQVEsR0FBRyxDQUFDLENBQUM7SUFDbkI3QyxRQUFRLENBQUM4QyxPQUFPLENBQUNyQyxPQUFPLElBQUk7TUFDMUJvQyxRQUFRLENBQUNwQyxPQUFPLENBQUMsR0FBRztRQUNsQmtDLE1BQU0sRUFBRSxXQUFXO1FBQ25CckIsU0FBUyxFQUFFLElBQUkxQixJQUFJLENBQUMsQ0FBQztRQUNyQm1ELFFBQVEsRUFBRTtNQUNaLENBQUM7SUFDSCxDQUFDLENBQUM7SUFDRixPQUFPRixRQUFRO0VBQ2pCO0FBQ0Y7QUFFQUcsTUFBTSxDQUFDQyxPQUFPLEdBQUd6RSxtQkFBbUIiLCJpZ25vcmVMaXN0IjpbXX0=