{"version":3,"names":["sendEmail","require","sendSMS","sendPush","User","NotificationService","notifications","emailService","smsService","pushService","initialize","config","email","send","mailOptions","success","sms","smsOptions","push","pushOptions","sendNotification","userId","notificationData","notif","id","Date","now","title","message","channels","priority","createdAt","sent","deliveryStatus","user","userObj","findById","lean","channel","to","subject","text","result","phone","tokens","fcmTokens","length","body","inApp","notificationId","sentTo","timestamp","err","Error","getNotifications","limit","unreadOnly","userNotifs","filter","n","read","count","slice","markAsRead","find","deleteNotification","deleteAllNotifications","countBefore","deletedCount","scheduleNotification","scheduleTime","scheduledFor","status","_simulateDelivery","delivery","forEach","attempts","module","exports"],"sources":["notificationService.js"],"sourcesContent":["/**\r\n * Notification Service - Multi-channel Notifications\r\n */\r\n\r\nconst { sendEmail } = require('./emailService');\r\nconst { sendSMS } = require('./smsService');\r\nconst { sendPush } = require('./pushService');\r\nconst User = require('../models/User');\r\n\r\nclass NotificationService {\r\n  static notifications = [];\r\n  static emailService = null;\r\n  static smsService = null;\r\n  static pushService = null;\r\n\r\n  /**\r\n   * Initialize notification service with configuration\r\n   */\r\n  static initialize(config = {}) {\r\n    this.emailService = {\r\n      config: config.email || {},\r\n      send: async (mailOptions) => ({ success: true }),\r\n    };\r\n    this.smsService = {\r\n      config: config.sms || {},\r\n      send: async (smsOptions) => ({ success: true }),\r\n    };\r\n    this.pushService = {\r\n      config: config.push || {},\r\n      send: async (pushOptions) => ({ success: true }),\r\n    };\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * إرسال إشعار\r\n   */\r\n  static async sendNotification(userId, notificationData) {\r\n    try {\r\n      const notif = {\r\n        id: `notif_${Date.now()}`,\r\n        userId,\r\n        title: notificationData.title,\r\n        message: notificationData.message,\r\n        channels: notificationData.channels || ['in-app'],\r\n        priority: notificationData.priority || 'normal',\r\n        createdAt: new Date(),\r\n        sent: true,\r\n        deliveryStatus: {},\r\n      };\r\n\r\n      // إرسال عبر القنوات المطلوبة\r\n\r\n      // جلب بيانات المستخدم (للحصول على البريد، الجوال، fcmTokens)\r\n      let user = notificationData.userObj;\r\n      if (!user) {\r\n        user = await User.findById(userId).lean();\r\n      }\r\n\r\n      for (const channel of notif.channels) {\r\n        if (channel === 'email') {\r\n          const to = notificationData.email || (user && user.email) || 'test@example.com';\r\n          const subject = notif.title;\r\n          const text = notif.message;\r\n          const result = await sendEmail({ to, subject, text });\r\n          notif.deliveryStatus.email = result.success ? 'sent' : 'failed';\r\n        } else if (channel === 'sms') {\r\n          const to = notificationData.phone || (user && user.phone) || '+201234567890';\r\n          const message = notif.message;\r\n          const result = await sendSMS({ to, message });\r\n          notif.deliveryStatus.sms = result.success ? 'sent' : 'failed';\r\n        } else if (channel === 'push') {\r\n          const tokens = (user && user.fcmTokens) || [];\r\n          if (tokens.length > 0) {\r\n            const result = await sendPush({ tokens, title: notif.title, body: notif.message });\r\n            notif.deliveryStatus.push = result.success ? 'sent' : 'failed';\r\n          } else {\r\n            notif.deliveryStatus.push = 'no-tokens';\r\n          }\r\n        } else if (channel === 'in-app') {\r\n          notif.deliveryStatus.inApp = 'delivered';\r\n        }\r\n      }\r\n\r\n      this.notifications.push(notif);\r\n\r\n      return {\r\n        success: true,\r\n        notificationId: notif.id,\r\n        sentTo: notif.channels,\r\n        deliveryStatus: notif.deliveryStatus,\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Notification send failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * الحصول على إشعارات المستخدم\r\n   */\r\n  static async getNotifications(userId, limit = 50, unreadOnly = false) {\r\n    try {\r\n      let userNotifs = this.notifications.filter(n => n.userId === userId);\r\n\r\n      if (unreadOnly) {\r\n        userNotifs = userNotifs.filter(n => !n.read);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        count: userNotifs.length,\r\n        notifications: userNotifs.slice(-limit),\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Get notifications failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * وضع علامة على الإشعار كمقروء\r\n   */\r\n  static async markAsRead(notificationId) {\r\n    try {\r\n      const notif = this.notifications.find(n => n.id === notificationId);\r\n      if (notif) {\r\n        notif.read = true;\r\n      }\r\n\r\n      return { success: true, message: 'Marked as read' };\r\n    } catch (err) {\r\n      throw new Error(`Mark as read failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * حذف الإشعار\r\n   */\r\n  static async deleteNotification(notificationId) {\r\n    try {\r\n      this.notifications = this.notifications.filter(n => n.id !== notificationId);\r\n      return { success: true, message: 'Notification deleted' };\r\n    } catch (err) {\r\n      throw new Error(`Delete notification failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * حذف جميع إشعارات المستخدم\r\n   */\r\n  static async deleteAllNotifications(userId) {\r\n    try {\r\n      const countBefore = this.notifications.length;\r\n      this.notifications = this.notifications.filter(n => n.userId !== userId);\r\n      const deletedCount = countBefore - this.notifications.length;\r\n\r\n      return {\r\n        success: true,\r\n        message: `${deletedCount} notifications deleted`,\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Delete all notifications failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * جدولة إشعار (محاكاة)\r\n   */\r\n  static async scheduleNotification(userId, notificationData, scheduleTime) {\r\n    try {\r\n      return {\r\n        success: true,\r\n        message: 'Notification scheduled',\r\n        scheduledFor: scheduleTime,\r\n        userId,\r\n        status: 'pending',\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Schedule notification failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  // Helper Methods\r\n  static _simulateDelivery(channels) {\r\n    const delivery = {};\r\n    channels.forEach(channel => {\r\n      delivery[channel] = {\r\n        status: 'delivered',\r\n        timestamp: new Date(),\r\n        attempts: 1,\r\n      };\r\n    });\r\n    return delivery;\r\n  }\r\n}\r\n\r\nmodule.exports = NotificationService;\r\n"],"mappings":"AAAA;AACA;AACA;;AAEA,MAAM;EAAEA;AAAU,CAAC,GAAGC,OAAO,CAAC,gBAAgB,CAAC;AAC/C,MAAM;EAAEC;AAAQ,CAAC,GAAGD,OAAO,CAAC,cAAc,CAAC;AAC3C,MAAM;EAAEE;AAAS,CAAC,GAAGF,OAAO,CAAC,eAAe,CAAC;AAC7C,MAAMG,IAAI,GAAGH,OAAO,CAAC,gBAAgB,CAAC;AAEtC,MAAMI,mBAAmB,CAAC;EACxB,OAAOC,aAAa,GAAG,EAAE;EACzB,OAAOC,YAAY,GAAG,IAAI;EAC1B,OAAOC,UAAU,GAAG,IAAI;EACxB,OAAOC,WAAW,GAAG,IAAI;;EAEzB;AACF;AACA;EACE,OAAOC,UAAUA,CAACC,MAAM,GAAG,CAAC,CAAC,EAAE;IAC7B,IAAI,CAACJ,YAAY,GAAG;MAClBI,MAAM,EAAEA,MAAM,CAACC,KAAK,IAAI,CAAC,CAAC;MAC1BC,IAAI,EAAE,MAAOC,WAAW,KAAM;QAAEC,OAAO,EAAE;MAAK,CAAC;IACjD,CAAC;IACD,IAAI,CAACP,UAAU,GAAG;MAChBG,MAAM,EAAEA,MAAM,CAACK,GAAG,IAAI,CAAC,CAAC;MACxBH,IAAI,EAAE,MAAOI,UAAU,KAAM;QAAEF,OAAO,EAAE;MAAK,CAAC;IAChD,CAAC;IACD,IAAI,CAACN,WAAW,GAAG;MACjBE,MAAM,EAAEA,MAAM,CAACO,IAAI,IAAI,CAAC,CAAC;MACzBL,IAAI,EAAE,MAAOM,WAAW,KAAM;QAAEJ,OAAO,EAAE;MAAK,CAAC;IACjD,CAAC;IACD,OAAO,IAAI;EACb;;EAEA;AACF;AACA;EACE,aAAaK,gBAAgBA,CAACC,MAAM,EAAEC,gBAAgB,EAAE;IACtD,IAAI;MACF,MAAMC,KAAK,GAAG;QACZC,EAAE,EAAE,SAASC,IAAI,CAACC,GAAG,CAAC,CAAC,EAAE;QACzBL,MAAM;QACNM,KAAK,EAAEL,gBAAgB,CAACK,KAAK;QAC7BC,OAAO,EAAEN,gBAAgB,CAACM,OAAO;QACjCC,QAAQ,EAAEP,gBAAgB,CAACO,QAAQ,IAAI,CAAC,QAAQ,CAAC;QACjDC,QAAQ,EAAER,gBAAgB,CAACQ,QAAQ,IAAI,QAAQ;QAC/CC,SAAS,EAAE,IAAIN,IAAI,CAAC,CAAC;QACrBO,IAAI,EAAE,IAAI;QACVC,cAAc,EAAE,CAAC;MACnB,CAAC;;MAED;;MAEA;MACA,IAAIC,IAAI,GAAGZ,gBAAgB,CAACa,OAAO;MACnC,IAAI,CAACD,IAAI,EAAE;QACTA,IAAI,GAAG,MAAM9B,IAAI,CAACgC,QAAQ,CAACf,MAAM,CAAC,CAACgB,IAAI,CAAC,CAAC;MAC3C;MAEA,KAAK,MAAMC,OAAO,IAAIf,KAAK,CAACM,QAAQ,EAAE;QACpC,IAAIS,OAAO,KAAK,OAAO,EAAE;UACvB,MAAMC,EAAE,GAAGjB,gBAAgB,CAACV,KAAK,IAAKsB,IAAI,IAAIA,IAAI,CAACtB,KAAM,IAAI,kBAAkB;UAC/E,MAAM4B,OAAO,GAAGjB,KAAK,CAACI,KAAK;UAC3B,MAAMc,IAAI,GAAGlB,KAAK,CAACK,OAAO;UAC1B,MAAMc,MAAM,GAAG,MAAM1C,SAAS,CAAC;YAAEuC,EAAE;YAAEC,OAAO;YAAEC;UAAK,CAAC,CAAC;UACrDlB,KAAK,CAACU,cAAc,CAACrB,KAAK,GAAG8B,MAAM,CAAC3B,OAAO,GAAG,MAAM,GAAG,QAAQ;QACjE,CAAC,MAAM,IAAIuB,OAAO,KAAK,KAAK,EAAE;UAC5B,MAAMC,EAAE,GAAGjB,gBAAgB,CAACqB,KAAK,IAAKT,IAAI,IAAIA,IAAI,CAACS,KAAM,IAAI,eAAe;UAC5E,MAAMf,OAAO,GAAGL,KAAK,CAACK,OAAO;UAC7B,MAAMc,MAAM,GAAG,MAAMxC,OAAO,CAAC;YAAEqC,EAAE;YAAEX;UAAQ,CAAC,CAAC;UAC7CL,KAAK,CAACU,cAAc,CAACjB,GAAG,GAAG0B,MAAM,CAAC3B,OAAO,GAAG,MAAM,GAAG,QAAQ;QAC/D,CAAC,MAAM,IAAIuB,OAAO,KAAK,MAAM,EAAE;UAC7B,MAAMM,MAAM,GAAIV,IAAI,IAAIA,IAAI,CAACW,SAAS,IAAK,EAAE;UAC7C,IAAID,MAAM,CAACE,MAAM,GAAG,CAAC,EAAE;YACrB,MAAMJ,MAAM,GAAG,MAAMvC,QAAQ,CAAC;cAAEyC,MAAM;cAAEjB,KAAK,EAAEJ,KAAK,CAACI,KAAK;cAAEoB,IAAI,EAAExB,KAAK,CAACK;YAAQ,CAAC,CAAC;YAClFL,KAAK,CAACU,cAAc,CAACf,IAAI,GAAGwB,MAAM,CAAC3B,OAAO,GAAG,MAAM,GAAG,QAAQ;UAChE,CAAC,MAAM;YACLQ,KAAK,CAACU,cAAc,CAACf,IAAI,GAAG,WAAW;UACzC;QACF,CAAC,MAAM,IAAIoB,OAAO,KAAK,QAAQ,EAAE;UAC/Bf,KAAK,CAACU,cAAc,CAACe,KAAK,GAAG,WAAW;QAC1C;MACF;MAEA,IAAI,CAAC1C,aAAa,CAACY,IAAI,CAACK,KAAK,CAAC;MAE9B,OAAO;QACLR,OAAO,EAAE,IAAI;QACbkC,cAAc,EAAE1B,KAAK,CAACC,EAAE;QACxB0B,MAAM,EAAE3B,KAAK,CAACM,QAAQ;QACtBI,cAAc,EAAEV,KAAK,CAACU,cAAc;QACpCkB,SAAS,EAAE,IAAI1B,IAAI,CAAC;MACtB,CAAC;IACH,CAAC,CAAC,OAAO2B,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,6BAA6BD,GAAG,CAACxB,OAAO,EAAE,CAAC;IAC7D;EACF;;EAEA;AACF;AACA;EACE,aAAa0B,gBAAgBA,CAACjC,MAAM,EAAEkC,KAAK,GAAG,EAAE,EAAEC,UAAU,GAAG,KAAK,EAAE;IACpE,IAAI;MACF,IAAIC,UAAU,GAAG,IAAI,CAACnD,aAAa,CAACoD,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACtC,MAAM,KAAKA,MAAM,CAAC;MAEpE,IAAImC,UAAU,EAAE;QACdC,UAAU,GAAGA,UAAU,CAACC,MAAM,CAACC,CAAC,IAAI,CAACA,CAAC,CAACC,IAAI,CAAC;MAC9C;MAEA,OAAO;QACL7C,OAAO,EAAE,IAAI;QACb8C,KAAK,EAAEJ,UAAU,CAACX,MAAM;QACxBxC,aAAa,EAAEmD,UAAU,CAACK,KAAK,CAAC,CAACP,KAAK,CAAC;QACvCJ,SAAS,EAAE,IAAI1B,IAAI,CAAC;MACtB,CAAC;IACH,CAAC,CAAC,OAAO2B,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,6BAA6BD,GAAG,CAACxB,OAAO,EAAE,CAAC;IAC7D;EACF;;EAEA;AACF;AACA;EACE,aAAamC,UAAUA,CAACd,cAAc,EAAE;IACtC,IAAI;MACF,MAAM1B,KAAK,GAAG,IAAI,CAACjB,aAAa,CAAC0D,IAAI,CAACL,CAAC,IAAIA,CAAC,CAACnC,EAAE,KAAKyB,cAAc,CAAC;MACnE,IAAI1B,KAAK,EAAE;QACTA,KAAK,CAACqC,IAAI,GAAG,IAAI;MACnB;MAEA,OAAO;QAAE7C,OAAO,EAAE,IAAI;QAAEa,OAAO,EAAE;MAAiB,CAAC;IACrD,CAAC,CAAC,OAAOwB,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,wBAAwBD,GAAG,CAACxB,OAAO,EAAE,CAAC;IACxD;EACF;;EAEA;AACF;AACA;EACE,aAAaqC,kBAAkBA,CAAChB,cAAc,EAAE;IAC9C,IAAI;MACF,IAAI,CAAC3C,aAAa,GAAG,IAAI,CAACA,aAAa,CAACoD,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACnC,EAAE,KAAKyB,cAAc,CAAC;MAC5E,OAAO;QAAElC,OAAO,EAAE,IAAI;QAAEa,OAAO,EAAE;MAAuB,CAAC;IAC3D,CAAC,CAAC,OAAOwB,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,+BAA+BD,GAAG,CAACxB,OAAO,EAAE,CAAC;IAC/D;EACF;;EAEA;AACF;AACA;EACE,aAAasC,sBAAsBA,CAAC7C,MAAM,EAAE;IAC1C,IAAI;MACF,MAAM8C,WAAW,GAAG,IAAI,CAAC7D,aAAa,CAACwC,MAAM;MAC7C,IAAI,CAACxC,aAAa,GAAG,IAAI,CAACA,aAAa,CAACoD,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACtC,MAAM,KAAKA,MAAM,CAAC;MACxE,MAAM+C,YAAY,GAAGD,WAAW,GAAG,IAAI,CAAC7D,aAAa,CAACwC,MAAM;MAE5D,OAAO;QACL/B,OAAO,EAAE,IAAI;QACba,OAAO,EAAE,GAAGwC,YAAY;MAC1B,CAAC;IACH,CAAC,CAAC,OAAOhB,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,oCAAoCD,GAAG,CAACxB,OAAO,EAAE,CAAC;IACpE;EACF;;EAEA;AACF;AACA;EACE,aAAayC,oBAAoBA,CAAChD,MAAM,EAAEC,gBAAgB,EAAEgD,YAAY,EAAE;IACxE,IAAI;MACF,OAAO;QACLvD,OAAO,EAAE,IAAI;QACba,OAAO,EAAE,wBAAwB;QACjC2C,YAAY,EAAED,YAAY;QAC1BjD,MAAM;QACNmD,MAAM,EAAE;MACV,CAAC;IACH,CAAC,CAAC,OAAOpB,GAAG,EAAE;MACZ,MAAM,IAAIC,KAAK,CAAC,iCAAiCD,GAAG,CAACxB,OAAO,EAAE,CAAC;IACjE;EACF;;EAEA;EACA,OAAO6C,iBAAiBA,CAAC5C,QAAQ,EAAE;IACjC,MAAM6C,QAAQ,GAAG,CAAC,CAAC;IACnB7C,QAAQ,CAAC8C,OAAO,CAACrC,OAAO,IAAI;MAC1BoC,QAAQ,CAACpC,OAAO,CAAC,GAAG;QAClBkC,MAAM,EAAE,WAAW;QACnBrB,SAAS,EAAE,IAAI1B,IAAI,CAAC,CAAC;QACrBmD,QAAQ,EAAE;MACZ,CAAC;IACH,CAAC,CAAC;IACF,OAAOF,QAAQ;EACjB;AACF;AAEAG,MAAM,CAACC,OAAO,GAAGzE,mBAAmB","ignoreList":[]}