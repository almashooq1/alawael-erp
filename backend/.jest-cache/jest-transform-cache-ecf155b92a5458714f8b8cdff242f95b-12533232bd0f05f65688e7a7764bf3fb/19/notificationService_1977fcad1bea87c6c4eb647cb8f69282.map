{"version":3,"names":["sendEmail","require","sendSMS","sendPush","NotificationService","notifications","sendNotification","userId","notificationData","notif","id","Date","now","title","message","channels","priority","createdAt","sent","deliveryStatus","user","userObj","User","findById","lean","channel","to","email","subject","text","result","success","phone","sms","tokens","fcmTokens","length","body","push","inApp","notificationId","sentTo","timestamp","err","Error","getNotifications","limit","unreadOnly","userNotifs","filter","n","read","count","slice","markAsRead","find","deleteNotification","deleteAllNotifications","countBefore","deletedCount","scheduleNotification","scheduleTime","scheduledFor","status","_simulateDelivery","delivery","forEach","attempts","module","exports"],"sources":["notificationService.js"],"sourcesContent":["/**\r\n * Notification Service - Multi-channel Notifications\r\n */\r\n\r\nconst { sendEmail } = require('./emailService');\r\nconst { sendSMS } = require('./smsService');\r\nconst { sendPush } = require('./pushService');\r\n\r\nclass NotificationService {\r\n  static notifications = [];\r\n\r\n  /**\r\n   * إرسال إشعار\r\n   */\r\n  static async sendNotification(userId, notificationData) {\r\n    try {\r\n      const notif = {\r\n        id: `notif_${Date.now()}`,\r\n        userId,\r\n        title: notificationData.title,\r\n        message: notificationData.message,\r\n        channels: notificationData.channels || ['in-app'],\r\n        priority: notificationData.priority || 'normal',\r\n        createdAt: new Date(),\r\n        sent: true,\r\n        deliveryStatus: {},\r\n      };\r\n\r\n      // إرسال عبر القنوات المطلوبة\r\n\r\n      // جلب بيانات المستخدم (للحصول على البريد، الجوال، fcmTokens)\r\n      let user = notificationData.userObj;\r\n      if (!user) {\r\n        user = await User.findById(userId).lean();\r\n      }\r\n\r\n      for (const channel of notif.channels) {\r\n        if (channel === 'email') {\r\n          const to = notificationData.email || (user && user.email) || 'test@example.com';\r\n          const subject = notif.title;\r\n          const text = notif.message;\r\n          const result = await sendEmail({ to, subject, text });\r\n          notif.deliveryStatus.email = result.success ? 'sent' : 'failed';\r\n        } else if (channel === 'sms') {\r\n          const to = notificationData.phone || (user && user.phone) || '+201234567890';\r\n          const message = notif.message;\r\n          const result = await sendSMS({ to, message });\r\n          notif.deliveryStatus.sms = result.success ? 'sent' : 'failed';\r\n        } else if (channel === 'push') {\r\n          const tokens = (user && user.fcmTokens) || [];\r\n          if (tokens.length > 0) {\r\n            const result = await sendPush({ tokens, title: notif.title, body: notif.message });\r\n            notif.deliveryStatus.push = result.success ? 'sent' : 'failed';\r\n          } else {\r\n            notif.deliveryStatus.push = 'no-tokens';\r\n          }\r\n        } else if (channel === 'in-app') {\r\n          notif.deliveryStatus.inApp = 'delivered';\r\n        }\r\n      }\r\n\r\n      this.notifications.push(notif);\r\n\r\n      return {\r\n        success: true,\r\n        notificationId: notif.id,\r\n        sentTo: notif.channels,\r\n        deliveryStatus: notif.deliveryStatus,\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Notification send failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * الحصول على إشعارات المستخدم\r\n   */\r\n  static async getNotifications(userId, limit = 50, unreadOnly = false) {\r\n    try {\r\n      let userNotifs = this.notifications.filter(n => n.userId === userId);\r\n\r\n      if (unreadOnly) {\r\n        userNotifs = userNotifs.filter(n => !n.read);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        count: userNotifs.length,\r\n        notifications: userNotifs.slice(-limit),\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Get notifications failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * وضع علامة على الإشعار كمقروء\r\n   */\r\n  static async markAsRead(notificationId) {\r\n    try {\r\n      const notif = this.notifications.find(n => n.id === notificationId);\r\n      if (notif) {\r\n        notif.read = true;\r\n      }\r\n\r\n      return { success: true, message: 'Marked as read' };\r\n    } catch (err) {\r\n      throw new Error(`Mark as read failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * حذف الإشعار\r\n   */\r\n  static async deleteNotification(notificationId) {\r\n    try {\r\n      this.notifications = this.notifications.filter(n => n.id !== notificationId);\r\n      return { success: true, message: 'Notification deleted' };\r\n    } catch (err) {\r\n      throw new Error(`Delete notification failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * حذف جميع إشعارات المستخدم\r\n   */\r\n  static async deleteAllNotifications(userId) {\r\n    try {\r\n      const countBefore = this.notifications.length;\r\n      this.notifications = this.notifications.filter(n => n.userId !== userId);\r\n      const deletedCount = countBefore - this.notifications.length;\r\n\r\n      return {\r\n        success: true,\r\n        message: `${deletedCount} notifications deleted`,\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Delete all notifications failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * جدولة إشعار (محاكاة)\r\n   */\r\n  static async scheduleNotification(userId, notificationData, scheduleTime) {\r\n    try {\r\n      return {\r\n        success: true,\r\n        message: 'Notification scheduled',\r\n        scheduledFor: scheduleTime,\r\n        userId,\r\n        status: 'pending',\r\n      };\r\n    } catch (err) {\r\n      throw new Error(`Schedule notification failed: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  // Helper Methods\r\n  static _simulateDelivery(channels) {\r\n    const delivery = {};\r\n    channels.forEach(channel => {\r\n      delivery[channel] = {\r\n        status: 'delivered',\r\n        timestamp: new Date(),\r\n        attempts: 1,\r\n      };\r\n    });\r\n    return delivery;\r\n  }\r\n}\r\n\r\nmodule.exports = NotificationService;\r\n"],"mappings":"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","ignoreList":[]}