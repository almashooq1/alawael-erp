{"version":3,"names":["EventEmitter","require","v4","uuidv4","Logger","TenantIsolationService","constructor","logger","tenantData","Map","tenantIndexes","crossTenantAccessLog","violations","stats","totalDataItems","isolationViolations","unauthorizedAccesses","initializeTenantContainer","tenantId","has","set","users","resources","documents","files","activities","customData","createdAt","Date","usersByEmail","resourcesByType","documentsByName","emit","info","error","message","storeTenantData","dataType","id","data","container","get","Error","taggedData","storedAt","_updateTenantIndex","retrieveTenantData","deleteTenantData","deleted","delete","_removeFromTenantIndex","queryTenantData","filters","dataMap","results","Array","from","values","search","toLowerCase","filter","item","JSON","stringify","includes","limit","slice","verifyCrossTenantAccess","requestedTenantId","actualTenantId","userId","violation","timestamp","severity","push","warn","getTenantIsolationReport","totalItems","breakdown","Object","keys","forEach","key","size","containerCreatedAt","lastModified","cleanupTenantData","archive","archivedAt","itemCount","_countTenantItems","cleanupLog","action","index","email","resourceType","name","value","list","idx","indexOf","splice","count","map","getStatistics","totalTenants","cachedIndexes","averageItemsPerTenant","Math","floor","module","exports"],"sources":["tenantIsolation.service.js"],"sourcesContent":["/**\r\n * Tenant Isolation Service\r\n * خدمة عزل الالتزامات\r\n * \r\n * المسؤوليات:\r\n * - فرض عزل البيانات بين الالتزامات\r\n * - إدارة الفهارس المنفصلة\r\n * - معالجة النسخ الاحتياطية من الالتزام\r\n * - تحكم الوصول المتقاطع\r\n */\r\n\r\nconst { EventEmitter } = require('events');\r\nconst { v4: uuidv4 } = require('uuid');\r\nconst Logger = require('../utils/logger');\r\n\r\nclass TenantIsolationService extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.logger = Logger;\r\n\r\n    // Tenant-specific data storage\r\n    this.tenantData = new Map();\r\n\r\n    // Tenant-specific indexes\r\n    this.tenantIndexes = new Map();\r\n\r\n    // Cross-tenant access logs\r\n    this.crossTenantAccessLog = [];\r\n\r\n    // Violation records\r\n    this.violations = [];\r\n\r\n    // Statistics\r\n    this.stats = {\r\n      totalDataItems: 0,\r\n      isolationViolations: 0,\r\n      unauthorizedAccesses: 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Initialize tenant data container\r\n   * تهيئة حاوية بيانات الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   */\r\n  initializeTenantContainer(tenantId) {\r\n    try {\r\n      if (this.tenantData.has(tenantId)) {\r\n        return false; // Already initialized\r\n      }\r\n\r\n      this.tenantData.set(tenantId, {\r\n        users: new Map(),\r\n        resources: new Map(),\r\n        documents: new Map(),\r\n        files: new Map(),\r\n        activities: [],\r\n        customData: new Map(),\r\n        createdAt: new Date()\r\n      });\r\n\r\n      this.tenantIndexes.set(tenantId, {\r\n        usersByEmail: new Map(),\r\n        resourcesByType: new Map(),\r\n        documentsByName: new Map(),\r\n        createdAt: new Date()\r\n      });\r\n\r\n      this.emit('tenant:container_initialized', { tenantId });\r\n      this.logger.info(`Tenant container initialized: ${tenantId}`);\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error(`Error initializing tenant container: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Store tenant data\r\n   * تخزين بيانات الالتزام\r\n   * \r\n   * Ensures data is stored in tenant-specific container\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} dataType - Data type (users, resources, documents, etc)\r\n   * @param {String} id - Data ID\r\n   * @param {Object} data - Data object\r\n   */\r\n  storeTenantData(tenantId, dataType, id, data) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) {\r\n        throw new Error(`Tenant container not found: ${tenantId}`);\r\n      }\r\n\r\n      // Ensure data is tagged with tenant\r\n      const taggedData = {\r\n        ...data,\r\n        tenantId,\r\n        dataType,\r\n        storedAt: new Date()\r\n      };\r\n\r\n      // Store in type-specific map\r\n      if (container[dataType]) {\r\n        container[dataType].set(id, taggedData);\r\n      } else {\r\n        container.customData.set(`${dataType}:${id}`, taggedData);\r\n      }\r\n\r\n      // Update index if applicable\r\n      this._updateTenantIndex(tenantId, dataType, id, taggedData);\r\n\r\n      this.stats.totalDataItems++;\r\n      this.emit('tenant:data_stored', { tenantId, dataType, id });\r\n\r\n      return taggedData;\r\n    } catch (error) {\r\n      this.logger.error(`Error storing tenant data: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve tenant data\r\n   * استرجاع بيانات الالتزام\r\n   * \r\n   * Ensures data belongs to tenant before returning\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} dataType - Data type\r\n   * @param {String} id - Data ID\r\n   * @returns {Object} Data object\r\n   */\r\n  retrieveTenantData(tenantId, dataType, id) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) {\r\n        return null;\r\n      }\r\n\r\n      let data;\r\n      if (container[dataType]) {\r\n        data = container[dataType].get(id);\r\n      } else {\r\n        data = container.customData.get(`${dataType}:${id}`);\r\n      }\r\n\r\n      // Verify ownership before returning\r\n      if (data && data.tenantId !== tenantId) {\r\n        throw new Error(`Data ownership mismatch: ${id}`);\r\n      }\r\n\r\n      return data || null;\r\n    } catch (error) {\r\n      this.logger.error(`Error retrieving tenant data: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete tenant data\r\n   * حذف بيانات الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} dataType - Data type\r\n   * @param {String} id - Data ID\r\n   */\r\n  deleteTenantData(tenantId, dataType, id) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) {\r\n        throw new Error(`Tenant container not found: ${tenantId}`);\r\n      }\r\n\r\n      let deleted = false;\r\n      if (container[dataType]) {\r\n        deleted = container[dataType].delete(id);\r\n      } else {\r\n        deleted = container.customData.delete(`${dataType}:${id}`);\r\n      }\r\n\r\n      if (deleted) {\r\n        this._removeFromTenantIndex(tenantId, dataType, id);\r\n        this.stats.totalDataItems--;\r\n        this.emit('tenant:data_deleted', { tenantId, dataType, id });\r\n      }\r\n\r\n      return deleted;\r\n    } catch (error) {\r\n      this.logger.error(`Error deleting tenant data: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query tenant data\r\n   * طلب بيانات الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} dataType - Data type\r\n   * @param {Object} filters - Filters\r\n   * @returns {Array} Matching data\r\n   */\r\n  queryTenantData(tenantId, dataType, filters = {}) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) {\r\n        return [];\r\n      }\r\n\r\n      let dataMap = container[dataType];\r\n      if (!dataMap) {\r\n        return [];\r\n      }\r\n\r\n      let results = Array.from(dataMap.values());\r\n\r\n      // Apply filtering\r\n      if (filters.search) {\r\n        const search = filters.search.toLowerCase();\r\n        results = results.filter(item =>\r\n          JSON.stringify(item).toLowerCase().includes(search)\r\n        );\r\n      }\r\n\r\n      if (filters.limit) {\r\n        results = results.slice(0, filters.limit);\r\n      }\r\n\r\n      return results;\r\n    } catch (error) {\r\n      this.logger.error(`Error querying tenant data: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify cross-tenant access attempt\r\n   * التحقق من محاولة الوصول المتقاطع للالتزام\r\n   * \r\n   * @param {String} requestedTenantId - Requested tenant ID\r\n   * @param {String} actualTenantId - Actual tenant ID from data\r\n   * @param {String} userId - User ID\r\n   * @returns {Boolean} Access allowed\r\n   */\r\n  verifyCrossTenantAccess(requestedTenantId, actualTenantId, userId) {\r\n    try {\r\n      if (requestedTenantId === actualTenantId) {\r\n        return true; // Same tenant, allowed\r\n      }\r\n\r\n      // Cross-tenant access attempt - log and deny\r\n      const violation = {\r\n        id: `violation-${uuidv4()}`,\r\n        timestamp: new Date(),\r\n        requestedTenantId,\r\n        actualTenantId,\r\n        userId,\r\n        severity: 'HIGH'\r\n      };\r\n\r\n      this.violations.push(violation);\r\n      this.stats.unauthorizedAccesses++;\r\n      this.stats.isolationViolations++;\r\n\r\n      this.emit('tenant:isolation_violation', violation);\r\n      this.logger.warn(\r\n        `Cross-tenant access violation: ${userId} tried to access ${actualTenantId} but is in ${requestedTenantId}`\r\n      );\r\n\r\n      return false;\r\n    } catch (error) {\r\n      this.logger.error(`Error verifying cross-tenant access: ${error.message}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get tenant isolation report\r\n   * الحصول على تقرير عزل الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @returns {Object} Isolation report\r\n   */\r\n  getTenantIsolationReport(tenantId) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) {\r\n        return null;\r\n      }\r\n\r\n      let totalItems = 0;\r\n      const breakdown = {};\r\n\r\n      Object.keys(container).forEach(key => {\r\n        if (key !== 'activities' && key !== 'customData' && container[key] instanceof Map) {\r\n          breakdown[key] = container[key].size;\r\n          totalItems += container[key].size;\r\n        }\r\n      });\r\n\r\n      if (container.customData) {\r\n        breakdown.customData = container.customData.size;\r\n        totalItems += container.customData.size;\r\n      }\r\n\r\n      return {\r\n        tenantId,\r\n        totalItems,\r\n        breakdown,\r\n        containerCreatedAt: container.createdAt,\r\n        lastModified: new Date()\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Error getting isolation report: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up tenant data\r\n   * تنظيف بيانات الالتزام\r\n   * \r\n   * Completely removes tenant's data\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   */\r\n  cleanupTenantData(tenantId) {\r\n    try {\r\n      // Archive before deletion\r\n      const container = this.tenantData.get(tenantId);\r\n      if (container) {\r\n        const archive = {\r\n          tenantId,\r\n          archivedAt: new Date(),\r\n          itemCount: this._countTenantItems(tenantId)\r\n        };\r\n\r\n        this.emit('tenant:data_archived', archive);\r\n      }\r\n\r\n      // Delete all tenant data\r\n      this.tenantData.delete(tenantId);\r\n      this.tenantIndexes.delete(tenantId);\r\n\r\n      // Log cleanup\r\n      const cleanupLog = {\r\n        tenantId,\r\n        action: 'cleanup',\r\n        timestamp: new Date()\r\n      };\r\n\r\n      this.crossTenantAccessLog.push(cleanupLog);\r\n      this.logger.info(`Tenant data cleaned up: ${tenantId}`);\r\n\r\n      this.emit('tenant:cleanup_complete', { tenantId });\r\n    } catch (error) {\r\n      this.logger.error(`Error cleaning up tenant data: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update tenant index\r\n   * تحديث فهرس الالتزام\r\n   * \r\n   * @private\r\n   */\r\n  _updateTenantIndex(tenantId, dataType, id, data) {\r\n    try {\r\n      const index = this.tenantIndexes.get(tenantId);\r\n      if (!index) return;\r\n\r\n      // Index by email for users\r\n      if (dataType === 'users' && data.email) {\r\n        index.usersByEmail.set(data.email, id);\r\n      }\r\n\r\n      // Index by type for resources\r\n      if (dataType === 'resources' && data.resourceType) {\r\n        if (!index.resourcesByType.has(data.resourceType)) {\r\n          index.resourcesByType.set(data.resourceType, []);\r\n        }\r\n        index.resourcesByType.get(data.resourceType).push(id);\r\n      }\r\n\r\n      // Index by name for documents\r\n      if (dataType === 'documents' && data.name) {\r\n        index.documentsByName.set(data.name, id);\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(`Error updating tenant index: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove from tenant index\r\n   * إزالة من فهرس الالتزام\r\n   * \r\n   * @private\r\n   */\r\n  _removeFromTenantIndex(tenantId, dataType, id) {\r\n    try {\r\n      const index = this.tenantIndexes.get(tenantId);\r\n      if (!index) return;\r\n\r\n      // Remove from user index\r\n      if (dataType === 'users') {\r\n        index.usersByEmail.forEach((value, key) => {\r\n          if (value === id) {\r\n            index.usersByEmail.delete(key);\r\n          }\r\n        });\r\n      }\r\n\r\n      // Remove from resource index\r\n      if (dataType === 'resources') {\r\n        index.resourcesByType.forEach(list => {\r\n          const idx = list.indexOf(id);\r\n          if (idx > -1) {\r\n            list.splice(idx, 1);\r\n          }\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(`Error removing from index: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Count tenant items\r\n   * عد عناصر الالتزام\r\n   * \r\n   * @private\r\n   */\r\n  _countTenantItems(tenantId) {\r\n    try {\r\n      const container = this.tenantData.get(tenantId);\r\n      if (!container) return 0;\r\n\r\n      let count = 0;\r\n      Object.values(container).forEach(map => {\r\n        if (map instanceof Map) {\r\n          count += map.size;\r\n        }\r\n      });\r\n\r\n      return count;\r\n    } catch (error) {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get isolation statistics\r\n   * الحصول على إحصائيات العزل\r\n   * \r\n   * @returns {Object} Statistics\r\n   */\r\n  getStatistics() {\r\n    return {\r\n      totalTenants: this.tenantData.size,\r\n      totalDataItems: this.stats.totalDataItems,\r\n      isolationViolations: this.stats.isolationViolations,\r\n      unauthorizedAccesses: this.stats.unauthorizedAccesses,\r\n      cachedIndexes: this.tenantIndexes.size,\r\n      averageItemsPerTenant: this.tenantData.size > 0\r\n        ? Math.floor(this.stats.totalDataItems / this.tenantData.size)\r\n        : 0\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = new TenantIsolationService();\r\n"],"mappings":"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","ignoreList":[]}