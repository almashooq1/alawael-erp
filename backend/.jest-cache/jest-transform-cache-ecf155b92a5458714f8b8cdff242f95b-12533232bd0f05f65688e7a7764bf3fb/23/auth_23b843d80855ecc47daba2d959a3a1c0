1ec2718b191720c3422eea7a7f6bef5f
/**
 * Authentication Middleware
 * Basic auth middleware for protected routes
 */

const jwt = require('jwt-simple');
const logger = require('../utils/logger');
const SECRET = process.env.JWT_SECRET || 'your-secret-key';

/**
 * Verify JWT token
 */
const verifyToken = (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    if (!token) {
      return res.status(401).json({
        success: false,
        error: 'No token provided'
      });
    }

    // Decode base64 token (as generated by AuthService)
    let decoded;
    try {
      decoded = JSON.parse(Buffer.from(token, 'base64').toString());
    } catch (_e) {
      // If base64 decoding fails, try JWT
      try {
        decoded = jwt.decode(token, SECRET);
      } catch (_jwtError) {
        // If both fail, return invalid token error
        return res.status(401).json({
          success: false,
          error: 'Invalid token'
        });
      }
    }
    if (decoded.exp && decoded.exp < Date.now()) {
      return res.status(401).json({
        success: false,
        error: 'Token expired'
      });
    }
    req.user = decoded;
    next();
  } catch (error) {
    logger.error('Token verification failed:', error);
    res.status(401).json({
      success: false,
      error: 'Invalid token'
    });
  }
};

/**
 * Optional authentication - doesn't fail if no token
 */
const optionalAuth = (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    if (token) {
      // Decode base64 token (as generated by AuthService)
      let decoded;
      try {
        decoded = JSON.parse(Buffer.from(token, 'base64').toString());
      } catch (_e) {
        // Try JWT decoding as fallback
        try {
          decoded = jwt.decode(token, SECRET);
        } catch (jwtError) {
          // If both fail, just continue without user
          return next();
        }
      }
      if (!decoded.exp || decoded.exp >= Date.now()) {
        req.user = decoded;
      }
    }
    next();
  } catch (error) {
    logger.debug('Optional auth failed:', error.message);
    next();
  }
};

/**
 * Admin authorization
 */

// RBAC متقدم: تحقق من الدور والصلاحيات والسياق المؤسسي/الفرعي
const requireAdmin = (req, res, next) => {
  if (!req.user) {
    return res.status(401).json({
      error: 'Not authenticated'
    });
  }
  // تحقق من الدور الأساسي أو الأدوار الإضافية
  const isAdmin = req.user.role === 'admin' || Array.isArray(req.user.roles) && req.user.roles.includes('admin');
  if (!isAdmin) {
    return res.status(403).json({
      error: 'Admin access required'
    });
  }
  // تحقق من المؤسسة/الفرع إذا تم تمرير orgId/branchId في الطلب
  if (req.params.orgId && req.user.organizationId && req.params.orgId !== req.user.organizationId) {
    return res.status(403).json({
      error: 'Access denied for this organization'
    });
  }
  if (req.params.branchId && req.user.branchId && req.params.branchId !== req.user.branchId) {
    return res.status(403).json({
      error: 'Access denied for this branch'
    });
  }
  next();
};

// ميدل وير لصلاحيات granular (permission string)
const requirePermission = permission => (req, res, next) => {
  if (!req.user) {
    return res.status(401).json({
      error: 'Not authenticated'
    });
  }
  // تحقق من الصلاحيات
  const hasPermission = Array.isArray(req.user.permissions) && req.user.permissions.includes(permission);
  if (!hasPermission) {
    return res.status(403).json({
      error: 'Permission denied'
    });
  }
  // تحقق من المؤسسة/الفرع إذا لزم
  if (req.params.orgId && req.user.organizationId && req.params.orgId !== req.user.organizationId) {
    return res.status(403).json({
      error: 'Access denied for this organization'
    });
  }
  if (req.params.branchId && req.user.branchId && req.params.branchId !== req.user.branchId) {
    return res.status(403).json({
      error: 'Access denied for this branch'
    });
  }
  next();
};

/**
 * Authenticate middleware (alias for verifyToken)
 */
const authenticate = verifyToken;

/**
 * Authorization middleware - checks multiple roles
 */
const authorize = (...allowedRoles) => (req, res, next) => {
  if (!req.user) {
    return res.status(401).json({
      error: 'Not authenticated'
    });
  }
  if (allowedRoles.length > 0 && !allowedRoles.includes(req.user.role)) {
    return res.status(403).json({
      error: 'Insufficient permissions'
    });
  }
  next();
};
module.exports = {
  verifyToken,
  optionalAuth,
  requireAdmin,
  requirePermission,
  authenticate,
  authorize,
  protect: verifyToken // Alias for backward compatibility
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3QiLCJyZXF1aXJlIiwibG9nZ2VyIiwiU0VDUkVUIiwicHJvY2VzcyIsImVudiIsIkpXVF9TRUNSRVQiLCJ2ZXJpZnlUb2tlbiIsInJlcSIsInJlcyIsIm5leHQiLCJ0b2tlbiIsImhlYWRlcnMiLCJhdXRob3JpemF0aW9uIiwic3BsaXQiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImVycm9yIiwiZGVjb2RlZCIsIkpTT04iLCJwYXJzZSIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsIl9lIiwiZGVjb2RlIiwiX2p3dEVycm9yIiwiZXhwIiwiRGF0ZSIsIm5vdyIsInVzZXIiLCJvcHRpb25hbEF1dGgiLCJqd3RFcnJvciIsImRlYnVnIiwibWVzc2FnZSIsInJlcXVpcmVBZG1pbiIsImlzQWRtaW4iLCJyb2xlIiwiQXJyYXkiLCJpc0FycmF5Iiwicm9sZXMiLCJpbmNsdWRlcyIsInBhcmFtcyIsIm9yZ0lkIiwib3JnYW5pemF0aW9uSWQiLCJicmFuY2hJZCIsInJlcXVpcmVQZXJtaXNzaW9uIiwicGVybWlzc2lvbiIsImhhc1Blcm1pc3Npb24iLCJwZXJtaXNzaW9ucyIsImF1dGhlbnRpY2F0ZSIsImF1dGhvcml6ZSIsImFsbG93ZWRSb2xlcyIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiLCJwcm90ZWN0Il0sInNvdXJjZXMiOlsiYXV0aC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQXV0aGVudGljYXRpb24gTWlkZGxld2FyZVxyXG4gKiBCYXNpYyBhdXRoIG1pZGRsZXdhcmUgZm9yIHByb3RlY3RlZCByb3V0ZXNcclxuICovXHJcblxyXG5jb25zdCBqd3QgPSByZXF1aXJlKCdqd3Qtc2ltcGxlJyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJy4uL3V0aWxzL2xvZ2dlcicpO1xyXG5cclxuY29uc3QgU0VDUkVUID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCAneW91ci1zZWNyZXQta2V5JztcclxuXHJcbi8qKlxyXG4gKiBWZXJpZnkgSldUIHRva2VuXHJcbiAqL1xyXG5jb25zdCB2ZXJpZnlUb2tlbiA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB0b2tlbiA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24/LnNwbGl0KCcgJylbMV07XHJcblxyXG4gICAgaWYgKCF0b2tlbikge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdObyB0b2tlbiBwcm92aWRlZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRGVjb2RlIGJhc2U2NCB0b2tlbiAoYXMgZ2VuZXJhdGVkIGJ5IEF1dGhTZXJ2aWNlKVxyXG4gICAgbGV0IGRlY29kZWQ7XHJcbiAgICB0cnkge1xyXG4gICAgICBkZWNvZGVkID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbSh0b2tlbiwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkpO1xyXG4gICAgfSBjYXRjaCAoX2UpIHtcclxuICAgICAgLy8gSWYgYmFzZTY0IGRlY29kaW5nIGZhaWxzLCB0cnkgSldUXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgZGVjb2RlZCA9IGp3dC5kZWNvZGUodG9rZW4sIFNFQ1JFVCk7XHJcbiAgICAgIH0gY2F0Y2ggKF9qd3RFcnJvcikge1xyXG4gICAgICAgIC8vIElmIGJvdGggZmFpbCwgcmV0dXJuIGludmFsaWQgdG9rZW4gZXJyb3JcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdJbnZhbGlkIHRva2VuJyB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChkZWNvZGVkLmV4cCAmJiBkZWNvZGVkLmV4cCA8IERhdGUubm93KCkpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnVG9rZW4gZXhwaXJlZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVxLnVzZXIgPSBkZWNvZGVkO1xyXG4gICAgbmV4dCgpO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoJ1Rva2VuIHZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xyXG4gICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdJbnZhbGlkIHRva2VuJyB9KTtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogT3B0aW9uYWwgYXV0aGVudGljYXRpb24gLSBkb2Vzbid0IGZhaWwgaWYgbm8gdG9rZW5cclxuICovXHJcbmNvbnN0IG9wdGlvbmFsQXV0aCA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB0b2tlbiA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24/LnNwbGl0KCcgJylbMV07XHJcblxyXG4gICAgaWYgKHRva2VuKSB7XHJcbiAgICAgIC8vIERlY29kZSBiYXNlNjQgdG9rZW4gKGFzIGdlbmVyYXRlZCBieSBBdXRoU2VydmljZSlcclxuICAgICAgbGV0IGRlY29kZWQ7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgZGVjb2RlZCA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20odG9rZW4sICdiYXNlNjQnKS50b1N0cmluZygpKTtcclxuICAgICAgfSBjYXRjaCAoX2UpIHtcclxuICAgICAgICAvLyBUcnkgSldUIGRlY29kaW5nIGFzIGZhbGxiYWNrXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGRlY29kZWQgPSBqd3QuZGVjb2RlKHRva2VuLCBTRUNSRVQpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGp3dEVycm9yKSB7XHJcbiAgICAgICAgICAvLyBJZiBib3RoIGZhaWwsIGp1c3QgY29udGludWUgd2l0aG91dCB1c2VyXHJcbiAgICAgICAgICByZXR1cm4gbmV4dCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCFkZWNvZGVkLmV4cCB8fCBkZWNvZGVkLmV4cCA+PSBEYXRlLm5vdygpKSB7XHJcbiAgICAgICAgcmVxLnVzZXIgPSBkZWNvZGVkO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmV4dCgpO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZGVidWcoJ09wdGlvbmFsIGF1dGggZmFpbGVkOicsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgbmV4dCgpO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBBZG1pbiBhdXRob3JpemF0aW9uXHJcbiAqL1xyXG5cclxuLy8gUkJBQyDZhdiq2YLYr9mFOiDYqtit2YLZgiDZhdmGINin2YTYr9mI2LEg2YjYp9mE2LXZhNin2K3Zitin2Kog2YjYp9mE2LPZitin2YIg2KfZhNmF2KTYs9iz2Yov2KfZhNmB2LHYudmKXHJcbmNvbnN0IHJlcXVpcmVBZG1pbiA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gIGlmICghcmVxLnVzZXIpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnTm90IGF1dGhlbnRpY2F0ZWQnIH0pO1xyXG4gIH1cclxuICAvLyDYqtit2YLZgiDZhdmGINin2YTYr9mI2LEg2KfZhNij2LPYp9iz2Yog2KPZiCDYp9mE2KPYr9mI2KfYsSDYp9mE2KXYttin2YHZitipXHJcbiAgY29uc3QgaXNBZG1pbiA9XHJcbiAgICByZXEudXNlci5yb2xlID09PSAnYWRtaW4nIHx8XHJcbiAgICAoQXJyYXkuaXNBcnJheShyZXEudXNlci5yb2xlcykgJiYgcmVxLnVzZXIucm9sZXMuaW5jbHVkZXMoJ2FkbWluJykpO1xyXG4gIGlmICghaXNBZG1pbikge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBZG1pbiBhY2Nlc3MgcmVxdWlyZWQnIH0pO1xyXG4gIH1cclxuICAvLyDYqtit2YLZgiDZhdmGINin2YTZhdik2LPYs9ipL9in2YTZgdix2Lkg2KXYsNinINiq2YUg2KrZhdix2YrYsSBvcmdJZC9icmFuY2hJZCDZgdmKINin2YTYt9mE2KhcclxuICBpZiAocmVxLnBhcmFtcy5vcmdJZCAmJiByZXEudXNlci5vcmdhbml6YXRpb25JZCAmJiByZXEucGFyYW1zLm9yZ0lkICE9PSByZXEudXNlci5vcmdhbml6YXRpb25JZCkge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkIGZvciB0aGlzIG9yZ2FuaXphdGlvbicgfSk7XHJcbiAgfVxyXG4gIGlmIChyZXEucGFyYW1zLmJyYW5jaElkICYmIHJlcS51c2VyLmJyYW5jaElkICYmIHJlcS5wYXJhbXMuYnJhbmNoSWQgIT09IHJlcS51c2VyLmJyYW5jaElkKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQgZm9yIHRoaXMgYnJhbmNoJyB9KTtcclxuICB9XHJcbiAgbmV4dCgpO1xyXG59O1xyXG5cclxuLy8g2YXZitiv2YQg2YjZitixINmE2LXZhNin2K3Zitin2KogZ3JhbnVsYXIgKHBlcm1pc3Npb24gc3RyaW5nKVxyXG5jb25zdCByZXF1aXJlUGVybWlzc2lvbiA9IHBlcm1pc3Npb24gPT4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdOb3QgYXV0aGVudGljYXRlZCcgfSk7XHJcbiAgfVxyXG4gIC8vINiq2K3ZgtmCINmF2YYg2KfZhNi12YTYp9it2YrYp9iqXHJcbiAgY29uc3QgaGFzUGVybWlzc2lvbiA9XHJcbiAgICBBcnJheS5pc0FycmF5KHJlcS51c2VyLnBlcm1pc3Npb25zKSAmJiByZXEudXNlci5wZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKTtcclxuICBpZiAoIWhhc1Blcm1pc3Npb24pIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnUGVybWlzc2lvbiBkZW5pZWQnIH0pO1xyXG4gIH1cclxuICAvLyDYqtit2YLZgiDZhdmGINin2YTZhdik2LPYs9ipL9in2YTZgdix2Lkg2KXYsNinINmE2LLZhVxyXG4gIGlmIChyZXEucGFyYW1zLm9yZ0lkICYmIHJlcS51c2VyLm9yZ2FuaXphdGlvbklkICYmIHJlcS5wYXJhbXMub3JnSWQgIT09IHJlcS51c2VyLm9yZ2FuaXphdGlvbklkKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQgZm9yIHRoaXMgb3JnYW5pemF0aW9uJyB9KTtcclxuICB9XHJcbiAgaWYgKHJlcS5wYXJhbXMuYnJhbmNoSWQgJiYgcmVxLnVzZXIuYnJhbmNoSWQgJiYgcmVxLnBhcmFtcy5icmFuY2hJZCAhPT0gcmVxLnVzZXIuYnJhbmNoSWQpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCBmb3IgdGhpcyBicmFuY2gnIH0pO1xyXG4gIH1cclxuICBuZXh0KCk7XHJcbn07XHJcblxyXG4vKipcclxuICogQXV0aGVudGljYXRlIG1pZGRsZXdhcmUgKGFsaWFzIGZvciB2ZXJpZnlUb2tlbilcclxuICovXHJcbmNvbnN0IGF1dGhlbnRpY2F0ZSA9IHZlcmlmeVRva2VuO1xyXG5cclxuLyoqXHJcbiAqIEF1dGhvcml6YXRpb24gbWlkZGxld2FyZSAtIGNoZWNrcyBtdWx0aXBsZSByb2xlc1xyXG4gKi9cclxuY29uc3QgYXV0aG9yaXplID1cclxuICAoLi4uYWxsb3dlZFJvbGVzKSA9PlxyXG4gIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ05vdCBhdXRoZW50aWNhdGVkJyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoYWxsb3dlZFJvbGVzLmxlbmd0aCA+IDAgJiYgIWFsbG93ZWRSb2xlcy5pbmNsdWRlcyhyZXEudXNlci5yb2xlKSkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmV4dCgpO1xyXG4gIH07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICB2ZXJpZnlUb2tlbixcclxuICBvcHRpb25hbEF1dGgsXHJcbiAgcmVxdWlyZUFkbWluLFxyXG4gIHJlcXVpcmVQZXJtaXNzaW9uLFxyXG4gIGF1dGhlbnRpY2F0ZSxcclxuICBhdXRob3JpemUsXHJcbiAgcHJvdGVjdDogdmVyaWZ5VG9rZW4sIC8vIEFsaWFzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsWUFBWSxDQUFDO0FBQ2pDLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBRXpDLE1BQU1FLE1BQU0sR0FBR0MsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFVBQVUsSUFBSSxpQkFBaUI7O0FBRTFEO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLFdBQVcsR0FBR0EsQ0FBQ0MsR0FBRyxFQUFFQyxHQUFHLEVBQUVDLElBQUksS0FBSztFQUN0QyxJQUFJO0lBQ0YsTUFBTUMsS0FBSyxHQUFHSCxHQUFHLENBQUNJLE9BQU8sQ0FBQ0MsYUFBYSxFQUFFQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXRELElBQUksQ0FBQ0gsS0FBSyxFQUFFO01BQ1YsT0FBT0YsR0FBRyxDQUFDTSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQztRQUFFQyxPQUFPLEVBQUUsS0FBSztRQUFFQyxLQUFLLEVBQUU7TUFBb0IsQ0FBQyxDQUFDO0lBQzdFOztJQUVBO0lBQ0EsSUFB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