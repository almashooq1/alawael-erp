{"version":3,"names":["logger","require","systemDashboard","PerformanceMonitor","constructor","metrics","requests","slowQueries","errors","throughput","startTime","Date","now","slowThreshold","parseInt","process","env","SLOW_QUERY_MS","middleware","req","res","next","routeKey","method","path","originalSend","send","data","duration","success","statusCode","recordMetric","recordSlowQuery","query","bind","route","count","totalTime","minTime","Infinity","maxTime","statusCodes","metric","Math","min","max","params","push","timestamp","toISOString","Object","keys","length","shift","warn","getSummary","routes","entries","map","avgTime","round","errorRate","toFixed","uptime","summary","totalRequests","floor","topRoutes","sort","a","b","slice","slowestRoutes","recentSlowQueries","reset","module","exports"],"sources":["performanceMonitor.js"],"sourcesContent":["/**\n * Performance Monitoring Middleware\n * Track and analyze system performance\n * Phase 11: System Integration\n */\n\nconst logger = require('../utils/logger');\nconst systemDashboard = require('../services/systemDashboard');\n\nclass PerformanceMonitor {\n  constructor() {\n    this.metrics = {\n      requests: {},\n      slowQueries: [],\n      errors: [],\n      throughput: 0,\n      startTime: Date.now(),\n    };\n    this.slowThreshold = parseInt(process.env.SLOW_QUERY_MS || '100');\n  }\n\n  /**\n   * Performance monitoring middleware\n   */\n  middleware() {\n    return (req, res, next) => {\n      const startTime = Date.now();\n      const routeKey = `${req.method} ${req.path}`;\n\n      // Track original send method\n      const originalSend = res.send;\n      res.send = function (data) {\n        res.send = originalSend;\n\n        const duration = Date.now() - startTime;\n        const success = res.statusCode < 400;\n\n        // Record metrics\n        this.recordMetric(routeKey, duration, success, res.statusCode);\n        systemDashboard.recordMetric(duration, success);\n\n        // Log slow requests\n        if (duration > this.slowThreshold) {\n          this.recordSlowQuery(routeKey, duration, req.query);\n        }\n\n        return res.send(data);\n      }.bind(this);\n\n      next();\n    };\n  }\n\n  /**\n   * Record request metric\n   */\n  recordMetric(route, duration, success, statusCode) {\n    if (!this.metrics.requests[route]) {\n      this.metrics.requests[route] = {\n        count: 0,\n        totalTime: 0,\n        minTime: Infinity,\n        maxTime: 0,\n        errors: 0,\n        statusCodes: {},\n      };\n    }\n\n    const metric = this.metrics.requests[route];\n    metric.count++;\n    metric.totalTime += duration;\n    metric.minTime = Math.min(metric.minTime, duration);\n    metric.maxTime = Math.max(metric.maxTime, duration);\n    metric.statusCodes[statusCode] = (metric.statusCodes[statusCode] || 0) + 1;\n\n    if (!success) {\n      metric.errors++;\n    }\n\n    this.metrics.throughput++;\n  }\n\n  /**\n   * Record slow query\n   */\n  recordSlowQuery(route, duration, params) {\n    this.metrics.slowQueries.push({\n      timestamp: new Date().toISOString(),\n      route,\n      duration,\n      params: Object.keys(params).length > 0 ? params : null,\n    });\n\n    // Keep only last 100 slow queries\n    if (this.metrics.slowQueries.length > 100) {\n      this.metrics.slowQueries.shift();\n    }\n\n    logger.warn(`⚠️  Slow query detected: ${route} (${duration}ms)`);\n  }\n\n  /**\n   * Get performance summary\n   */\n  getSummary() {\n    const routes = Object.entries(this.metrics.requests).map(([route, data]) => ({\n      route,\n      requests: data.count,\n      avgTime: Math.round(data.totalTime / data.count),\n      minTime: data.minTime,\n      maxTime: data.maxTime,\n      errorRate: `${((data.errors / data.count) * 100).toFixed(2)}%`,\n      statusCodes: data.statusCodes,\n    }));\n\n    const uptime = (Date.now() - this.metrics.startTime) / 1000;\n\n    return {\n      summary: {\n        totalRequests: this.metrics.throughput,\n        throughput: `${(this.metrics.throughput / uptime).toFixed(2)} req/s`,\n        slowQueries: this.metrics.slowQueries.length,\n        uptime: `${Math.floor(uptime)}s`,\n      },\n      topRoutes: routes.sort((a, b) => b.requests - a.requests).slice(0, 10),\n      slowestRoutes: routes.sort((a, b) => b.avgTime - a.avgTime).slice(0, 10),\n      recentSlowQueries: this.metrics.slowQueries.slice(-5),\n    };\n  }\n\n  /**\n   * Reset metrics\n   */\n  reset() {\n    this.metrics = {\n      requests: {},\n      slowQueries: [],\n      errors: [],\n      throughput: 0,\n      startTime: Date.now(),\n    };\n  }\n}\n\nmodule.exports = new PerformanceMonitor();\n"],"mappings":"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","ignoreList":[]}