{"version":3,"names":["fs","require","path","ApiError","logsDir","join","__dirname","existsSync","mkdirSync","recursive","errorLogFile","logErrorToFile","error","req","timestamp","Date","toISOString","logEntry","method","url","originalUrl","ip","connection","remoteAddress","statusCode","message","stack","process","env","NODE_ENV","undefined","userAgent","get","userId","user","_id","logMessage","appendFileSync","analyticsFile","existingErrors","JSON","parse","readFileSync","push","recentErrors","slice","writeFileSync","stringify","formatErrorResponse","isDevelopment","errors","name","Object","values","map","e","code","field","keys","keyPattern","response","success","Array","isArray","module","exports","err","res","next","Error","String","console","fileError","set","now","Math","random","toString","substr","status","json"],"sources":["errorHandler.js"],"sourcesContent":["/**\r\n * =====================================================\r\n * ADVANCED ERROR HANDLER MIDDLEWARE - Phase 6\r\n * =====================================================\r\n * Global error handling with comprehensive logging\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst { ApiError } = require('../utils/apiResponse');\r\n\r\n// Ensure logs directory exists\r\nconst logsDir = path.join(__dirname, '../logs');\r\nif (!fs.existsSync(logsDir)) {\r\n  fs.mkdirSync(logsDir, { recursive: true });\r\n}\r\n\r\n// Log file path\r\nconst errorLogFile = path.join(logsDir, 'errors.log');\r\n\r\n/**\r\n * Log error to file\r\n */\r\nconst logErrorToFile = (error, req) => {\r\n  const timestamp = new Date().toISOString();\r\n  const logEntry = {\r\n    timestamp,\r\n    method: req.method,\r\n    url: req.originalUrl,\r\n    ip: req.ip || req.connection.remoteAddress,\r\n    statusCode: error.statusCode || 500,\r\n    message: error.message,\r\n    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,\r\n    userAgent: req.get('user-agent'),\r\n    userId: req.user?._id || 'anonymous',\r\n  };\r\n\r\n  const logMessage = `${timestamp} [${error.statusCode || 500}] ${req.method} ${req.originalUrl} - ${error.message}\\n`;\r\n\r\n  fs.appendFileSync(errorLogFile, logMessage);\r\n\r\n  // Also write JSON for analysis\r\n  const analyticsFile = path.join(logsDir, 'errors.json');\r\n  const existingErrors = fs.existsSync(analyticsFile)\r\n    ? JSON.parse(fs.readFileSync(analyticsFile, 'utf8'))\r\n    : [];\r\n  existingErrors.push(logEntry);\r\n  // Keep only last 1000 errors\r\n  const recentErrors = existingErrors.slice(-1000);\r\n  fs.writeFileSync(analyticsFile, JSON.stringify(recentErrors, null, 2));\r\n};\r\n\r\n/**\r\n * Format error response\r\n */\r\nconst formatErrorResponse = (error, req, isDevelopment = false) => {\r\n  let statusCode = error.statusCode || 500;\r\n  let message = error.message || 'Internal Server Error';\r\n  let errors = error.errors || [];\r\n\r\n  // Handle different error types\r\n  if (error.name === 'ValidationError') {\r\n    statusCode = 400;\r\n    errors = Object.values(error.errors || {})\r\n      .map((e) => e.message)\r\n      .join(', ');\r\n    message = 'Validation Error';\r\n  }\r\n\r\n  if (error.code === 11000) {\r\n    statusCode = 409;\r\n    const field = Object.keys(error.keyPattern)[0];\r\n    message = `Duplicate value for field: ${field}`;\r\n    errors = [`${field} already exists`];\r\n  }\r\n\r\n  if (error.name === 'CastError') {\r\n    statusCode = 400;\r\n    message = 'Invalid ID format';\r\n    errors = ['The provided ID is not valid'];\r\n  }\r\n\r\n  if (error.name === 'JsonWebTokenError') {\r\n    statusCode = 401;\r\n    message = 'Invalid token';\r\n    errors = ['Your authentication token is invalid or expired'];\r\n  }\r\n\r\n  if (error.name === 'TokenExpiredError') {\r\n    statusCode = 401;\r\n    message = 'Token expired';\r\n    errors = ['Your authentication token has expired. Please login again'];\r\n  }\r\n\r\n  let response = {\r\n    success: false,\r\n    statusCode,\r\n    message,\r\n    error: message,\r\n    timestamp: new Date().toISOString(),\r\n  };\r\n\r\n  // Add detailed errors in development\r\n  if (isDevelopment) {\r\n    response.errors = Array.isArray(errors) ? errors : [errors];\r\n    response.path = req.originalUrl;\r\n    response.stack = error.stack;\r\n  } else {\r\n    // In production, only include specific error field if exists\r\n    if (error.errors) {\r\n      response.errors = Array.isArray(errors) ? errors : [errors];\r\n    }\r\n  }\r\n\r\n  return response;\r\n};\r\n\r\n/**\r\n * Global error handler middleware\r\n */\r\nmodule.exports = (err, req, res, next) => {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n\r\n  // Ensure error is an Error instance\r\n  if (!(err instanceof Error)) {\r\n    err = new Error(String(err));\r\n  }\r\n\r\n  // Log error\r\n  console.error(`\\n‚ùå ERROR: ${err.message}`);\r\n  console.error(`üìç Route: ${req.method} ${req.originalUrl}`);\r\n  console.error(`üë§ User: ${req.user?._id || 'anonymous'}`);\r\n  console.error(`üîó IP: ${req.ip || req.connection.remoteAddress}`);\r\n\r\n  if (isDevelopment) {\r\n    console.error(`\\n${err.stack}`);\r\n  }\r\n\r\n  // Log to file\r\n  try {\r\n    logErrorToFile(err, req);\r\n  } catch (fileError) {\r\n    console.error('Failed to log error to file:', fileError);\r\n  }\r\n\r\n  // Format and send response\r\n  const response = formatErrorResponse(err, req, isDevelopment);\r\n\r\n  // Set response headers\r\n  res.set('X-Error-Id', `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);\r\n  res.set('X-Error-Timestamp', new Date().toISOString());\r\n\r\n  // Send response\r\n  res.status(response.statusCode).json(response);\r\n};\r\n\r\n/**\r\n * Export ApiError for throwing custom errors\r\n */\r\nmodule.exports.ApiError = ApiError;\r\n"],"mappings":"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","ignoreList":[]}