e507816b452faf2b4265ba0d1ca79cd7
/**
 * Performance Optimizer Utility
 * Implements caching, compression, and response optimization strategies
 * 
 * Features:
 * - Gzip response compression
 * - Cache-Control headers optimization
 * - Request result caching (in-memory)
 * - Response size optimization
 * - Performance metrics tracking
 */

const compression = require('compression');

// ==================== CONFIGURATION ====================
const CACHE_CONFIG = {
  // Cache duration by route pattern (in seconds)
  durations: {
    '/health': 5,
    '/api/health': 10,
    '/api/analytics': 30,
    '/api/reports': 60,
    '/api/dashboard': 30,
    '/api/notifications': 0,
    // No cache - real-time data
    '/api/users': 0 // No cache - user-specific data
  },
  // Maximum cache size in MB
  maxSize: 50,
  // Enable/disable compression
  compression: true,
  // Compression options
  compressionOptions: {
    level: 6,
    // 0-9, default 6
    threshold: 1024 // Only compress responses > 1KB
  }
};

// ==================== IN-MEMORY CACHE ====================
class ResponseCache {
  constructor(maxSizeMB = 50) {
    this.cache = new Map();
    this.maxSize = maxSizeMB * 1024 * 1024;
    this.currentSize = 0;
    this.hits = 0;
    this.misses = 0;
  }

  /**
   * Generate cache key from request
   */
  generateKey(req) {
    const method = req.method || 'GET';
    const path = req.originalUrl || req.url;
    return `${method}:${path}`;
  }

  /**
   * Get cached response
   */
  get(key) {
    if (!this.cache.has(key)) {
      this.misses++;
      return null;
    }
    const entry = this.cache.get(key);

    // Check if expired
    if (entry.expiresAt && Date.now() > entry.expiresAt) {
      this.cache.delete(key);
      this.currentSize -= entry.size;
      this.misses++;
      return null;
    }
    this.hits++;
    return entry.data;
  }

  /**
   * Set cached response
   */
  set(key, data, durationSeconds = 60) {
    // Calculate size of data
    const size = JSON.stringify(data).length;

    // Evict old entries if needed
    if (this.currentSize + size > this.maxSize) {
      this.evict();
    }
    const entry = {
      data: data,
      size: size,
      createdAt: Date.now(),
      expiresAt: durationSeconds > 0 ? Date.now() + durationSeconds * 1000 : null
    };
    this.cache.set(key, entry);
    this.currentSize += size;
  }

  /**
   * Evict old entries using LRU (Least Recently Used)
   */
  evict() {
    const entriesToRemove = Math.ceil(this.cache.size * 0.2); // Remove 20% of old entries
    let removed = 0;

    // Sort by creation time (oldest first)
    const sorted = Array.from(this.cache.entries()).sort((a, b) => a[1].createdAt - b[1].createdAt);
    for (let i = 0; i < entriesToRemove && i < sorted.length; i++) {
      const [key, entry] = sorted[i];
      this.cache.delete(key);
      this.currentSize -= entry.size;
      removed++;
    }
    console.log(`ðŸ“¦ Cache evicted ${removed} old entries (freed ${Math.round(removed * 1024 / 1024)}MB)`);
  }

  /**
   * Clear entire cache
   */
  clear() {
    this.cache.clear();
    this.currentSize = 0;
  }

  /**
   * Get cache statistics
   */
  getStats() {
    const hitRate = this.hits / (this.hits + this.misses) * 100 || 0;
    return {
      entries: this.cache.size,
      size: `${(this.currentSize / 1024 / 1024).toFixed(2)} MB`,
      maxSize: `${CACHE_CONFIG.maxSize} MB`,
      hits: this.hits,
      misses: this.misses,
      hitRate: `${hitRate.toFixed(2)}%`
    };
  }
}

// ==================== CACHE INSTANCE ====================
const cache = new ResponseCache(CACHE_CONFIG.maxSize);

// ==================== MIDDLEWARE ====================

/**
 * Add compression middleware
 */
const compressionMiddleware = () => {
  if (!CACHE_CONFIG.compression) {
    return (req, res, next) => next();
  }
  return compression(CACHE_CONFIG.compressionOptions);
};

/**
 * Cache control headers middleware
 */
const cacheControlMiddleware = (req, res, next) => {
  // Determine cache duration based on route
  let cacheDuration = 0;
  for (const [pattern, duration] of Object.entries(CACHE_CONFIG.durations)) {
    if (req.path.startsWith(pattern)) {
      cacheDuration = duration;
      break;
    }
  }

  // Set cache headers
  if (cacheDuration > 0) {
    res.set('Cache-Control', `public, max-age=${cacheDuration}`);
    res.set('X-Cache-Duration', `${cacheDuration}s`);
  } else {
    res.set('Cache-Control', 'no-cache, no-store, must-revalidate');
    res.set('Pragma', 'no-cache');
    res.set('Expires', '0');
  }

  // Wrap res.json if it exists
  if (res.json) {
    const originalJson = res.json.bind(res);
    res.json = function (data) {
      const size = JSON.stringify(data).length;
      res.set('X-Response-Size', `${size}B`);
      res.set('X-Cache-Duration', `${cacheDuration}s`);
      return originalJson(data);
    };
  }

  // Wrap res.send if it exists
  if (res.send) {
    const originalSend = res.send.bind(res);
    res.send = function (data) {
      if (typeof data === 'object') {
        const size = JSON.stringify(data).length;
        res.set('X-Response-Size', `${size}B`);
      }
      return originalSend(data);
    };
  }
  next();
};

/**
 * Request response caching middleware
 */
const responseCachingMiddleware = (req, res, next) => {
  // Only cache GET requests
  if (req.method !== 'GET') {
    return next();
  }
  const cacheKey = cache.generateKey(req);

  // Check if response is cached
  const cachedResponse = cache.get(cacheKey);
  if (cachedResponse) {
    res.set('X-Cache', 'HIT');
    return res.json(cachedResponse);
  }

  // Intercept res.json to cache response
  const originalJson = res.json.bind(res);
  res.json = function (data) {
    // Determine cache duration
    let cacheDuration = 0;
    for (const [pattern, duration] of Object.entries(CACHE_CONFIG.durations)) {
      if (req.path.startsWith(pattern)) {
        cacheDuration = duration;
        break;
      }
    }

    // Cache the response
    if (cacheDuration > 0 && data) {
      cache.set(cacheKey, data, cacheDuration);
      res.set('X-Cache', 'MISS');
      res.set('X-Cache-Duration', `${cacheDuration}s`);
    }
    return originalJson(data);
  };
  next();
};

/**
 * Monitoring middleware - tracks response performance
 */
const performanceMonitoringMiddleware = (req, res, next) => {
  const startTime = Date.now();
  const originalJson = res.json.bind(res);
  res.json = function (data) {
    const duration = Date.now() - startTime;

    // Add performance headers
    res.set('X-Response-Time', `${duration}ms`);

    // Log slow requests
    if (duration > 1000) {
      console.warn(`âš ï¸  Slow request: ${req.method} ${req.path} took ${duration}ms`);
    }
    return originalJson(data);
  };
  next();
};

// ==================== CACHE MANAGEMENT ===================

/**
 * Clear cache for specific route or all routes
 */
const clearCache = (path = null) => {
  if (!path) {
    cache.clear();
    console.log('ðŸ§¹ Cache cleared completely');
    return;
  }

  // Clear cache entries matching path
  let cleared = 0;
  for (const [key, entry] of cache.cache.entries()) {
    if (key.includes(path)) {
      cache.cache.delete(key);
      cache.currentSize -= entry.size;
      cleared++;
    }
  }
  console.log(`ðŸ§¹ Cleared ${cleared} cache entries for path: ${path}`);
};

/**
 * Get cache statistics
 */
const getCacheStats = () => cache.getStats();

// ==================== OPTIMIZATION SETUP ====================

/**
 * Initialize all performance optimizations
 */
function initializePerformanceOptimizations(app) {
  // Add compression
  app.use(compressionMiddleware());

  // Add cache control headers
  app.use(cacheControlMiddleware);

  // Add response caching
  app.use(responseCachingMiddleware);

  // Add performance monitoring
  app.use(performanceMonitoringMiddleware);
  console.log('âœ… Performance optimizations initialized');
  console.log('   - Compression: Enabled');
  console.log('   - Response caching: Enabled');
  console.log('   - Cache-Control headers: Enabled');
  console.log('   - Performance monitoring: Enabled');
  console.log('   - Management endpoints: Register manually in app.js (/api/cache-stats, /api/cache/clear)');
}

// ==================== EXPORTS ====================

module.exports = {
  compression: compressionMiddleware,
  cacheControl: cacheControlMiddleware,
  responseCache: responseCachingMiddleware,
  performanceMonitoring: performanceMonitoringMiddleware,
  initializePerformanceOptimizations,
  clearCache,
  getCacheStats,
  ResponseCache,
  CACHE_CONFIG
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21wcmVzc2lvbiIsInJlcXVpcmUiLCJDQUNIRV9DT05GSUciLCJkdXJhdGlvbnMiLCJtYXhTaXplIiwiY29tcHJlc3Npb25PcHRpb25zIiwibGV2ZWwiLCJ0aHJlc2hvbGQiLCJSZXNwb25zZUNhY2hlIiwiY29uc3RydWN0b3IiLCJtYXhTaXplTUIiLCJjYWNoZSIsIk1hcCIsImN1cnJlbnRTaXplIiwiaGl0cyIsIm1pc3NlcyIsImdlbmVyYXRlS2V5IiwicmVxIiwibWV0aG9kIiwicGF0aCIsIm9yaWdpbmFsVXJsIiwidXJsIiwiZ2V0Iiwia2V5IiwiaGFzIiwiZW50cnkiLCJleHBpcmVzQXQiLCJEYXRlIiwibm93IiwiZGVsZXRlIiwic2l6ZSIsImRhdGEiLCJzZXQiLCJkdXJhdGlvblNlY29uZHMiLCJKU09OIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwiZXZpY3QiLCJjcmVhdGVkQXQiLCJlbnRyaWVzVG9SZW1vdmUiLCJNYXRoIiwiY2VpbCIsInJlbW92ZWQiLCJzb3J0ZWQiLCJBcnJheSIsImZyb20iLCJlbnRyaWVzIiwic29ydCIsImEiLCJiIiwiaSIsImNvbnNvbGUiLCJsb2ciLCJyb3VuZCIsImNsZWFyIiwiZ2V0U3RhdHMiLCJoaXRSYXRlIiwidG9GaXhlZCIsImNvbXByZXNzaW9uTWlkZGxld2FyZSIsInJlcyIsIm5leHQiLCJjYWNoZUNvbnRyb2xNaWRkbGV3YXJlIiwiY2FjaGVEdXJhdGlvbiIsInBhdHRlcm4iLCJkdXJhdGlvbiIsIk9iamVjdCIsInN0YXJ0c1dpdGgiLCJqc29uIiwib3JpZ2luYWxKc29uIiwiYmluZCIsInNlbmQiLCJvcmlnaW5hbFNlbmQiLCJyZXNwb25zZUNhY2hpbmdNaWRkbGV3YXJlIiwiY2FjaGVLZXkiLCJjYWNoZWRSZXNwb25zZSIsInBlcmZvcm1hbmNlTW9uaXRvcmluZ01pZGRsZXdhcmUiLCJzdGFydFRpbWUiLCJ3YXJuIiwiY2xlYXJDYWNoZSIsImNsZWFyZWQiLCJpbmNsdWRlcyIsImdldENhY2hlU3RhdHMiLCJpbml0aWFsaXplUGVyZm9ybWFuY2VPcHRpbWl6YXRpb25zIiwiYXBwIiwidXNlIiwibW9kdWxlIiwiZXhwb3J0cyIsImNhY2hlQ29udHJvbCIsInJlc3BvbnNlQ2FjaGUiLCJwZXJmb3JtYW5jZU1vbml0b3JpbmciXSwic291cmNlcyI6WyJwZXJmb3JtYW5jZS1vcHRpbWl6ZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFBlcmZvcm1hbmNlIE9wdGltaXplciBVdGlsaXR5XHJcbiAqIEltcGxlbWVudHMgY2FjaGluZywgY29tcHJlc3Npb24sIGFuZCByZXNwb25zZSBvcHRpbWl6YXRpb24gc3RyYXRlZ2llc1xyXG4gKiBcclxuICogRmVhdHVyZXM6XHJcbiAqIC0gR3ppcCByZXNwb25zZSBjb21wcmVzc2lvblxyXG4gKiAtIENhY2hlLUNvbnRyb2wgaGVhZGVycyBvcHRpbWl6YXRpb25cclxuICogLSBSZXF1ZXN0IHJlc3VsdCBjYWNoaW5nIChpbi1tZW1vcnkpXHJcbiAqIC0gUmVzcG9uc2Ugc2l6ZSBvcHRpbWl6YXRpb25cclxuICogLSBQZXJmb3JtYW5jZSBtZXRyaWNzIHRyYWNraW5nXHJcbiAqL1xyXG5cclxuY29uc3QgY29tcHJlc3Npb24gPSByZXF1aXJlKCdjb21wcmVzc2lvbicpO1xyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gQ09ORklHVVJBVElPTiA9PT09PT09PT09PT09PT09PT09PVxyXG5jb25zdCBDQUNIRV9DT05GSUcgPSB7XHJcbiAgLy8gQ2FjaGUgZHVyYXRpb24gYnkgcm91dGUgcGF0dGVybiAoaW4gc2Vjb25kcylcclxuICBkdXJhdGlvbnM6IHtcclxuICAgICcvaGVhbHRoJzogNSxcclxuICAgICcvYXBpL2hlYWx0aCc6IDEwLFxyXG4gICAgJy9hcGkvYW5hbHl0aWNzJzogMzAsXHJcbiAgICAnL2FwaS9yZXBvcnRzJzogNjAsXHJcbiAgICAnL2FwaS9kYXNoYm9hcmQnOiAzMCxcclxuICAgICcvYXBpL25vdGlmaWNhdGlvbnMnOiAwLCAvLyBObyBjYWNoZSAtIHJlYWwtdGltZSBkYXRhXHJcbiAgICAnL2FwaS91c2Vycyc6IDAsIC8vIE5vIGNhY2hlIC0gdXNlci1zcGVjaWZpYyBkYXRhXHJcbiAgfSxcclxuICBcclxuICAvLyBNYXhpbXVtIGNhY2hlIHNpemUgaW4gTUJcclxuICBtYXhTaXplOiA1MCxcclxuICBcclxuICAvLyBFbmFibGUvZGlzYWJsZSBjb21wcmVzc2lvblxyXG4gIGNvbXByZXNzaW9uOiB0cnVlLFxyXG4gIFxyXG4gIC8vIENvbXByZXNzaW9uIG9wdGlvbnNcclxuICBjb21wcmVzc2lvbk9wdGlvbnM6IHtcclxuICAgIGxldmVsOiA2LCAvLyAwLTksIGRlZmF1bHQgNlxyXG4gICAgdGhyZXNob2xkOiAxMDI0LCAvLyBPbmx5IGNvbXByZXNzIHJlc3BvbnNlcyA+IDFLQlxyXG4gIH0sXHJcbn07XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PSBJTi1NRU1PUlkgQ0FDSEUgPT09PT09PT09PT09PT09PT09PT1cclxuY2xhc3MgUmVzcG9uc2VDYWNoZSB7XHJcbiAgY29uc3RydWN0b3IobWF4U2l6ZU1CID0gNTApIHtcclxuICAgIHRoaXMuY2FjaGUgPSBuZXcgTWFwKCk7XHJcbiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplTUIgKiAxMDI0ICogMTAyNDtcclxuICAgIHRoaXMuY3VycmVudFNpemUgPSAwO1xyXG4gICAgdGhpcy5oaXRzID0gMDtcclxuICAgIHRoaXMubWlzc2VzID0gMDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdlbmVyYXRlIGNhY2hlIGtleSBmcm9tIHJlcXVlc3RcclxuICAgKi9cclxuICBnZW5lcmF0ZUtleShyZXEpIHtcclxuICAgIGNvbnN0IG1ldGhvZCA9IHJlcS5tZXRob2QgfHwgJ0dFVCc7XHJcbiAgICBjb25zdCBwYXRoID0gcmVxLm9yaWdpbmFsVXJsIHx8IHJlcS51cmw7XHJcbiAgICByZXR1cm4gYCR7bWV0aG9kfToke3BhdGh9YDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBjYWNoZWQgcmVzcG9uc2VcclxuICAgKi9cclxuICBnZXQoa2V5KSB7XHJcbiAgICBpZiAoIXRoaXMuY2FjaGUuaGFzKGtleSkpIHtcclxuICAgICAgdGhpcy5taXNzZXMrKztcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xyXG4gICAgXHJcbiAgICAvLyBDaGVjayBpZiBleHBpcmVkXHJcbiAgICBpZiAoZW50cnkuZXhwaXJlc0F0ICYmIERhdGUubm93KCkgPiBlbnRyeS5leHBpcmVzQXQpIHtcclxuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcclxuICAgICAgdGhpcy5jdXJyZW50U2l6ZSAtPSBlbnRyeS5zaXplO1xyXG4gICAgICB0aGlzLm1pc3NlcysrO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmhpdHMrKztcclxuICAgIHJldHVybiBlbnRyeS5kYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IGNhY2hlZCByZXNwb25zZVxyXG4gICAqL1xyXG4gIHNldChrZXksIGRhdGEsIGR1cmF0aW9uU2Vjb25kcyA9IDYwKSB7XHJcbiAgICAvLyBDYWxjdWxhdGUgc2l6ZSBvZiBkYXRhXHJcbiAgICBjb25zdCBzaXplID0gSlNPTi5zdHJpbmdpZnkoZGF0YSkubGVuZ3RoO1xyXG5cclxuICAgIC8vIEV2aWN0IG9sZCBlbnRyaWVzIGlmIG5lZWRlZFxyXG4gICAgaWYgKHRoaXMuY3VycmVudFNpemUgKyBzaXplID4gdGhpcy5tYXhTaXplKSB7XHJcbiAgICAgIHRoaXMuZXZpY3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBlbnRyeSA9IHtcclxuICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgc2l6ZTogc2l6ZSxcclxuICAgICAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLFxyXG4gICAgICBleHBpcmVzQXQ6IGR1cmF0aW9uU2Vjb25kcyA+IDAgPyBEYXRlLm5vdygpICsgKGR1cmF0aW9uU2Vjb25kcyAqIDEwMDApIDogbnVsbCxcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5jYWNoZS5zZXQoa2V5LCBlbnRyeSk7XHJcbiAgICB0aGlzLmN1cnJlbnRTaXplICs9IHNpemU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBFdmljdCBvbGQgZW50cmllcyB1c2luZyBMUlUgKExlYXN0IFJlY2VudGx5IFVzZWQpXHJcbiAgICovXHJcbiAgZXZpY3QoKSB7XHJcbiAgICBjb25zdCBlbnRyaWVzVG9SZW1vdmUgPSBNYXRoLmNlaWwodGhpcy5jYWNoZS5zaXplICogMC4yKTsgLy8gUmVtb3ZlIDIwJSBvZiBvbGQgZW50cmllc1xyXG4gICAgbGV0IHJlbW92ZWQgPSAwO1xyXG5cclxuICAgIC8vIFNvcnQgYnkgY3JlYXRpb24gdGltZSAob2xkZXN0IGZpcnN0KVxyXG4gICAgY29uc3Qgc29ydGVkID0gQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmVudHJpZXMoKSlcclxuICAgICAgLnNvcnQoKGEsIGIpID0+IGFbMV0uY3JlYXRlZEF0IC0gYlsxXS5jcmVhdGVkQXQpO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZW50cmllc1RvUmVtb3ZlICYmIGkgPCBzb3J0ZWQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgY29uc3QgW2tleSwgZW50cnldID0gc29ydGVkW2ldO1xyXG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xyXG4gICAgICB0aGlzLmN1cnJlbnRTaXplIC09IGVudHJ5LnNpemU7XHJcbiAgICAgIHJlbW92ZWQrKztcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhg8J+TpiBDYWNoZSBldmljdGVkICR7cmVtb3ZlZH0gb2xkIGVudHJpZXMgKGZyZWVkICR7TWF0aC5yb3VuZChyZW1vdmVkICogMTAyNCAvIDEwMjQpfU1CKWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgZW50aXJlIGNhY2hlXHJcbiAgICovXHJcbiAgY2xlYXIoKSB7XHJcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XHJcbiAgICB0aGlzLmN1cnJlbnRTaXplID0gMDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBjYWNoZSBzdGF0aXN0aWNzXHJcbiAgICovXHJcbiAgZ2V0U3RhdHMoKSB7XHJcbiAgICBjb25zdCBoaXRSYXRlID0gKHRoaXMuaGl0cyAvICh0aGlzLmhpdHMgKyB0aGlzLm1pc3NlcykpICogMTAwIHx8IDA7XHJcbiAgICBcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGVudHJpZXM6IHRoaXMuY2FjaGUuc2l6ZSxcclxuICAgICAgc2l6ZTogYCR7KHRoaXMuY3VycmVudFNpemUgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX0gTUJgLFxyXG4gICAgICBtYXhTaXplOiBgJHtDQUNIRV9DT05GSUcubWF4U2l6ZX0gTUJgLFxyXG4gICAgICBoaXRzOiB0aGlzLmhpdHMsXHJcbiAgICAgIG1pc3NlczogdGhpcy5taXNzZXMsXHJcbiAgICAgIGhpdFJhdGU6IGAke2hpdFJhdGUudG9GaXhlZCgyKX0lYCxcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PSBDQUNIRSBJTlNUQU5DRSA9PT09PT09PT09PT09PT09PT09PVxyXG5jb25zdCBjYWNoZSA9IG5ldyBSZXNwb25zZUNhY2hlKENBQ0hFX0NPTkZJRy5tYXhTaXplKTtcclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09IE1JRERMRVdBUkUgPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbi8qKlxyXG4gKiBBZGQgY29tcHJlc3Npb24gbWlkZGxld2FyZVxyXG4gKi9cclxuY29uc3QgY29tcHJlc3Npb25NaWRkbGV3YXJlID0gKCkgPT4ge1xyXG4gIGlmICghQ0FDSEVfQ09ORklHLmNvbXByZXNzaW9uKSB7XHJcbiAgICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiBuZXh0KCk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gY29tcHJlc3Npb24oQ0FDSEVfQ09ORklHLmNvbXByZXNzaW9uT3B0aW9ucyk7XHJcbn07XHJcblxyXG4vKipcclxuICogQ2FjaGUgY29udHJvbCBoZWFkZXJzIG1pZGRsZXdhcmVcclxuICovXHJcbmNvbnN0IGNhY2hlQ29udHJvbE1pZGRsZXdhcmUgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAvLyBEZXRlcm1pbmUgY2FjaGUgZHVyYXRpb24gYmFzZWQgb24gcm91dGVcclxuICBsZXQgY2FjaGVEdXJhdGlvbiA9IDA7XHJcbiAgZm9yIChjb25zdCBbcGF0dGVybiwgZHVyYXRpb25dIG9mIE9iamVjdC5lbnRyaWVzKENBQ0hFX0NPTkZJRy5kdXJhdGlvbnMpKSB7XHJcbiAgICBpZiAocmVxLnBhdGguc3RhcnRzV2l0aChwYXR0ZXJuKSkge1xyXG4gICAgICBjYWNoZUR1cmF0aW9uID0gZHVyYXRpb247XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gU2V0IGNhY2hlIGhlYWRlcnNcclxuICBpZiAoY2FjaGVEdXJhdGlvbiA+IDApIHtcclxuICAgIHJlcy5zZXQoJ0NhY2hlLUNvbnRyb2wnLCBgcHVibGljLCBtYXgtYWdlPSR7Y2FjaGVEdXJhdGlvbn1gKTtcclxuICAgIHJlcy5zZXQoJ1gtQ2FjaGUtRHVyYXRpb24nLCBgJHtjYWNoZUR1cmF0aW9ufXNgKTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmVzLnNldCgnQ2FjaGUtQ29udHJvbCcsICduby1jYWNoZSwgbm8tc3RvcmUsIG11c3QtcmV2YWxpZGF0ZScpO1xyXG4gICAgcmVzLnNldCgnUHJhZ21hJywgJ25vLWNhY2hlJyk7XHJcbiAgICByZXMuc2V0KCdFeHBpcmVzJywgJzAnKTtcclxuICB9XHJcblxyXG4gIC8vIFdyYXAgcmVzLmpzb24gaWYgaXQgZXhpc3RzXHJcbiAgaWYgKHJlcy5qc29uKSB7XHJcbiAgICBjb25zdCBvcmlnaW5hbEpzb24gPSByZXMuanNvbi5iaW5kKHJlcyk7XHJcbiAgICByZXMuanNvbiA9IGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgY29uc3Qgc2l6ZSA9IEpTT04uc3RyaW5naWZ5KGRhdGEpLmxlbmd0aDtcclxuICAgICAgcmVzLnNldCgnWC1SZXNwb25zZS1TaXplJywgYCR7c2l6ZX1CYCk7XHJcbiAgICAgIHJlcy5zZXQoJ1gtQ2FjaGUtRHVyYXRpb24nLCBgJHtjYWNoZUR1cmF0aW9ufXNgKTtcclxuICAgICAgcmV0dXJuIG9yaWdpbmFsSnNvbihkYXRhKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBXcmFwIHJlcy5zZW5kIGlmIGl0IGV4aXN0c1xyXG4gIGlmIChyZXMuc2VuZCkge1xyXG4gICAgY29uc3Qgb3JpZ2luYWxTZW5kID0gcmVzLnNlbmQuYmluZChyZXMpO1xyXG4gICAgcmVzLnNlbmQgPSBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICBjb25zdCBzaXplID0gSlNPTi5zdHJpbmdpZnkoZGF0YSkubGVuZ3RoO1xyXG4gICAgICAgIHJlcy5zZXQoJ1gtUmVzcG9uc2UtU2l6ZScsIGAke3NpemV9QmApO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBvcmlnaW5hbFNlbmQoZGF0YSk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgbmV4dCgpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFJlcXVlc3QgcmVzcG9uc2UgY2FjaGluZyBtaWRkbGV3YXJlXHJcbiAqL1xyXG5jb25zdCByZXNwb25zZUNhY2hpbmdNaWRkbGV3YXJlID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgLy8gT25seSBjYWNoZSBHRVQgcmVxdWVzdHNcclxuICBpZiAocmVxLm1ldGhvZCAhPT0gJ0dFVCcpIHtcclxuICAgIHJldHVybiBuZXh0KCk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBjYWNoZUtleSA9IGNhY2hlLmdlbmVyYXRlS2V5KHJlcSk7XHJcbiAgXHJcbiAgLy8gQ2hlY2sgaWYgcmVzcG9uc2UgaXMgY2FjaGVkXHJcbiAgY29uc3QgY2FjaGVkUmVzcG9uc2UgPSBjYWNoZS5nZXQoY2FjaGVLZXkpO1xyXG4gIGlmIChjYWNoZWRSZXNwb25zZSkge1xyXG4gICAgcmVzLnNldCgnWC1DYWNoZScsICdISVQnKTtcclxuICAgIHJldHVybiByZXMuanNvbihjYWNoZWRSZXNwb25zZSk7XHJcbiAgfVxyXG5cclxuICAvLyBJbnRlcmNlcHQgcmVzLmpzb24gdG8gY2FjaGUgcmVzcG9uc2VcclxuICBjb25zdCBvcmlnaW5hbEpzb24gPSByZXMuanNvbi5iaW5kKHJlcyk7XHJcbiAgXHJcbiAgcmVzLmpzb24gPSBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAvLyBEZXRlcm1pbmUgY2FjaGUgZHVyYXRpb25cclxuICAgIGxldCBjYWNoZUR1cmF0aW9uID0gMDtcclxuICAgIGZvciAoY29uc3QgW3BhdHRlcm4sIGR1cmF0aW9uXSBvZiBPYmplY3QuZW50cmllcyhDQUNIRV9DT05GSUcuZHVyYXRpb25zKSkge1xyXG4gICAgICBpZiAocmVxLnBhdGguc3RhcnRzV2l0aChwYXR0ZXJuKSkge1xyXG4gICAgICAgIGNhY2hlRHVyYXRpb24gPSBkdXJhdGlvbjtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIENhY2hlIHRoZSByZXNwb25zZVxyXG4gICAgaWYgKGNhY2hlRHVyYXRpb24gPiAwICYmIGRhdGEpIHtcclxuICAgICAgY2FjaGUuc2V0KGNhY2hlS2V5LCBkYXRhLCBjYWNoZUR1cmF0aW9uKTtcclxuICAgICAgcmVzLnNldCgnWC1DYWNoZScsICdNSVNTJyk7XHJcbiAgICAgIHJlcy5zZXQoJ1gtQ2FjaGUtRHVyYXRpb24nLCBgJHtjYWNoZUR1cmF0aW9ufXNgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gb3JpZ2luYWxKc29uKGRhdGEpO1xyXG4gIH07XHJcblxyXG4gIG5leHQoKTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBNb25pdG9yaW5nIG1pZGRsZXdhcmUgLSB0cmFja3MgcmVzcG9uc2UgcGVyZm9ybWFuY2VcclxuICovXHJcbmNvbnN0IHBlcmZvcm1hbmNlTW9uaXRvcmluZ01pZGRsZXdhcmUgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gIGNvbnN0IG9yaWdpbmFsSnNvbiA9IHJlcy5qc29uLmJpbmQocmVzKTtcclxuXHJcbiAgcmVzLmpzb24gPSBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcbiAgICBcclxuICAgIC8vIEFkZCBwZXJmb3JtYW5jZSBoZWFkZXJzXHJcbiAgICByZXMuc2V0KCdYLVJlc3BvbnNlLVRpbWUnLCBgJHtkdXJhdGlvbn1tc2ApO1xyXG4gICAgXHJcbiAgICAvLyBMb2cgc2xvdyByZXF1ZXN0c1xyXG4gICAgaWYgKGR1cmF0aW9uID4gMTAwMCkge1xyXG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyAgU2xvdyByZXF1ZXN0OiAke3JlcS5tZXRob2R9ICR7cmVxLnBhdGh9IHRvb2sgJHtkdXJhdGlvbn1tc2ApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBvcmlnaW5hbEpzb24oZGF0YSk7XHJcbiAgfTtcclxuXHJcbiAgbmV4dCgpO1xyXG59O1xyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gQ0FDSEUgTUFOQUdFTUVOVCA9PT09PT09PT09PT09PT09PT09XHJcblxyXG4vKipcclxuICogQ2xlYXIgY2FjaGUgZm9yIHNwZWNpZmljIHJvdXRlIG9yIGFsbCByb3V0ZXNcclxuICovXHJcbmNvbnN0IGNsZWFyQ2FjaGUgPSAocGF0aCA9IG51bGwpID0+IHtcclxuICBpZiAoIXBhdGgpIHtcclxuICAgIGNhY2hlLmNsZWFyKCk7XHJcbiAgICBjb25zb2xlLmxvZygn8J+nuSBDYWNoZSBjbGVhcmVkIGNvbXBsZXRlbHknKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIC8vIENsZWFyIGNhY2hlIGVudHJpZXMgbWF0Y2hpbmcgcGF0aFxyXG4gIGxldCBjbGVhcmVkID0gMDtcclxuICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiBjYWNoZS5jYWNoZS5lbnRyaWVzKCkpIHtcclxuICAgIGlmIChrZXkuaW5jbHVkZXMocGF0aCkpIHtcclxuICAgICAgY2FjaGUuY2FjaGUuZGVsZXRlKGtleSk7XHJcbiAgICAgIGNhY2hlLmN1cnJlbnRTaXplIC09IGVudHJ5LnNpemU7XHJcbiAgICAgIGNsZWFyZWQrKztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnNvbGUubG9nKGDwn6e5IENsZWFyZWQgJHtjbGVhcmVkfSBjYWNoZSBlbnRyaWVzIGZvciBwYXRoOiAke3BhdGh9YCk7XHJcbn07XHJcblxyXG4vKipcclxuICogR2V0IGNhY2hlIHN0YXRpc3RpY3NcclxuICovXHJcbmNvbnN0IGdldENhY2hlU3RhdHMgPSAoKSA9PiBjYWNoZS5nZXRTdGF0cygpO1xyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gT1BUSU1JWkFUSU9OIFNFVFVQID09PT09PT09PT09PT09PT09PT09XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6ZSBhbGwgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uc1xyXG4gKi9cclxuZnVuY3Rpb24gaW5pdGlhbGl6ZVBlcmZvcm1hbmNlT3B0aW1pemF0aW9ucyhhcHApIHtcclxuICAvLyBBZGQgY29tcHJlc3Npb25cclxuICBhcHAudXNlKGNvbXByZXNzaW9uTWlkZGxld2FyZSgpKTtcclxuXHJcbiAgLy8gQWRkIGNhY2hlIGNvbnRyb2wgaGVhZGVyc1xyXG4gIGFwcC51c2UoY2FjaGVDb250cm9sTWlkZGxld2FyZSk7XHJcblxyXG4gIC8vIEFkZCByZXNwb25zZSBjYWNoaW5nXHJcbiAgYXBwLnVzZShyZXNwb25zZUNhY2hpbmdNaWRkbGV3YXJlKTtcclxuXHJcbiAgLy8gQWRkIHBlcmZvcm1hbmNlIG1vbml0b3JpbmdcclxuICBhcHAudXNlKHBlcmZvcm1hbmNlTW9uaXRvcmluZ01pZGRsZXdhcmUpO1xyXG5cclxuICBjb25zb2xlLmxvZygn4pyFIFBlcmZvcm1hbmNlIG9wdGltaXphdGlvbnMgaW5pdGlhbGl6ZWQnKTtcclxuICBjb25zb2xlLmxvZygnICAgLSBDb21wcmVzc2lvbjogRW5hYmxlZCcpO1xyXG4gIGNvbnNvbGUubG9nKCcgICAtIFJlc3BvbnNlIGNhY2hpbmc6IEVuYWJsZWQnKTtcclxuICBjb25zb2xlLmxvZygnICAgLSBDYWNoZS1Db250cm9sIGhlYWRlcnM6IEVuYWJsZWQnKTtcclxuICBjb25zb2xlLmxvZygnICAgLSBQZXJmb3JtYW5jZSBtb25pdG9yaW5nOiBFbmFibGVkJyk7XHJcbiAgY29uc29sZS5sb2coJyAgIC0gTWFuYWdlbWVudCBlbmRwb2ludHM6IFJlZ2lzdGVyIG1hbnVhbGx5IGluIGFwcC5qcyAoL2FwaS9jYWNoZS1zdGF0cywgL2FwaS9jYWNoZS9jbGVhciknKTtcclxufVxyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gRVhQT1JUUyA9PT09PT09PT09PT09PT09PT09PVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgY29tcHJlc3Npb246IGNvbXByZXNzaW9uTWlkZGxld2FyZSxcclxuICBjYWNoZUNvbnRyb2w6IGNhY2hlQ29udHJvbE1pZGRsZXdhcmUsXHJcbiAgcmVzcG9uc2VDYWNoZTogcmVzcG9uc2VDYWNoaW5nTWlkZGxld2FyZSxcclxuICBwZXJmb3JtYW5jZU1vbml0b3Jpbmc6IHBlcmZvcm1hbmNlTW9uaXRvcmluZ01pZGRsZXdhcmUsXHJcbiAgaW5pdGlhbGl6ZVBlcmZvcm1hbmNlT3B0aW1pemF0aW9ucyxcclxuICBjbGVhckNhY2hlLFxyXG4gIGdldENhY2hlU3RhdHMsXHJcbiAgUmVzcG9uc2VDYWNoZSxcclxuICBDQUNIRV9DT05GSUcsXHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtB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