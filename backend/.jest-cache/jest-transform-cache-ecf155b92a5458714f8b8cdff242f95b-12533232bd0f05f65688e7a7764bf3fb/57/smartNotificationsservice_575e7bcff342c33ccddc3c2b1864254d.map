{"version":3,"names":["EventEmitter","require","v4","uuidv4","SmartNotificationsService","constructor","notifications","Map","notificationQueue","userPreferences","deliveryLogs","scheduledNotifications","aiModel","priorities","patterns","engagement","createSmartNotification","notificationData","userId","title","message","type","priority","channels","metadata","scheduledFor","optimalSendTime","calculateOptimalSendTime","notification","id","determinePriority","filterChannelsForUser","createdAt","Date","status","deliveryAttempts","maxRetries","aiScore","calculateNotificationScore","sent","delivered","read","clicked","sentAt","deliveredAt","readAt","clickedAt","set","scheduleNotification","push","emit","preferences","get","now","pattern","bestHour","findPeakActivityHour","optimalTime","setHours","setDate","getDate","userPriority","typePriorities","alert","warning","reminder","info","success","finalPriority","containsCriticalKeywords","requestedChannels","filter","channel","isEnabled","score","factors","critical","high","normal","low","length","Math","min","activityHours","defaultHours","criticalKeywords","lowerMessage","toLowerCase","some","keyword","includes","delay","timeoutId","setTimeout","moveToQueue","notificationId","delete","processQueue","processed","shift","deliverNotification","error","deliveryPromises","map","deliverViaChannel","Promise","allSettled","logDelivery","deliveryMethods","in-app","deliverInApp","email","deliverEmail","sms","deliverSMS","deliverPush","slack","deliverSlack","method","resolve","reject","has","timestamp","updateUserPreferences","existing","updated","updatedAt","recordInteraction","action","actionMap","click","dismiss","dismissed","dismissedAt","handler","learnFromInteraction","totalReceived","userEngagement","engagementRate","frequency","getUserNotifications","options","limit","offset","sortBy","userNotifications","Array","from","values","n","sort","a","b","priorityMap","slice","getNotificationStats","stats","total","byStatus","byType","byPriority","forEach","readCount","deleteNotification","clearUserNotifications","count","broadcastNotification","userIds","getPerformanceReport","report","totalNotifications","deliveredRate","readRate","clickRate","averageScore","reduce","sum","channelDistribution","typeDistribution","module","exports"],"sources":["smartNotifications.service.js"],"sourcesContent":["/**\r\n * نظام الإشعارات الذكية\r\n * Smart Notifications System\r\n * \r\n * AI-powered notification management with:\r\n * - Intelligent scheduling\r\n * - ML-based prioritization\r\n * - User preference learning\r\n * - Multi-channel delivery\r\n * - Real-time delivery tracking\r\n */\r\n\r\nconst { EventEmitter } = require('events');\r\nconst { v4: uuidv4 } = require('uuid');\r\n\r\nclass SmartNotificationsService extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.notifications = new Map();\r\n    this.notificationQueue = [];\r\n    this.userPreferences = new Map();\r\n    this.deliveryLogs = new Map();\r\n    this.scheduledNotifications = new Map();\r\n    this.aiModel = {\r\n      priorities: {},\r\n      patterns: {},\r\n      engagement: {},\r\n    };\r\n  }\r\n\r\n  /**\r\n   * إنشاء إشعار ذكي\r\n   * Create smart notification\r\n   * @param {Object} notificationData - Notification payload\r\n   * @returns {Object} - Created notification\r\n   */\r\n  createSmartNotification(notificationData) {\r\n    const {\r\n      userId,\r\n      title,\r\n      message,\r\n      type, // 'alert', 'reminder', 'info', 'warning', 'success'\r\n      priority = 'normal', // 'low', 'normal', 'high', 'critical'\r\n      channels = ['in-app', 'email'],\r\n      metadata = {},\r\n      scheduledFor = null,\r\n    } = notificationData;\r\n\r\n    // تحليل الإشعار والتنبؤ بأفضل وقت للإرسال\r\n    const optimalSendTime = this.calculateOptimalSendTime(userId, type);\r\n\r\n    const notification = {\r\n      id: uuidv4(),\r\n      userId,\r\n      title,\r\n      message,\r\n      type,\r\n      priority: this.determinePriority(type, priority, message),\r\n      channels: this.filterChannelsForUser(userId, channels),\r\n      metadata,\r\n      createdAt: new Date(),\r\n      scheduledFor: scheduledFor || optimalSendTime,\r\n      status: 'scheduled', // 'scheduled', 'queued', 'sent', 'delivered', 'read', 'failed'\r\n      deliveryAttempts: 0,\r\n      maxRetries: 3,\r\n      aiScore: this.calculateNotificationScore(notificationData),\r\n      engagement: {\r\n        sent: false,\r\n        delivered: false,\r\n        read: false,\r\n        clicked: false,\r\n        sentAt: null,\r\n        deliveredAt: null,\r\n        readAt: null,\r\n        clickedAt: null,\r\n      },\r\n    };\r\n\r\n    this.notifications.set(notification.id, notification);\r\n\r\n    // إذا كان مجدول، أضفه إلى قائمة جدولة\r\n    if (scheduledFor) {\r\n      this.scheduleNotification(notification);\r\n    } else {\r\n      // وإلا أضفه للطابور الفوري\r\n      this.notificationQueue.push(notification.id);\r\n    }\r\n\r\n    this.emit('notification:created', notification);\r\n    return notification;\r\n  }\r\n\r\n  /**\r\n   * حساب أفضل وقت لإرسال الإشعار\r\n   * Calculate optimal send time using ML\r\n   * @param {String} userId - User ID\r\n   * @param {String} type - Notification type\r\n   * @returns {Date} - Optimal send time\r\n   */\r\n  calculateOptimalSendTime(userId, type) {\r\n    const preferences = this.userPreferences.get(userId);\r\n    const now = new Date();\r\n\r\n    // إذا لم تكن هناك تفضيلات، استخدم القيم الافتراضية\r\n    if (!preferences) {\r\n      return now; // إرسال فوري\r\n    }\r\n\r\n    // تحليل نمط استخدام المستخدم\r\n    const pattern = this.aiModel.patterns[userId];\r\n    if (!pattern) {\r\n      return now;\r\n    }\r\n\r\n    // إرجاع أفضل وقت بناءً على أنماط الاستخدام\r\n    const bestHour = this.findPeakActivityHour(userId, type);\r\n    const optimalTime = new Date(now);\r\n    optimalTime.setHours(bestHour);\r\n\r\n    // إذا كان الوقت قد مضى اليوم، جدول للغد\r\n    if (optimalTime < now) {\r\n      optimalTime.setDate(optimalTime.getDate() + 1);\r\n    }\r\n\r\n    return optimalTime;\r\n  }\r\n\r\n  /**\r\n   * تحديد أولوية الإشعار\r\n   * Determine notification priority\r\n   * @param {String} type - Notification type\r\n   * @param {String} userPriority - User-specified priority\r\n   * @param {String} message - Message content\r\n   * @returns {String} - Final priority\r\n   */\r\n  determinePriority(type, userPriority, message) {\r\n    // أولويات افتراضية حسب النوع\r\n    const typePriorities = {\r\n      alert: 'high',\r\n      warning: 'high',\r\n      reminder: 'normal',\r\n      info: 'low',\r\n      success: 'normal',\r\n    };\r\n\r\n    let finalPriority = userPriority || typePriorities[type] || 'normal';\r\n\r\n    // زيادة الأولوية إذا احتوت الرسالة على كلمات حساسة\r\n    if (this.containsCriticalKeywords(message)) {\r\n      finalPriority = 'critical';\r\n    }\r\n\r\n    return finalPriority;\r\n  }\r\n\r\n  /**\r\n   * تحديد القنوات المناسبة للمستخدم\r\n   * Filter channels for user\r\n   * @param {String} userId - User ID\r\n   * @param {Array} requestedChannels - Requested channels\r\n   * @returns {Array} - Filtered channels\r\n   */\r\n  filterChannelsForUser(userId, requestedChannels) {\r\n    const preferences = this.userPreferences.get(userId);\r\n\r\n    if (!preferences) {\r\n      return requestedChannels;\r\n    }\r\n\r\n    // احترام تفضيلات المستخدم\r\n    return requestedChannels.filter(channel => {\r\n      const isEnabled = preferences.channels?.[channel];\r\n      return isEnabled !== false;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * حساب درجة الإشعار (0-100)\r\n   * Calculate notification relevance score\r\n   * @param {Object} notificationData - Notification data\r\n   * @returns {Number} - Score\r\n   */\r\n  calculateNotificationScore(notificationData) {\r\n    let score = 50; // Base score\r\n\r\n    // عوامل التأثير\r\n    const factors = {\r\n      priority: {\r\n        critical: 20,\r\n        high: 15,\r\n        normal: 5,\r\n        low: 0,\r\n      },\r\n      type: {\r\n        alert: 15,\r\n        warning: 10,\r\n        reminder: 5,\r\n        info: 2,\r\n        success: 3,\r\n      },\r\n    };\r\n\r\n    score += factors.priority[notificationData.priority] || 0;\r\n    score += factors.type[notificationData.type] || 0;\r\n\r\n    // تعديل بناءً على المحتوى\r\n    if (notificationData.message.length > 50) {\r\n      score += 5; // النصوص الطويلة عادة ما تكون أكثر أهمية\r\n    }\r\n\r\n    if (this.containsCriticalKeywords(notificationData.message)) {\r\n      score += 20;\r\n    }\r\n\r\n    return Math.min(100, score);\r\n  }\r\n\r\n  /**\r\n   * تحديد ساعة الذروة للنشاط\r\n   * Find peak activity hour\r\n   * @param {String} userId - User ID\r\n   * @param {String} type - Notification type\r\n   * @returns {Number} - Hour (0-23)\r\n   */\r\n  findPeakActivityHour(userId, type) {\r\n    const pattern = this.aiModel.patterns[userId];\r\n\r\n    if (!pattern || !pattern.activityHours) {\r\n      // أوقات افتراضية\r\n      const defaultHours = {\r\n        alert: 9, // صباحاً\r\n        reminder: 10,\r\n        info: 14, // بعد الظهر\r\n        success: 15,\r\n        warning: 11,\r\n      };\r\n      return defaultHours[type] || 10;\r\n    }\r\n\r\n    // ابحث عن ساعة الذروة للنوع المحدد\r\n    return pattern.activityHours[type] || 10;\r\n  }\r\n\r\n  /**\r\n   * التحقق من الكلمات الحساسة\r\n   * Check for critical keywords\r\n   * @param {String} message - Message text\r\n   * @returns {Boolean} - Contains critical keywords\r\n   */\r\n  containsCriticalKeywords(message) {\r\n    const criticalKeywords = [\r\n      'عاجل',\r\n      'critical',\r\n      'urgent',\r\n      'فشل',\r\n      'error',\r\n      'خطر',\r\n      'danger',\r\n      'emergency',\r\n      'طوارئ',\r\n    ];\r\n\r\n    const lowerMessage = message.toLowerCase();\r\n    return criticalKeywords.some(keyword =>\r\n      lowerMessage.includes(keyword.toLowerCase())\r\n    );\r\n  }\r\n\r\n  /**\r\n   * جدولة الإشعار\r\n   * Schedule notification\r\n   * @param {Object} notification - Notification object\r\n   */\r\n  scheduleNotification(notification) {\r\n    const delay = notification.scheduledFor - new Date();\r\n\r\n    if (delay > 0) {\r\n      const timeoutId = setTimeout(() => {\r\n        this.moveToQueue(notification.id);\r\n      }, delay);\r\n\r\n      this.scheduledNotifications.set(notification.id, timeoutId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * نقل إشعار من الجدول إلى الطابور\r\n   * Move notification from scheduled to queue\r\n   * @param {String} notificationId - Notification ID\r\n   */\r\n  moveToQueue(notificationId) {\r\n    const notification = this.notifications.get(notificationId);\r\n\r\n    if (notification) {\r\n      notification.status = 'queued';\r\n      this.notificationQueue.push(notificationId);\r\n      this.scheduledNotifications.delete(notificationId);\r\n\r\n      this.emit('notification:queued', notification);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * معالجة الإشعارات في الطابور\r\n   * Process notification queue\r\n   * @returns {Promise<Array>} - Processed notifications\r\n   */\r\n  async processQueue() {\r\n    const processed = [];\r\n\r\n    while (this.notificationQueue.length > 0) {\r\n      const notificationId = this.notificationQueue.shift();\r\n      const notification = this.notifications.get(notificationId);\r\n\r\n      if (notification) {\r\n        try {\r\n          await this.deliverNotification(notification);\r\n          processed.push(notification);\r\n        } catch (error) {\r\n          // إعادة المحاولة\r\n          if (notification.deliveryAttempts < notification.maxRetries) {\r\n            notification.deliveryAttempts++;\r\n            this.notificationQueue.push(notificationId);\r\n          } else {\r\n            notification.status = 'failed';\r\n            this.emit('notification:failed', {\r\n              notification,\r\n              error: error.message,\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return processed;\r\n  }\r\n\r\n  /**\r\n   * تسليم الإشعار عبر القنوات المتعددة\r\n   * Deliver notification through multiple channels\r\n   * @param {Object} notification - Notification object\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverNotification(notification) {\r\n    notification.status = 'sent';\r\n    notification.engagement.sent = true;\r\n    notification.engagement.sentAt = new Date();\r\n\r\n    const deliveryPromises = notification.channels.map(channel =>\r\n      this.deliverViaChannel(notification, channel)\r\n    );\r\n\r\n    await Promise.allSettled(deliveryPromises);\r\n\r\n    notification.status = 'delivered';\r\n    notification.engagement.delivered = true;\r\n    notification.engagement.deliveredAt = new Date();\r\n\r\n    this.logDelivery(notification);\r\n    this.emit('notification:delivered', notification);\r\n  }\r\n\r\n  /**\r\n   * تسليم الإشعار عبر قناة محددة\r\n   * Deliver via specific channel\r\n   * @param {Object} notification - Notification object\r\n   * @param {String} channel - Channel name\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverViaChannel(notification, channel) {\r\n    // محاكاة التسليم عبر قنوات مختلفة\r\n    const deliveryMethods = {\r\n      'in-app': () => this.deliverInApp(notification),\r\n      email: () => this.deliverEmail(notification),\r\n      sms: () => this.deliverSMS(notification),\r\n      push: () => this.deliverPush(notification),\r\n      slack: () => this.deliverSlack(notification),\r\n    };\r\n\r\n    const method = deliveryMethods[channel];\r\n    if (method) {\r\n      return await method();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * تسليم في التطبيق\r\n   * In-app delivery\r\n   * @param {Object} notification - Notification\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverInApp(notification) {\r\n    return new Promise((resolve, reject) => {\r\n      // محاكاة تأخير الشبكة\r\n      setTimeout(() => {\r\n        this.emit('channel:inApp', {\r\n          userId: notification.userId,\r\n          notification,\r\n        });\r\n        resolve();\r\n      }, 100);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تسليم البريد الإلكتروني\r\n   * Email delivery\r\n   * @param {Object} notification - Notification\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverEmail(notification) {\r\n    return new Promise((resolve, reject) => {\r\n      setTimeout(() => {\r\n        this.emit('channel:email', {\r\n          userId: notification.userId,\r\n          notification,\r\n        });\r\n        resolve();\r\n      }, 300);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تسليم SMS\r\n   * SMS delivery\r\n   * @param {Object} notification - Notification\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverSMS(notification) {\r\n    return new Promise((resolve, reject) => {\r\n      setTimeout(() => {\r\n        this.emit('channel:sms', {\r\n          userId: notification.userId,\r\n          notification,\r\n        });\r\n        resolve();\r\n      }, 200);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تسليم إشعار push\r\n   * Push notification delivery\r\n   * @param {Object} notification - Notification\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverPush(notification) {\r\n    return new Promise((resolve, reject) => {\r\n      setTimeout(() => {\r\n        this.emit('channel:push', {\r\n          userId: notification.userId,\r\n          notification,\r\n        });\r\n        resolve();\r\n      }, 150);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تسليم Slack\r\n   * Slack delivery\r\n   * @param {Object} notification - Notification\r\n   * @returns {Promise<void>}\r\n   */\r\n  async deliverSlack(notification) {\r\n    return new Promise((resolve, reject) => {\r\n      setTimeout(() => {\r\n        this.emit('channel:slack', {\r\n          userId: notification.userId,\r\n          notification,\r\n        });\r\n        resolve();\r\n      }, 250);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تسجيل تسليم الإشعار\r\n   * Log notification delivery\r\n   * @param {Object} notification - Notification\r\n   */\r\n  logDelivery(notification) {\r\n    if (!this.deliveryLogs.has(notification.userId)) {\r\n      this.deliveryLogs.set(notification.userId, []);\r\n    }\r\n\r\n    this.deliveryLogs.get(notification.userId).push({\r\n      notificationId: notification.id,\r\n      timestamp: new Date(),\r\n      status: notification.status,\r\n      channels: notification.channels,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * تحديث تفضيلات المستخدم\r\n   * Update user preferences\r\n   * @param {String} userId - User ID\r\n   * @param {Object} preferences - Preferences object\r\n   * @returns {Object} - Updated preferences\r\n   */\r\n  updateUserPreferences(userId, preferences) {\r\n    const existing = this.userPreferences.get(userId) || {};\r\n\r\n    const updated = {\r\n      ...existing,\r\n      ...preferences,\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    this.userPreferences.set(userId, updated);\r\n    this.emit('preferences:updated', { userId, preferences: updated });\r\n\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * تسجيل التفاعل مع الإشعار\r\n   * Record notification interaction\r\n   * @param {String} notificationId - Notification ID\r\n   * @param {String} action - Action ('read', 'click', 'dismiss')\r\n   */\r\n  recordInteraction(notificationId, action) {\r\n    const notification = this.notifications.get(notificationId);\r\n\r\n    if (!notification) {\r\n      return;\r\n    }\r\n\r\n    const actionMap = {\r\n      read: () => {\r\n        notification.engagement.read = true;\r\n        notification.engagement.readAt = new Date();\r\n      },\r\n      click: () => {\r\n        notification.engagement.clicked = true;\r\n        notification.engagement.clickedAt = new Date();\r\n      },\r\n      dismiss: () => {\r\n        notification.engagement.dismissed = true;\r\n        notification.engagement.dismissedAt = new Date();\r\n      },\r\n    };\r\n\r\n    const handler = actionMap[action];\r\n    if (handler) {\r\n      handler();\r\n\r\n      // تعلم الأنماط\r\n      this.learnFromInteraction(notification.userId, notification, action);\r\n\r\n      this.emit('notification:interaction', {\r\n        notificationId,\r\n        action,\r\n        engagement: notification.engagement,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * التعلم من التفاعلات\r\n   * Learn from user interactions\r\n   * @param {String} userId - User ID\r\n   * @param {Object} notification - Notification object\r\n   * @param {String} action - Action type\r\n   */\r\n  learnFromInteraction(userId, notification, action) {\r\n    // تحديث نموذج AI\r\n    if (!this.aiModel.engagement[userId]) {\r\n      this.aiModel.engagement[userId] = {\r\n        read: 0,\r\n        clicked: 0,\r\n        dismissed: 0,\r\n        totalReceived: 0,\r\n      };\r\n    }\r\n\r\n    const userEngagement = this.aiModel.engagement[userId];\r\n    userEngagement[action]++;\r\n    userEngagement.totalReceived++;\r\n\r\n    // حساب معدل الانجراط\r\n    const engagementRate =\r\n      (userEngagement.clicked / userEngagement.totalReceived) * 100;\r\n\r\n    // تعديل تفضيلات المستخدم بناءً على السلوك\r\n    if (engagementRate > 70) {\r\n      // زيادة تكرار الإشعارات\r\n      this.updateUserPreferences(userId, {\r\n        frequency: 'high',\r\n      });\r\n    } else if (engagementRate < 30) {\r\n      // تقليل تكرار الإشعارات\r\n      this.updateUserPreferences(userId, {\r\n        frequency: 'low',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * الحصول على إشعارات المستخدم\r\n   * Get user notifications\r\n   * @param {String} userId - User ID\r\n   * @param {Object} options - Filter options\r\n   * @returns {Array} - User notifications\r\n   */\r\n  getUserNotifications(userId, options = {}) {\r\n    const {\r\n      status = null,\r\n      limit = 50,\r\n      offset = 0,\r\n      sortBy = 'createdAt',\r\n    } = options;\r\n\r\n    const userNotifications = Array.from(this.notifications.values())\r\n      .filter(n => n.userId === userId)\r\n      .filter(n => !status || n.status === status);\r\n\r\n    // الفرز\r\n    userNotifications.sort((a, b) => {\r\n      if (sortBy === 'priority') {\r\n        const priorityMap = { critical: 4, high: 3, normal: 2, low: 1 };\r\n        return priorityMap[b.priority] - priorityMap[a.priority];\r\n      }\r\n      return new Date(b[sortBy]) - new Date(a[sortBy]);\r\n    });\r\n\r\n    // التصفح\r\n    return userNotifications.slice(offset, offset + limit);\r\n  }\r\n\r\n  /**\r\n   * جلب إحصائيات الإشعارات\r\n   * Get notification statistics\r\n   * @param {String} userId - User ID\r\n   * @returns {Object} - Statistics\r\n   */\r\n  getNotificationStats(userId) {\r\n    const userNotifications = Array.from(this.notifications.values()).filter(\r\n      n => n.userId === userId\r\n    );\r\n\r\n    const stats = {\r\n      total: userNotifications.length,\r\n      byStatus: {},\r\n      byType: {},\r\n      byPriority: {},\r\n      engagementRate: 0,\r\n    };\r\n\r\n    userNotifications.forEach(notification => {\r\n      // Count by status\r\n      stats.byStatus[notification.status] =\r\n        (stats.byStatus[notification.status] || 0) + 1;\r\n\r\n      // Count by type\r\n      stats.byType[notification.type] =\r\n        (stats.byType[notification.type] || 0) + 1;\r\n\r\n      // Count by priority\r\n      stats.byPriority[notification.priority] =\r\n        (stats.byPriority[notification.priority] || 0) + 1;\r\n    });\r\n\r\n    // Calculate engagement rate\r\n    const readCount = userNotifications.filter(n => n.engagement.read).length;\r\n    stats.engagementRate = (readCount / userNotifications.length) * 100 || 0;\r\n\r\n    return stats;\r\n  }\r\n\r\n  /**\r\n   * حذف إشعار\r\n   * Delete notification\r\n   * @param {String} notificationId - Notification ID\r\n   * @returns {Boolean} - Success\r\n   */\r\n  deleteNotification(notificationId) {\r\n    return this.notifications.delete(notificationId);\r\n  }\r\n\r\n  /**\r\n   * حذف جميع إشعارات المستخدم\r\n   * Clear all user notifications\r\n   * @param {String} userId - User ID\r\n   * @returns {Number} - Count of deleted notifications\r\n   */\r\n  clearUserNotifications(userId) {\r\n    let count = 0;\r\n    this.notifications.forEach((notification, id) => {\r\n      if (notification.userId === userId) {\r\n        this.notifications.delete(id);\r\n        count++;\r\n      }\r\n    });\r\n    return count;\r\n  }\r\n\r\n  /**\r\n   * إرسال إشعار مجموعي\r\n   * Broadcast notification to multiple users\r\n   * @param {Array} userIds - User IDs\r\n   * @param {Object} notificationData - Notification data\r\n   * @returns {Array} - Created notifications\r\n   */\r\n  broadcastNotification(userIds, notificationData) {\r\n    return userIds.map(userId =>\r\n      this.createSmartNotification({\r\n        ...notificationData,\r\n        userId,\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * جلب تقرير الأداء\r\n   * Get performance report\r\n   * @param {String} userId - User ID (optional)\r\n   * @returns {Object} - Performance metrics\r\n   */\r\n  getPerformanceReport(userId = null) {\r\n    const notifications = userId\r\n      ? Array.from(this.notifications.values()).filter(n => n.userId === userId)\r\n      : Array.from(this.notifications.values());\r\n\r\n    const report = {\r\n      totalNotifications: notifications.length,\r\n      deliveredRate:\r\n        (notifications.filter(n => n.engagement.delivered).length /\r\n          notifications.length) *\r\n          100 || 0,\r\n      readRate:\r\n        (notifications.filter(n => n.engagement.read).length /\r\n          notifications.length) *\r\n          100 || 0,\r\n      clickRate:\r\n        (notifications.filter(n => n.engagement.clicked).length /\r\n          notifications.length) *\r\n          100 || 0,\r\n      averageScore:\r\n        notifications.reduce((sum, n) => sum + n.aiScore, 0) /\r\n          notifications.length || 0,\r\n      channelDistribution: {},\r\n      typeDistribution: {},\r\n    };\r\n\r\n    // Channel distribution\r\n    notifications.forEach(n => {\r\n      n.channels.forEach(channel => {\r\n        report.channelDistribution[channel] =\r\n          (report.channelDistribution[channel] || 0) + 1;\r\n      });\r\n\r\n      report.typeDistribution[n.type] =\r\n        (report.typeDistribution[n.type] || 0) + 1;\r\n    });\r\n\r\n    return report;\r\n  }\r\n}\r\n\r\nmodule.exports = new SmartNotificationsService();\r\n"],"mappings":"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","ignoreList":[]}