{"version":3,"names":["jwt","require","SSOService","logger","SSOAuthMiddleware","constructor","ssoService","JWT_SECRET","process","env","verifySSOToken","options","req","res","next","token","extractToken","status","json","success","error","message","code","sessionId","headers","extractSessionId","verification","verifySession","valid","user","session","activityMetadata","timestamp","Date","now","endpoint","originalUrl","method","ip","getClientIp","userAgent","get","verifyOptionalSSO","debug","requireRole","allowedRoles","userRole","role","roles","includes","warn","userId","requiredRoles","requirePermission","requiredPermissions","userPermissions","permissions","hasPermission","some","perm","verifyMultiDeviceSession","deviceId","metadata","userRateLimit","maxRequests","windowMs","storage","Map","key","has","set","count","resetAt","userData","retryAfter","Math","ceil","verifySSOMixCors","origin","allowedOrigins","ALLOWED_ORIGINS","split","auditLog","original","bind","data","setImmediate","auditEntry","toISOString","action","statusCode","info","authHeader","authorization","startsWith","slice","cookies","accessToken","decoded","decode","_error","trim","socket","remoteAddress","ssoAuthMiddleware","module","exports","perms","opts"],"sources":["sso-auth.middleware.js"],"sourcesContent":["/**\r\n * Advanced SSO Authentication Middleware\r\n * Middleware متقدم لـ SSO مع دعم OAuth 2.0 و OpenID Connect\r\n */\r\n\r\nconst jwt = require('jwt-simple');\r\nconst SSOService = require('../services/sso.service');\r\nconst logger = require('../utils/logger');\r\n\r\nclass SSOAuthMiddleware {\r\n  constructor() {\r\n    this.ssoService = new SSOService();\r\n    this.JWT_SECRET = process.env.JWT_SECRET || 'sso-secret-key';\r\n  }\r\n\r\n  /**\r\n   * التحقق من SSO Token - Middleware رئيسي\r\n   * Verify SSO token middleware\r\n   */\r\n  verifySSOToken = (options = {}) => {\r\n    return async (req, res, next) => {\r\n      try {\r\n        const token = this.extractToken(req);\r\n\r\n        if (!token) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: 'No token provided',\r\n            code: 'MISSING_TOKEN'\r\n          });\r\n        }\r\n\r\n        // Get session ID from request or token\r\n        const sessionId = req.headers['x-session-id'] || this.extractSessionId(token);\r\n\r\n        if (!sessionId) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: 'No session ID provided',\r\n            code: 'MISSING_SESSION_ID'\r\n          });\r\n        }\r\n\r\n        // Verify session\r\n        const verification = await this.ssoService.verifySession(sessionId, token);\r\n\r\n        if (!verification.valid) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: verification.error,\r\n            code: 'INVALID_SESSION'\r\n          });\r\n        }\r\n\r\n        // Attach user and session info to request\r\n        req.user = verification.user;\r\n        req.session = verification.session;\r\n        req.sessionId = sessionId;\r\n\r\n        // Update activity tracking\r\n        req.activityMetadata = {\r\n          timestamp: Date.now(),\r\n          endpoint: req.originalUrl,\r\n          method: req.method,\r\n          ip: this.getClientIp(req),\r\n          userAgent: req.get('user-agent')\r\n        };\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('SSO token verification failed:', error);\r\n        return res.status(401).json({\r\n          success: false,\r\n          error: 'unauthorized',\r\n          message: 'Token verification failed',\r\n          code: 'TOKEN_VERIFICATION_FAILED'\r\n        });\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * التحقق الاختياري من Token\r\n   * Optional SSO verification\r\n   */\r\n  verifyOptionalSSO = async (req, res, next) => {\r\n    try {\r\n      const token = this.extractToken(req);\r\n\r\n      if (token) {\r\n        const sessionId = req.headers['x-session-id'] || this.extractSessionId(token);\r\n\r\n        if (sessionId) {\r\n          const verification = await this.ssoService.verifySession(sessionId, token);\r\n\r\n          if (verification.valid) {\r\n            req.user = verification.user;\r\n            req.session = verification.session;\r\n            req.sessionId = sessionId;\r\n          }\r\n        }\r\n      }\r\n\r\n      next();\r\n    } catch (error) {\r\n      logger.debug('Optional SSO verification failed:', error.message);\r\n      // Continue without authentication\r\n      next();\r\n    }\r\n  };\r\n\r\n  /**\r\n   * التحقق من الأدوار والصلاحيات\r\n   * Role and permission verification\r\n   */\r\n  requireRole = (allowedRoles = []) => {\r\n    return async (req, res, next) => {\r\n      try {\r\n        if (!req.user) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: 'User not authenticated',\r\n            code: 'NOT_AUTHENTICATED'\r\n          });\r\n        }\r\n\r\n        const userRole = req.user.role || req.user.roles?.[0];\r\n\r\n        if (!allowedRoles.includes(userRole)) {\r\n          logger.warn(`Unauthorized role access: user ${req.user.userId} attempted to access ${req.originalUrl}`);\r\n          return res.status(403).json({\r\n            success: false,\r\n            error: 'forbidden',\r\n            message: 'Insufficient permissions for this operation',\r\n            code: 'FORBIDDEN',\r\n            requiredRoles: allowedRoles\r\n          });\r\n        }\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('Role verification failed:', error);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: 'internal_error',\r\n          message: 'Role verification failed'\r\n        });\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * التحقق من الصلاحيات الدقيقة\r\n   * Fine-grained permission verification\r\n   */\r\n  requirePermission = (requiredPermissions = []) => {\r\n    return async (req, res, next) => {\r\n      try {\r\n        if (!req.user) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: 'User not authenticated'\r\n          });\r\n        }\r\n\r\n        const userPermissions = req.user.permissions || [];\r\n        const hasPermission = requiredPermissions.some(perm => userPermissions.includes(perm));\r\n\r\n        if (!hasPermission) {\r\n          return res.status(403).json({\r\n            success: false,\r\n            error: 'forbidden',\r\n            message: 'Insufficient permissions',\r\n            requiredPermissions\r\n          });\r\n        }\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('Permission verification failed:', error);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: 'internal_error',\r\n          message: 'Permission verification failed'\r\n        });\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * التحقق من الجلسة المتعددة الأجهزة\r\n   * Multi-device session verification\r\n   */\r\n  verifyMultiDeviceSession = (options = {}) => {\r\n    return async (req, res, next) => {\r\n      try {\r\n        const token = this.extractToken(req);\r\n        const sessionId = req.headers['x-session-id'];\r\n        const deviceId = req.headers['x-device-id'];\r\n\r\n        if (!token || !sessionId || !deviceId) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: 'Missing authentication headers'\r\n          });\r\n        }\r\n\r\n        const verification = await this.ssoService.verifySession(sessionId, token);\r\n\r\n        if (!verification.valid) {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: 'unauthorized',\r\n            message: verification.error\r\n          });\r\n        }\r\n\r\n        // Check if device ID matches\r\n        if (verification.session.metadata.deviceId !== deviceId) {\r\n          logger.warn(`Device mismatch for session ${sessionId}`);\r\n          return res.status(403).json({\r\n            success: false,\r\n            error: 'forbidden',\r\n            message: 'Device authentication failed',\r\n            code: 'DEVICE_MISMATCH'\r\n          });\r\n        }\r\n\r\n        req.user = verification.user;\r\n        req.session = verification.session;\r\n        req.sessionId = sessionId;\r\n        req.deviceId = deviceId;\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('Multi-device verification failed:', error);\r\n        return res.status(401).json({\r\n          success: false,\r\n          error: 'unauthorized',\r\n          message: 'Session verification failed'\r\n        });\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * Rate limiting بناءً على المستخدم\r\n   * Per-user rate limiting\r\n   */\r\n  userRateLimit = (options = {}) => {\r\n    const maxRequests = options.maxRequests || 100;\r\n    const windowMs = options.windowMs || 60000; // 1 minute\r\n    const storage = new Map();\r\n\r\n    return async (req, res, next) => {\r\n      try {\r\n        const userId = req.user?.userId || req.ip;\r\n        const now = Date.now();\r\n        const key = `ratelimit:${userId}`;\r\n\r\n        if (!storage.has(key)) {\r\n          storage.set(key, { count: 1, resetAt: now + windowMs });\r\n        } else {\r\n          const userData = storage.get(key);\r\n\r\n          if (now > userData.resetAt) {\r\n            userData.count = 1;\r\n            userData.resetAt = now + windowMs;\r\n          } else {\r\n            userData.count++;\r\n          }\r\n\r\n          if (userData.count > maxRequests) {\r\n            return res.status(429).json({\r\n              success: false,\r\n              error: 'too_many_requests',\r\n              message: 'Rate limit exceeded',\r\n              retryAfter: Math.ceil((userData.resetAt - now) / 1000)\r\n            });\r\n          }\r\n        }\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('Rate limiting failed:', error);\r\n        next();\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * التحقق من CORS آمن مع SSO\r\n   * Secure CORS verification with SSO\r\n   */\r\n  verifySSOMixCors = (options = {}) => {\r\n    return async (req, res, next) => {\r\n      try {\r\n        const origin = req.get('origin');\r\n        const token = this.extractToken(req);\r\n\r\n        // For requests with SSO token, verify token first\r\n        if (token) {\r\n          const sessionId = req.headers['x-session-id'];\r\n          if (sessionId) {\r\n            const verification = await this.ssoService.verifySession(sessionId, token);\r\n            if (verification.valid) {\r\n              req.user = verification.user;\r\n              req.sessionId = sessionId;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Verify CORS origin\r\n        const allowedOrigins = (process.env.ALLOWED_ORIGINS || '').split(',');\r\n        if (allowedOrigins.includes(origin) || allowedOrigins.includes('*')) {\r\n          res.set('Access-Control-Allow-Origin', origin || '*');\r\n        }\r\n\r\n        next();\r\n      } catch (error) {\r\n        logger.error('CORS SSO verification failed:', error);\r\n        return res.status(403).json({\r\n          success: false,\r\n          error: 'forbidden',\r\n          message: 'CORS verification failed'\r\n        });\r\n      }\r\n    };\r\n  };\r\n\r\n  /**\r\n   * تسجيل النشاط والتدقيق\r\n   * Activity logging and audit trail\r\n   */\r\n  auditLog = async (req, res, next) => {\r\n    try {\r\n      const original = res.json.bind(res);\r\n\r\n      res.json = function (data) {\r\n        // Log the request after sending response\r\n        setImmediate(() => {\r\n          const auditEntry = {\r\n            timestamp: new Date().toISOString(),\r\n            userId: req.user?.userId || 'anonymous',\r\n            action: req.method,\r\n            endpoint: req.originalUrl,\r\n            statusCode: res.statusCode,\r\n            metadata: {\r\n              ip: this.getClientIp(req),\r\n              userAgent: req.get('user-agent'),\r\n              sessionId: req.sessionId\r\n            }\r\n          };\r\n\r\n          logger.info('AUDIT', auditEntry);\r\n        });\r\n\r\n        return original(data);\r\n      };\r\n\r\n      next();\r\n    } catch (error) {\r\n      logger.error('Audit logging failed:', error);\r\n      next();\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Helper method: Extract token from request\r\n   */\r\n  extractToken(req) {\r\n    // Check Authorization header\r\n    const authHeader = req.headers.authorization;\r\n    if (authHeader?.startsWith('Bearer ')) {\r\n      return authHeader.slice(7);\r\n    }\r\n\r\n    // Check X-Access-Token header\r\n    if (req.headers['x-access-token']) {\r\n      return req.headers['x-access-token'];\r\n    }\r\n\r\n    // Check cookies\r\n    if (req.cookies?.accessToken) {\r\n      return req.cookies.accessToken;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Helper method: Extract session ID from token\r\n   */\r\n  extractSessionId(token) {\r\n    try {\r\n      const decoded = jwt.decode(token, this.JWT_SECRET);\r\n      return decoded.sessionId;\r\n    } catch (_error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Helper method: Get client IP\r\n   */\r\n  getClientIp(req) {\r\n    return (\r\n      req.headers['x-forwarded-for']?.split(',')[0].trim() ||\r\n      req.socket.remoteAddress ||\r\n      'unknown'\r\n    );\r\n  }\r\n}\r\n\r\n// Export singleton instance and factory function\r\nconst ssoAuthMiddleware = new SSOAuthMiddleware();\r\n\r\nmodule.exports = {\r\n  ssoAuthMiddleware,\r\n  verifySSOToken: () => ssoAuthMiddleware.verifySSOToken(),\r\n  requireRole: (roles) => ssoAuthMiddleware.requireRole(roles),\r\n  requirePermission: (perms) => ssoAuthMiddleware.requirePermission(perms),\r\n  verifyOptionalSSO: ssoAuthMiddleware.verifyOptionalSSO.bind(ssoAuthMiddleware),\r\n  verifyMultiDeviceSession: () => ssoAuthMiddleware.verifyMultiDeviceSession(),\r\n  userRateLimit: (opts) => ssoAuthMiddleware.userRateLimit(opts),\r\n  verifySSOMixCors: (opts) => ssoAuthMiddleware.verifySSOMixCors(opts),\r\n  auditLog: ssoAuthMiddleware.auditLog.bind(ssoAuthMiddleware)\r\n};\r\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAEA,MAAMA,GAAG,GAAGC,OAAO,CAAC,YAAY,CAAC;AACjC,MAAMC,UAAU,GAAGD,OAAO,CAAC,yBAAyB,CAAC;AACrD,MAAME,MAAM,GAAGF,OAAO,CAAC,iBAAiB,CAAC;AAEzC,MAAMG,iBAAiB,CAAC;EACtBC,WAAWA,CAAA,EAAG;IACZ,IAAI,CAACC,UAAU,GAAG,IAAIJ,UAAU,CAAC,CAAC;IAClC,IAAI,CAACK,UAAU,GAAGC,OAAO,CAACC,GAAG,CAACF,UAAU,IAAI,gBAAgB;EAC9D;;EAEA;AACF;AACA;AACA;EACEG,cAAc,GAAGA,CAACC,OAAO,GAAG,CAAC,CAAC,KAAK;IACjC,OAAO,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,MAAMC,KAAK,GAAG,IAAI,CAACC,YAAY,CAACJ,GAAG,CAAC;QAEpC,IAAI,CAACG,KAAK,EAAE;UACV,OAAOF,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAE,mBAAmB;YAC5BC,IAAI,EAAE;UACR,CAAC,CAAC;QACJ;;QAEA;QACA,MAAMC,SAAS,GAAGX,GAAG,CAACY,OAAO,CAAC,cAAc,CAAC,IAAI,IAAI,CAACC,gBAAgB,CAACV,KAAK,CAAC;QAE7E,IAAI,CAACQ,SAAS,EAAE;UACd,OAAOV,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAE,wBAAwB;YACjCC,IAAI,EAAE;UACR,CAAC,CAAC;QACJ;;QAEA;QACA,MAAMI,YAAY,GAAG,MAAM,IAAI,CAACpB,UAAU,CAACqB,aAAa,CAACJ,SAAS,EAAER,KAAK,CAAC;QAE1E,IAAI,CAACW,YAAY,CAACE,KAAK,EAAE;UACvB,OAAOf,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAEK,YAAY,CAACN,KAAK;YAC3BE,IAAI,EAAE;UACR,CAAC,CAAC;QACJ;;QAEA;QACAV,GAAG,CAACiB,IAAI,GAAGH,YAAY,CAACG,IAAI;QAC5BjB,GAAG,CAACkB,OAAO,GAAGJ,YAAY,CAACI,OAAO;QAClClB,GAAG,CAACW,SAAS,GAAGA,SAAS;;QAEzB;QACAX,GAAG,CAACmB,gBAAgB,GAAG;UACrBC,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC;UACrBC,QAAQ,EAAEvB,GAAG,CAACwB,WAAW;UACzBC,MAAM,EAAEzB,GAAG,CAACyB,MAAM;UAClBC,EAAE,EAAE,IAAI,CAACC,WAAW,CAAC3B,GAAG,CAAC;UACzB4B,SAAS,EAAE5B,GAAG,CAAC6B,GAAG,CAAC,YAAY;QACjC,CAAC;QAED3B,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,gCAAgC,EAAEA,KAAK,CAAC;QACrD,OAAOP,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;UAC1BC,OAAO,EAAE,KAAK;UACdC,KAAK,EAAE,cAAc;UACrBC,OAAO,EAAE,2BAA2B;UACpCC,IAAI,EAAE;QACR,CAAC,CAAC;MACJ;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACEoB,iBAAiB,GAAG,MAAAA,CAAO9B,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;IAC5C,IAAI;MACF,MAAMC,KAAK,GAAG,IAAI,CAACC,YAAY,CAACJ,GAAG,CAAC;MAEpC,IAAIG,KAAK,EAAE;QACT,MAAMQ,SAAS,GAAGX,GAAG,CAACY,OAAO,CAAC,cAAc,CAAC,IAAI,IAAI,CAACC,gBAAgB,CAACV,KAAK,CAAC;QAE7E,IAAIQ,SAAS,EAAE;UACb,MAAMG,YAAY,GAAG,MAAM,IAAI,CAACpB,UAAU,CAACqB,aAAa,CAACJ,SAAS,EAAER,KAAK,CAAC;UAE1E,IAAIW,YAAY,CAACE,KAAK,EAAE;YACtBhB,GAAG,CAACiB,IAAI,GAAGH,YAAY,CAACG,IAAI;YAC5BjB,GAAG,CAACkB,OAAO,GAAGJ,YAAY,CAACI,OAAO;YAClClB,GAAG,CAACW,SAAS,GAAGA,SAAS;UAC3B;QACF;MACF;MAEAT,IAAI,CAAC,CAAC;IACR,CAAC,CAAC,OAAOM,KAAK,EAAE;MACdjB,MAAM,CAACwC,KAAK,CAAC,mCAAmC,EAAEvB,KAAK,CAACC,OAAO,CAAC;MAChE;MACAP,IAAI,CAAC,CAAC;IACR;EACF,CAAC;;EAED;AACF;AACA;AACA;EACE8B,WAAW,GAAGA,CAACC,YAAY,GAAG,EAAE,KAAK;IACnC,OAAO,OAAOjC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,IAAI,CAACF,GAAG,CAACiB,IAAI,EAAE;UACb,OAAOhB,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAE,wBAAwB;YACjCC,IAAI,EAAE;UACR,CAAC,CAAC;QACJ;QAEA,MAAMwB,QAAQ,GAAGlC,GAAG,CAACiB,IAAI,CAACkB,IAAI,IAAInC,GAAG,CAACiB,IAAI,CAACmB,KAAK,GAAG,CAAC,CAAC;QAErD,IAAI,CAACH,YAAY,CAACI,QAAQ,CAACH,QAAQ,CAAC,EAAE;UACpC3C,MAAM,CAAC+C,IAAI,CAAC,kCAAkCtC,GAAG,CAACiB,IAAI,CAACsB,MAAM,wBAAwBvC,GAAG,CAACwB,WAAW,EAAE,CAAC;UACvG,OAAOvB,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,WAAW;YAClBC,OAAO,EAAE,6CAA6C;YACtDC,IAAI,EAAE,WAAW;YACjB8B,aAAa,EAAEP;UACjB,CAAC,CAAC;QACJ;QAEA/B,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,2BAA2B,EAAEA,KAAK,CAAC;QAChD,OAAOP,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;UAC1BC,OAAO,EAAE,KAAK;UACdC,KAAK,EAAE,gBAAgB;UACvBC,OAAO,EAAE;QACX,CAAC,CAAC;MACJ;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACEgC,iBAAiB,GAAGA,CAACC,mBAAmB,GAAG,EAAE,KAAK;IAChD,OAAO,OAAO1C,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,IAAI,CAACF,GAAG,CAACiB,IAAI,EAAE;UACb,OAAOhB,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAE;UACX,CAAC,CAAC;QACJ;QAEA,MAAMkC,eAAe,GAAG3C,GAAG,CAACiB,IAAI,CAAC2B,WAAW,IAAI,EAAE;QAClD,MAAMC,aAAa,GAAGH,mBAAmB,CAACI,IAAI,CAACC,IAAI,IAAIJ,eAAe,CAACN,QAAQ,CAACU,IAAI,CAAC,CAAC;QAEtF,IAAI,CAACF,aAAa,EAAE;UAClB,OAAO5C,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,WAAW;YAClBC,OAAO,EAAE,0BAA0B;YACnCiC;UACF,CAAC,CAAC;QACJ;QAEAxC,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,iCAAiC,EAAEA,KAAK,CAAC;QACtD,OAAOP,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;UAC1BC,OAAO,EAAE,KAAK;UACdC,KAAK,EAAE,gBAAgB;UACvBC,OAAO,EAAE;QACX,CAAC,CAAC;MACJ;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACEuC,wBAAwB,GAAGA,CAACjD,OAAO,GAAG,CAAC,CAAC,KAAK;IAC3C,OAAO,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,MAAMC,KAAK,GAAG,IAAI,CAACC,YAAY,CAACJ,GAAG,CAAC;QACpC,MAAMW,SAAS,GAAGX,GAAG,CAACY,OAAO,CAAC,cAAc,CAAC;QAC7C,MAAMqC,QAAQ,GAAGjD,GAAG,CAACY,OAAO,CAAC,aAAa,CAAC;QAE3C,IAAI,CAACT,KAAK,IAAI,CAACQ,SAAS,IAAI,CAACsC,QAAQ,EAAE;UACrC,OAAOhD,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAE;UACX,CAAC,CAAC;QACJ;QAEA,MAAMK,YAAY,GAAG,MAAM,IAAI,CAACpB,UAAU,CAACqB,aAAa,CAACJ,SAAS,EAAER,KAAK,CAAC;QAE1E,IAAI,CAACW,YAAY,CAACE,KAAK,EAAE;UACvB,OAAOf,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,cAAc;YACrBC,OAAO,EAAEK,YAAY,CAACN;UACxB,CAAC,CAAC;QACJ;;QAEA;QACA,IAAIM,YAAY,CAACI,OAAO,CAACgC,QAAQ,CAACD,QAAQ,KAAKA,QAAQ,EAAE;UACvD1D,MAAM,CAAC+C,IAAI,CAAC,+BAA+B3B,SAAS,EAAE,CAAC;UACvD,OAAOV,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;YAC1BC,OAAO,EAAE,KAAK;YACdC,KAAK,EAAE,WAAW;YAClBC,OAAO,EAAE,8BAA8B;YACvCC,IAAI,EAAE;UACR,CAAC,CAAC;QACJ;QAEAV,GAAG,CAACiB,IAAI,GAAGH,YAAY,CAACG,IAAI;QAC5BjB,GAAG,CAACkB,OAAO,GAAGJ,YAAY,CAACI,OAAO;QAClClB,GAAG,CAACW,SAAS,GAAGA,SAAS;QACzBX,GAAG,CAACiD,QAAQ,GAAGA,QAAQ;QAEvB/C,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,mCAAmC,EAAEA,KAAK,CAAC;QACxD,OAAOP,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;UAC1BC,OAAO,EAAE,KAAK;UACdC,KAAK,EAAE,cAAc;UACrBC,OAAO,EAAE;QACX,CAAC,CAAC;MACJ;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACE0C,aAAa,GAAGA,CAACpD,OAAO,GAAG,CAAC,CAAC,KAAK;IAChC,MAAMqD,WAAW,GAAGrD,OAAO,CAACqD,WAAW,IAAI,GAAG;IAC9C,MAAMC,QAAQ,GAAGtD,OAAO,CAACsD,QAAQ,IAAI,KAAK,CAAC,CAAC;IAC5C,MAAMC,OAAO,GAAG,IAAIC,GAAG,CAAC,CAAC;IAEzB,OAAO,OAAOvD,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,MAAMqC,MAAM,GAAGvC,GAAG,CAACiB,IAAI,EAAEsB,MAAM,IAAIvC,GAAG,CAAC0B,EAAE;QACzC,MAAMJ,GAAG,GAAGD,IAAI,CAACC,GAAG,CAAC,CAAC;QACtB,MAAMkC,GAAG,GAAG,aAAajB,MAAM,EAAE;QAEjC,IAAI,CAACe,OAAO,CAACG,GAAG,CAACD,GAAG,CAAC,EAAE;UACrBF,OAAO,CAACI,GAAG,CAACF,GAAG,EAAE;YAAEG,KAAK,EAAE,CAAC;YAAEC,OAAO,EAAEtC,GAAG,GAAG+B;UAAS,CAAC,CAAC;QACzD,CAAC,MAAM;UACL,MAAMQ,QAAQ,GAAGP,OAAO,CAACzB,GAAG,CAAC2B,GAAG,CAAC;UAEjC,IAAIlC,GAAG,GAAGuC,QAAQ,CAACD,OAAO,EAAE;YAC1BC,QAAQ,CAACF,KAAK,GAAG,CAAC;YAClBE,QAAQ,CAACD,OAAO,GAAGtC,GAAG,GAAG+B,QAAQ;UACnC,CAAC,MAAM;YACLQ,QAAQ,CAACF,KAAK,EAAE;UAClB;UAEA,IAAIE,QAAQ,CAACF,KAAK,GAAGP,WAAW,EAAE;YAChC,OAAOnD,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;cAC1BC,OAAO,EAAE,KAAK;cACdC,KAAK,EAAE,mBAAmB;cAC1BC,OAAO,EAAE,qBAAqB;cAC9BqD,UAAU,EAAEC,IAAI,CAACC,IAAI,CAAC,CAACH,QAAQ,CAACD,OAAO,GAAGtC,GAAG,IAAI,IAAI;YACvD,CAAC,CAAC;UACJ;QACF;QAEApB,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC5CN,IAAI,CAAC,CAAC;MACR;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACE+D,gBAAgB,GAAGA,CAAClE,OAAO,GAAG,CAAC,CAAC,KAAK;IACnC,OAAO,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC/B,IAAI;QACF,MAAMgE,MAAM,GAAGlE,GAAG,CAAC6B,GAAG,CAAC,QAAQ,CAAC;QAChC,MAAM1B,KAAK,GAAG,IAAI,CAACC,YAAY,CAACJ,GAAG,CAAC;;QAEpC;QACA,IAAIG,KAAK,EAAE;UACT,MAAMQ,SAAS,GAAGX,GAAG,CAACY,OAAO,CAAC,cAAc,CAAC;UAC7C,IAAID,SAAS,EAAE;YACb,MAAMG,YAAY,GAAG,MAAM,IAAI,CAACpB,UAAU,CAACqB,aAAa,CAACJ,SAAS,EAAER,KAAK,CAAC;YAC1E,IAAIW,YAAY,CAACE,KAAK,EAAE;cACtBhB,GAAG,CAACiB,IAAI,GAAGH,YAAY,CAACG,IAAI;cAC5BjB,GAAG,CAACW,SAAS,GAAGA,SAAS;YAC3B;UACF;QACF;;QAEA;QACA,MAAMwD,cAAc,GAAG,CAACvE,OAAO,CAACC,GAAG,CAACuE,eAAe,IAAI,EAAE,EAAEC,KAAK,CAAC,GAAG,CAAC;QACrE,IAAIF,cAAc,CAAC9B,QAAQ,CAAC6B,MAAM,CAAC,IAAIC,cAAc,CAAC9B,QAAQ,CAAC,GAAG,CAAC,EAAE;UACnEpC,GAAG,CAACyD,GAAG,CAAC,6BAA6B,EAAEQ,MAAM,IAAI,GAAG,CAAC;QACvD;QAEAhE,IAAI,CAAC,CAAC;MACR,CAAC,CAAC,OAAOM,KAAK,EAAE;QACdjB,MAAM,CAACiB,KAAK,CAAC,+BAA+B,EAAEA,KAAK,CAAC;QACpD,OAAOP,GAAG,CAACI,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;UAC1BC,OAAO,EAAE,KAAK;UACdC,KAAK,EAAE,WAAW;UAClBC,OAAO,EAAE;QACX,CAAC,CAAC;MACJ;IACF,CAAC;EACH,CAAC;;EAED;AACF;AACA;AACA;EACE6D,QAAQ,GAAG,MAAAA,CAAOtE,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;IACnC,IAAI;MACF,MAAMqE,QAAQ,GAAGtE,GAAG,CAACK,IAAI,CAACkE,IAAI,CAACvE,GAAG,CAAC;MAEnCA,GAAG,CAACK,IAAI,GAAG,UAAUmE,IAAI,EAAE;QACzB;QACAC,YAAY,CAAC,MAAM;UACjB,MAAMC,UAAU,GAAG;YACjBvD,SAAS,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACuD,WAAW,CAAC,CAAC;YACnCrC,MAAM,EAAEvC,GAAG,CAACiB,IAAI,EAAEsB,MAAM,IAAI,WAAW;YACvCsC,MAAM,EAAE7E,GAAG,CAACyB,MAAM;YAClBF,QAAQ,EAAEvB,GAAG,CAACwB,WAAW;YACzBsD,UAAU,EAAE7E,GAAG,CAAC6E,UAAU;YAC1B5B,QAAQ,EAAE;cACRxB,EAAE,EAAE,IAAI,CAACC,WAAW,CAAC3B,GAAG,CAAC;cACzB4B,SAAS,EAAE5B,GAAG,CAAC6B,GAAG,CAAC,YAAY,CAAC;cAChClB,SAAS,EAAEX,GAAG,CAACW;YACjB;UACF,CAAC;UAEDpB,MAAM,CAACwF,IAAI,CAAC,OAAO,EAAEJ,UAAU,CAAC;QAClC,CAAC,CAAC;QAEF,OAAOJ,QAAQ,CAACE,IAAI,CAAC;MACvB,CAAC;MAEDvE,IAAI,CAAC,CAAC;IACR,CAAC,CAAC,OAAOM,KAAK,EAAE;MACdjB,MAAM,CAACiB,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;MAC5CN,IAAI,CAAC,CAAC;IACR;EACF,CAAC;;EAED;AACF;AACA;EACEE,YAAYA,CAACJ,GAAG,EAAE;IAChB;IACA,MAAMgF,UAAU,GAAGhF,GAAG,CAACY,OAAO,CAACqE,aAAa;IAC5C,IAAID,UAAU,EAAEE,UAAU,CAAC,SAAS,CAAC,EAAE;MACrC,OAAOF,UAAU,CAACG,KAAK,CAAC,CAAC,CAAC;IAC5B;;IAEA;IACA,IAAInF,GAAG,CAACY,OAAO,CAAC,gBAAgB,CAAC,EAAE;MACjC,OAAOZ,GAAG,CAACY,OAAO,CAAC,gBAAgB,CAAC;IACtC;;IAEA;IACA,IAAIZ,GAAG,CAACoF,OAAO,EAAEC,WAAW,EAAE;MAC5B,OAAOrF,GAAG,CAACoF,OAAO,CAACC,WAAW;IAChC;IAEA,OAAO,IAAI;EACb;;EAEA;AACF;AACA;EACExE,gBAAgBA,CAACV,KAAK,EAAE;IACtB,IAAI;MACF,MAAMmF,OAAO,GAAGlG,GAAG,CAACmG,MAAM,CAACpF,KAAK,EAAE,IAAI,CAACR,UAAU,CAAC;MAClD,OAAO2F,OAAO,CAAC3E,SAAS;IAC1B,CAAC,CAAC,OAAO6E,MAAM,EAAE;MACf,OAAO,IAAI;IACb;EACF;;EAEA;AACF;AACA;EACE7D,WAAWA,CAAC3B,GAAG,EAAE;IACf,OACEA,GAAG,CAACY,OAAO,CAAC,iBAAiB,CAAC,EAAEyD,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAACoB,IAAI,CAAC,CAAC,IACpDzF,GAAG,CAAC0F,MAAM,CAACC,aAAa,IACxB,SAAS;EAEb;AACF;;AAEA;AACA,MAAMC,iBAAiB,GAAG,IAAIpG,iBAAiB,CAAC,CAAC;AAEjDqG,MAAM,CAACC,OAAO,GAAG;EACfF,iBAAiB;EACjB9F,cAAc,EAAEA,CAAA,KAAM8F,iBAAiB,CAAC9F,cAAc,CAAC,CAAC;EACxDkC,WAAW,EAAGI,KAAK,IAAKwD,iBAAiB,CAAC5D,WAAW,CAACI,KAAK,CAAC;EAC5DK,iBAAiB,EAAGsD,KAAK,IAAKH,iBAAiB,CAACnD,iBAAiB,CAACsD,KAAK,CAAC;EACxEjE,iBAAiB,EAAE8D,iBAAiB,CAAC9D,iBAAiB,CAAC0C,IAAI,CAACoB,iBAAiB,CAAC;EAC9E5C,wBAAwB,EAAEA,CAAA,KAAM4C,iBAAiB,CAAC5C,wBAAwB,CAAC,CAAC;EAC5EG,aAAa,EAAG6C,IAAI,IAAKJ,iBAAiB,CAACzC,aAAa,CAAC6C,IAAI,CAAC;EAC9D/B,gBAAgB,EAAG+B,IAAI,IAAKJ,iBAAiB,CAAC3B,gBAAgB,CAAC+B,IAAI,CAAC;EACpE1B,QAAQ,EAAEsB,iBAAiB,CAACtB,QAAQ,CAACE,IAAI,CAACoB,iBAAiB;AAC7D,CAAC","ignoreList":[]}