{"version":3,"names":["redis","require","logger","process","env","USE_MOCK_CACHE","memoryStore","Map","cache","set","key","value","get","delete","deletePattern","pattern","regex","RegExp","replace","keys","test","clear","stats","items","size","cacheMiddleware","req","res","next","module","exports","redisClient","warn","createClient","socket","host","REDIS_HOST","port","Number","REDIS_PORT","password","REDIS_PASSWORD","undefined","database","REDIS_DB","on","err","error","info","connect","catch","ttl","serialized","JSON","stringify","setEx","data","parse","del","length","flushdb","duration","method","cacheKey","originalUrl","cachedData","json","originalJson","bind","body"],"sources":["redis.js"],"sourcesContent":["const redis = require('redis');\r\nconst logger = require('../utils/logger');\r\n\r\n// Allow running without a Redis instance in local/offline scenarios\r\nif (process.env.USE_MOCK_CACHE === 'true') {\r\n  const memoryStore = new Map();\r\n\r\n  const cache = {\r\n    async set(key, value) {\r\n      memoryStore.set(key, value);\r\n      return true;\r\n    },\r\n    async get(key) {\r\n      return memoryStore.get(key) ?? null;\r\n    },\r\n    async delete(key) {\r\n      memoryStore.delete(key);\r\n      return true;\r\n    },\r\n    async deletePattern(pattern) {\r\n      const regex = new RegExp(pattern.replace('*', '.*'));\r\n      for (const key of memoryStore.keys()) {\r\n        if (regex.test(key)) memoryStore.delete(key);\r\n      }\r\n      return true;\r\n    },\r\n    async clear() {\r\n      memoryStore.clear();\r\n      return true;\r\n    },\r\n    async stats() {\r\n      return { items: memoryStore.size };\r\n    },\r\n  };\r\n\r\n  const cacheMiddleware = () => (req, res, next) => next();\r\n\r\n  module.exports = {\r\n    redisClient: null,\r\n    cache,\r\n    cacheMiddleware,\r\n  };\r\n  logger.warn('Redis is mocked (USE_MOCK_CACHE=true). No external cache connection required.');\r\n} else {\r\n  const redisClient = redis.createClient({\r\n    socket: {\r\n      host: process.env.REDIS_HOST || 'localhost',\r\n      port: Number(process.env.REDIS_PORT || 6379),\r\n    },\r\n    password: process.env.REDIS_PASSWORD || undefined,\r\n    database: Number(process.env.REDIS_DB || 0),\r\n  });\r\n\r\n  redisClient.on('error', err => {\r\n    logger.error('Redis error:', err);\r\n  });\r\n\r\n  redisClient.on('connect', () => {\r\n    logger.info('Redis connected successfully');\r\n  });\r\n\r\n  // Initiate connection (Redis v4 requires explicit connect)\r\n  redisClient.connect().catch(err => logger.error('Redis connect error:', err));\r\n\r\n  // Cache helper functions\r\n  const cache = {\r\n    // Set cache with TTL (Time To Live in seconds)\r\n    async set(key, value, ttl = 3600) {\r\n      try {\r\n        const serialized = JSON.stringify(value);\r\n        if (ttl) {\r\n          await redisClient.setEx(key, ttl, serialized);\r\n        } else {\r\n          await redisClient.set(key, serialized);\r\n        }\r\n        return true;\r\n      } catch (error) {\r\n        logger.error('Cache set error:', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // Get cache\r\n    async get(key) {\r\n      try {\r\n        const data = await redisClient.get(key);\r\n        return data ? JSON.parse(data) : null;\r\n      } catch (error) {\r\n        logger.error('Cache get error:', error);\r\n        return null;\r\n      }\r\n    },\r\n\r\n    // Delete cache\r\n    async delete(key) {\r\n      try {\r\n        await redisClient.del(key);\r\n        return true;\r\n      } catch (error) {\r\n        logger.error('Cache delete error:', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // Delete by pattern\r\n    async deletePattern(pattern) {\r\n      try {\r\n        const keys = await redisClient.keys(pattern);\r\n        if (keys.length > 0) {\r\n          await redisClient.del(...keys);\r\n        }\r\n        return true;\r\n      } catch (error) {\r\n        logger.error('Cache deletePattern error:', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // Clear all cache\r\n    async clear() {\r\n      try {\r\n        await redisClient.flushdb();\r\n        return true;\r\n      } catch (error) {\r\n        logger.error('Cache clear error:', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // Get cache statistics\r\n    async stats() {\r\n      try {\r\n        const info = await redisClient.info('stats');\r\n        return info;\r\n      } catch (error) {\r\n        logger.error('Cache stats error:', error);\r\n        return null;\r\n      }\r\n    },\r\n  };\r\n\r\n  // Cache middleware\r\n  const cacheMiddleware = (duration = 3600) => {\r\n    return async (req, res, next) => {\r\n      if (req.method !== 'GET') {\r\n        return next();\r\n      }\r\n\r\n      const cacheKey = `route:${req.originalUrl}`;\r\n\r\n      try {\r\n        const cachedData = await cache.get(cacheKey);\r\n        if (cachedData) {\r\n          res.set('X-Cache', 'HIT');\r\n          return res.json(cachedData);\r\n        }\r\n      } catch (error) {\r\n        logger.error('Cache middleware error:', error);\r\n      }\r\n\r\n      // Override res.json to cache the response\r\n      const originalJson = res.json.bind(res);\r\n      res.json = body => {\r\n        cache.set(cacheKey, body, duration).catch(err => {\r\n          logger.error('Failed to cache response:', err);\r\n        });\r\n        res.set('X-Cache', 'MISS');\r\n        return originalJson(body);\r\n      };\r\n\r\n      next();\r\n    };\r\n  };\r\n\r\n  module.exports = {\r\n    redisClient,\r\n    cache,\r\n    cacheMiddleware,\r\n  };\r\n}\r\n"],"mappings":"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","ignoreList":[]}