{"version":3,"names":["redis","require","logger","createMemoryStore","store","Map","incr","key","current","get","set","expire","seconds","setTimeout","delete","unref","del","RateLimiter","constructor","options","windowMs","maxRequests","message","statusCode","client","process","env","USE_MOCK_CACHE","createClient","connect","catch","err","warn","getKey","req","identifier","user","id","ip","socket","remoteAddress","middleware","res","next","Math","ceil","max","status","json","error","retryAfter","reset","getStatus","parseInt","limit","remaining","limiters","api","login","passwordReset","upload","strict","module","exports"],"sources":["rateLimit.js"],"sourcesContent":["const redis = require('redis');\r\nconst logger = require('../utils/logger');\r\n\r\n// Simple in-memory store used when USE_MOCK_CACHE=true\r\nconst createMemoryStore = () => {\r\n  const store = new Map();\r\n  return {\r\n    async incr(key) {\r\n      const current = (store.get(key) || 0) + 1;\r\n      store.set(key, current);\r\n      return current;\r\n    },\r\n    async expire(key, seconds) {\r\n      // Basic expiry using timeout; good enough for local mock\r\n      setTimeout(() => store.delete(key), seconds * 1000).unref?.();\r\n      return true;\r\n    },\r\n    async del(key) {\r\n      store.delete(key);\r\n      return true;\r\n    },\r\n    async get(key) {\r\n      return store.get(key) || null;\r\n    },\r\n  };\r\n};\r\n\r\nclass RateLimiter {\r\n  constructor(options = {}) {\r\n    this.windowMs = options.windowMs || 60 * 1000; // 1 minute\r\n    this.maxRequests = options.maxRequests || 100;\r\n    this.message = options.message || 'Too many requests';\r\n    this.statusCode = options.statusCode || 429;\r\n\r\n    const client =\r\n      options.client ||\r\n      (process.env.USE_MOCK_CACHE === 'true' ? createMemoryStore() : redis.createClient());\r\n\r\n    // Ensure Redis clients attempt a connection; mock store is synchronous\r\n    if (client.connect) {\r\n      client.connect().catch(err => logger.warn('Redis connect error:', err.message));\r\n    }\r\n\r\n    this.client = client;\r\n  }\r\n\r\n  // Generate rate limit key\r\n  getKey(req) {\r\n    const identifier = req.user?.id || req.ip || req.socket.remoteAddress;\r\n    return `ratelimit:${identifier}`;\r\n  }\r\n\r\n  // Check rate limit\r\n  middleware = async (req, res, next) => {\r\n    try {\r\n      const key = this.getKey(req);\r\n      const current = await this.client.incr(key);\r\n\r\n      if (current === 1) {\r\n        await this.client.expire(key, Math.ceil(this.windowMs / 1000));\r\n      }\r\n\r\n      res.set('X-RateLimit-Limit', this.maxRequests);\r\n      res.set('X-RateLimit-Remaining', Math.max(0, this.maxRequests - current));\r\n\r\n      if (current > this.maxRequests) {\r\n        return res.status(this.statusCode).json({\r\n          error: this.message,\r\n          retryAfter: Math.ceil(this.windowMs / 1000),\r\n        });\r\n      }\r\n\r\n      next();\r\n    } catch (error) {\r\n      logger.error('Rate limit error:', error);\r\n      next(); // Continue on error\r\n    }\r\n  };\r\n\r\n  // Reset rate limit for user\r\n  reset = async req => {\r\n    try {\r\n      const key = this.getKey(req);\r\n      await this.client.del(key);\r\n      return true;\r\n    } catch (error) {\r\n      logger.error('Rate limit reset error:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Get current rate limit status\r\n  getStatus = async req => {\r\n    try {\r\n      const key = this.getKey(req);\r\n      const current = await this.client.get(key);\r\n      return {\r\n        current: parseInt(current) || 0,\r\n        limit: this.maxRequests,\r\n        remaining: Math.max(0, this.maxRequests - (parseInt(current) || 0)),\r\n      };\r\n    } catch (error) {\r\n      logger.error('Rate limit getStatus error:', error);\r\n      return null;\r\n    }\r\n  };\r\n}\r\n\r\n// Pre-configured rate limiters\r\nconst limiters = {\r\n  // General API rate limiter\r\n  api: new RateLimiter({\r\n    windowMs: 15 * 60 * 1000, // 15 minutes\r\n    maxRequests: 100,\r\n    message: 'Too many API requests',\r\n  }),\r\n\r\n  // Login attempts rate limiter\r\n  login: new RateLimiter({\r\n    windowMs: 15 * 60 * 1000,\r\n    maxRequests: 5,\r\n    message: 'Too many login attempts',\r\n  }),\r\n\r\n  // Password reset rate limiter\r\n  passwordReset: new RateLimiter({\r\n    windowMs: 60 * 60 * 1000, // 1 hour\r\n    maxRequests: 3,\r\n    message: 'Too many password reset attempts',\r\n  }),\r\n\r\n  // File upload rate limiter\r\n  upload: new RateLimiter({\r\n    windowMs: 60 * 60 * 1000, // 1 hour\r\n    maxRequests: 50,\r\n    message: 'Too many file uploads',\r\n  }),\r\n\r\n  // Strict rate limiter for sensitive operations\r\n  strict: new RateLimiter({\r\n    windowMs: 15 * 60 * 1000,\r\n    maxRequests: 10,\r\n    message: 'Too many requests for this operation',\r\n  }),\r\n};\r\n\r\nmodule.exports = { RateLimiter, limiters };\r\n"],"mappings":"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","ignoreList":[]}