{"version":3,"names":["resources","timers","Set","intervals","connections","servers","promises","trackTimeout","callback","delay","args","timeoutId","setTimeout","add","trackInterval","intervalId","setInterval","clearTrackedTimeout","clearTimeout","delete","clearTrackedInterval","clearInterval","trackPromise","promise","finally","createTimeoutPromise","Promise","resolve","waitFor","condition","options","timeout","interval","message","startTime","Date","now","Error","cleanupResources","error","clear","allSettled","Array","from","connection","close","destroy","server","reject","withTimeout","testFn","customTimeout","timeoutPromise","_","race","MockFactory","constructor","mocks","Map","create","name","implementation","mock","jest","fn","set","get","reset","mockReset","resetAll","values","clearAll","HTTPHelper","request","app","method","path","req","require","toLowerCase","headers","body","send","query","post","put","DatabaseHelper","connectAndClear","uri","dbName","mongoose","connect","clearDatabase","collections","collection","Object","deleteMany","disconnect","readyState","module","exports","getResources"],"sources":["test-helpers.js"],"sourcesContent":["/**\r\n * Test Helpers and Utilities\r\n * Provides utilities for proper test cleanup and resource management\r\n */\r\n\r\n// Track all active resources\r\nconst resources = {\r\n  timers: new Set(),\r\n  intervals: new Set(),\r\n  connections: new Set(),\r\n  servers: new Set(),\r\n  promises: new Set()\r\n};\r\n\r\n/**\r\n * Track a timeout and ensure it gets cleaned up\r\n */\r\nfunction trackTimeout(callback, delay, ...args) {\r\n  const timeoutId = setTimeout(callback, delay, ...args);\r\n  resources.timers.add(timeoutId);\r\n  return timeoutId;\r\n}\r\n\r\n/**\r\n * Track an interval and ensure it gets cleaned up\r\n */\r\nfunction trackInterval(callback, delay, ...args) {\r\n  const intervalId = setInterval(callback, delay, ...args);\r\n  resources.intervals.add(intervalId);\r\n  return intervalId;\r\n}\r\n\r\n/**\r\n * Clear a timeout and remove from tracking\r\n */\r\nfunction clearTrackedTimeout(timeoutId) {\r\n  clearTimeout(timeoutId);\r\n  resources.timers.delete(timeoutId);\r\n}\r\n\r\n/**\r\n * Clear an interval and remove from tracking\r\n */\r\nfunction clearTrackedInterval(intervalId) {\r\n  clearInterval(intervalId);\r\n  resources.intervals.delete(intervalId);\r\n}\r\n\r\n/**\r\n * Track a promise for cleanup\r\n */\r\nfunction trackPromise(promise) {\r\n  resources.promises.add(promise);\r\n  return promise.finally(() => {\r\n    resources.promises.delete(promise);\r\n  });\r\n}\r\n\r\n/**\r\n * Create a promise with timeout\r\n */\r\nfunction createTimeoutPromise(delay) {\r\n  return new Promise(resolve => {\r\n    const timeoutId = trackTimeout(() => {\r\n      resolve();\r\n      resources.timers.delete(timeoutId);\r\n    }, delay);\r\n  });\r\n}\r\n\r\n/**\r\n * Wait for a condition with timeout\r\n */\r\nasync function waitFor(condition, options = {}) {\r\n  const {\r\n    timeout = 5000,\r\n    interval = 100,\r\n    message = 'Condition not met within timeout'\r\n  } = options;\r\n\r\n  const startTime = Date.now();\r\n\r\n  while (Date.now() - startTime < timeout) {\r\n    if (await condition()) {\r\n      return true;\r\n    }\r\n    await createTimeoutPromise(interval);\r\n  }\r\n\r\n  throw new Error(message);\r\n}\r\n\r\n/**\r\n * Cleanup all tracked resources\r\n */\r\nasync function cleanupResources() {\r\n  // Clear all timeouts\r\n  for (const timeoutId of resources.timers) {\r\n    try {\r\n      clearTimeout(timeoutId);\r\n    } catch (error) {\r\n      // Ignore errors\r\n    }\r\n  }\r\n  resources.timers.clear();\r\n\r\n  // Clear all intervals\r\n  for (const intervalId of resources.intervals) {\r\n    try {\r\n      clearInterval(intervalId);\r\n    } catch (error) {\r\n      // Ignore errors\r\n    }\r\n  }\r\n  resources.intervals.clear();\r\n\r\n  // Wait for promises to settle\r\n  try {\r\n    await Promise.allSettled(Array.from(resources.promises));\r\n  } catch (error) {\r\n    // Ignore errors\r\n  }\r\n  resources.promises.clear();\r\n\r\n  // Close connections\r\n  for (const connection of resources.connections) {\r\n    try {\r\n      if (typeof connection.close === 'function') {\r\n        await connection.close();\r\n      } else if (typeof connection.destroy === 'function') {\r\n        await connection.destroy();\r\n      }\r\n    } catch (error) {\r\n      // Ignore errors\r\n    }\r\n  }\r\n  resources.connections.clear();\r\n\r\n  // Close servers\r\n  for (const server of resources.servers) {\r\n    try {\r\n      await new Promise((resolve, reject) => {\r\n        server.close((error) => {\r\n          if (error) reject(error);\r\n          else resolve();\r\n        });\r\n      });\r\n    } catch (error) {\r\n      // Ignore errors\r\n    }\r\n  }\r\n  resources.servers.clear();\r\n}\r\n\r\n/**\r\n * Create a test timeout wrapper\r\n */\r\nfunction withTimeout(testFn, customTimeout = 30000) {\r\n  return async function() {\r\n    const timeoutPromise = new Promise((_, reject) => {\r\n      const timeoutId = trackTimeout(() => {\r\n        reject(new Error(`Test timeout after ${customTimeout}ms`));\r\n      }, customTimeout);\r\n    });\r\n\r\n    try {\r\n      await Promise.race([testFn(), timeoutPromise]);\r\n    } finally {\r\n      await cleanupResources();\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Mock factory for creating reusable mocks\r\n */\r\nclass MockFactory {\r\n  constructor() {\r\n    this.mocks = new Map();\r\n  }\r\n\r\n  create(name, implementation = {}) {\r\n    const mock = jest.fn(implementation);\r\n    this.mocks.set(name, mock);\r\n    return mock;\r\n  }\r\n\r\n  get(name) {\r\n    return this.mocks.get(name);\r\n  }\r\n\r\n  reset(name) {\r\n    const mock = this.mocks.get(name);\r\n    if (mock) {\r\n      mock.mockReset();\r\n    }\r\n  }\r\n\r\n  resetAll() {\r\n    for (const mock of this.mocks.values()) {\r\n      mock.mockReset();\r\n    }\r\n  }\r\n\r\n  clearAll() {\r\n    this.mocks.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * HTTP Request Helper\r\n */\r\nclass HTTPHelper {\r\n  static async request(app, method, path, options = {}) {\r\n    let req = require('supertest')(app)[method.toLowerCase()](path);\r\n\r\n    if (options.headers) {\r\n      req = req.set(options.headers);\r\n    }\r\n\r\n    if (options.body) {\r\n      req = req.send(options.body);\r\n    }\r\n\r\n    if (options.query) {\r\n      req = req.query(options.query);\r\n    }\r\n\r\n    return req;\r\n  }\r\n\r\n  static async get(app, path, options = {}) {\r\n    return this.request(app, 'GET', path, options);\r\n  }\r\n\r\n  static async post(app, path, body, options = {}) {\r\n    return this.request(app, 'POST', path, { ...options, body });\r\n  }\r\n\r\n  static async put(app, path, body, options = {}) {\r\n    return this.request(app, 'PUT', path, { ...options, body });\r\n  }\r\n\r\n  static async delete(app, path, options = {}) {\r\n    return this.request(app, 'DELETE', path, options);\r\n  }\r\n}\r\n\r\n/**\r\n * Database Helper\r\n */\r\nclass DatabaseHelper {\r\n  static async connectAndClear(uri, dbName) {\r\n    const mongoose = require('mongoose');\r\n    await mongoose.connect(uri, {\r\n      dbName: dbName || 'test_db'\r\n    });\r\n  }\r\n\r\n  static async clearDatabase() {\r\n    const mongoose = require('mongoose');\r\n    const collections = mongoose.connection.collections;\r\n\r\n    for (const collection of Object.values(collections)) {\r\n      await collection.deleteMany({});\r\n    }\r\n  }\r\n\r\n  static async disconnect() {\r\n    const mongoose = require('mongoose');\r\n    if (mongoose.connection.readyState !== 0) {\r\n      await mongoose.disconnect();\r\n    }\r\n  }\r\n}\r\n\r\n// Export functions and classes\r\nmodule.exports = {\r\n  trackTimeout,\r\n  trackInterval,\r\n  clearTrackedTimeout,\r\n  clearTrackedInterval,\r\n  trackPromise,\r\n  createTimeoutPromise,\r\n  waitFor,\r\n  cleanupResources,\r\n  withTimeout,\r\n  MockFactory,\r\n  HTTPHelper,\r\n  DatabaseHelper,\r\n  getResources: () => ({ ...resources })\r\n};\r\n"],"mappings":"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","ignoreList":[]}