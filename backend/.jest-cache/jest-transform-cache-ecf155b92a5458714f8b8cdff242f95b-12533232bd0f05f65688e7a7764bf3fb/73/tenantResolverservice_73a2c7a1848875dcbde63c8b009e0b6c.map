{"version":3,"names":["EventEmitter","require","Logger","tenantService","TenantResolverService","constructor","logger","requestContext","Map","tenantCache","cacheTTL","resolveTenant","req","tenant","headerTenantId","headers","_getCachedOrFetch","_canUserAccessTenant","user","id","subdomain","_extractSubdomain","hostname","_resolveTenantFromHostname","userTenants","getUserTenants","length","error","message","parts","split","includes","tenants","getAllTenants","find","t","type","value","cacheKey","cached","get","expiresAt","Date","now","getTenant","getTenantBySlug","set","userId","tenantId","users","tenantUsers","has","setTenantContext","requestId","Math","random","timestamp","method","path","emit","buildTenantQuery","baseQuery","canAccessTenant","status","getTenantResources","resourceType","filters","tenantQuery","query","checkQuota","quotaType","quota","getTenantQuota","usedUsers","maxUsers","usedStorage","storageGB","usedApiCalls","apiCallsPerDay","getTenantUserRole","userData","role","hasTenantPermission","permission","rolePermissions","owner","admin","manager","member","viewer","permissions","clearExpiredCache","toDelete","forEach","key","push","delete","info","startCacheCleanup","setInterval","getStatistics","cachedTenants","size","requestContexts","cacheHitRate","_calculateCacheHitRate","module","exports"],"sources":["tenantResolver.service.js"],"sourcesContent":["/**\r\n * Tenant Resolver Service\r\n * خدمة حل الالتزامات\r\n * \r\n * المسؤوليات:\r\n * - حل الالتزامات من الطلبات\r\n * - عزل بيانات الالتزام\r\n * - إدارة سياق الالتزام\r\n * - التحقق من وصول الالتزام\r\n */\r\n\r\nconst { EventEmitter } = require('events');\r\nconst Logger = require('../utils/logger');\r\nconst tenantService = require('./tenant.service');\r\n\r\nclass TenantResolverService extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.logger = Logger;\r\n\r\n    // Context storage (tenant-request mapping)\r\n    this.requestContext = new Map();\r\n\r\n    // Tenant cache\r\n    this.tenantCache = new Map();\r\n\r\n    // Cache TTL: 5 minutes\r\n    this.cacheTTL = 5 * 60 * 1000;\r\n  }\r\n\r\n  /**\r\n   * Resolve tenant from request\r\n   * حل الالتزام من الطلب\r\n   * \r\n   * Tries to resolve tenant from:\r\n   * 1. X-Tenant-ID header\r\n   * 2. Subdomain\r\n   * 3. User's primary tenant\r\n   * \r\n   * @param {Object} req - Express request\r\n   * @returns {Object} Tenant or null\r\n   */\r\n  resolveTenant(req) {\r\n    try {\r\n      let tenant = null;\r\n\r\n      // 1. Check X-Tenant-ID header\r\n      const headerTenantId = req.headers['x-tenant-id'];\r\n      if (headerTenantId) {\r\n        tenant = this._getCachedOrFetch('id', headerTenantId);\r\n        if (tenant && this._canUserAccessTenant(req.user?.id, tenant.id)) {\r\n          return tenant;\r\n        }\r\n      }\r\n\r\n      // 2. Check subdomain\r\n      const subdomain = this._extractSubdomain(req);\r\n      if (subdomain && subdomain !== 'www' && subdomain !== 'api') {\r\n        tenant = this._getCachedOrFetch('subdomain', subdomain);\r\n        if (tenant && this._canUserAccessTenant(req.user?.id, tenant.id)) {\r\n          return tenant;\r\n        }\r\n      }\r\n\r\n      // 3. Check hostname-based routing\r\n      const hostname = req.hostname;\r\n      tenant = this._resolveTenantFromHostname(hostname);\r\n      if (tenant && this._canUserAccessTenant(req.user?.id, tenant.id)) {\r\n        return tenant;\r\n      }\r\n\r\n      // 4. Use user's primary tenant\r\n      if (req.user?.id) {\r\n        const userTenants = tenantService.getUserTenants(req.user.id);\r\n        if (userTenants.length > 0) {\r\n          return userTenants[0]; // Primary tenant\r\n        }\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      this.logger.error(`Error resolving tenant: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extract subdomain from request\r\n   * استخراج النطاق الفرعي من الطلب\r\n   * \r\n   * @private\r\n   */\r\n  _extractSubdomain(req) {\r\n    try {\r\n      const hostname = req.hostname;\r\n      const parts = hostname.split('.');\r\n\r\n      // localhost:3000 has no subdomain\r\n      if (parts.length <= 1 || hostname.includes(':')) {\r\n        return null;\r\n      }\r\n\r\n      // For example.com, return 'example'\r\n      // For tenant.example.com, return 'tenant'\r\n      return parts[0];\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolve tenant from hostname\r\n   * حل الالتزام من اسم المضيف\r\n   * \r\n   * @private\r\n   */\r\n  _resolveTenantFromHostname(hostname) {\r\n    try {\r\n      // Check if it's a tenant subdomain\r\n      const tenants = tenantService.getAllTenants();\r\n      return tenants.find(t => t.subdomain === hostname);\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached or fetch tenant\r\n   * الحصول على الالتزام المخزن مؤقتًا أو جلبه\r\n   * \r\n   * @private\r\n   */\r\n  _getCachedOrFetch(type, value) {\r\n    try {\r\n      const cacheKey = `${type}:${value}`;\r\n\r\n      // Check cache\r\n      const cached = this.tenantCache.get(cacheKey);\r\n      if (cached && cached.expiresAt > Date.now()) {\r\n        return cached.tenant;\r\n      }\r\n\r\n      // Fetch from service\r\n      let tenant;\r\n      if (type === 'id') {\r\n        tenant = tenantService.getTenant(value);\r\n      } else if (type === 'subdomain') {\r\n        tenant = tenantService.getTenantBySlug(value);\r\n      }\r\n\r\n      // Cache result\r\n      if (tenant) {\r\n        this.tenantCache.set(cacheKey, {\r\n          tenant,\r\n          expiresAt: Date.now() + this.cacheTTL\r\n        });\r\n      }\r\n\r\n      return tenant;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if user can access tenant\r\n   * التحقق من إمكانية وصول المستخدم للالتزام\r\n   * \r\n   * @private\r\n   */\r\n  _canUserAccessTenant(userId, tenantId) {\r\n    try {\r\n      if (!userId) return false;\r\n\r\n      const users = tenantService.tenantUsers.get(tenantId);\r\n      return users ? users.has(userId) : false;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set request tenant context\r\n   * تعيين سياق الالتزام للطلب\r\n   * \r\n   * @param {Object} req - Express request\r\n   * @param {Object} tenant - Tenant object\r\n   */\r\n  setTenantContext(req, tenant) {\r\n    try {\r\n      const requestId = req.id || `${Date.now()}-${Math.random()}`;\r\n\r\n      req.tenant = tenant;\r\n      req.tenantId = tenant?.id;\r\n\r\n      this.requestContext.set(requestId, {\r\n        tenantId: tenant?.id,\r\n        userId: req.user?.id,\r\n        timestamp: new Date(),\r\n        method: req.method,\r\n        path: req.path\r\n      });\r\n\r\n      this.emit('tenant:context_set', { requestId, tenantId: tenant?.id });\r\n    } catch (error) {\r\n      this.logger.error(`Error setting tenant context: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build tenant-scoped query\r\n   * بناء استعلام نطاقه الالتزام\r\n   * \r\n   * Automatically adds tenantId filter to MongoDB queries\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {Object} baseQuery - Base query\r\n   * @returns {Object} Tenant-scoped query\r\n   */\r\n  buildTenantQuery(tenantId, baseQuery = {}) {\r\n    try {\r\n      return {\r\n        ...baseQuery,\r\n        tenantId: tenantId\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Error building tenant query: ${error.message}`);\r\n      return baseQuery;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate tenant access\r\n   * التحقق من وصول الالتزام\r\n   * \r\n   * @param {Object} req - Express request\r\n   * @returns {Boolean} Can access\r\n   */\r\n  canAccessTenant(req) {\r\n    try {\r\n      const tenant = req.tenant;\r\n      const userId = req.user?.id;\r\n\r\n      if (!tenant || !userId) {\r\n        return false;\r\n      }\r\n\r\n      if (tenant.status !== 'active') {\r\n        return false;\r\n      }\r\n\r\n      // Check if user belongs to tenant\r\n      const users = tenantService.tenantUsers.get(tenant.id);\r\n      if (!users || !users.has(userId)) {\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error(`Error validating tenant access: ${error.message}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get tenant resources\r\n   * الحصول على موارد الالتزام\r\n   * \r\n   * Returns all resources (filtered by tenant)\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} resourceType - Resource type\r\n   * @param {Object} filters - Filters\r\n   * @returns {Array} Resources\r\n   */\r\n  getTenantResources(tenantId, resourceType, filters = {}) {\r\n    try {\r\n      const tenantQuery = this.buildTenantQuery(tenantId, filters);\r\n\r\n      // This would be called on actual database queries\r\n      // For now, return structured query\r\n      return {\r\n        tenantId,\r\n        resourceType,\r\n        query: tenantQuery\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Error getting tenant resources: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check quota\r\n   * التحقق من الحصة\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} quotaType - quota type (users, storage, api)\r\n   * @returns {Boolean} Within quota\r\n   */\r\n  checkQuota(tenantId, quotaType = 'api') {\r\n    try {\r\n      const quota = tenantService.getTenantQuota(tenantId);\r\n      if (!quota) return false;\r\n\r\n      switch (quotaType) {\r\n        case 'users':\r\n          return quota.usedUsers < quota.maxUsers;\r\n        case 'storage':\r\n          return quota.usedStorage < quota.storageGB;\r\n        case 'api':\r\n          return quota.usedApiCalls < quota.apiCallsPerDay;\r\n        default:\r\n          return true;\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(`Error checking quota: ${error.message}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get tenant user role\r\n   * الحصول على دور مستخدم الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @returns {String} User role\r\n   */\r\n  getTenantUserRole(tenantId, userId) {\r\n    try {\r\n      const users = tenantService.tenantUsers.get(tenantId);\r\n      if (!users) return null;\r\n\r\n      const userData = users.get(userId);\r\n      return userData ? userData.role : null;\r\n    } catch (error) {\r\n      this.logger.error(`Error getting user role: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check tenant permission\r\n   * التحقق من إذن الالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @param {String} permission - Permission\r\n   * @returns {Boolean} Has permission\r\n   */\r\n  hasTenantPermission(tenantId, userId, permission) {\r\n    try {\r\n      const role = this.getTenantUserRole(tenantId, userId);\r\n      if (!role) return false;\r\n\r\n      // Role-based permission mapping\r\n      const rolePermissions = {\r\n        owner: ['*'],\r\n        admin: ['read', 'write', 'delete', 'manage_users'],\r\n        manager: ['read', 'write', 'manage_own_data'],\r\n        member: ['read', 'write_own_data'],\r\n        viewer: ['read']\r\n      };\r\n\r\n      const permissions = rolePermissions[role] || [];\r\n      return permissions.includes('*') || permissions.includes(permission);\r\n    } catch (error) {\r\n      this.logger.error(`Error checking permission: ${error.message}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired cache\r\n   * تنظيف الذاكرة المؤقتة المنتهية الصلاحية\r\n   * \r\n   * @private\r\n   */\r\n  clearExpiredCache() {\r\n    try {\r\n      const now = Date.now();\r\n      const toDelete = [];\r\n\r\n      this.tenantCache.forEach((value, key) => {\r\n        if (value.expiresAt <= now) {\r\n          toDelete.push(key);\r\n        }\r\n      });\r\n\r\n      toDelete.forEach(key => this.tenantCache.delete(key));\r\n\r\n      if (toDelete.length > 0) {\r\n        this.logger.info(`Cleared ${toDelete.length} expired tenant cache entries`);\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(`Error clearing cache: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start cache cleanup interval\r\n   * بدء فترة تنظيف الذاكرة المؤقتة\r\n   */\r\n  startCacheCleanup() {\r\n    setInterval(() => {\r\n      this.clearExpiredCache();\r\n    }, 60 * 1000); // Every minute\r\n  }\r\n\r\n  /**\r\n   * Get statistics\r\n   * الحصول على الإحصائيات\r\n   * \r\n   * @returns {Object} Statistics\r\n   */\r\n  getStatistics() {\r\n    return {\r\n      cachedTenants: this.tenantCache.size,\r\n      requestContexts: this.requestContext.size,\r\n      cacheHitRate: this._calculateCacheHitRate()\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculate cache hit rate\r\n   * حساب معدل الإصابة في الذاكرة المؤقتة\r\n   * \r\n   * @private\r\n   */\r\n  _calculateCacheHitRate() {\r\n    // Placeholder - would track hits/misses in production\r\n    return '0.00%';\r\n  }\r\n}\r\n\r\nmodule.exports = new TenantResolverService();\r\n"],"mappings":"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","ignoreList":[]}