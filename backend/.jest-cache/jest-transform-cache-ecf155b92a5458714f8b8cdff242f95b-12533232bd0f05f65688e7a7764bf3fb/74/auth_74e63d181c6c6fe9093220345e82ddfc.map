{"version":3,"names":["jwt","require","logger","SECRET","process","env","JWT_SECRET","verifyToken","req","res","next","token","headers","authorization","split","status","json","success","error","decoded","JSON","parse","Buffer","from","toString","_e","decode","_jwtError","exp","Date","now","user","optionalAuth","debug","message","requireAdmin","isAdmin","role","Array","isArray","roles","includes","params","orgId","organizationId","branchId","requirePermission","permission","hasPermission","permissions","authenticate","authorize","allowedRoles","length","module","exports","protect"],"sources":["auth.js"],"sourcesContent":["/**\r\n * Authentication Middleware\r\n * Basic auth middleware for protected routes\r\n */\r\n\r\nconst jwt = require('jwt-simple');\r\nconst logger = require('../utils/logger');\r\n\r\nconst SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\n\r\n/**\r\n * Verify JWT token\r\n */\r\nconst verifyToken = (req, res, next) => {\r\n  try {\r\n    const token = req.headers.authorization?.split(' ')[1];\r\n\r\n    if (!token) {\r\n      return res.status(401).json({ success: false, error: 'No token provided' });\r\n    }\r\n\r\n    // Decode base64 token (as generated by AuthService)\r\n    let decoded;\r\n    try {\r\n      decoded = JSON.parse(Buffer.from(token, 'base64').toString());\r\n    } catch (_e) {\r\n      // If base64 decoding fails, try JWT\r\n      try {\r\n        decoded = jwt.decode(token, SECRET);\r\n      } catch (_jwtError) {\r\n        // If both fail, return invalid token error\r\n        return res.status(401).json({ success: false, error: 'Invalid token' });\r\n      }\r\n    }\r\n\r\n    if (decoded.exp && decoded.exp < Date.now()) {\r\n      return res.status(401).json({ success: false, error: 'Token expired' });\r\n    }\r\n\r\n    req.user = decoded;\r\n    next();\r\n  } catch (error) {\r\n    logger.error('Token verification failed:', error);\r\n    res.status(401).json({ success: false, error: 'Invalid token' });\r\n  }\r\n};\r\n\r\n/**\r\n * Optional authentication - doesn't fail if no token\r\n */\r\nconst optionalAuth = (req, res, next) => {\r\n  try {\r\n    const token = req.headers.authorization?.split(' ')[1];\r\n\r\n    if (token) {\r\n      // Decode base64 token (as generated by AuthService)\r\n      let decoded;\r\n      try {\r\n        decoded = JSON.parse(Buffer.from(token, 'base64').toString());\r\n      } catch (_e) {\r\n        // Try JWT decoding as fallback\r\n        try {\r\n          decoded = jwt.decode(token, SECRET);\r\n        } catch (_jwtError) {\r\n          // If both fail, just continue without user\r\n          return next();\r\n        }\r\n      }\r\n\r\n      if (!decoded.exp || decoded.exp >= Date.now()) {\r\n        req.user = decoded;\r\n      }\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    logger.debug('Optional auth failed:', error.message);\r\n    next();\r\n  }\r\n};\r\n\r\n/**\r\n * Admin authorization\r\n */\r\n\r\n// RBAC متقدم: تحقق من الدور والصلاحيات والسياق المؤسسي/الفرعي\r\nconst requireAdmin = (req, res, next) => {\r\n  if (!req.user) {\r\n    return res.status(401).json({ error: 'Not authenticated' });\r\n  }\r\n  // تحقق من الدور الأساسي أو الأدوار الإضافية\r\n  const isAdmin =\r\n    req.user.role === 'admin' ||\r\n    (Array.isArray(req.user.roles) && req.user.roles.includes('admin'));\r\n  if (!isAdmin) {\r\n    return res.status(403).json({ error: 'Admin access required' });\r\n  }\r\n  // تحقق من المؤسسة/الفرع إذا تم تمرير orgId/branchId في الطلب\r\n  if (req.params.orgId && req.user.organizationId && req.params.orgId !== req.user.organizationId) {\r\n    return res.status(403).json({ error: 'Access denied for this organization' });\r\n  }\r\n  if (req.params.branchId && req.user.branchId && req.params.branchId !== req.user.branchId) {\r\n    return res.status(403).json({ error: 'Access denied for this branch' });\r\n  }\r\n  next();\r\n};\r\n\r\n// ميدل وير لصلاحيات granular (permission string)\r\nconst requirePermission = permission => (req, res, next) => {\r\n  if (!req.user) {\r\n    return res.status(401).json({ error: 'Not authenticated' });\r\n  }\r\n  // تحقق من الصلاحيات\r\n  const hasPermission =\r\n    Array.isArray(req.user.permissions) && req.user.permissions.includes(permission);\r\n  if (!hasPermission) {\r\n    return res.status(403).json({ error: 'Permission denied' });\r\n  }\r\n  // تحقق من المؤسسة/الفرع إذا لزم\r\n  if (req.params.orgId && req.user.organizationId && req.params.orgId !== req.user.organizationId) {\r\n    return res.status(403).json({ error: 'Access denied for this organization' });\r\n  }\r\n  if (req.params.branchId && req.user.branchId && req.params.branchId !== req.user.branchId) {\r\n    return res.status(403).json({ error: 'Access denied for this branch' });\r\n  }\r\n  next();\r\n};\r\n\r\n/**\r\n * Authenticate middleware (alias for verifyToken)\r\n */\r\nconst authenticate = verifyToken;\r\n\r\n/**\r\n * Authorization middleware - checks multiple roles\r\n */\r\nconst authorize =\r\n  (...allowedRoles) =>\r\n  (req, res, next) => {\r\n    if (!req.user) {\r\n      return res.status(401).json({ error: 'Not authenticated' });\r\n    }\r\n\r\n    if (allowedRoles.length > 0 && !allowedRoles.includes(req.user.role)) {\r\n      return res.status(403).json({ error: 'Insufficient permissions' });\r\n    }\r\n\r\n    next();\r\n  };\r\n\r\nmodule.exports = {\r\n  verifyToken,\r\n  optionalAuth,\r\n  requireAdmin,\r\n  requirePermission,\r\n  authenticate,\r\n  authorize,\r\n  protect: verifyToken, // Alias for backward compatibility\r\n};\r\n"],"mappings":"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","ignoreList":[]}