{"version":3,"names":["mongoose","require","notificationSchema","Schema","userId","type","Types","ObjectId","ref","required","index","String","enum","default","title","trim","message","icon","color","link","metadata","Mixed","archiveStatus","archiveId","signatureStatus","signatureId","stampStatus","stampId","isRead","Boolean","readAt","Date","priority","expiresAt","sentViaWebSocket","senderId","category","serialNumber","unique","sparse","barcode","timestamps","createdAt","expireAfterSeconds","virtual","get","now","diff","seconds","Math","floor","minutes","hours","days","methods","markAsRead","save","markAsUnread","statics","createNotification","data","notification","createBulkNotifications","userIds","notificationData","notifications","map","insertMany","deleteOldNotifications","cutoffDate","setDate","getDate","deleteMany","$lt","pre","next","colorMap","info","success","warning","error","system","task","reminder","Notification","models","model","module","exports"],"sources":["Notification.js"],"sourcesContent":["const mongoose = require('mongoose');\r\n\r\nconst notificationSchema = new mongoose.Schema(\r\n  {\r\n    // المستخدم المستلم للإشعار\r\n    userId: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'User',\r\n      required: true,\r\n      index: true,\r\n    },\r\n\r\n    // نوع الإشعار\r\n    type: {\r\n      type: String,\r\n      enum: ['info', 'success', 'warning', 'error', 'system', 'message', 'task', 'reminder'],\r\n      default: 'info',\r\n    },\r\n\r\n    // عنوان الإشعار\r\n    title: {\r\n      type: String,\r\n      required: true,\r\n      trim: true,\r\n    },\r\n\r\n    // محتوى الإشعار\r\n    message: {\r\n      type: String,\r\n      required: true,\r\n      trim: true,\r\n    },\r\n\r\n    // أيقونة الإشعار (اختياري)\r\n    icon: {\r\n      type: String,\r\n      default: 'NotificationsIcon',\r\n    },\r\n\r\n    // لون الإشعار (اختياري)\r\n    color: {\r\n      type: String,\r\n      default: '#1976d2',\r\n    },\r\n\r\n    // رابط للإشعار (اختياري)\r\n    link: {\r\n      type: String,\r\n      trim: true,\r\n    },\r\n\r\n    // بيانات إضافية (JSON)\r\n    metadata: {\r\n      type: mongoose.Schema.Types.Mixed,\r\n      default: {},\r\n    },\r\n\r\n    // حالة الأرشفة\r\n    archiveStatus: {\r\n      type: String,\r\n      enum: ['pending', 'archived', 'failed'],\r\n      default: 'pending',\r\n    },\r\n    archiveId: { type: String },\r\n\r\n    // حالة التوقيع الإلكتروني\r\n    signatureStatus: {\r\n      type: String,\r\n      enum: ['none', 'pending', 'signed', 'failed'],\r\n      default: 'none',\r\n    },\r\n    signatureId: { type: String },\r\n\r\n    // حالة الختم الإلكتروني\r\n    stampStatus: {\r\n      type: String,\r\n      enum: ['none', 'pending', 'stamped', 'failed'],\r\n      default: 'none',\r\n    },\r\n    stampId: { type: String },\r\n\r\n    // حالة القراءة\r\n    isRead: {\r\n      type: Boolean,\r\n      default: false,\r\n      index: true,\r\n    },\r\n\r\n    // تاريخ القراءة\r\n    readAt: {\r\n      type: Date,\r\n    },\r\n\r\n    // الأولوية\r\n    priority: {\r\n      type: String,\r\n      enum: ['low', 'normal', 'high', 'urgent'],\r\n      default: 'normal',\r\n    },\r\n\r\n    // تاريخ الانتهاء (للإشعارات المؤقتة)\r\n    expiresAt: {\r\n      type: Date,\r\n    },\r\n\r\n    // هل تم إرساله عبر WebSocket\r\n    sentViaWebSocket: {\r\n      type: Boolean,\r\n      default: false,\r\n    },\r\n\r\n    // المرسل (اختياري)\r\n    senderId: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'User',\r\n    },\r\n\r\n    // الفئة\r\n    category: {\r\n      type: String,\r\n      default: 'general',\r\n    },\r\n\r\n    // رقم تسلسلي مميز لكل خطاب/إشعار\r\n    serialNumber: {\r\n      type: String,\r\n      unique: true,\r\n      sparse: true,\r\n      index: true,\r\n    },\r\n\r\n    // باركود (Base64 أو نص)\r\n    barcode: {\r\n      type: String,\r\n    },\r\n  },\r\n  {\r\n    timestamps: true,\r\n  }\r\n);\r\n\r\n// Indexes للأداء\r\nnotificationSchema.index({ userId: 1, isRead: 1 });\r\nnotificationSchema.index({ userId: 1, createdAt: -1 });\r\nnotificationSchema.index({ expiresAt: 1 }, { expireAfterSeconds: 0 });\r\n\r\n// Virtual لعرض الوقت المنقضي\r\nnotificationSchema.virtual('timeAgo').get(function () {\r\n  const now = new Date();\r\n  const diff = now - this.createdAt;\r\n  const seconds = Math.floor(diff / 1000);\r\n  const minutes = Math.floor(seconds / 60);\r\n  const hours = Math.floor(minutes / 60);\r\n  const days = Math.floor(hours / 24);\r\n\r\n  if (days > 0) return `منذ ${days} يوم`;\r\n  if (hours > 0) return `منذ ${hours} ساعة`;\r\n  if (minutes > 0) return `منذ ${minutes} دقيقة`;\r\n  return 'الآن';\r\n});\r\n\r\n// Method لتحديد الإشعار كمقروء\r\nnotificationSchema.methods.markAsRead = async function () {\r\n  this.isRead = true;\r\n  this.readAt = new Date();\r\n  return await this.save();\r\n};\r\n\r\n// Method لتحديد الإشعار كغير مقروء\r\nnotificationSchema.methods.markAsUnread = async function () {\r\n  this.isRead = false;\r\n  this.readAt = null;\r\n  return await this.save();\r\n};\r\n\r\n// Static method لإنشاء إشعار جديد\r\nnotificationSchema.statics.createNotification = async function (data) {\r\n  const notification = new this(data);\r\n  return await notification.save();\r\n};\r\n\r\n// Static method لإنشاء إشعار لعدة مستخدمين\r\nnotificationSchema.statics.createBulkNotifications = async function (userIds, notificationData) {\r\n  const notifications = userIds.map(userId => ({\r\n    ...notificationData,\r\n    userId,\r\n  }));\r\n  return await this.insertMany(notifications);\r\n};\r\n\r\n// Static method لحذف الإشعارات القديمة\r\nnotificationSchema.statics.deleteOldNotifications = async function (days = 30) {\r\n  const cutoffDate = new Date();\r\n  cutoffDate.setDate(cutoffDate.getDate() - days);\r\n\r\n  return await this.deleteMany({\r\n    createdAt: { $lt: cutoffDate },\r\n    isRead: true,\r\n  });\r\n};\r\n\r\n// Middleware قبل الحفظ\r\nnotificationSchema.pre('save', function (next) {\r\n  // تعيين لون افتراضي حسب النوع\r\n  if (!this.color) {\r\n    const colorMap = {\r\n      info: '#1976d2',\r\n      success: '#2e7d32',\r\n      warning: '#ed6c02',\r\n      error: '#d32f2f',\r\n      system: '#9c27b0',\r\n      message: '#0288d1',\r\n      task: '#f57c00',\r\n      reminder: '#7b1fa2',\r\n    };\r\n    this.color = colorMap[this.type] || '#1976d2';\r\n  }\r\n  next();\r\n});\r\n\r\n// Prevent model recompilation in tests\r\nconst Notification = mongoose.models.Notification || mongoose.model('Notification', notificationSchema);\r\n\r\nmodule.exports = Notification;\r\n"],"mappings":"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","ignoreList":[]}