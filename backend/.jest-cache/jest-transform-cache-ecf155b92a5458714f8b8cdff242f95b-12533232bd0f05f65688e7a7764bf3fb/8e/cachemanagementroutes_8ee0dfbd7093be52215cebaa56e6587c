522775f0f94b5ed75917367e8a1720a2
/**
 * Cache Management Routes
 * Handles performance optimizer cache statistics and clearing
 * 
 * Endpoints:
 * - GET /api/cache-stats - Get cache statistics
 * - POST /api/cache/clear - Clear cache
 */

const express = require('express');
const router = express.Router();
const {
  getCacheStats,
  clearCache
} = require('../utils/performance-optimizer');

// Debug middleware to log all requests to this router
router.use((req, res, next) => {
  console.log(`[CACHE-ROUTER] ${req.method} ${req.path} | URL: ${req.originalUrl} | Base URL: ${req.baseUrl}`);
  next();
});

/**
 * @route   GET /cache-stats
 * @desc    Get cache statistics from response cache
 * @access  Public
 */
router.get('/cache-stats', (req, res) => {
  try {
    console.log('[CACHE-STATS] Endpoint hit - returning statistics');
    const stats = getCacheStats();
    console.log('[CACHE-STATS] Stats retrieved:', JSON.stringify(stats));
    res.json({
      success: true,
      caching: stats,
      message: 'Cache statistics retrieved successfully'
    });
  } catch (error) {
    console.error('[CACHE-STATS] Error:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
      message: 'Failed to retrieve cache statistics'
    });
  }
});

/**
 * @route   POST /cache/clear
 * @desc    Clear cache (all or specific path)
 * @access  Public
 */
router.post('/cache/clear', (req, res) => {
  try {
    console.log('[CACHE-CLEAR] Endpoint hit - clearing cache');
    const path = req.body?.path || null;
    clearCache(path);
    const stats = getCacheStats();
    console.log('[CACHE-CLEAR] Cache cleared successfully');
    res.json({
      success: true,
      message: path ? `Cache cleared for ${path}` : 'All cache cleared',
      stats: stats
    });
  } catch (error) {
    console.error('[CACHE-CLEAR] Error:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
      message: 'Failed to clear cache'
    });
  }
});

/**
 * @route   GET /cache/health
 * @desc    Health check for cache system
 * @access  Public
 */
router.get('/cache/health', (req, res) => {
  try {
    const stats = getCacheStats();
    const isHealthy = parseInt(stats.entries) >= 0;
    res.json({
      success: true,
      status: isHealthy ? 'healthy' : 'degraded',
      cacheStatus: {
        enabled: true,
        entries: stats.entries,
        size: stats.size,
        hitRate: stats.hitRate
      }
    });
  } catch (error) {
    res.status(503).json({
      success: false,
      status: 'unhealthy',
      error: error.message
    });
  }
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsInJvdXRlciIsIlJvdXRlciIsImdldENhY2hlU3RhdHMiLCJjbGVhckNhY2hlIiwidXNlIiwicmVxIiwicmVzIiwibmV4dCIsImNvbnNvbGUiLCJsb2ciLCJtZXRob2QiLCJwYXRoIiwib3JpZ2luYWxVcmwiLCJiYXNlVXJsIiwiZ2V0Iiwic3RhdHMiLCJKU09OIiwic3RyaW5naWZ5IiwianNvbiIsInN1Y2Nlc3MiLCJjYWNoaW5nIiwibWVzc2FnZSIsImVycm9yIiwic3RhdHVzIiwicG9zdCIsImJvZHkiLCJpc0hlYWx0aHkiLCJwYXJzZUludCIsImVudHJpZXMiLCJjYWNoZVN0YXR1cyIsImVuYWJsZWQiLCJzaXplIiwiaGl0UmF0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJjYWNoZS1tYW5hZ2VtZW50LnJvdXRlcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ2FjaGUgTWFuYWdlbWVudCBSb3V0ZXNcclxuICogSGFuZGxlcyBwZXJmb3JtYW5jZSBvcHRpbWl6ZXIgY2FjaGUgc3RhdGlzdGljcyBhbmQgY2xlYXJpbmdcclxuICogXHJcbiAqIEVuZHBvaW50czpcclxuICogLSBHRVQgL2FwaS9jYWNoZS1zdGF0cyAtIEdldCBjYWNoZSBzdGF0aXN0aWNzXHJcbiAqIC0gUE9TVCAvYXBpL2NhY2hlL2NsZWFyIC0gQ2xlYXIgY2FjaGVcclxuICovXHJcblxyXG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xyXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5jb25zdCB7IGdldENhY2hlU3RhdHMsIGNsZWFyQ2FjaGUgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL3BlcmZvcm1hbmNlLW9wdGltaXplcicpO1xyXG5cclxuLy8gRGVidWcgbWlkZGxld2FyZSB0byBsb2cgYWxsIHJlcXVlc3RzIHRvIHRoaXMgcm91dGVyXHJcbnJvdXRlci51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgY29uc29sZS5sb2coYFtDQUNIRS1ST1VURVJdICR7cmVxLm1ldGhvZH0gJHtyZXEucGF0aH0gfCBVUkw6ICR7cmVxLm9yaWdpbmFsVXJsfSB8IEJhc2UgVVJMOiAke3JlcS5iYXNlVXJsfWApO1xyXG4gIG5leHQoKTtcclxufSk7XHJcblxyXG4vKipcclxuICogQHJvdXRlICAgR0VUIC9jYWNoZS1zdGF0c1xyXG4gKiBAZGVzYyAgICBHZXQgY2FjaGUgc3RhdGlzdGljcyBmcm9tIHJlc3BvbnNlIGNhY2hlXHJcbiAqIEBhY2Nlc3MgIFB1YmxpY1xyXG4gKi9cclxucm91dGVyLmdldCgnL2NhY2hlLXN0YXRzJywgKHJlcSwgcmVzKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnNvbGUubG9nKCdbQ0FDSEUtU1RBVFNdIEVuZHBvaW50IGhpdCAtIHJldHVybmluZyBzdGF0aXN0aWNzJyk7XHJcbiAgICBjb25zdCBzdGF0cyA9IGdldENhY2hlU3RhdHMoKTtcclxuICAgIGNvbnNvbGUubG9nKCdbQ0FDSEUtU1RBVFNdIFN0YXRzIHJldHJpZXZlZDonLCBKU09OLnN0cmluZ2lmeShzdGF0cykpO1xyXG4gICAgcmVzLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBjYWNoaW5nOiBzdGF0cyxcclxuICAgICAgbWVzc2FnZTogJ0NhY2hlIHN0YXRpc3RpY3MgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseSdcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdbQ0FDSEUtU1RBVFNdIEVycm9yOicsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gcmV0cmlldmUgY2FjaGUgc3RhdGlzdGljcydcclxuICAgIH0pO1xyXG4gIH1cclxufSk7XHJcblxyXG4vKipcclxuICogQHJvdXRlICAgUE9TVCAvY2FjaGUvY2xlYXJcclxuICogQGRlc2MgICAgQ2xlYXIgY2FjaGUgKGFsbCBvciBzcGVjaWZpYyBwYXRoKVxyXG4gKiBAYWNjZXNzICBQdWJsaWNcclxuICovXHJcbnJvdXRlci5wb3N0KCcvY2FjaGUvY2xlYXInLCAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc29sZS5sb2coJ1tDQUNIRS1DTEVBUl0gRW5kcG9pbnQgaGl0IC0gY2xlYXJpbmcgY2FjaGUnKTtcclxuICAgIGNvbnN0IHBhdGggPSByZXEuYm9keT8ucGF0aCB8fCBudWxsO1xyXG4gICAgY2xlYXJDYWNoZShwYXRoKTtcclxuICAgIFxyXG4gICAgY29uc3Qgc3RhdHMgPSBnZXRDYWNoZVN0YXRzKCk7XHJcbiAgICBjb25zb2xlLmxvZygnW0NBQ0hFLUNMRUFSXSBDYWNoZSBjbGVhcmVkIHN1Y2Nlc3NmdWxseScpO1xyXG4gICAgcmVzLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBtZXNzYWdlOiBwYXRoID8gYENhY2hlIGNsZWFyZWQgZm9yICR7cGF0aH1gIDogJ0FsbCBjYWNoZSBjbGVhcmVkJyxcclxuICAgICAgc3RhdHM6IHN0YXRzXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignW0NBQ0hFLUNMRUFSXSBFcnJvcjonLCBlcnJvci5tZXNzYWdlKTtcclxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGNsZWFyIGNhY2hlJ1xyXG4gICAgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBAcm91dGUgICBHRVQgL2NhY2hlL2hlYWx0aFxyXG4gKiBAZGVzYyAgICBIZWFsdGggY2hlY2sgZm9yIGNhY2hlIHN5c3RlbVxyXG4gKiBAYWNjZXNzICBQdWJsaWNcclxuICovXHJcbnJvdXRlci5nZXQoJy9jYWNoZS9oZWFsdGgnLCAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3Qgc3RhdHMgPSBnZXRDYWNoZVN0YXRzKCk7XHJcbiAgICBjb25zdCBpc0hlYWx0aHkgPSBwYXJzZUludChzdGF0cy5lbnRyaWVzKSA+PSAwO1xyXG4gICAgXHJcbiAgICByZXMuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIHN0YXR1czogaXNIZWFsdGh5ID8gJ2hlYWx0aHknIDogJ2RlZ3JhZGVkJyxcclxuICAgICAgY2FjaGVTdGF0dXM6IHtcclxuICAgICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgICAgIGVudHJpZXM6IHN0YXRzLmVudHJpZXMsXHJcbiAgICAgICAgc2l6ZTogc3RhdHMuc2l6ZSxcclxuICAgICAgICBoaXRSYXRlOiBzdGF0cy5oaXRSYXRlXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICByZXMuc3RhdHVzKDUwMykuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBzdGF0dXM6ICd1bmhlYWx0aHknLFxyXG4gICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxyXG4gICAgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBUyxDQUFDO0FBQ2xDLE1BQU1DLE1BQU0sR0FBR0YsT0FBTyxDQUFDRyxNQUFNLENBQUMsQ0FBQztBQUMvQixNQUFNO0VBQUVDLGFBQWE7RUFBRUM7QUFBVyxDQUFDLEdBQUdKLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQzs7QUFFL0U7QUFDQUMsTUFBTSxDQUFD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