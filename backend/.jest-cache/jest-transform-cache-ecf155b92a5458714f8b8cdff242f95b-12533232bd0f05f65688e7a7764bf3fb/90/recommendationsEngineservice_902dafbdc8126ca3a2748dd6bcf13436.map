{"version":3,"names":["EventEmitter","require","v4","uuidv4","Logger","aiModels","RecommendationsEngineService","constructor","logger","recommendationCache","Map","userPreferences","recommendationHistory","userFeedback","abTests","strategies","stats","totalRecommendations","totalFeedback","positiveRatings","averageRating","cacheHits","cacheMisses","_initializeStrategies","set","name","description","weight","active","info","error","message","generateRecommendations","tenantId","userId","params","cacheKey","has","cached","get","Date","timestamp","cacheMaxAge","recommendations","userContext","_getUserContext","cfRecs","_collaborativeFiltering","push","map","r","strategy","score","cbRecs","_contentBasedFiltering","hybridRecs","_hybridRecommendation","contextRecs","_contextAwareRecommendation","aggregated","_aggregateRecommendations","sort","a","b","finalScore","limit","result","slice","count","Math","min","length","generatedAt","Array","from","entries","filter","s","key","id","expiresAt","now","cacheTTL","_storeRecommendationHistory","emit","recordFeedback","recommendationId","feedback","feedbackRecord","rating","helpful","comment","action","userKey","_updateUserPreferences","delete","getUserPreferences","_createDefaultPreferences","updateUserPreferences","preferences","prefs","categories","excludeCategories","topics","maxRecommendations","undefined","diversity","freshness","updatedAt","getRecommendationHistory","filters","history","startDate","endDate","getUserFeedback","createABTest","testConfig","test","variants","status","results","createdAt","forEach","variant","clicks","conversions","impressions","ctr","conversionRate","recordABTestEvent","testId","eventType","Error","getABTestResults","personalizeForTenant","users","options","personalizedRecs","user","recs","userCount","getStatistics","parseFloat","toFixed","cacheHitRate","round","cachedUsers","size","activeABTests","values","t","totalUsers","feedbackCount","f","recentRecommendations","engagementLevel","max","context","title","category","reasoning","hour","getHours","timeContext","rec","existing","historyRecord","storedAt","includes","module","exports"],"sources":["recommendationsEngine.service.js"],"sourcesContent":["/**\r\n * Recommendations Engine Service\r\n * خدمة محرك التوصيات\r\n * \r\n * المسؤوليات:\r\n * - توليد التوصيات الشخصية\r\n * - تحليل سلوك المستخدم\r\n * - تصنيف التوصيات\r\n * - مراقبة ردود الفعل\r\n */\r\n\r\nconst { EventEmitter } = require('events');\r\nconst { v4: uuidv4 } = require('uuid');\r\nconst Logger = require('../utils/logger');\r\nconst aiModels = require('./aiModels.service');\r\n\r\nclass RecommendationsEngineService extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.logger = Logger;\r\n\r\n    // Recommendation cache\r\n    this.recommendationCache = new Map();\r\n\r\n    // User preferences\r\n    this.userPreferences = new Map();\r\n\r\n    // Recommendation history\r\n    this.recommendationHistory = new Map();\r\n\r\n    // User feedback collection\r\n    this.userFeedback = new Map();\r\n\r\n    // A/B test variations\r\n    this.abTests = new Map();\r\n\r\n    // Recommendation strategies\r\n    this.strategies = new Map();\r\n\r\n    // Statistics\r\n    this.stats = {\r\n      totalRecommendations: 0,\r\n      totalFeedback: 0,\r\n      positiveRatings: 0,\r\n      averageRating: 0,\r\n      cacheHits: 0,\r\n      cacheMisses: 0\r\n    };\r\n\r\n    this._initializeStrategies();\r\n  }\r\n\r\n  /**\r\n   * Initialize recommendation strategies\r\n   * تهيئة استراتيجيات التوصية\r\n   * \r\n   * @private\r\n   */\r\n  _initializeStrategies() {\r\n    try {\r\n      this.strategies.set('collaborative_filtering', {\r\n        name: 'Collaborative Filtering',\r\n        description: 'يوصي بناءً على تفضيلات المستخدمين المشابهين',\r\n        weight: 0.35,\r\n        active: true\r\n      });\r\n\r\n      this.strategies.set('content_based', {\r\n        name: 'Content-Based Filtering',\r\n        description: 'يوصي بناءً على خصائص المحتوى المفضل',\r\n        weight: 0.30,\r\n        active: true\r\n      });\r\n\r\n      this.strategies.set('hybrid', {\r\n        name: 'Hybrid Recommendation',\r\n        description: 'يجمع بين عدة استراتيجيات',\r\n        weight: 0.25,\r\n        active: true\r\n      });\r\n\r\n      this.strategies.set('context_aware', {\r\n        name: 'Context-Aware Recommendation',\r\n        description: 'يأخذ في الاعتبار السياق والموقع والوقت',\r\n        weight: 0.10,\r\n        active: true\r\n      });\r\n\r\n      this.logger.info('✅ Recommendation strategies initialized');\r\n    } catch (error) {\r\n      this.logger.error(`Error initializing strategies: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate recommendations for user\r\n   * توليد التوصيات للمستخدم\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @param {Object} params - Generation parameters\r\n   * @returns {Object} Recommendations\r\n   */\r\n  generateRecommendations(tenantId, userId, params = {}) {\r\n    try {\r\n      const cacheKey = `${tenantId}:${userId}`;\r\n      \r\n      // Check cache\r\n      if (this.recommendationCache.has(cacheKey)) {\r\n        const cached = this.recommendationCache.get(cacheKey);\r\n        if (new Date() - cached.timestamp < (params.cacheMaxAge || 5 * 60 * 1000)) {\r\n          this.stats.cacheHits++;\r\n          return cached.recommendations;\r\n        }\r\n      }\r\n\r\n      this.stats.cacheMisses++;\r\n\r\n      // Get user context\r\n      const userContext = this._getUserContext(tenantId, userId);\r\n      \r\n      // Generate recommendations using different strategies\r\n      let recommendations = [];\r\n\r\n      // Collaborative filtering\r\n      const cfRecs = this._collaborativeFiltering(tenantId, userId, userContext);\r\n      recommendations.push(...cfRecs.map(r => ({ ...r, strategy: 'collaborative_filtering', score: r.score * 0.35 })));\r\n\r\n      // Content-based filtering\r\n      const cbRecs = this._contentBasedFiltering(tenantId, userId, userContext);\r\n      recommendations.push(...cbRecs.map(r => ({ ...r, strategy: 'content_based', score: r.score * 0.30 })));\r\n\r\n      // Hybrid approach\r\n      const hybridRecs = this._hybridRecommendation(tenantId, userId, userContext);\r\n      recommendations.push(...hybridRecs.map(r => ({ ...r, strategy: 'hybrid', score: r.score * 0.25 })));\r\n\r\n      // Context-aware\r\n      const contextRecs = this._contextAwareRecommendation(tenantId, userId, userContext);\r\n      recommendations.push(...contextRecs.map(r => ({ ...r, strategy: 'context_aware', score: r.score * 0.10 })));\r\n\r\n      // Deduplicate and aggregate scores\r\n      const aggregated = this._aggregateRecommendations(recommendations);\r\n\r\n      // Sort by score\r\n      aggregated.sort((a, b) => b.finalScore - a.finalScore);\r\n\r\n      // Apply limit\r\n      const limit = params.limit || 10;\r\n      const result = {\r\n        tenantId,\r\n        userId,\r\n        recommendations: aggregated.slice(0, limit),\r\n        count: Math.min(limit, aggregated.length),\r\n        generatedAt: new Date(),\r\n        strategies: Array.from(this.strategies.entries())\r\n          .filter(([, s]) => s.active)\r\n          .map(([key, s]) => ({ id: key, ...s }))\r\n      };\r\n\r\n      // Cache results\r\n      this.recommendationCache.set(cacheKey, {\r\n        recommendations: result,\r\n        timestamp: new Date(),\r\n        expiresAt: new Date(Date.now() + (params.cacheTTL || 5 * 60 * 1000))\r\n      });\r\n\r\n      // Store in history\r\n      this._storeRecommendationHistory(tenantId, userId, result);\r\n\r\n      this.stats.totalRecommendations++;\r\n      this.emit('recommendations:generated', { tenantId, userId, count: result.count });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      this.logger.error(`Error generating recommendations: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Record user feedback on recommendation\r\n   * تسجيل ردود فعل المستخدم على التوصية\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @param {String} recommendationId - Recommendation ID\r\n   * @param {Object} feedback - Feedback data\r\n   */\r\n  recordFeedback(tenantId, userId, recommendationId, feedback) {\r\n    try {\r\n      const feedbackRecord = {\r\n        id: `feedback-${uuidv4()}`,\r\n        tenantId,\r\n        userId,\r\n        recommendationId,\r\n        rating: feedback.rating, // 1-5\r\n        helpful: feedback.helpful || feedback.rating >= 4,\r\n        comment: feedback.comment || '',\r\n        action: feedback.action || null, // clicked, ignored, dismissed, etc\r\n        timestamp: new Date()\r\n      };\r\n\r\n      const userKey = `${tenantId}:${userId}`;\r\n      if (!this.userFeedback.has(userKey)) {\r\n        this.userFeedback.set(userKey, []);\r\n      }\r\n      this.userFeedback.get(userKey).push(feedbackRecord);\r\n\r\n      // Update statistics\r\n      this.stats.totalFeedback++;\r\n      if (feedbackRecord.helpful) {\r\n        this.stats.positiveRatings++;\r\n      }\r\n      this.stats.averageRating = this.stats.totalFeedback > 0\r\n        ? (this.stats.positiveRatings / this.stats.totalFeedback) * 5\r\n        : 0;\r\n\r\n      // Update user preferences based on feedback\r\n      this._updateUserPreferences(tenantId, userId, feedbackRecord);\r\n\r\n      // Invalidate cache for this user\r\n      this.recommendationCache.delete(userKey);\r\n\r\n      this.emit('feedback:recorded', { feedbackRecord });\r\n      this.logger.info(`Feedback recorded: ${userId} rated recommendation ${recommendationId}`);\r\n\r\n      return feedbackRecord;\r\n    } catch (error) {\r\n      this.logger.error(`Error recording feedback: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user preferences\r\n   * الحصول على تفضيلات المستخدم\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @returns {Object} User preferences\r\n   */\r\n  getUserPreferences(tenantId, userId) {\r\n    try {\r\n      const key = `${tenantId}:${userId}`;\r\n      return this.userPreferences.get(key) || this._createDefaultPreferences(tenantId, userId);\r\n    } catch (error) {\r\n      this.logger.error(`Error getting user preferences: ${error.message}`);\r\n      return this._createDefaultPreferences(tenantId, userId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update user preferences\r\n   * تحديث تفضيلات المستخدم\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @param {Object} preferences - Preferences to update\r\n   * @returns {Object} Updated preferences\r\n   */\r\n  updateUserPreferences(tenantId, userId, preferences) {\r\n    try {\r\n      const key = `${tenantId}:${userId}`;\r\n      let prefs = this.userPreferences.get(key) || this._createDefaultPreferences(tenantId, userId);\r\n\r\n      // Update allowed fields\r\n      if (preferences.categories) prefs.categories = preferences.categories;\r\n      if (preferences.excludeCategories) prefs.excludeCategories = preferences.excludeCategories;\r\n      if (preferences.topics) prefs.topics = preferences.topics;\r\n      if (preferences.maxRecommendations !== undefined) prefs.maxRecommendations = preferences.maxRecommendations;\r\n      if (preferences.diversity !== undefined) prefs.diversity = preferences.diversity;\r\n      if (preferences.freshness !== undefined) prefs.freshness = preferences.freshness;\r\n\r\n      prefs.updatedAt = new Date();\r\n\r\n      this.userPreferences.set(key, prefs);\r\n\r\n      this.emit('preferences:updated', { tenantId, userId, preferences: prefs });\r\n      this.logger.info(`User preferences updated: ${userId}`);\r\n\r\n      return prefs;\r\n    } catch (error) {\r\n      this.logger.error(`Error updating preferences: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get recommendation history for user\r\n   * الحصول على سجل التوصيات للمستخدم\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @param {Object} filters - Filters\r\n   * @returns {Array} Recommendation history\r\n   */\r\n  getRecommendationHistory(tenantId, userId, filters = {}) {\r\n    try {\r\n      const key = `${tenantId}:${userId}`;\r\n      let history = this.recommendationHistory.get(key) || [];\r\n\r\n      // Apply filters\r\n      if (filters.limit) {\r\n        history = history.slice(-filters.limit);\r\n      }\r\n\r\n      if (filters.startDate) {\r\n        history = history.filter(r => r.generatedAt >= filters.startDate);\r\n      }\r\n\r\n      if (filters.endDate) {\r\n        history = history.filter(r => r.generatedAt <= filters.endDate);\r\n      }\r\n\r\n      return history;\r\n    } catch (error) {\r\n      this.logger.error(`Error getting recommendation history: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user feedback\r\n   * الحصول على ردود فعل المستخدم\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {String} userId - User ID\r\n   * @returns {Array} User feedback\r\n   */\r\n  getUserFeedback(tenantId, userId) {\r\n    try {\r\n      const key = `${tenantId}:${userId}`;\r\n      return this.userFeedback.get(key) || [];\r\n    } catch (error) {\r\n      this.logger.error(`Error getting user feedback: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create A/B test\r\n   * إنشاء اختبار A/B\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {Object} testConfig - Test configuration\r\n   * @returns {Object} A/B test\r\n   */\r\n  createABTest(tenantId, testConfig) {\r\n    try {\r\n      const test = {\r\n        id: `test-${uuidv4()}`,\r\n        tenantId,\r\n        name: testConfig.name,\r\n        description: testConfig.description,\r\n        variants: testConfig.variants || ['control', 'variant_a', 'variant_b'],\r\n        startDate: testConfig.startDate || new Date(),\r\n        endDate: testConfig.endDate,\r\n        status: 'active',\r\n        results: {},\r\n        createdAt: new Date()\r\n      };\r\n\r\n      // Initialize results for each variant\r\n      test.variants.forEach(variant => {\r\n        test.results[variant] = {\r\n          clicks: 0,\r\n          conversions: 0,\r\n          impressions: 0,\r\n          ctr: 0,\r\n          conversionRate: 0\r\n        };\r\n      });\r\n\r\n      this.abTests.set(test.id, test);\r\n\r\n      this.emit('abtest:created', { test });\r\n      this.logger.info(`A/B test created: ${test.name}`);\r\n\r\n      return test;\r\n    } catch (error) {\r\n      this.logger.error(`Error creating A/B test: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Record A/B test event\r\n   * تسجيل حدث اختبار A/B\r\n   * \r\n   * @param {String} testId - Test ID\r\n   * @param {String} variant - Variant name\r\n   * @param {String} eventType - Event type (impression, click, conversion)\r\n   */\r\n  recordABTestEvent(testId, variant, eventType) {\r\n    try {\r\n      const test = this.abTests.get(testId);\r\n      if (!test) {\r\n        throw new Error(`A/B test not found: ${testId}`);\r\n      }\r\n\r\n      const results = test.results[variant];\r\n      if (!results) {\r\n        throw new Error(`Variant not found: ${variant}`);\r\n      }\r\n\r\n      if (eventType === 'impression') {\r\n        results.impressions++;\r\n      } else if (eventType === 'click') {\r\n        results.clicks++;\r\n      } else if (eventType === 'conversion') {\r\n        results.conversions++;\r\n      }\r\n\r\n      // Calculate metrics\r\n      results.ctr = results.impressions > 0 ? (results.clicks / results.impressions) * 100 : 0;\r\n      results.conversionRate = results.clicks > 0 ? (results.conversions / results.clicks) * 100 : 0;\r\n\r\n      this.emit('abtest:event_recorded', { testId, variant, eventType });\r\n    } catch (error) {\r\n      this.logger.error(`Error recording A/B test event: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get A/B test results\r\n   * الحصول على نتائج اختبار A/B\r\n   * \r\n   * @param {String} testId - Test ID\r\n   * @returns {Object} Test results\r\n   */\r\n  getABTestResults(testId) {\r\n    try {\r\n      return this.abTests.get(testId) || null;\r\n    } catch (error) {\r\n      this.logger.error(`Error getting A/B test results: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Personalize recommendations for tenant\r\n   * شخصنة التوصيات للالتزام\r\n   * \r\n   * @param {String} tenantId - Tenant ID\r\n   * @param {Array} users - Users array\r\n   * @param {Object} options - Options\r\n   * @returns {Object} Personalized recommendations\r\n   */\r\n  personalizeForTenant(tenantId, users, options = {}) {\r\n    try {\r\n      const personalizedRecs = {};\r\n\r\n      users.forEach(user => {\r\n        const recs = this.generateRecommendations(tenantId, user.id, options);\r\n        personalizedRecs[user.id] = recs;\r\n      });\r\n\r\n      return {\r\n        tenantId,\r\n        userCount: users.length,\r\n        recommendations: personalizedRecs,\r\n        generatedAt: new Date()\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Error personalizing for tenant: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get recommendations statistics\r\n   * الحصول على إحصائيات التوصيات\r\n   * \r\n   * @returns {Object} Statistics\r\n   */\r\n  getStatistics() {\r\n    try {\r\n      return {\r\n        totalRecommendations: this.stats.totalRecommendations,\r\n        totalFeedback: this.stats.totalFeedback,\r\n        positiveRatings: this.stats.positiveRatings,\r\n        averageRating: parseFloat(this.stats.averageRating.toFixed(2)),\r\n        cacheHitRate: this.stats.totalRecommendations > 0\r\n          ? Math.round((this.stats.cacheHits / (this.stats.cacheHits + this.stats.cacheMisses)) * 100)\r\n          : 0,\r\n        cachedUsers: this.recommendationCache.size,\r\n        activeABTests: Array.from(this.abTests.values()).filter(t => t.status === 'active').length,\r\n        totalUsers: this.userPreferences.size,\r\n        strategies: Array.from(this.strategies.entries()).map(([key, s]) => ({\r\n          id: key,\r\n          name: s.name,\r\n          active: s.active,\r\n          weight: s.weight\r\n        }))\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Error getting statistics: ${error.message}`);\r\n      return {};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user context\r\n   * الحصول على سياق المستخدم\r\n   * \r\n   * @private\r\n   */\r\n  _getUserContext(tenantId, userId) {\r\n    const key = `${tenantId}:${userId}`;\r\n    const prefs = this.userPreferences.get(key) || this._createDefaultPreferences(tenantId, userId);\r\n    const feedback = this.userFeedback.get(key) || [];\r\n    const history = this.recommendationHistory.get(key) || [];\r\n\r\n    return {\r\n      preferences: prefs,\r\n      feedbackCount: feedback.length,\r\n      positiveRatings: feedback.filter(f => f.helpful).length,\r\n      recentRecommendations: history.slice(-5),\r\n      engagementLevel: feedback.length / Math.max(1, history.length)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Create default preferences\r\n   * إنشاء التفضيلات الافتراضية\r\n   * \r\n   * @private\r\n   */\r\n  _createDefaultPreferences(tenantId, userId) {\r\n    const prefs = {\r\n      tenantId,\r\n      userId,\r\n      categories: ['rehabilitation', 'education', 'performance'],\r\n      excludeCategories: [],\r\n      topics: [],\r\n      maxRecommendations: 10,\r\n      diversity: 0.5, // 0-1, how diverse recommendations should be\r\n      freshness: 0.3, // 0-1, preference for recent items\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    this.userPreferences.set(`${tenantId}:${userId}`, prefs);\r\n    return prefs;\r\n  }\r\n\r\n  /**\r\n   * Collaborative filtering recommendations\r\n   * توصيات تصفية التعاون\r\n   * \r\n   * @private\r\n   */\r\n  _collaborativeFiltering(tenantId, userId, context) {\r\n    try {\r\n      const recommendations = [\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: 'Similar User Preferences',\r\n          description: 'Based on users with similar interests',\r\n          category: 'rehabilitation',\r\n          score: 0.9,\r\n          reasoning: 'Users like you found this helpful'\r\n        },\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: 'Trending Among Your Peers',\r\n          description: 'Popular items in your user group',\r\n          category: 'education',\r\n          score: 0.85,\r\n          reasoning: 'Popular in your organization'\r\n        }\r\n      ];\r\n\r\n      return recommendations;\r\n    } catch (error) {\r\n      this.logger.error(`Error in collaborative filtering: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Content-based filtering recommendations\r\n   * توصيات تصفية القائمة على المحتوى\r\n   * \r\n   * @private\r\n   */\r\n  _contentBasedFiltering(tenantId, userId, context) {\r\n    try {\r\n      const recommendations = [\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: 'Related to Your Interests',\r\n          description: 'Content matching your preferences',\r\n          category: context.preferences.categories[0],\r\n          score: 0.88,\r\n          reasoning: 'Matches your saved preferences'\r\n        },\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: 'Advanced Topics',\r\n          description: 'Higher level materials in your area',\r\n          category: 'education',\r\n          score: 0.82,\r\n          reasoning: 'Based on your learning level'\r\n        }\r\n      ];\r\n\r\n      return recommendations;\r\n    } catch (error) {\r\n      this.logger.error(`Error in content-based filtering: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hybrid recommendation approach\r\n   * منهج التوصية الهجين\r\n   * \r\n   * @private\r\n   */\r\n  _hybridRecommendation(tenantId, userId, context) {\r\n    try {\r\n      const recommendations = [\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: 'Personalized Learning Path',\r\n          description: 'Custom learning sequence',\r\n          category: 'education',\r\n          score: 0.87,\r\n          reasoning: 'Combines your history and preferences'\r\n        }\r\n      ];\r\n\r\n      return recommendations;\r\n    } catch (error) {\r\n      this.logger.error(`Error in hybrid recommendation: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Context-aware recommendation\r\n   * توصية مراعية للسياق\r\n   * \r\n   * @private\r\n   */\r\n  _contextAwareRecommendation(tenantId, userId, context) {\r\n    try {\r\n      const now = new Date();\r\n      const hour = now.getHours();\r\n      let timeContext = 'general';\r\n      \r\n      if (hour >= 6 && hour < 12) timeContext = 'morning';\r\n      else if (hour >= 12 && hour < 18) timeContext = 'afternoon';\r\n      else timeContext = 'evening';\r\n\r\n      const recommendations = [\r\n        {\r\n          id: `rec-${uuidv4()}`,\r\n          title: `Perfect for ${timeContext} sessions`,\r\n          description: 'Optimized for this time of day',\r\n          category: 'performance',\r\n          score: 0.80,\r\n          reasoning: `Recommended for ${timeContext} engagement`\r\n        }\r\n      ];\r\n\r\n      return recommendations;\r\n    } catch (error) {\r\n      this.logger.error(`Error in context-aware recommendation: ${error.message}`);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Aggregate recommendations from all strategies\r\n   * دمج التوصيات من جميع الاستراتيجيات\r\n   * \r\n   * @private\r\n   */\r\n  _aggregateRecommendations(recommendations) {\r\n    const aggregated = new Map();\r\n\r\n    recommendations.forEach(rec => {\r\n      const key = rec.id;\r\n      if (aggregated.has(key)) {\r\n        const existing = aggregated.get(key);\r\n        existing.score += rec.score;\r\n        existing.strategies.push(rec.strategy);\r\n      } else {\r\n        aggregated.set(key, {\r\n          ...rec,\r\n          finalScore: rec.score,\r\n          strategies: [rec.strategy]\r\n        });\r\n      }\r\n    });\r\n\r\n    return Array.from(aggregated.values()).map(rec => ({\r\n      ...rec,\r\n      finalScore: parseFloat(rec.finalScore.toFixed(3))\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Store recommendation in history\r\n   * تخزين التوصية في السجل\r\n   * \r\n   * @private\r\n   */\r\n  _storeRecommendationHistory(tenantId, userId, recommendations) {\r\n    const key = `${tenantId}:${userId}`;\r\n    if (!this.recommendationHistory.has(key)) {\r\n      this.recommendationHistory.set(key, []);\r\n    }\r\n\r\n    const historyRecord = {\r\n      ...recommendations,\r\n      storedAt: new Date()\r\n    };\r\n\r\n    const history = this.recommendationHistory.get(key);\r\n    history.push(historyRecord);\r\n\r\n    // Keep only last 100 records\r\n    if (history.length > 100) {\r\n      this.recommendationHistory.set(key, history.slice(-100));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update user preferences based on feedback\r\n   * تحديث تفضيلات المستخدم بناءً على الملاحظات\r\n   * \r\n   * @private\r\n   */\r\n  _updateUserPreferences(tenantId, userId, feedback) {\r\n    try {\r\n      const key = `${tenantId}:${userId}`;\r\n      let prefs = this.userPreferences.get(key);\r\n\r\n      if (prefs && feedback.helpful) {\r\n        // Boost category if feedback was positive\r\n        if (!prefs.categories.includes(feedback.category)) {\r\n          prefs.categories.push(feedback.category);\r\n        }\r\n\r\n        prefs.updatedAt = new Date();\r\n        this.userPreferences.set(key, prefs);\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(`Error updating preferences from feedback: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = new RecommendationsEngineService();\r\n"],"mappings":"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","ignoreList":[]}