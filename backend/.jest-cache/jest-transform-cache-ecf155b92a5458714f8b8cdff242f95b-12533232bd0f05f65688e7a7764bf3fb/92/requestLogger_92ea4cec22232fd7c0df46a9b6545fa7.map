{"version":3,"names":["fs","require","path","logsDir","join","__dirname","existsSync","mkdirSync","recursive","requestLogFile","metricsFile","colors","reset","green","yellow","red","blue","cyan","getStatusColor","status","getMethodColor","method","methodColors","GET","POST","PUT","PATCH","DELETE","OPTIONS","formatBytes","bytes","k","sizes","i","Math","floor","log","round","pow","logRequestToFile","req","res","duration","timestamp","Date","toISOString","logEntry","url","originalUrl","query","statusCode","ip","connection","remoteAddress","userAgent","get","userId","user","_id","contentLength","responseTime","logMessage","appendFileSync","metricsExist","metrics","JSON","parse","readFileSync","push","recentMetrics","slice","writeFileSync","stringify","getRequestSize","parseInt","module","exports","next","startTime","now","startHrTime","process","hrtime","originalSend","send","responseSize","data","Buffer","byteLength","on","seconds","nanoseconds","nanosecondDuration","milliseconds","requestSize","totalSize","methodColor","statusColor","toLocaleTimeString","console","error","warn","err","set"],"sources":["requestLogger.js"],"sourcesContent":["/**\r\n * =====================================================\r\n * ADVANCED REQUEST LOGGER MIDDLEWARE - Phase 6\r\n * =====================================================\r\n * Comprehensive request/response logging and tracking\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// Ensure logs directory exists\r\nconst logsDir = path.join(__dirname, '../logs');\r\nif (!fs.existsSync(logsDir)) {\r\n  fs.mkdirSync(logsDir, { recursive: true });\r\n}\r\n\r\n// Log file paths\r\nconst requestLogFile = path.join(logsDir, 'requests.log');\r\nconst metricsFile = path.join(logsDir, 'metrics.json');\r\n\r\n/**\r\n * Color codes for terminal output\r\n */\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  green: '\\x1b[32m',\r\n  yellow: '\\x1b[33m',\r\n  red: '\\x1b[31m',\r\n  blue: '\\x1b[34m',\r\n  cyan: '\\x1b[36m',\r\n};\r\n\r\n/**\r\n * Get status color based on HTTP status code\r\n */\r\nconst getStatusColor = (status) => {\r\n  if (status < 300) return colors.green;\r\n  if (status < 400) return colors.blue;\r\n  if (status < 500) return colors.yellow;\r\n  return colors.red;\r\n};\r\n\r\n/**\r\n * Get HTTP method color\r\n */\r\nconst getMethodColor = (method) => {\r\n  const methodColors = {\r\n    GET: colors.blue,\r\n    POST: colors.green,\r\n    PUT: colors.yellow,\r\n    PATCH: colors.cyan,\r\n    DELETE: colors.red,\r\n    OPTIONS: colors.reset,\r\n  };\r\n  return methodColors[method] || colors.reset;\r\n};\r\n\r\n/**\r\n * Format bytes to human readable\r\n */\r\nconst formatBytes = (bytes) => {\r\n  if (bytes === 0) return '0 B';\r\n  const k = 1024;\r\n  const sizes = ['B', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];\r\n};\r\n\r\n/**\r\n * Log request to file\r\n */\r\nconst logRequestToFile = (req, res, duration) => {\r\n  const timestamp = new Date().toISOString();\r\n  const logEntry = {\r\n    timestamp,\r\n    method: req.method,\r\n    url: req.originalUrl,\r\n    path: req.path,\r\n    query: req.query,\r\n    statusCode: res.statusCode,\r\n    duration: `${duration}ms`,\r\n    ip: req.ip || req.connection.remoteAddress,\r\n    userAgent: req.get('user-agent'),\r\n    userId: req.user?._id || 'anonymous',\r\n    contentLength: req.get('content-length') || 0,\r\n    responseTime: new Date().toISOString(),\r\n  };\r\n\r\n  const logMessage = `${timestamp} ${req.method} ${req.originalUrl} - ${res.statusCode} - ${duration}ms - ${req.ip || 'unknown'}\\n`;\r\n\r\n  fs.appendFileSync(requestLogFile, logMessage);\r\n\r\n  // Write metrics\r\n  const metricsExist = fs.existsSync(metricsFile);\r\n  const metrics = metricsExist ? JSON.parse(fs.readFileSync(metricsFile, 'utf8')) : [];\r\n  metrics.push(logEntry);\r\n  // Keep only last 5000 entries\r\n  const recentMetrics = metrics.slice(-5000);\r\n  fs.writeFileSync(metricsFile, JSON.stringify(recentMetrics, null, 2));\r\n};\r\n\r\n/**\r\n * Parse request body size\r\n */\r\nconst getRequestSize = (req) => {\r\n  const contentLength = req.get('content-length');\r\n  return contentLength ? parseInt(contentLength) : 0;\r\n};\r\n\r\n/**\r\n * Advanced request logger middleware\r\n */\r\nmodule.exports = (req, res, next) => {\r\n  // Record start time\r\n  const startTime = Date.now();\r\n  const startHrTime = process.hrtime();\r\n\r\n  // Store original send method\r\n  const originalSend = res.send;\r\n  let responseSize = 0;\r\n\r\n  // Override send to capture response details\r\n  res.send = function (data) {\r\n    // Calculate response size\r\n    if (data) {\r\n      responseSize = Buffer.byteLength(JSON.stringify(data));\r\n    }\r\n\r\n    // Call original send\r\n    res.send = originalSend;\r\n    return res.send(data);\r\n  };\r\n\r\n  // Listen to finish event\r\n  res.on('finish', () => {\r\n    const duration = Date.now() - startTime;\r\n    const [seconds, nanoseconds] = process.hrtime(startHrTime);\r\n    const nanosecondDuration = seconds * 1000000000 + nanoseconds;\r\n    const milliseconds = nanosecondDuration / 1000000;\r\n\r\n    const method = req.method;\r\n    const url = req.originalUrl;\r\n    const status = res.statusCode;\r\n    const requestSize = getRequestSize(req);\r\n    const totalSize = requestSize + responseSize;\r\n\r\n    // Console logging with colors\r\n    const methodColor = getMethodColor(method);\r\n    const statusColor = getStatusColor(status);\r\n\r\n    const logMessage =\r\n      `${colors.cyan}[${new Date().toLocaleTimeString()}]${colors.reset} ` +\r\n      `${methodColor}${method}${colors.reset} ` +\r\n      `${colors.reset}${url}${colors.reset} ` +\r\n      `${statusColor}${status}${colors.reset} ` +\r\n      `${colors.yellow}${Math.round(milliseconds)}ms${colors.reset} ` +\r\n      `${colors.blue}${formatBytes(totalSize)}${colors.reset}`;\r\n\r\n    // Different logging level based on status\r\n    if (status >= 500) {\r\n      console.error(`❌ ${logMessage}`);\r\n    } else if (status >= 400) {\r\n      console.warn(`⚠️  ${logMessage}`);\r\n    } else {\r\n      console.log(`✓  ${logMessage}`);\r\n    }\r\n\r\n    // Log to file\r\n    try {\r\n      logRequestToFile(req, res, Math.round(milliseconds));\r\n    } catch (err) {\r\n      console.error('Failed to log request to file:', err);\r\n    }\r\n\r\n    // Add custom headers\r\n    res.set('X-Response-Time', `${Math.round(milliseconds)}ms`);\r\n    res.set('X-Response-Size', formatBytes(responseSize));\r\n    res.set('X-Request-Time', new Date().toISOString());\r\n  });\r\n\r\n  next();\r\n};\r\n"],"mappings":"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","ignoreList":[]}