6ae448aff65693a6b4d82cb6aa01c95a
/**
 * Advanced SSO Authentication Middleware
 * Middleware متقدم لـ SSO مع دعم OAuth 2.0 و OpenID Connect
 */

const jwt = require('jwt-simple');
const SSOService = require('../services/sso.service');
const logger = require('../utils/logger');
class SSOAuthMiddleware {
  constructor() {
    this.ssoService = new SSOService();
    this.JWT_SECRET = process.env.JWT_SECRET || 'sso-secret-key';
  }

  /**
   * التحقق من SSO Token - Middleware رئيسي
   * Verify SSO token middleware
   */
  verifySSOToken = (options = {}) => {
    return async (req, res, next) => {
      try {
        const token = this.extractToken(req);
        if (!token) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: 'No token provided',
            code: 'MISSING_TOKEN'
          });
        }

        // Get session ID from request or token
        const sessionId = req.headers['x-session-id'] || this.extractSessionId(token);
        if (!sessionId) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: 'No session ID provided',
            code: 'MISSING_SESSION_ID'
          });
        }

        // Verify session
        const verification = await this.ssoService.verifySession(sessionId, token);
        if (!verification.valid) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: verification.error,
            code: 'INVALID_SESSION'
          });
        }

        // Attach user and session info to request
        req.user = verification.user;
        req.session = verification.session;
        req.sessionId = sessionId;

        // Update activity tracking
        req.activityMetadata = {
          timestamp: Date.now(),
          endpoint: req.originalUrl,
          method: req.method,
          ip: this.getClientIp(req),
          userAgent: req.get('user-agent')
        };
        next();
      } catch (error) {
        logger.error('SSO token verification failed:', error);
        return res.status(401).json({
          success: false,
          error: 'unauthorized',
          message: 'Token verification failed',
          code: 'TOKEN_VERIFICATION_FAILED'
        });
      }
    };
  };

  /**
   * التحقق الاختياري من Token
   * Optional SSO verification
   */
  verifyOptionalSSO = async (req, res, next) => {
    try {
      const token = this.extractToken(req);
      if (token) {
        const sessionId = req.headers['x-session-id'] || this.extractSessionId(token);
        if (sessionId) {
          const verification = await this.ssoService.verifySession(sessionId, token);
          if (verification.valid) {
            req.user = verification.user;
            req.session = verification.session;
            req.sessionId = sessionId;
          }
        }
      }
      next();
    } catch (error) {
      logger.debug('Optional SSO verification failed:', error.message);
      // Continue without authentication
      next();
    }
  };

  /**
   * التحقق من الأدوار والصلاحيات
   * Role and permission verification
   */
  requireRole = (allowedRoles = []) => {
    return async (req, res, next) => {
      try {
        if (!req.user) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: 'User not authenticated',
            code: 'NOT_AUTHENTICATED'
          });
        }
        const userRole = req.user.role || req.user.roles?.[0];
        if (!allowedRoles.includes(userRole)) {
          logger.warn(`Unauthorized role access: user ${req.user.userId} attempted to access ${req.originalUrl}`);
          return res.status(403).json({
            success: false,
            error: 'forbidden',
            message: 'Insufficient permissions for this operation',
            code: 'FORBIDDEN',
            requiredRoles: allowedRoles
          });
        }
        next();
      } catch (error) {
        logger.error('Role verification failed:', error);
        return res.status(500).json({
          success: false,
          error: 'internal_error',
          message: 'Role verification failed'
        });
      }
    };
  };

  /**
   * التحقق من الصلاحيات الدقيقة
   * Fine-grained permission verification
   */
  requirePermission = (requiredPermissions = []) => {
    return async (req, res, next) => {
      try {
        if (!req.user) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: 'User not authenticated'
          });
        }
        const userPermissions = req.user.permissions || [];
        const hasPermission = requiredPermissions.some(perm => userPermissions.includes(perm));
        if (!hasPermission) {
          return res.status(403).json({
            success: false,
            error: 'forbidden',
            message: 'Insufficient permissions',
            requiredPermissions
          });
        }
        next();
      } catch (error) {
        logger.error('Permission verification failed:', error);
        return res.status(500).json({
          success: false,
          error: 'internal_error',
          message: 'Permission verification failed'
        });
      }
    };
  };

  /**
   * التحقق من الجلسة المتعددة الأجهزة
   * Multi-device session verification
   */
  verifyMultiDeviceSession = (options = {}) => {
    return async (req, res, next) => {
      try {
        const token = this.extractToken(req);
        const sessionId = req.headers['x-session-id'];
        const deviceId = req.headers['x-device-id'];
        if (!token || !sessionId || !deviceId) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: 'Missing authentication headers'
          });
        }
        const verification = await this.ssoService.verifySession(sessionId, token);
        if (!verification.valid) {
          return res.status(401).json({
            success: false,
            error: 'unauthorized',
            message: verification.error
          });
        }

        // Check if device ID matches
        if (verification.session.metadata.deviceId !== deviceId) {
          logger.warn(`Device mismatch for session ${sessionId}`);
          return res.status(403).json({
            success: false,
            error: 'forbidden',
            message: 'Device authentication failed',
            code: 'DEVICE_MISMATCH'
          });
        }
        req.user = verification.user;
        req.session = verification.session;
        req.sessionId = sessionId;
        req.deviceId = deviceId;
        next();
      } catch (error) {
        logger.error('Multi-device verification failed:', error);
        return res.status(401).json({
          success: false,
          error: 'unauthorized',
          message: 'Session verification failed'
        });
      }
    };
  };

  /**
   * Rate limiting بناءً على المستخدم
   * Per-user rate limiting
   */
  userRateLimit = (options = {}) => {
    const maxRequests = options.maxRequests || 100;
    const windowMs = options.windowMs || 60000; // 1 minute
    const storage = new Map();
    return async (req, res, next) => {
      try {
        const userId = req.user?.userId || req.ip;
        const now = Date.now();
        const key = `ratelimit:${userId}`;
        if (!storage.has(key)) {
          storage.set(key, {
            count: 1,
            resetAt: now + windowMs
          });
        } else {
          const userData = storage.get(key);
          if (now > userData.resetAt) {
            userData.count = 1;
            userData.resetAt = now + windowMs;
          } else {
            userData.count++;
          }
          if (userData.count > maxRequests) {
            return res.status(429).json({
              success: false,
              error: 'too_many_requests',
              message: 'Rate limit exceeded',
              retryAfter: Math.ceil((userData.resetAt - now) / 1000)
            });
          }
        }
        next();
      } catch (error) {
        logger.error('Rate limiting failed:', error);
        next();
      }
    };
  };

  /**
   * التحقق من CORS آمن مع SSO
   * Secure CORS verification with SSO
   */
  verifySSOMixCors = (options = {}) => {
    return async (req, res, next) => {
      try {
        const origin = req.get('origin');
        const token = this.extractToken(req);

        // For requests with SSO token, verify token first
        if (token) {
          const sessionId = req.headers['x-session-id'];
          if (sessionId) {
            const verification = await this.ssoService.verifySession(sessionId, token);
            if (verification.valid) {
              req.user = verification.user;
              req.sessionId = sessionId;
            }
          }
        }

        // Verify CORS origin
        const allowedOrigins = (process.env.ALLOWED_ORIGINS || '').split(',');
        if (allowedOrigins.includes(origin) || allowedOrigins.includes('*')) {
          res.set('Access-Control-Allow-Origin', origin || '*');
        }
        next();
      } catch (error) {
        logger.error('CORS SSO verification failed:', error);
        return res.status(403).json({
          success: false,
          error: 'forbidden',
          message: 'CORS verification failed'
        });
      }
    };
  };

  /**
   * تسجيل النشاط والتدقيق
   * Activity logging and audit trail
   */
  auditLog = async (req, res, next) => {
    try {
      const original = res.json.bind(res);
      res.json = function (data) {
        // Log the request after sending response
        setImmediate(() => {
          const auditEntry = {
            timestamp: new Date().toISOString(),
            userId: req.user?.userId || 'anonymous',
            action: req.method,
            endpoint: req.originalUrl,
            statusCode: res.statusCode,
            metadata: {
              ip: this.getClientIp(req),
              userAgent: req.get('user-agent'),
              sessionId: req.sessionId
            }
          };
          logger.info('AUDIT', auditEntry);
        });
        return original(data);
      };
      next();
    } catch (error) {
      logger.error('Audit logging failed:', error);
      next();
    }
  };

  /**
   * Helper method: Extract token from request
   */
  extractToken(req) {
    // Check Authorization header
    const authHeader = req.headers.authorization;
    if (authHeader?.startsWith('Bearer ')) {
      return authHeader.slice(7);
    }

    // Check X-Access-Token header
    if (req.headers['x-access-token']) {
      return req.headers['x-access-token'];
    }

    // Check cookies
    if (req.cookies?.accessToken) {
      return req.cookies.accessToken;
    }
    return null;
  }

  /**
   * Helper method: Extract session ID from token
   */
  extractSessionId(token) {
    try {
      const decoded = jwt.decode(token, this.JWT_SECRET);
      return decoded.sessionId;
    } catch (error) {
      return null;
    }
  }

  /**
   * Helper method: Get client IP
   */
  getClientIp(req) {
    return req.headers['x-forwarded-for']?.split(',')[0].trim() || req.socket.remoteAddress || 'unknown';
  }
}

// Export singleton instance and factory function
const ssoAuthMiddleware = new SSOAuthMiddleware();
module.exports = {
  ssoAuthMiddleware,
  verifySSOToken: () => ssoAuthMiddleware.verifySSOToken(),
  requireRole: roles => ssoAuthMiddleware.requireRole(roles),
  requirePermission: perms => ssoAuthMiddleware.requirePermission(perms),
  verifyOptionalSSO: ssoAuthMiddleware.verifyOptionalSSO.bind(ssoAuthMiddleware),
  verifyMultiDeviceSession: () => ssoAuthMiddleware.verifyMultiDeviceSession(),
  userRateLimit: opts => ssoAuthMiddleware.userRateLimit(opts),
  verifySSOMixCors: opts => ssoAuthMiddleware.verifySSOMixCors(opts),
  auditLog: ssoAuthMiddleware.auditLog.bind(ssoAuthMiddleware)
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3QiLCJyZXF1aXJlIiwiU1NPU2VydmljZSIsImxvZ2dlciIsIlNTT0F1dGhNaWRkbGV3YXJlIiwiY29uc3RydWN0b3IiLCJzc29TZXJ2aWNlIiwiSldUX1NFQ1JFVCIsInByb2Nlc3MiLCJlbnYiLCJ2ZXJpZnlTU09Ub2tlbiIsIm9wdGlvbnMiLCJyZXEiLCJyZXMiLCJuZXh0IiwidG9rZW4iLCJleHRyYWN0VG9rZW4iLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImVycm9yIiwibWVzc2FnZSIsImNvZGUiLCJzZXNzaW9uSWQiLCJoZWFkZXJzIiwiZXh0cmFjdFNlc3Npb25JZCIsInZlcmlmaWNhdGlvbiIsInZlcmlmeVNlc3Npb24iLCJ2YWxpZCIsInVzZXIiLCJzZXNzaW9uIiwiYWN0aXZpdHlNZXRhZGF0YSIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJlbmRwb2ludCIsIm9yaWdpbmFsVXJsIiwibWV0aG9kIiwiaXAiLCJnZXRDbGllbnRJcCIsInVzZXJBZ2VudCIsImdldCIsInZlcmlmeU9wdGlvbmFsU1NPIiwiZGVidWciLCJyZXF1aXJlUm9sZSIsImFsbG93ZWRSb2xlcyIsInVzZXJSb2xlIiwicm9sZSIsInJvbGVzIiwiaW5jbHVkZXMiLCJ3YXJuIiwidXNlcklkIiwicmVxdWlyZWRSb2xlcyIsInJlcXVpcmVQZXJtaXNzaW9uIiwicmVxdWlyZWRQZXJtaXNzaW9ucyIsInVzZXJQZXJtaXNzaW9ucyIsInBlcm1pc3Npb25zIiwiaGFzUGVybWlzc2lvbiIsInNvbWUiLCJwZXJtIiwidmVyaWZ5TXVsdGlEZXZpY2VTZXNzaW9uIiwiZGV2aWNlSWQiLCJtZXRhZGF0YSIsInVzZXJSYXRlTGltaXQiLCJtYXhSZXF1ZXN0cyIsIndpbmRvd01zIiwic3RvcmFnZSIsIk1hcCIsImtleSIsImhhcyIsInNldCIsImNvdW50IiwicmVzZXRBdCIsInVzZXJEYXRhIiwicmV0cnlBZnRlciIsIk1hdGgiLCJjZWlsIiwidmVyaWZ5U1NPTWl4Q29ycyIsIm9yaWdpbiIsImFsbG93ZWRPcmlnaW5zIiwiQUxMT1dFRF9PUklHSU5TIiwic3BsaXQiLCJhdWRpdExvZyIsIm9yaWdpbmFsIiwiYmluZCIsImRhdGEiLCJzZXRJbW1lZGlhdGUiLCJhdWRpdEVudHJ5IiwidG9JU09TdHJpbmciLCJhY3Rpb24iLCJzdGF0dXNDb2RlIiwiaW5mbyIsImF1dGhIZWFkZXIiLCJhdXRob3JpemF0aW9uIiwic3RhcnRzV2l0aCIsInNsaWNlIiwiY29va2llcyIsImFjY2Vzc1Rva2VuIiwiZGVjb2RlZCIsImRlY29kZSIsInRyaW0iLCJzb2NrZXQiLCJyZW1vdGVBZGRyZXNzIiwic3NvQXV0aE1pZGRsZXdhcmUiLCJtb2R1bGUiLCJleHBvcnRzIiwicGVybXMiLCJvcHRzIl0sInNvdXJjZXMiOlsic3NvLWF1dGgubWlkZGxld2FyZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQWR2YW5jZWQgU1NPIEF1dGhlbnRpY2F0aW9uIE1pZGRsZXdhcmVcclxuICogTWlkZGxld2FyZSDZhdiq2YLYr9mFINmE2YAgU1NPINmF2Lkg2K/YudmFIE9BdXRoIDIuMCDZiCBPcGVuSUQgQ29ubmVjdFxyXG4gKi9cclxuXHJcbmNvbnN0IGp3dCA9IHJlcXVpcmUoJ2p3dC1zaW1wbGUnKTtcclxuY29uc3QgU1NPU2VydmljZSA9IHJlcXVpcmUoJy4uL3NlcnZpY2VzL3Nzby5zZXJ2aWNlJyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJy4uL3V0aWxzL2xvZ2dlcicpO1xyXG5cclxuY2xhc3MgU1NPQXV0aE1pZGRsZXdhcmUge1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5zc29TZXJ2aWNlID0gbmV3IFNTT1NlcnZpY2UoKTtcclxuICAgIHRoaXMuSldUX1NFQ1JFVCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgJ3Nzby1zZWNyZXQta2V5JztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqINin2YTYqtit2YLZgiDZhdmGIFNTTyBUb2tlbiAtIE1pZGRsZXdhcmUg2LHYptmK2LPZilxyXG4gICAqIFZlcmlmeSBTU08gdG9rZW4gbWlkZGxld2FyZVxyXG4gICAqL1xyXG4gIHZlcmlmeVNTT1Rva2VuID0gKG9wdGlvbnMgPSB7fSkgPT4ge1xyXG4gICAgcmV0dXJuIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHRva2VuID0gdGhpcy5leHRyYWN0VG9rZW4ocmVxKTtcclxuXHJcbiAgICAgICAgaWYgKCF0b2tlbikge1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ05vIHRva2VuIHByb3ZpZGVkJyxcclxuICAgICAgICAgICAgY29kZTogJ01JU1NJTkdfVE9LRU4nXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEdldCBzZXNzaW9uIElEIGZyb20gcmVxdWVzdCBvciB0b2tlblxyXG4gICAgICAgIGNvbnN0IHNlc3Npb25JZCA9IHJlcS5oZWFkZXJzWyd4LXNlc3Npb24taWQnXSB8fCB0aGlzLmV4dHJhY3RTZXNzaW9uSWQodG9rZW4pO1xyXG5cclxuICAgICAgICBpZiAoIXNlc3Npb25JZCkge1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ05vIHNlc3Npb24gSUQgcHJvdmlkZWQnLFxyXG4gICAgICAgICAgICBjb2RlOiAnTUlTU0lOR19TRVNTSU9OX0lEJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBWZXJpZnkgc2Vzc2lvblxyXG4gICAgICAgIGNvbnN0IHZlcmlmaWNhdGlvbiA9IGF3YWl0IHRoaXMuc3NvU2VydmljZS52ZXJpZnlTZXNzaW9uKHNlc3Npb25JZCwgdG9rZW4pO1xyXG5cclxuICAgICAgICBpZiAoIXZlcmlmaWNhdGlvbi52YWxpZCkge1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogdmVyaWZpY2F0aW9uLmVycm9yLFxyXG4gICAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9TRVNTSU9OJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBBdHRhY2ggdXNlciBhbmQgc2Vzc2lvbiBpbmZvIHRvIHJlcXVlc3RcclxuICAgICAgICByZXEudXNlciA9IHZlcmlmaWNhdGlvbi51c2VyO1xyXG4gICAgICAgIHJlcS5zZXNzaW9uID0gdmVyaWZpY2F0aW9uLnNlc3Npb247XHJcbiAgICAgICAgcmVxLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcclxuXHJcbiAgICAgICAgLy8gVXBkYXRlIGFjdGl2aXR5IHRyYWNraW5nXHJcbiAgICAgICAgcmVxLmFjdGl2aXR5TWV0YWRhdGEgPSB7XHJcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXHJcbiAgICAgICAgICBlbmRwb2ludDogcmVxLm9yaWdpbmFsVXJsLFxyXG4gICAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxyXG4gICAgICAgICAgaXA6IHRoaXMuZ2V0Q2xpZW50SXAocmVxKSxcclxuICAgICAgICAgIHVzZXJBZ2VudDogcmVxLmdldCgndXNlci1hZ2VudCcpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbmV4dCgpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignU1NPIHRva2VuIHZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICAgIG1lc3NhZ2U6ICdUb2tlbiB2ZXJpZmljYXRpb24gZmFpbGVkJyxcclxuICAgICAgICAgIGNvZGU6ICdUT0tFTl9WRVJJRklDQVRJT05fRkFJTEVEJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqINin2YTYqtit2YLZgiDYp9mE2KfYrtiq2YrYp9ix2Yog2YXZhiBUb2tlblxyXG4gICAqIE9wdGlvbmFsIFNTTyB2ZXJpZmljYXRpb25cclxuICAgKi9cclxuICB2ZXJpZnlPcHRpb25hbFNTTyA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmV4dHJhY3RUb2tlbihyZXEpO1xyXG5cclxuICAgICAgaWYgKHRva2VuKSB7XHJcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLmhlYWRlcnNbJ3gtc2Vzc2lvbi1pZCddIHx8IHRoaXMuZXh0cmFjdFNlc3Npb25JZCh0b2tlbik7XHJcblxyXG4gICAgICAgIGlmIChzZXNzaW9uSWQpIHtcclxuICAgICAgICAgIGNvbnN0IHZlcmlmaWNhdGlvbiA9IGF3YWl0IHRoaXMuc3NvU2VydmljZS52ZXJpZnlTZXNzaW9uKHNlc3Npb25JZCwgdG9rZW4pO1xyXG5cclxuICAgICAgICAgIGlmICh2ZXJpZmljYXRpb24udmFsaWQpIHtcclxuICAgICAgICAgICAgcmVxLnVzZXIgPSB2ZXJpZmljYXRpb24udXNlcjtcclxuICAgICAgICAgICAgcmVxLnNlc3Npb24gPSB2ZXJpZmljYXRpb24uc2Vzc2lvbjtcclxuICAgICAgICAgICAgcmVxLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIG5leHQoKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGxvZ2dlci5kZWJ1ZygnT3B0aW9uYWwgU1NPIHZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIC8vIENvbnRpbnVlIHdpdGhvdXQgYXV0aGVudGljYXRpb25cclxuICAgICAgbmV4dCgpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqINin2YTYqtit2YLZgiDZhdmGINin2YTYo9iv2YjYp9ixINmI2KfZhNi12YTYp9it2YrYp9iqXHJcbiAgICogUm9sZSBhbmQgcGVybWlzc2lvbiB2ZXJpZmljYXRpb25cclxuICAgKi9cclxuICByZXF1aXJlUm9sZSA9IChhbGxvd2VkUm9sZXMgPSBbXSkgPT4ge1xyXG4gICAgcmV0dXJuIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3VuYXV0aG9yaXplZCcsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIG5vdCBhdXRoZW50aWNhdGVkJyxcclxuICAgICAgICAgICAgY29kZTogJ05PVF9BVVRIRU5USUNBVEVEJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB1c2VyUm9sZSA9IHJlcS51c2VyLnJvbGUgfHwgcmVxLnVzZXIucm9sZXM/LlswXTtcclxuXHJcbiAgICAgICAgaWYgKCFhbGxvd2VkUm9sZXMuaW5jbHVkZXModXNlclJvbGUpKSB7XHJcbiAgICAgICAgICBsb2dnZXIud2FybihgVW5hdXRob3JpemVkIHJvbGUgYWNjZXNzOiB1c2VyICR7cmVxLnVzZXIudXNlcklkfSBhdHRlbXB0ZWQgdG8gYWNjZXNzICR7cmVxLm9yaWdpbmFsVXJsfWApO1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAnZm9yYmlkZGVuJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucyBmb3IgdGhpcyBvcGVyYXRpb24nLFxyXG4gICAgICAgICAgICBjb2RlOiAnRk9SQklEREVOJyxcclxuICAgICAgICAgICAgcmVxdWlyZWRSb2xlczogYWxsb3dlZFJvbGVzXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5leHQoKTtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoJ1JvbGUgdmVyaWZpY2F0aW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgZXJyb3I6ICdpbnRlcm5hbF9lcnJvcicsXHJcbiAgICAgICAgICBtZXNzYWdlOiAnUm9sZSB2ZXJpZmljYXRpb24gZmFpbGVkJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqINin2YTYqtit2YLZgiDZhdmGINin2YTYtdmE2KfYrdmK2KfYqiDYp9mE2K/ZgtmK2YLYqVxyXG4gICAqIEZpbmUtZ3JhaW5lZCBwZXJtaXNzaW9uIHZlcmlmaWNhdGlvblxyXG4gICAqL1xyXG4gIHJlcXVpcmVQZXJtaXNzaW9uID0gKHJlcXVpcmVkUGVybWlzc2lvbnMgPSBbXSkgPT4ge1xyXG4gICAgcmV0dXJuIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3VuYXV0aG9yaXplZCcsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIG5vdCBhdXRoZW50aWNhdGVkJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB1c2VyUGVybWlzc2lvbnMgPSByZXEudXNlci5wZXJtaXNzaW9ucyB8fCBbXTtcclxuICAgICAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gcmVxdWlyZWRQZXJtaXNzaW9ucy5zb21lKHBlcm0gPT4gdXNlclBlcm1pc3Npb25zLmluY2x1ZGVzKHBlcm0pKTtcclxuXHJcbiAgICAgICAgaWYgKCFoYXNQZXJtaXNzaW9uKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6ICdmb3JiaWRkZW4nLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnSW5zdWZmaWNpZW50IHBlcm1pc3Npb25zJyxcclxuICAgICAgICAgICAgcmVxdWlyZWRQZXJtaXNzaW9uc1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBuZXh0KCk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdQZXJtaXNzaW9uIHZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgIGVycm9yOiAnaW50ZXJuYWxfZXJyb3InLFxyXG4gICAgICAgICAgbWVzc2FnZTogJ1Blcm1pc3Npb24gdmVyaWZpY2F0aW9uIGZhaWxlZCdcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiDYp9mE2KrYrdmC2YIg2YXZhiDYp9mE2KzZhNiz2Kkg2KfZhNmF2KrYudiv2K/YqSDYp9mE2KPYrNmH2LLYqVxyXG4gICAqIE11bHRpLWRldmljZSBzZXNzaW9uIHZlcmlmaWNhdGlvblxyXG4gICAqL1xyXG4gIHZlcmlmeU11bHRpRGV2aWNlU2Vzc2lvbiA9IChvcHRpb25zID0ge30pID0+IHtcclxuICAgIHJldHVybiBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZXh0cmFjdFRva2VuKHJlcSk7XHJcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLmhlYWRlcnNbJ3gtc2Vzc2lvbi1pZCddO1xyXG4gICAgICAgIGNvbnN0IGRldmljZUlkID0gcmVxLmhlYWRlcnNbJ3gtZGV2aWNlLWlkJ107XHJcblxyXG4gICAgICAgIGlmICghdG9rZW4gfHwgIXNlc3Npb25JZCB8fCAhZGV2aWNlSWQpIHtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3VuYXV0aG9yaXplZCcsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdNaXNzaW5nIGF1dGhlbnRpY2F0aW9uIGhlYWRlcnMnXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHZlcmlmaWNhdGlvbiA9IGF3YWl0IHRoaXMuc3NvU2VydmljZS52ZXJpZnlTZXNzaW9uKHNlc3Npb25JZCwgdG9rZW4pO1xyXG5cclxuICAgICAgICBpZiAoIXZlcmlmaWNhdGlvbi52YWxpZCkge1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogdmVyaWZpY2F0aW9uLmVycm9yXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENoZWNrIGlmIGRldmljZSBJRCBtYXRjaGVzXHJcbiAgICAgICAgaWYgKHZlcmlmaWNhdGlvbi5zZXNzaW9uLm1ldGFkYXRhLmRldmljZUlkICE9PSBkZXZpY2VJZCkge1xyXG4gICAgICAgICAgbG9nZ2VyLndhcm4oYERldmljZSBtaXNtYXRjaCBmb3Igc2Vzc2lvbiAke3Nlc3Npb25JZH1gKTtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ2ZvcmJpZGRlbicsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXZpY2UgYXV0aGVudGljYXRpb24gZmFpbGVkJyxcclxuICAgICAgICAgICAgY29kZTogJ0RFVklDRV9NSVNNQVRDSCdcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVxLnVzZXIgPSB2ZXJpZmljYXRpb24udXNlcjtcclxuICAgICAgICByZXEuc2Vzc2lvbiA9IHZlcmlmaWNhdGlvbi5zZXNzaW9uO1xyXG4gICAgICAgIHJlcS5zZXNzaW9uSWQgPSBzZXNzaW9uSWQ7XHJcbiAgICAgICAgcmVxLmRldmljZUlkID0gZGV2aWNlSWQ7XHJcblxyXG4gICAgICAgIG5leHQoKTtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoJ011bHRpLWRldmljZSB2ZXJpZmljYXRpb24gZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICBlcnJvcjogJ3VuYXV0aG9yaXplZCcsXHJcbiAgICAgICAgICBtZXNzYWdlOiAnU2Vzc2lvbiB2ZXJpZmljYXRpb24gZmFpbGVkJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIFJhdGUgbGltaXRpbmcg2KjZhtin2KHZiyDYudmE2Ykg2KfZhNmF2LPYqtiu2K/ZhVxyXG4gICAqIFBlci11c2VyIHJhdGUgbGltaXRpbmdcclxuICAgKi9cclxuICB1c2VyUmF0ZUxpbWl0ID0gKG9wdGlvbnMgPSB7fSkgPT4ge1xyXG4gICAgY29uc3QgbWF4UmVxdWVzdHMgPSBvcHRpb25zLm1heFJlcXVlc3RzIHx8IDEwMDtcclxuICAgIGNvbnN0IHdpbmRvd01zID0gb3B0aW9ucy53aW5kb3dNcyB8fCA2MDAwMDsgLy8gMSBtaW51dGVcclxuICAgIGNvbnN0IHN0b3JhZ2UgPSBuZXcgTWFwKCk7XHJcblxyXG4gICAgcmV0dXJuIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy51c2VySWQgfHwgcmVxLmlwO1xyXG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gYHJhdGVsaW1pdDoke3VzZXJJZH1gO1xyXG5cclxuICAgICAgICBpZiAoIXN0b3JhZ2UuaGFzKGtleSkpIHtcclxuICAgICAgICAgIHN0b3JhZ2Uuc2V0KGtleSwgeyBjb3VudDogMSwgcmVzZXRBdDogbm93ICsgd2luZG93TXMgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IHVzZXJEYXRhID0gc3RvcmFnZS5nZXQoa2V5KTtcclxuXHJcbiAgICAgICAgICBpZiAobm93ID4gdXNlckRhdGEucmVzZXRBdCkge1xyXG4gICAgICAgICAgICB1c2VyRGF0YS5jb3VudCA9IDE7XHJcbiAgICAgICAgICAgIHVzZXJEYXRhLnJlc2V0QXQgPSBub3cgKyB3aW5kb3dNcztcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHVzZXJEYXRhLmNvdW50Kys7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKHVzZXJEYXRhLmNvdW50ID4gbWF4UmVxdWVzdHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDI5KS5qc29uKHtcclxuICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICBlcnJvcjogJ3Rvb19tYW55X3JlcXVlc3RzJyxcclxuICAgICAgICAgICAgICBtZXNzYWdlOiAnUmF0ZSBsaW1pdCBleGNlZWRlZCcsXHJcbiAgICAgICAgICAgICAgcmV0cnlBZnRlcjogTWF0aC5jZWlsKCh1c2VyRGF0YS5yZXNldEF0IC0gbm93KSAvIDEwMDApXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbmV4dCgpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignUmF0ZSBsaW1pdGluZyBmYWlsZWQ6JywgZXJyb3IpO1xyXG4gICAgICAgIG5leHQoKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiDYp9mE2KrYrdmC2YIg2YXZhiBDT1JTINii2YXZhiDZhdi5IFNTT1xyXG4gICAqIFNlY3VyZSBDT1JTIHZlcmlmaWNhdGlvbiB3aXRoIFNTT1xyXG4gICAqL1xyXG4gIHZlcmlmeVNTT01peENvcnMgPSAob3B0aW9ucyA9IHt9KSA9PiB7XHJcbiAgICByZXR1cm4gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luID0gcmVxLmdldCgnb3JpZ2luJyk7XHJcbiAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmV4dHJhY3RUb2tlbihyZXEpO1xyXG5cclxuICAgICAgICAvLyBGb3IgcmVxdWVzdHMgd2l0aCBTU08gdG9rZW4sIHZlcmlmeSB0b2tlbiBmaXJzdFxyXG4gICAgICAgIGlmICh0b2tlbikge1xyXG4gICAgICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLmhlYWRlcnNbJ3gtc2Vzc2lvbi1pZCddO1xyXG4gICAgICAgICAgaWYgKHNlc3Npb25JZCkge1xyXG4gICAgICAgICAgICBjb25zdCB2ZXJpZmljYXRpb24gPSBhd2FpdCB0aGlzLnNzb1NlcnZpY2UudmVyaWZ5U2Vzc2lvbihzZXNzaW9uSWQsIHRva2VuKTtcclxuICAgICAgICAgICAgaWYgKHZlcmlmaWNhdGlvbi52YWxpZCkge1xyXG4gICAgICAgICAgICAgIHJlcS51c2VyID0gdmVyaWZpY2F0aW9uLnVzZXI7XHJcbiAgICAgICAgICAgICAgcmVxLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmVyaWZ5IENPUlMgb3JpZ2luXHJcbiAgICAgICAgY29uc3QgYWxsb3dlZE9yaWdpbnMgPSAocHJvY2Vzcy5lbnYuQUxMT1dFRF9PUklHSU5TIHx8ICcnKS5zcGxpdCgnLCcpO1xyXG4gICAgICAgIGlmIChhbGxvd2VkT3JpZ2lucy5pbmNsdWRlcyhvcmlnaW4pIHx8IGFsbG93ZWRPcmlnaW5zLmluY2x1ZGVzKCcqJykpIHtcclxuICAgICAgICAgIHJlcy5zZXQoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsIG9yaWdpbiB8fCAnKicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbmV4dCgpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignQ09SUyBTU08gdmVyaWZpY2F0aW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgZXJyb3I6ICdmb3JiaWRkZW4nLFxyXG4gICAgICAgICAgbWVzc2FnZTogJ0NPUlMgdmVyaWZpY2F0aW9uIGZhaWxlZCdcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiDYqtiz2KzZitmEINin2YTZhti02KfYtyDZiNin2YTYqtiv2YLZitmCXHJcbiAgICogQWN0aXZpdHkgbG9nZ2luZyBhbmQgYXVkaXQgdHJhaWxcclxuICAgKi9cclxuICBhdWRpdExvZyA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qgb3JpZ2luYWwgPSByZXMuanNvbi5iaW5kKHJlcyk7XHJcblxyXG4gICAgICByZXMuanNvbiA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgLy8gTG9nIHRoZSByZXF1ZXN0IGFmdGVyIHNlbmRpbmcgcmVzcG9uc2VcclxuICAgICAgICBzZXRJbW1lZGlhdGUoKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgYXVkaXRFbnRyeSA9IHtcclxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LnVzZXJJZCB8fCAnYW5vbnltb3VzJyxcclxuICAgICAgICAgICAgYWN0aW9uOiByZXEubWV0aG9kLFxyXG4gICAgICAgICAgICBlbmRwb2ludDogcmVxLm9yaWdpbmFsVXJsLFxyXG4gICAgICAgICAgICBzdGF0dXNDb2RlOiByZXMuc3RhdHVzQ29kZSxcclxuICAgICAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgICAgICBpcDogdGhpcy5nZXRDbGllbnRJcChyZXEpLFxyXG4gICAgICAgICAgICAgIHVzZXJBZ2VudDogcmVxLmdldCgndXNlci1hZ2VudCcpLFxyXG4gICAgICAgICAgICAgIHNlc3Npb25JZDogcmVxLnNlc3Npb25JZFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgIGxvZ2dlci5pbmZvKCdBVURJVCcsIGF1ZGl0RW50cnkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gb3JpZ2luYWwoZGF0YSk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICBuZXh0KCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ0F1ZGl0IGxvZ2dpbmcgZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgbmV4dCgpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIEhlbHBlciBtZXRob2Q6IEV4dHJhY3QgdG9rZW4gZnJvbSByZXF1ZXN0XHJcbiAgICovXHJcbiAgZXh0cmFjdFRva2VuKHJlcSkge1xyXG4gICAgLy8gQ2hlY2sgQXV0aG9yaXphdGlvbiBoZWFkZXJcclxuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xyXG4gICAgaWYgKGF1dGhIZWFkZXI/LnN0YXJ0c1dpdGgoJ0JlYXJlciAnKSkge1xyXG4gICAgICByZXR1cm4gYXV0aEhlYWRlci5zbGljZSg3KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBYLUFjY2Vzcy1Ub2tlbiBoZWFkZXJcclxuICAgIGlmIChyZXEuaGVhZGVyc1sneC1hY2Nlc3MtdG9rZW4nXSkge1xyXG4gICAgICByZXR1cm4gcmVxLmhlYWRlcnNbJ3gtYWNjZXNzLXRva2VuJ107XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2hlY2sgY29va2llc1xyXG4gICAgaWYgKHJlcS5jb29raWVzPy5hY2Nlc3NUb2tlbikge1xyXG4gICAgICByZXR1cm4gcmVxLmNvb2tpZXMuYWNjZXNzVG9rZW47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBIZWxwZXIgbWV0aG9kOiBFeHRyYWN0IHNlc3Npb24gSUQgZnJvbSB0b2tlblxyXG4gICAqL1xyXG4gIGV4dHJhY3RTZXNzaW9uSWQodG9rZW4pIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBqd3QuZGVjb2RlKHRva2VuLCB0aGlzLkpXVF9TRUNSRVQpO1xyXG4gICAgICByZXR1cm4gZGVjb2RlZC5zZXNzaW9uSWQ7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhlbHBlciBtZXRob2Q6IEdldCBjbGllbnQgSVBcclxuICAgKi9cclxuICBnZXRDbGllbnRJcChyZXEpIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXT8uc3BsaXQoJywnKVswXS50cmltKCkgfHxcclxuICAgICAgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzIHx8XHJcbiAgICAgICd1bmtub3duJ1xyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2UgYW5kIGZhY3RvcnkgZnVuY3Rpb25cclxuY29uc3Qgc3NvQXV0aE1pZGRsZXdhcmUgPSBuZXcgU1NPQXV0aE1pZGRsZXdhcmUoKTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHNzb0F1dGhNaWRkbGV3YXJlLFxyXG4gIHZlcmlmeVNTT1Rva2VuOiAoKSA9PiBzc29BdXRoTWlkZGxld2FyZS52ZXJpZnlTU09Ub2tlbigpLFxyXG4gIHJlcXVpcmVSb2xlOiAocm9sZXMpID0+IHNzb0F1dGhNaWRkbGV3YXJlLnJlcXVpcmVSb2xlKHJvbGVzKSxcclxuICByZXF1aXJlUGVybWlzc2lvbjogKHBlcm1zKSA9PiBzc29BdXRoTWlkZGxld2FyZS5yZXF1aXJlUGVybWlzc2lvbihwZXJtcyksXHJcbiAgdmVyaWZ5T3B0aW9uYWxTU086IHNzb0F1dGhNaWRkbGV3YXJlLnZlcmlmeU9wdGlvbmFsU1NPLmJpbmQoc3NvQXV0aE1pZGRsZXdhcmUpLFxyXG4gIHZlcmlmeU11bHRpRGV2aWNlU2Vzc2lvbjogKCkgPT4gc3NvQXV0aE1pZGRsZXdhcmUudmVyaWZ5TXVsdGlEZXZpY2VTZXNzaW9uKCksXHJcbiAgdXNlclJhdGVMaW1pdDogKG9wdHMpID0+IHNzb0F1dGhNaWRkbGV3YXJlLnVzZXJSYXRlTGltaXQob3B0cyksXHJcbiAgdmVyaWZ5U1NPTWl4Q29yczogKG9wdHMpID0+IHNzb0F1dGhNaWRkbGV3YXJlLnZlcmlmeVNTT01peENvcnMob3B0cyksXHJcbiAgYXVkaXRMb2c6IHNzb0F1dGhNaWRkbGV3YXJlLmF1ZGl0TG9nLmJpbmQoc3NvQXV0aE1pZGRsZXdhcmUpXHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsWUFBWSxDQUFDO0FBQ2pDLE1BQU1DLFVBQVUsR0FBR0QsT0FBTyxDQUFDLHlCQUF5QixDQUFDO0FBQ3JELE1BQU1FLE1BQU0sR0FBR0YsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBRXpDLE1BQU1HLGlCQUFpQixDQUFDO0VBQ3RCQyxXQUFXQSxDQUFBLEVBQUc7SUFDWixJQUFJLENBQUNDLFVBQVUsR0FBRyxJQUFJSixVQUFVLENBQUMsQ0FBQztJQUNsQyxJQUFJLENBQUNLLFVBQVUsR0FBR0MsT0FBTyxDQUFDQyxHQUFHLENBQUNGLFVBQVUsSUFBSSxnQkFBZ0I7RUFDOUQ7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7RUFDRUcsY0FBYyxHQUFHQSxDQUFDQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEtBQUs7SUFDakMsT0FBTyxPQUFPQyxHQUFHLEVBQUVDLEdBQUcsRUFBRUMsSUFBSSxLQUFLO01BQy9CLElBQUk7UUFDRixNQUFN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