{"version":3,"names":["ScheduledNotification","require","Notification","User","processScheduledNotifications","now","Date","due","find","sent","scheduleTime","$lte","sched","user","findById","userId","create","title","message","type","priority","metadata","senderId","createdBy","category","sentAt","save","module","exports"],"sources":["processScheduledNotifications.js"],"sourcesContent":["const ScheduledNotification = require('../models/ScheduledNotification');\r\nconst Notification = require('../models/Notification');\r\nconst User = require('../models/User');\r\n\r\n/**\r\n * خدمة تنفيذ الإشعارات المجدولة (تشغيل دوري)\r\n */\r\nasync function processScheduledNotifications() {\r\n  const now = new Date();\r\n  // جلب الإشعارات المجدولة غير المرسلة والتي حان وقتها\r\n  const due = await ScheduledNotification.find({ sent: false, scheduleTime: { $lte: now } });\r\n  for (const sched of due) {\r\n    // تحقق من المستخدم\r\n    const user = await User.findById(sched.userId);\r\n    if (!user) continue;\r\n    // إنشاء إشعار فعلي\r\n    await Notification.create({\r\n      userId: sched.userId,\r\n      title: sched.title,\r\n      message: sched.message,\r\n      type: 'reminder',\r\n      priority: sched.metadata?.priority || 'normal',\r\n      senderId: sched.createdBy,\r\n      metadata: sched.metadata || {},\r\n      category: 'reminder',\r\n    });\r\n    // تحديث حالة الإرسال\r\n    sched.sent = true;\r\n    sched.sentAt = new Date();\r\n    await sched.save();\r\n    // يمكن إضافة إرسال عبر القنوات الأخرى هنا\r\n  }\r\n}\r\n\r\nmodule.exports = processScheduledNotifications;\r\n"],"mappings":"AAAA,MAAMA,qBAAqB,GAAGC,OAAO,CAAC,iCAAiC,CAAC;AACxE,MAAMC,YAAY,GAAGD,OAAO,CAAC,wBAAwB,CAAC;AACtD,MAAME,IAAI,GAAGF,OAAO,CAAC,gBAAgB,CAAC;;AAEtC;AACA;AACA;AACA,eAAeG,6BAA6BA,CAAA,EAAG;EAC7C,MAAMC,GAAG,GAAG,IAAIC,IAAI,CAAC,CAAC;EACtB;EACA,MAAMC,GAAG,GAAG,MAAMP,qBAAqB,CAACQ,IAAI,CAAC;IAAEC,IAAI,EAAE,KAAK;IAAEC,YAAY,EAAE;MAAEC,IAAI,EAAEN;IAAI;EAAE,CAAC,CAAC;EAC1F,KAAK,MAAMO,KAAK,IAAIL,GAAG,EAAE;IACvB;IACA,MAAMM,IAAI,GAAG,MAAMV,IAAI,CAACW,QAAQ,CAACF,KAAK,CAACG,MAAM,CAAC;IAC9C,IAAI,CAACF,IAAI,EAAE;IACX;IACA,MAAMX,YAAY,CAACc,MAAM,CAAC;MACxBD,MAAM,EAAEH,KAAK,CAACG,MAAM;MACpBE,KAAK,EAAEL,KAAK,CAACK,KAAK;MAClBC,OAAO,EAAEN,KAAK,CAACM,OAAO;MACtBC,IAAI,EAAE,UAAU;MAChBC,QAAQ,EAAER,KAAK,CAACS,QAAQ,EAAED,QAAQ,IAAI,QAAQ;MAC9CE,QAAQ,EAAEV,KAAK,CAACW,SAAS;MACzBF,QAAQ,EAAET,KAAK,CAACS,QAAQ,IAAI,CAAC,CAAC;MAC9BG,QAAQ,EAAE;IACZ,CAAC,CAAC;IACF;IACAZ,KAAK,CAACH,IAAI,GAAG,IAAI;IACjBG,KAAK,CAACa,MAAM,GAAG,IAAInB,IAAI,CAAC,CAAC;IACzB,MAAMM,KAAK,CAACc,IAAI,CAAC,CAAC;IAClB;EACF;AACF;AAEAC,MAAM,CAACC,OAAO,GAAGxB,6BAA6B","ignoreList":[]}