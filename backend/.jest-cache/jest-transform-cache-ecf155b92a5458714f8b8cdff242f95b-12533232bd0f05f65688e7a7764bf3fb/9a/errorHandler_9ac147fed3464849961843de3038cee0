fd3f3192de31e0cbb1f70ed9ff332ae3
/**
 * =====================================================
 * ADVANCED ERROR HANDLER MIDDLEWARE - Phase 6
 * =====================================================
 * Global error handling with comprehensive logging
 */

const fs = require('fs');
const path = require('path');
const {
  ApiError
} = require('../utils/apiResponse');

// Ensure logs directory exists
const logsDir = path.join(__dirname, '../logs');
if (!fs.existsSync(logsDir)) {
  fs.mkdirSync(logsDir, {
    recursive: true
  });
}

// Log file path
const errorLogFile = path.join(logsDir, 'errors.log');

/**
 * Log error to file
 */
const logErrorToFile = (error, req) => {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    method: req.method,
    url: req.originalUrl,
    ip: req.ip || req.connection.remoteAddress,
    statusCode: error.statusCode || 500,
    message: error.message,
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    userAgent: req.get('user-agent'),
    userId: req.user?._id || 'anonymous'
  };
  const logMessage = `${timestamp} [${error.statusCode || 500}] ${req.method} ${req.originalUrl} - ${error.message}\n`;
  fs.appendFileSync(errorLogFile, logMessage);

  // Also write JSON for analysis
  const analyticsFile = path.join(logsDir, 'errors.json');
  const existingErrors = fs.existsSync(analyticsFile) ? JSON.parse(fs.readFileSync(analyticsFile, 'utf8')) : [];
  existingErrors.push(logEntry);
  // Keep only last 1000 errors
  const recentErrors = existingErrors.slice(-1000);
  fs.writeFileSync(analyticsFile, JSON.stringify(recentErrors, null, 2));
};

/**
 * Format error response
 */
const formatErrorResponse = (error, req, isDevelopment = false) => {
  let statusCode = error.statusCode || 500;
  let message = error.message || 'Internal Server Error';
  let errors = error.errors || [];

  // Handle different error types
  if (error.name === 'ValidationError') {
    statusCode = 400;
    errors = Object.values(error.errors || {}).map(e => e.message).join(', ');
    message = 'Validation Error';
  }
  if (error.code === 11000) {
    statusCode = 409;
    const field = Object.keys(error.keyPattern)[0];
    message = `Duplicate value for field: ${field}`;
    errors = [`${field} already exists`];
  }
  if (error.name === 'CastError') {
    statusCode = 400;
    message = 'Invalid ID format';
    errors = ['The provided ID is not valid'];
  }
  if (error.name === 'JsonWebTokenError') {
    statusCode = 401;
    message = 'Invalid token';
    errors = ['Your authentication token is invalid or expired'];
  }
  if (error.name === 'TokenExpiredError') {
    statusCode = 401;
    message = 'Token expired';
    errors = ['Your authentication token has expired. Please login again'];
  }
  let response = {
    success: false,
    statusCode,
    message,
    error: message,
    timestamp: new Date().toISOString()
  };

  // Add detailed errors in development
  if (isDevelopment) {
    response.errors = Array.isArray(errors) ? errors : [errors];
    response.path = req.originalUrl;
    response.stack = error.stack;
  } else {
    // In production, only include specific error field if exists
    if (error.errors) {
      response.errors = Array.isArray(errors) ? errors : [errors];
    }
  }
  return response;
};

/**
 * Global error handler middleware
 */
module.exports = (err, req, res, next) => {
  const isDevelopment = process.env.NODE_ENV === 'development';

  // Ensure error is an Error instance
  if (!(err instanceof Error)) {
    err = new Error(String(err));
  }

  // Log error
  console.error(`\n‚ùå ERROR: ${err.message}`);
  console.error(`üìç Route: ${req.method} ${req.originalUrl}`);
  console.error(`üë§ User: ${req.user?._id || 'anonymous'}`);
  console.error(`üîó IP: ${req.ip || req.connection.remoteAddress}`);
  if (isDevelopment) {
    console.error(`\n${err.stack}`);
  }

  // Log to file
  try {
    logErrorToFile(err, req);
  } catch (fileError) {
    console.error('Failed to log error to file:', fileError);
  }

  // Format and send response
  const response = formatErrorResponse(err, req, isDevelopment);

  // Set response headers
  res.set('X-Error-Id', `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);
  res.set('X-Error-Timestamp', new Date().toISOString());

  // Send response
  res.status(response.statusCode).json(response);
};

/**
 * Export ApiError for throwing custom errors
 */
module.exports.ApiError = ApiError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiQXBpRXJyb3IiLCJsb2dzRGlyIiwiam9pbiIsIl9fZGlybmFtZSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJlcnJvckxvZ0ZpbGUiLCJsb2dFcnJvclRvRmlsZSIsImVycm9yIiwicmVxIiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwibG9nRW50cnkiLCJtZXRob2QiLCJ1cmwiLCJvcmlnaW5hbFVybCIsImlwIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJzdGF0dXNDb2RlIiwibWVzc2FnZSIsInN0YWNrIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwidW5kZWZpbmVkIiwidXNlckFnZW50IiwiZ2V0IiwidXNlcklkIiwidXNlciIsIl9pZCIsImxvZ01lc3NhZ2UiLCJhcHBlbmRGaWxlU3luYyIsImFuYWx5dGljc0ZpbGUiLCJleGlzdGluZ0Vycm9ycyIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsInB1c2giLCJyZWNlbnRFcnJvcnMiLCJzbGljZSIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJmb3JtYXRFcnJvclJlc3BvbnNlIiwiaXNEZXZlbG9wbWVudCIsImVycm9ycyIsIm5hbWUiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXAiLCJlIiwiY29kZSIsImZpZWxkIiwia2V5cyIsImtleVBhdHRlcm4iLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJBcnJheSIsImlzQXJyYXkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZXJyIiwicmVzIiwibmV4dCIsIkVycm9yIiwiU3RyaW5nIiwiY29uc29sZSIsImZpbGVFcnJvciIsInNldCIsIm5vdyIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0ciIsInN0YXR1cyIsImpzb24iXSwic291cmNlcyI6WyJlcnJvckhhbmRsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAqIEFEVkFOQ0VEIEVSUk9SIEhBTkRMRVIgTUlERExFV0FSRSAtIFBoYXNlIDZcclxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICogR2xvYmFsIGVycm9yIGhhbmRsaW5nIHdpdGggY29tcHJlaGVuc2l2ZSBsb2dnaW5nXHJcbiAqL1xyXG5cclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCB7IEFwaUVycm9yIH0gPSByZXF1aXJlKCcuLi91dGlscy9hcGlSZXNwb25zZScpO1xyXG5cclxuLy8gRW5zdXJlIGxvZ3MgZGlyZWN0b3J5IGV4aXN0c1xyXG5jb25zdCBsb2dzRGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xvZ3MnKTtcclxuaWYgKCFmcy5leGlzdHNTeW5jKGxvZ3NEaXIpKSB7XHJcbiAgZnMubWtkaXJTeW5jKGxvZ3NEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xyXG59XHJcblxyXG4vLyBMb2cgZmlsZSBwYXRoXHJcbmNvbnN0IGVycm9yTG9nRmlsZSA9IHBhdGguam9pbihsb2dzRGlyLCAnZXJyb3JzLmxvZycpO1xyXG5cclxuLyoqXHJcbiAqIExvZyBlcnJvciB0byBmaWxlXHJcbiAqL1xyXG5jb25zdCBsb2dFcnJvclRvRmlsZSA9IChlcnJvciwgcmVxKSA9PiB7XHJcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xyXG4gIGNvbnN0IGxvZ0VudHJ5ID0ge1xyXG4gICAgdGltZXN0YW1wLFxyXG4gICAgbWV0aG9kOiByZXEubWV0aG9kLFxyXG4gICAgdXJsOiByZXEub3JpZ2luYWxVcmwsXHJcbiAgICBpcDogcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MsXHJcbiAgICBzdGF0dXNDb2RlOiBlcnJvci5zdGF0dXNDb2RlIHx8IDUwMCxcclxuICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICBzdGFjazogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcclxuICAgIHVzZXJBZ2VudDogcmVxLmdldCgndXNlci1hZ2VudCcpLFxyXG4gICAgdXNlcklkOiByZXEudXNlcj8uX2lkIHx8ICdhbm9ueW1vdXMnLFxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGxvZ01lc3NhZ2UgPSBgJHt0aW1lc3RhbXB9IFske2Vycm9yLnN0YXR1c0NvZGUgfHwgNTAwfV0gJHtyZXEubWV0aG9kfSAke3JlcS5vcmlnaW5hbFVybH0gLSAke2Vycm9yLm1lc3NhZ2V9XFxuYDtcclxuXHJcbiAgZnMuYXBwZW5kRmlsZVN5bmMoZXJyb3JMb2dGaWxlLCBsb2dNZXNzYWdlKTtcclxuXHJcbiAgLy8gQWxzbyB3cml0ZSBKU09OIGZvciBhbmFseXNpc1xyXG4gIGNvbnN0IGFuYWx5dGljc0ZpbGUgPSBwYXRoLmpvaW4obG9nc0RpciwgJ2Vycm9ycy5qc29uJyk7XHJcbiAgY29uc3QgZXhpc3RpbmdFcnJvcnMgPSBmcy5leGlzdHNTeW5jKGFuYWx5dGljc0ZpbGUpXHJcbiAgICA/IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGFuYWx5dGljc0ZpbGUsICd1dGY4JykpXHJcbiAgICA6IFtdO1xyXG4gIGV4aXN0aW5nRXJyb3JzLnB1c2gobG9nRW50cnkpO1xyXG4gIC8vIEtlZXAgb25seSBsYXN0IDEwMDAgZXJyb3JzXHJcbiAgY29uc3QgcmVjZW50RXJyb3JzID0gZXhpc3RpbmdFcnJvcnMuc2xpY2UoLTEwMDApO1xyXG4gIGZzLndyaXRlRmlsZVN5bmMoYW5hbHl0aWNzRmlsZSwgSlNPTi5zdHJpbmdpZnkocmVjZW50RXJyb3JzLCBudWxsLCAyKSk7XHJcbn07XHJcblxyXG4vKipcclxuICogRm9ybWF0IGVycm9yIHJlc3BvbnNlXHJcbiAqL1xyXG5jb25zdCBmb3JtYXRFcnJvclJlc3BvbnNlID0gKGVycm9yLCByZXEsIGlzRGV2ZWxvcG1lbnQgPSBmYWxzZSkgPT4ge1xyXG4gIGxldCBzdGF0dXNDb2RlID0gZXJyb3Iuc3RhdHVzQ29kZSB8fCA1MDA7XHJcbiAgbGV0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlIHx8ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InO1xyXG4gIGxldCBlcnJvcnMgPSBlcnJvci5lcnJvcnMgfHwgW107XHJcblxyXG4gIC8vIEhhbmRsZSBkaWZmZXJlbnQgZXJyb3IgdHlwZXNcclxuICBpZiAoZXJyb3IubmFtZSA9PT0gJ1ZhbGlkYXRpb25FcnJvcicpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDA7XHJcbiAgICBlcnJvcnMgPSBPYmplY3QudmFsdWVzKGVycm9yLmVycm9ycyB8fCB7fSlcclxuICAgICAgLm1hcCgoZSkgPT4gZS5tZXNzYWdlKVxyXG4gICAgICAuam9pbignLCAnKTtcclxuICAgIG1lc3NhZ2UgPSAnVmFsaWRhdGlvbiBFcnJvcic7XHJcbiAgfVxyXG5cclxuICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDk7XHJcbiAgICBjb25zdCBmaWVsZCA9IE9iamVjdC5rZXlzKGVycm9yLmtleVBhdHRlcm4pWzBdO1xyXG4gICAgbWVzc2FnZSA9IGBEdXBsaWNhdGUgdmFsdWUgZm9yIGZpZWxkOiAke2ZpZWxkfWA7XHJcbiAgICBlcnJvcnMgPSBbYCR7ZmllbGR9IGFscmVhZHkgZXhpc3RzYF07XHJcbiAgfVxyXG5cclxuICBpZiAoZXJyb3IubmFtZSA9PT0gJ0Nhc3RFcnJvcicpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDA7XHJcbiAgICBtZXNzYWdlID0gJ0ludmFsaWQgSUQgZm9ybWF0JztcclxuICAgIGVycm9ycyA9IFsnVGhlIHByb3ZpZGVkIElEIGlzIG5vdCB2YWxpZCddO1xyXG4gIH1cclxuXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdKc29uV2ViVG9rZW5FcnJvcicpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICBtZXNzYWdlID0gJ0ludmFsaWQgdG9rZW4nO1xyXG4gICAgZXJyb3JzID0gWydZb3VyIGF1dGhlbnRpY2F0aW9uIHRva2VuIGlzIGludmFsaWQgb3IgZXhwaXJlZCddO1xyXG4gIH1cclxuXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdUb2tlbkV4cGlyZWRFcnJvcicpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICBtZXNzYWdlID0gJ1Rva2VuIGV4cGlyZWQnO1xyXG4gICAgZXJyb3JzID0gWydZb3VyIGF1dGhlbnRpY2F0aW9uIHRva2VuIGhhcyBleHBpcmVkLiBQbGVhc2UgbG9naW4gYWdhaW4nXTtcclxuICB9XHJcblxyXG4gIGxldCByZXNwb25zZSA9IHtcclxuICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIG1lc3NhZ2UsXHJcbiAgICBlcnJvcjogbWVzc2FnZSxcclxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gIH07XHJcblxyXG4gIC8vIEFkZCBkZXRhaWxlZCBlcnJvcnMgaW4gZGV2ZWxvcG1lbnRcclxuICBpZiAoaXNEZXZlbG9wbWVudCkge1xyXG4gICAgcmVzcG9uc2UuZXJyb3JzID0gQXJyYXkuaXNBcnJheShlcnJvcnMpID8gZXJyb3JzIDogW2Vycm9yc107XHJcbiAgICByZXNwb25zZS5wYXRoID0gcmVxLm9yaWdpbmFsVXJsO1xyXG4gICAgcmVzcG9uc2Uuc3RhY2sgPSBlcnJvci5zdGFjaztcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gSW4gcHJvZHVjdGlvbiwgb25seSBpbmNsdWRlIHNwZWNpZmljIGVycm9yIGZpZWxkIGlmIGV4aXN0c1xyXG4gICAgaWYgKGVycm9yLmVycm9ycykge1xyXG4gICAgICByZXNwb25zZS5lcnJvcnMgPSBBcnJheS5pc0FycmF5KGVycm9ycykgPyBlcnJvcnMgOiBbZXJyb3JzXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiByZXNwb25zZTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBHbG9iYWwgZXJyb3IgaGFuZGxlciBtaWRkbGV3YXJlXHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IChlcnIsIHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgY29uc3QgaXNEZXZlbG9wbWVudCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnO1xyXG5cclxuICAvLyBFbnN1cmUgZXJyb3IgaXMgYW4gRXJyb3IgaW5zdGFuY2VcclxuICBpZiAoIShlcnIgaW5zdGFuY2VvZiBFcnJvcikpIHtcclxuICAgIGVyciA9IG5ldyBFcnJvcihTdHJpbmcoZXJyKSk7XHJcbiAgfVxyXG5cclxuICAvLyBMb2cgZXJyb3JcclxuICBjb25zb2xlLmVycm9yKGBcXG7inYwgRVJST1I6ICR7ZXJyLm1lc3NhZ2V9YCk7XHJcbiAgY29uc29sZS5lcnJvcihg8J+TjSBSb3V0ZTogJHtyZXEubWV0aG9kfSAke3JlcS5vcmlnaW5hbFVybH1gKTtcclxuICBjb25zb2xlLmVycm9yKGDwn5GkIFVzZXI6ICR7cmVxLnVzZXI/Ll9pZCB8fCAnYW5vbnltb3VzJ31gKTtcclxuICBjb25zb2xlLmVycm9yKGDwn5SXIElQOiAke3JlcS5pcCB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzfWApO1xyXG5cclxuICBpZiAoaXNEZXZlbG9wbWVudCkge1xyXG4gICAgY29uc29sZS5lcnJvcihgXFxuJHtlcnIuc3RhY2t9YCk7XHJcbiAgfVxyXG5cclxuICAvLyBMb2cgdG8gZmlsZVxyXG4gIHRyeSB7XHJcbiAgICBsb2dFcnJvclRvRmlsZShlcnIsIHJlcSk7XHJcbiAgfSBjYXRjaCAoZmlsZUVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9nIGVycm9yIHRvIGZpbGU6JywgZmlsZUVycm9yKTtcclxuICB9XHJcblxyXG4gIC8vIEZvcm1hdCBhbmQgc2VuZCByZXNwb25zZVxyXG4gIGNvbnN0IHJlc3BvbnNlID0gZm9ybWF0RXJyb3JSZXNwb25zZShlcnIsIHJlcSwgaXNEZXZlbG9wbWVudCk7XHJcblxyXG4gIC8vIFNldCByZXNwb25zZSBoZWFkZXJzXHJcbiAgcmVzLnNldCgnWC1FcnJvci1JZCcsIGAke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWApO1xyXG4gIHJlcy5zZXQoJ1gtRXJyb3ItVGltZXN0YW1wJywgbmV3IERhdGUoKS50b0lTT1N0cmluZygpKTtcclxuXHJcbiAgLy8gU2VuZCByZXNwb25zZVxyXG4gIHJlcy5zdGF0dXMocmVzcG9uc2Uuc3RhdHVzQ29kZSkuanNvbihyZXNwb25zZSk7XHJcbn07XHJcblxyXG4vKipcclxuICogRXhwb3J0IEFwaUVycm9yIGZvciB0aHJvd2luZyBjdXN0b20gZXJyb3JzXHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cy5BcGlFcnJvciA9IEFwaUVycm9yO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDeEIsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLE1BQU07RUFBRUU7QUFBUyxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQzs7QUFFcEQ7QUFDQSxNQUFNRyxPQUFPLEdBQUdGLElBQUksQ0FBQ0csSUFBSSxDQUFDQyxTQUFTLEVBQUUsU0FBUyxDQUFDO0FBQy9DLElBQUksQ0FBQ04sRUFBRSxDQUFDTyxVQUFVLENBQUNILE9BQU8sQ0FBQyxFQUFFO0VBQzNCSixFQUFFLENBQUNRLFNBQVMsQ0FBQ0osT0FBTyxFQUFFO0lBQUVLLFNBQVMsRUFBRTtFQUFLLENBQUMsQ0FBQztBQUM1Qzs7QUFFQTtBQUNBLE1BQU1DLFlBQVksR0FBR1IsSUFBSSxDQUFDRyxJQUFJLENBQUNELE9B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