{"version":3,"names":["axios","require","EventEmitter","logger","WhatsAppNotificationService","constructor","config","whitelist","Set","apiConfig","baseURL","process","env","WHATSAPP_API_URL","token","WHATSAPP_API_TOKEN","WHATSAPP_TOKEN","phoneNumberId","WHATSAPP_PHONE_NUMBER_ID","businessAccountId","WHATSAPP_BUSINESS_ACCOUNT_ID","apiVersion","WHATSAPP_API_VERSION","whatsappProviders","official","version","twilio","accountSid","TWILIO_ACCOUNT_SID","authToken","TWILIO_AUTH_TOKEN","messagebird","MESSAGEBIRD_API_KEY","provider","WHATSAPP_PROVIDER","messageHistory","maxHistory","rateLimit","messagesPerMinute","parseInt","WHATSAPP_RATE_LIMIT","messagesPerHour","WHATSAPP_RATE_LIMIT_HOUR","messagesSent","retryQueue","maxRetries","retryDelay","messageQueue","isProcessing","initializeProvider","startQueueProcessor","info","setupTwilioProvider","setupMessageBirdProvider","setupOfficialProvider","client","create","headers","timeout","twilioClient","error","warn","sendMessage","phoneNumber","message","options","isValidPhoneNumber","Error","WHATSAPP_WHITELIST_ONLY","has","checkRateLimit","messageData","normalizePhoneNumber","sanitizeMessage","timestamp","Date","status","retries","push","emit","sendImageMessage","imageUrl","caption","isValidURL","type","media","sendDocumentMessage","fileUrl","fileName","sendInteractiveMessage","buttons","Array","isArray","length","map","btn","idx","id","title","description","sendBulkMessages","phoneNumbers","results","result","filter","r","setInterval","processQueue","shift","deliverMessage","sentAt","addToHistory","delay","retryAt","now","processRetryQueue","readyRetries","forEach","retry","sendViatwilio","sendViaMessageBird","sendViaOfficial","payload","messaging_product","recipient_type","to","image","link","document","filename","interactive","body","text","action","reply","preview_url","response","post","data","messages","sendViaTwilio","from","TWILIO_WHATSAPP_NUMBER","mediaUrl","sid","MESSAGEBIRD_WHATSAPP_CHANNEL_ID","content","cleaned","replace","startsWith","substring","String","trim","url","URL","oneMinuteAgo","oneHourAgo","time","lastMinute","slice","ms","Promise","resolve","setTimeout","getStatistics","total","sent","m","failed","pending","successRate","toFixed","queueLength","queueProcessing","getHistory","limit","clearHistory","addToWhitelist","normalized","add","removeFromWhitelist","delete","getWhitelist","module","exports"],"sources":["whatsappNotificationService.js"],"sourcesContent":["/**\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n * üì± WhatsApp Notification Service\r\n * ÿÆÿØŸÖÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸàÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ ÿ¢ÿ®\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n * \r\n * ŸÖÿ™ŸÇÿØŸÖÿ© Ÿàÿ¥ÿßŸÖŸÑÿ© Ÿàÿ∞ŸÉŸäÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸàÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ ÿ¢ÿ®\r\n * - ÿØÿπŸÖ ÿßŸÑŸÜÿµŸàÿµ ŸàÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™\r\n * - ŸÜÿ∏ÿßŸÖ ŸÇŸàÿßŸÑÿ® ÿ∞ŸÉŸäÿ©\r\n * - ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸàÿßŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©\r\n * - ÿ™ÿ™ÿ®ÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ\r\n */\r\n\r\nconst axios = require('axios');\r\nconst EventEmitter = require('events');\r\nconst logger = require('../utils/logger');\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// ‚úÖ WhatsApp Notification Service\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nclass WhatsAppNotificationService extends EventEmitter {\r\n  constructor(config = {}) {\r\n    super();\r\n\r\n    // ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ° (Whitelist) ŸÖŸÜ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáÿßÿ™ŸÅ\r\n    this.whitelist = new Set();\r\n    \r\n    // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ WhatsApp API\r\n    this.apiConfig = {\r\n      baseURL: process.env.WHATSAPP_API_URL || 'https://api.whatsapp.com/send',\r\n      token: process.env.WHATSAPP_API_TOKEN || process.env.WHATSAPP_TOKEN,\r\n      phoneNumberId: process.env.WHATSAPP_PHONE_NUMBER_ID,\r\n      businessAccountId: process.env.WHATSAPP_BUSINESS_ACCOUNT_ID,\r\n      apiVersion: process.env.WHATSAPP_API_VERSION || 'v18.0',\r\n    };\r\n\r\n    // ÿÆŸàÿßÿØŸÖ WhatsApp ÿßŸÑŸÖŸàÿ´ŸàŸÇÿ©\r\n    this.whatsappProviders = {\r\n      official: {\r\n        baseURL: 'https://graph.instagram.com',\r\n        version: 'v18.0',\r\n      },\r\n      twilio: {\r\n        baseURL: 'https://api.twilio.com',\r\n        accountSid: process.env.TWILIO_ACCOUNT_SID,\r\n        authToken: process.env.TWILIO_AUTH_TOKEN,\r\n      },\r\n      messagebird: {\r\n        baseURL: 'https://messages-sandbox.nexmo.com',\r\n        token: process.env.MESSAGEBIRD_API_KEY,\r\n      },\r\n    };\r\n\r\n    // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸÇÿØŸÖ ÿßŸÑŸÜÿ¥ÿ∑\r\n    this.provider = process.env.WHATSAPP_PROVIDER || 'official';\r\n\r\n    // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ© (ŸÑŸÑÿ™ÿ™ÿ®ÿπ)\r\n    this.messageHistory = [];\r\n    this.maxHistory = 1000;\r\n\r\n    // ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ (Rate Limiting)\r\n    this.rateLimit = {\r\n      messagesPerMinute: parseInt(process.env.WHATSAPP_RATE_LIMIT || '60'),\r\n      messagesPerHour: parseInt(process.env.WHATSAPP_RATE_LIMIT_HOUR || '1000'),\r\n      messagesSent: [],\r\n    };\r\n\r\n    // ŸÖÿÆÿ≤ŸÜ ŸÖÿ§ŸÇÿ™ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™\r\n    this.retryQueue = [];\r\n    this.maxRetries = 3;\r\n    this.retryDelay = 5000; // 5 ÿ´ŸàÿßŸÜŸä\r\n\r\n    // ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±\r\n    this.messageQueue = [];\r\n    this.isProcessing = false;\r\n\r\n    this.initializeProvider();\r\n    this.startQueueProcessor();\r\n  }\r\n\r\n  /**\r\n   * ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖŸÇÿØŸÖ ÿßŸÑŸÖÿÆÿ™ÿßÿ±\r\n   */\r\n  initializeProvider() {\r\n    logger.info(`üîÑ Initializing WhatsApp provider: ${this.provider}`);\r\n\r\n    switch (this.provider) {\r\n      case 'twilio':\r\n        this.setupTwilioProvider();\r\n        break;\r\n      case 'messagebird':\r\n        this.setupMessageBirdProvider();\r\n        break;\r\n      default:\r\n        this.setupOfficialProvider();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿπÿØÿßÿØ ŸÖŸÇÿØŸÖ WhatsApp ÿßŸÑÿ±ÿ≥ŸÖŸä\r\n   */\r\n  setupOfficialProvider() {\r\n    this.client = axios.create({\r\n      baseURL: `${this.whatsappProviders.official.baseURL}/${this.whatsappProviders.official.version}/${this.apiConfig.phoneNumberId}`,\r\n      headers: {\r\n        'Authorization': `Bearer ${this.apiConfig.token}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      timeout: 10000,\r\n    });\r\n\r\n    logger.info('‚úÖ WhatsApp Official Provider initialized');\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿπÿØÿßÿØ ŸÖŸÇÿØŸÖ Twilio\r\n   */\r\n  setupTwilioProvider() {\r\n    try {\r\n      const twilio = require('twilio');\r\n      this.twilioClient = twilio(\r\n        this.whatsappProviders.twilio.accountSid,\r\n        this.whatsappProviders.twilio.authToken\r\n      );\r\n      logger.info('‚úÖ Twilio WhatsApp Provider initialized');\r\n    } catch (error) {\r\n      logger.warn('‚ö†Ô∏è Twilio module not available. Falling back to Official Provider.');\r\n      this.provider = 'official';\r\n      this.setupOfficialProvider();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿπÿØÿßÿØ ŸÖŸÇÿØŸÖ MessageBird\r\n   */\r\n  setupMessageBirdProvider() {\r\n    this.client = axios.create({\r\n      baseURL: this.whatsappProviders.messagebird.baseURL,\r\n      headers: {\r\n        'Authorization': `Bearer ${this.whatsappProviders.messagebird.token}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      timeout: 10000,\r\n    });\r\n    logger.info('‚úÖ MessageBird WhatsApp Provider initialized');\r\n  }\r\n\r\n  /**\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   * üì® ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   */\r\n\r\n  /**\r\n   * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿµŸäÿ©\r\n   */\r\n  async sendMessage(phoneNumber, message, options = {}) {\r\n    try {\r\n      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ\r\n      if (!this.isValidPhoneNumber(phoneNumber)) {\r\n        throw new Error(`ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠: ${phoneNumber}`);\r\n      }\r\n\r\n      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿ®Ÿäÿ∂ÿßÿ° (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)\r\n      if (process.env.WHATSAPP_WHITELIST_ONLY === 'true') {\r\n        if (!this.whitelist.has(phoneNumber)) {\r\n          logger.warn(`üì± ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿ±ÿ¨ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°: ${phoneNumber}`);\r\n          throw new Error(`ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ÿ®Ÿá`);\r\n        }\r\n      }\r\n\r\n      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ\r\n      if (!this.checkRateLimit()) {\r\n        logger.warn('‚ö†Ô∏è ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ ŸÖÿπÿØŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ');\r\n        throw new Error('ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ ŸÖÿπÿØŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã');\r\n      }\r\n\r\n      const messageData = {\r\n        phoneNumber: this.normalizePhoneNumber(phoneNumber),\r\n        message: this.sanitizeMessage(message),\r\n        timestamp: new Date(),\r\n        status: 'pending',\r\n        retries: 0,\r\n        ...options,\r\n      };\r\n\r\n      // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±\r\n      this.messageQueue.push(messageData);\r\n\r\n      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ≠ÿØÿ´\r\n      this.emit('messageQueued', messageData);\r\n\r\n      logger.info(`üìù ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${phoneNumber}`);\r\n\r\n      return messageData;\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©: ${error.message}`);\r\n      this.emit('messageSendError', { phoneNumber, error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿπ ÿµŸàÿ±ÿ©\r\n   */\r\n  async sendImageMessage(phoneNumber, imageUrl, caption = '', options = {}) {\r\n    try {\r\n      if (!this.isValidURL(imageUrl)) {\r\n        throw new Error('ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');\r\n      }\r\n\r\n      const messageData = {\r\n        type: 'image',\r\n        phoneNumber: this.normalizePhoneNumber(phoneNumber),\r\n        media: imageUrl,\r\n        caption: this.sanitizeMessage(caption),\r\n        timestamp: new Date(),\r\n        status: 'pending',\r\n        retries: 0,\r\n        ...options,\r\n      };\r\n\r\n      this.messageQueue.push(messageData);\r\n      this.emit('messageQueued', messageData);\r\n\r\n      logger.info(`üñºÔ∏è ÿ±ÿ≥ÿßŸÑÿ© ÿµŸàÿ±ÿ© ŸÖÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${phoneNumber}`);\r\n\r\n      return messageData;\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿµŸàÿ±ÿ©: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿπ ŸÖŸÑŸÅ\r\n   */\r\n  async sendDocumentMessage(phoneNumber, fileUrl, fileName = '', options = {}) {\r\n    try {\r\n      if (!this.isValidURL(fileUrl)) {\r\n        throw new Error('ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');\r\n      }\r\n\r\n      const messageData = {\r\n        type: 'document',\r\n        phoneNumber: this.normalizePhoneNumber(phoneNumber),\r\n        media: fileUrl,\r\n        fileName: fileName || 'document',\r\n        timestamp: new Date(),\r\n        status: 'pending',\r\n        retries: 0,\r\n        ...options,\r\n      };\r\n\r\n      this.messageQueue.push(messageData);\r\n      this.emit('messageQueued', messageData);\r\n\r\n      logger.info(`üìÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÑŸÅ ŸÖÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${phoneNumber}`);\r\n\r\n      return messageData;\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖŸÑŸÅ: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÅÿßÿπŸÑŸäÿ© (ÿ£ÿ≤ÿ±ÿßÿ±)\r\n   */\r\n  async sendInteractiveMessage(phoneNumber, message, buttons, options = {}) {\r\n    try {\r\n      if (!Array.isArray(buttons) || buttons.length === 0) {\r\n        throw new Error('Ÿäÿ¨ÿ® ÿ™ŸàŸÅŸäÿ± ÿ≤ÿ± Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');\r\n      }\r\n\r\n      if (buttons.length > 3) {\r\n        throw new Error('ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸáŸà 3');\r\n      }\r\n\r\n      const messageData = {\r\n        type: 'interactive',\r\n        phoneNumber: this.normalizePhoneNumber(phoneNumber),\r\n        message: this.sanitizeMessage(message),\r\n        buttons: buttons.map((btn, idx) => ({\r\n          id: btn.id || `btn_${idx}`,\r\n          title: btn.title,\r\n          description: btn.description || '',\r\n        })),\r\n        timestamp: new Date(),\r\n        status: 'pending',\r\n        retries: 0,\r\n        ...options,\r\n      };\r\n\r\n      this.messageQueue.push(messageData);\r\n      this.emit('messageQueued', messageData);\r\n\r\n      logger.info(`üîò ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÅÿßÿπŸÑŸäÿ© ŸÖÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±: ${phoneNumber}`);\r\n\r\n      return messageData;\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ©: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ¨ŸÖÿßÿπŸäÿ©\r\n   */\r\n  async sendBulkMessages(phoneNumbers, message, options = {}) {\r\n    try {\r\n      if (!Array.isArray(phoneNumbers) || phoneNumbers.length === 0) {\r\n        throw new Error('Ÿäÿ¨ÿ® ÿ™ŸàŸÅŸäÿ± ŸÇÿßÿ¶ŸÖÿ© ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáÿßÿ™ŸÅ');\r\n      }\r\n\r\n      const results = [];\r\n\r\n      for (const phoneNumber of phoneNumbers) {\r\n        try {\r\n          const result = await this.sendMessage(phoneNumber, message, options);\r\n          results.push({\r\n            phoneNumber,\r\n            status: 'queued',\r\n            id: result.id,\r\n          });\r\n        } catch (error) {\r\n          results.push({\r\n            phoneNumber,\r\n            status: 'failed',\r\n            error: error.message,\r\n          });\r\n        }\r\n      }\r\n\r\n      logger.info(`üì¨ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${results.filter(r => r.status === 'queued').length} ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ŸÖÿßÿπŸäÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±`);\r\n\r\n      return results;\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸä: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   * ‚öôÔ∏è ŸÖÿπÿßŸÑÿ¨ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   */\r\n\r\n  /**\r\n   * ÿ®ÿØÿ° ŸÖÿπÿßŸÑÿ¨ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±\r\n   */\r\n  startQueueProcessor() {\r\n    setInterval(() => {\r\n      if (!this.isProcessing && this.messageQueue.length > 0) {\r\n        this.processQueue();\r\n      }\r\n    }, 1000);\r\n\r\n    logger.info('‚ñ∂Ô∏è ŸÖÿπÿßŸÑÿ¨ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÜÿ¥ÿ∑');\r\n  }\r\n\r\n  /**\r\n   * ŸÖÿπÿßŸÑÿ¨ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±\r\n   */\r\n  async processQueue() {\r\n    if (this.isProcessing || this.messageQueue.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.isProcessing = true;\r\n\r\n    try {\r\n      while (this.messageQueue.length > 0) {\r\n        const message = this.messageQueue.shift();\r\n\r\n        try {\r\n          const result = await this.deliverMessage(message);\r\n          message.status = 'sent';\r\n          message.id = result.id;\r\n          message.sentAt = new Date();\r\n\r\n          this.addToHistory(message);\r\n          this.emit('messageSent', message);\r\n\r\n          logger.info(`‚úÖ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ±ÿ≥ŸÑÿ© ÿ•ŸÑŸâ ${message.phoneNumber}`);\r\n\r\n          // ÿ™ÿ£ÿÆŸäÿ± ÿµÿ∫Ÿäÿ± ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿßÿ≤ÿØÿ≠ÿßŸÖ\r\n          await this.delay(100);\r\n        } catch (error) {\r\n          message.retries = (message.retries || 0) + 1;\r\n\r\n          if (message.retries >= this.maxRetries) {\r\n            message.status = 'failed';\r\n            message.error = error.message;\r\n            this.addToHistory(message);\r\n            this.emit('messageFailed', message);\r\n\r\n            logger.error(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿπÿØ ${this.maxRetries} ŸÖÿ≠ÿßŸàŸÑÿßÿ™: ${message.phoneNumber}`);\r\n          } else {\r\n            // ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©\r\n            this.retryQueue.push({\r\n              message,\r\n              retryAt: Date.now() + (this.retryDelay * message.retries),\r\n            });\r\n\r\n            logger.warn(`‚ö†Ô∏è ÿ•ÿπÿßÿØÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ (${message.retries}/${this.maxRetries}): ${message.phoneNumber}`);\r\n          }\r\n        }\r\n      }\r\n\r\n      // ŸÖÿπÿßŸÑÿ¨ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™\r\n      await this.processRetryQueue();\r\n    } finally {\r\n      this.isProcessing = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ŸÖÿπÿßŸÑÿ¨ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™\r\n   */\r\n  async processRetryQueue() {\r\n    const now = Date.now();\r\n    const readyRetries = this.retryQueue.filter(r => r.retryAt <= now);\r\n\r\n    readyRetries.forEach(retry => {\r\n      this.messageQueue.push(retry.message);\r\n      this.retryQueue = this.retryQueue.filter(r => r !== retry);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÅÿπŸÑŸä\r\n   */\r\n  async deliverMessage(messageData) {\r\n    try {\r\n      switch (this.provider) {\r\n        case 'twilio':\r\n          return await this.sendViatwilio(messageData);\r\n        case 'messagebird':\r\n          return await this.sendViaMessageBird(messageData);\r\n        default:\r\n          return await this.sendViaOfficial(messageData);\r\n      }\r\n    } catch (error) {\r\n      logger.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± WhatsApp ÿßŸÑÿ±ÿ≥ŸÖŸä\r\n   */\r\n  async sendViaOfficial(messageData) {\r\n    try {\r\n      let payload;\r\n\r\n      switch (messageData.type) {\r\n        case 'image':\r\n          payload = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: messageData.phoneNumber,\r\n            type: 'image',\r\n            image: {\r\n              link: messageData.media,\r\n            },\r\n          };\r\n          break;\r\n\r\n        case 'document':\r\n          payload = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: messageData.phoneNumber,\r\n            type: 'document',\r\n            document: {\r\n              link: messageData.media,\r\n              filename: messageData.fileName,\r\n            },\r\n          };\r\n          break;\r\n\r\n        case 'interactive':\r\n          payload = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: messageData.phoneNumber,\r\n            type: 'interactive',\r\n            interactive: {\r\n              type: 'button',\r\n              body: {\r\n                text: messageData.message,\r\n              },\r\n              action: {\r\n                buttons: messageData.buttons.map((btn, idx) => ({\r\n                  type: 'reply',\r\n                  reply: {\r\n                    id: btn.id,\r\n                    title: btn.title,\r\n                  },\r\n                })),\r\n              },\r\n            },\r\n          };\r\n          break;\r\n\r\n        default:\r\n          payload = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: messageData.phoneNumber,\r\n            type: 'text',\r\n            text: {\r\n              preview_url: true,\r\n              body: messageData.message,\r\n            },\r\n          };\r\n      }\r\n\r\n      const response = await this.client.post('/messages', payload);\r\n\r\n      return {\r\n        id: response.data.messages[0].id,\r\n        status: 'sent',\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (error) {\r\n      throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± WhatsApp ÿßŸÑÿ±ÿ≥ŸÖŸä: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± Twilio\r\n   */\r\n  async sendViaTwilio(messageData) {\r\n    try {\r\n      let message;\r\n\r\n      switch (messageData.type) {\r\n        case 'image':\r\n          message = await this.twilioClient.messages.create({\r\n            from: 'whatsapp:' + process.env.TWILIO_WHATSAPP_NUMBER,\r\n            mediaUrl: [messageData.media],\r\n            body: messageData.caption || '',\r\n            to: 'whatsapp:' + messageData.phoneNumber,\r\n          });\r\n          break;\r\n\r\n        default:\r\n          message = await this.twilioClient.messages.create({\r\n            from: 'whatsapp:' + process.env.TWILIO_WHATSAPP_NUMBER,\r\n            body: messageData.message || messageData.caption,\r\n            to: 'whatsapp:' + messageData.phoneNumber,\r\n          });\r\n      }\r\n\r\n      return {\r\n        id: message.sid,\r\n        status: 'sent',\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (error) {\r\n      throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± Twilio: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± MessageBird\r\n   */\r\n  async sendViaMessageBird(messageData) {\r\n    try {\r\n      const payload = {\r\n        to: messageData.phoneNumber,\r\n        from: process.env.MESSAGEBIRD_WHATSAPP_CHANNEL_ID,\r\n        type: messageData.type || 'text',\r\n        content: {\r\n          text: messageData.message,\r\n        },\r\n      };\r\n\r\n      const response = await this.client.post('/send', payload);\r\n\r\n      return {\r\n        id: response.data.id,\r\n        status: 'sent',\r\n        timestamp: new Date(),\r\n      };\r\n    } catch (error) {\r\n      throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± MessageBird: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   * üõ†Ô∏è ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   */\r\n\r\n  /**\r\n   * ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ\r\n   */\r\n  isValidPhoneNumber(phoneNumber) {\r\n    const cleaned = phoneNumber.replace(/\\D/g, '');\r\n    return cleaned.length >= 10 && cleaned.length <= 15;\r\n  }\r\n\r\n  /**\r\n   * ÿ™ÿ∑ÿ®Ÿäÿπ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ\r\n   */\r\n  normalizePhoneNumber(phoneNumber) {\r\n    let cleaned = phoneNumber.replace(/\\D/g, '');\r\n\r\n    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÅÿßÿ± ÿßŸÑÿ®ÿßÿØÿ¶ÿ©\r\n    if (cleaned.startsWith('00')) {\r\n      cleaned = cleaned.substring(2);\r\n    } else if (cleaned.startsWith('0')) {\r\n      cleaned = cleaned.substring(1);\r\n    }\r\n\r\n    // ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ÿßŸÑŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿ≥ÿπŸàÿØŸäÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã\r\n    if (!cleaned.startsWith('966')) {\r\n      if (cleaned.startsWith('5')) {\r\n        cleaned = '966' + cleaned;\r\n      }\r\n    }\r\n\r\n    return cleaned;\r\n  }\r\n\r\n  /**\r\n   * ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©\r\n   */\r\n  sanitizeMessage(message) {\r\n    return String(message)\r\n      .replace(/[^\\w\\s\\-\\u0600-\\u06FF.!?ÿåÿõ:()[\\]{}]/g, '')\r\n      .trim()\r\n      .substring(0, 4096);\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ±ÿßÿ®ÿ∑\r\n   */\r\n  isValidURL(url) {\r\n    try {\r\n      new URL(url);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ\r\n   */\r\n  checkRateLimit() {\r\n    const now = Date.now();\r\n    const oneMinuteAgo = now - 60000;\r\n    const oneHourAgo = now - 3600000;\r\n\r\n    // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÇÿØŸäŸÖÿ©\r\n    this.rateLimit.messagesSent = this.rateLimit.messagesSent.filter(\r\n      time => time > oneHourAgo\r\n    );\r\n\r\n    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿØ ÿßŸÑÿØŸÇŸäŸÇÿ©\r\n    const lastMinute = this.rateLimit.messagesSent.filter(\r\n      time => time > oneMinuteAgo\r\n    ).length;\r\n\r\n    if (lastMinute >= this.rateLimit.messagesPerMinute) {\r\n      return false;\r\n    }\r\n\r\n    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿØ ÿßŸÑÿ≥ÿßÿπÿ©\r\n    if (this.rateLimit.messagesSent.length >= this.rateLimit.messagesPerHour) {\r\n      return false;\r\n    }\r\n\r\n    this.rateLimit.messagesSent.push(now);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ\r\n   */\r\n  addToHistory(message) {\r\n    this.messageHistory.push({\r\n      id: message.id || `msg_${Date.now()}`,\r\n      phoneNumber: message.phoneNumber,\r\n      type: message.type || 'text',\r\n      status: message.status,\r\n      sentAt: message.sentAt || new Date(),\r\n      retries: message.retries || 0,\r\n    });\r\n\r\n    // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ≠ÿØ ÿ£ŸÇÿµŸâ\r\n    if (this.messageHistory.length > this.maxHistory) {\r\n      this.messageHistory = this.messageHistory.slice(-this.maxHistory);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ÿ™ÿ£ÿÆŸäÿ±\r\n   */\r\n  delay(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   * üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸàÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©\r\n   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n   */\r\n\r\n  /**\r\n   * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ\r\n   */\r\n  getStatistics() {\r\n    const total = this.messageHistory.length;\r\n    const sent = this.messageHistory.filter(m => m.status === 'sent').length;\r\n    const failed = this.messageHistory.filter(m => m.status === 'failed').length;\r\n    const pending = this.messageQueue.length;\r\n\r\n    return {\r\n      total,\r\n      sent,\r\n      failed,\r\n      pending,\r\n      successRate: total > 0 ? ((sent / total) * 100).toFixed(2) + '%' : '0%',\r\n      queueLength: pending,\r\n      queueProcessing: this.isProcessing,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ\r\n   */\r\n  getHistory(limit = 50) {\r\n    return this.messageHistory.slice(-limit);\r\n  }\r\n\r\n  /**\r\n   * ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ\r\n   */\r\n  clearHistory() {\r\n    this.messageHistory = [];\r\n    logger.info('üóëÔ∏è ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ');\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÇŸÖ ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°\r\n   */\r\n  addToWhitelist(phoneNumber) {\r\n    const normalized = this.normalizePhoneNumber(phoneNumber);\r\n    this.whitelist.add(normalized);\r\n    logger.info(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${normalized} ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°`);\r\n  }\r\n\r\n  /**\r\n   * ÿ•ÿ≤ÿßŸÑÿ© ÿ±ŸÇŸÖ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°\r\n   */\r\n  removeFromWhitelist(phoneNumber) {\r\n    const normalized = this.normalizePhoneNumber(phoneNumber);\r\n    this.whitelist.delete(normalized);\r\n    logger.info(`‚ùå ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ${normalized} ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°`);\r\n  }\r\n\r\n  /**\r\n   * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°\r\n   */\r\n  getWhitelist() {\r\n    return Array.from(this.whitelist);\r\n  }\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// üì¶ ÿßŸÑÿ™ÿµÿØŸäÿ±\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nmodule.exports = new WhatsAppNotificationService();\r\n"],"mappings":"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","ignoreList":[]}