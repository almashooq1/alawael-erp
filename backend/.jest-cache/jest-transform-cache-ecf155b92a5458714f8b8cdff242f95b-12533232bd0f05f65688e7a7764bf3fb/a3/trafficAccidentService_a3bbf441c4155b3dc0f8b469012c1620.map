{"version":3,"names":["TrafficAccidentReport","require","Driver","Vehicle","logger","PDFDocument","xlsx","TrafficAccidentService","createAccidentReport","accidentData","userId","info","report","reportedBy","auditInfo","createdBy","createdAt","Date","generateReportNumber","calculateTotalLoss","save","reportNumber","error","message","getAllReports","filters","page","limit","query","archived","status","severity","startDate","endDate","$gte","$lte","city","priority","skip","total","countDocuments","reports","find","populate","sort","lean","pagination","pages","Math","ceil","getReportById","reportId","findById","Error","updateAccidentReport","updateData","allowedFields","Object","keys","forEach","key","includes","lastModifiedBy","lastModifiedAt","deleteAccidentReport","reason","archive","updateReportStatus","newStatus","notes","oldStatus","comments","push","userName","comment","startInvestigation","investigatingOfficerId","markAsUnderInvestigation","investigatingOfficer","completeInvestigation","investigationResults","findings","rootCause","contributingFactors","recommendations","primaryCause","investigation","addComment","attachments","timestamp","addWitness","witnessData","witnesses","contactedAt","addAttachment","attachmentData","uploadedAt","uploadedBy","addInsuranceInfo","vehicleIndex","insuranceData","vehicles","length","insurance","determineLiability","primaryResponsiblePartyId","responsibilityPercentage","determination","liability","primaryResponsibleParty","closeReport","conclusionData","close","followUp","generatePDFReport","includeAttachments","doc","size","margin","fontSize","font","text","align","moveDown","accidentInfo","accidentDateTime","toLocaleDateString","location","address","description","vehicle","index","plateNumber","vehicleType","damage","type","financialImpact","totalLoss","repairCosts","medicalCosts","generateExcelReport","data","map","totalInjured","totalDeaths","name","worksheet","utils","json_to_ws","workbook","book_new","book_append_sheet","getStatistics","statistics","statusDistribution","severityDistribution","Promise","all","getStatusDistribution","getSeverityDistribution","summary","totalReports","totalFinancialLoss","searchReports","searchTerm","searchRegex","RegExp","$or","getNearbyAccidents","latitude","longitude","maxDistance","accidents","$near","$geometry","coordinates","$maxDistance","recordViewHistory","recordView","getOverdueFollowUps","daysThreshold","thresholdDate","setDate","getDate","overdueReports","$lt","updateDamageInfo","damageData","applyArchivalFilter","reportIds","retentionDays","cutoffDate","result","updateMany","_id","$in","archivedAt","archivedBy","archivedReason","module","exports"],"sources":["trafficAccidentService.js"],"sourcesContent":["/**\r\n * Traffic Accident Reporting Service - خدمة تقارير الحوادث المرورية\r\n * خدمة شاملة لإدارة تقارير الحوادث المرورية\r\n */\r\n\r\nconst TrafficAccidentReport = require('../models/TrafficAccidentReport');\r\nconst Driver = require('../models/Driver');\r\nconst Vehicle = require('../models/Vehicle');\r\nconst logger = require('../utils/logger');\r\nconst PDFDocument = require('pdfkit');\r\nconst xlsx = require('xlsx');\r\n\r\nclass TrafficAccidentService {\r\n  /**\r\n   * 1. إنشاء تقرير حادث جديد\r\n   */\r\n  async createAccidentReport(accidentData, userId) {\r\n    try {\r\n      logger.info('Creating new accident report', { userId });\r\n\r\n      const report = new TrafficAccidentReport({\r\n        ...accidentData,\r\n        reportedBy: userId,\r\n        auditInfo: {\r\n          createdBy: userId,\r\n          createdAt: new Date()\r\n        }\r\n      });\r\n\r\n      report.generateReportNumber();\r\n      report.calculateTotalLoss();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Accident report created successfully', {\r\n        reportNumber: report.reportNumber,\r\n        userId\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error creating accident report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 2. الحصول على جميع التقارير\r\n   */\r\n  async getAllReports(filters = {}, page = 1, limit = 20) {\r\n    try {\r\n      const query = { archived: false };\r\n\r\n      // Filter by status\r\n      if (filters.status) {\r\n        query.status = filters.status;\r\n      }\r\n\r\n      // Filter by severity\r\n      if (filters.severity) {\r\n        query.severity = filters.severity;\r\n      }\r\n\r\n      // Filter by date range\r\n      if (filters.startDate || filters.endDate) {\r\n        query['accidentInfo.accidentDateTime'] = {};\r\n        if (filters.startDate) {\r\n          query['accidentInfo.accidentDateTime'].$gte = new Date(\r\n            filters.startDate\r\n          );\r\n        }\r\n        if (filters.endDate) {\r\n          query['accidentInfo.accidentDateTime'].$lte = new Date(\r\n            filters.endDate\r\n          );\r\n        }\r\n      }\r\n\r\n      // Filter by location/city\r\n      if (filters.city) {\r\n        query['accidentInfo.location.city'] = filters.city;\r\n      }\r\n\r\n      // Filter by priority\r\n      if (filters.priority) {\r\n        query.priority = filters.priority;\r\n      }\r\n\r\n      const skip = (page - 1) * limit;\r\n      const total = await TrafficAccidentReport.countDocuments(query);\r\n      const reports = await TrafficAccidentReport.find(query)\r\n        .populate('reportedBy', 'name email')\r\n        .populate('investigation.investigatingOfficer', 'name email')\r\n        .populate('liability.primaryResponsibleParty', 'firstName lastName')\r\n        .sort({ 'accidentInfo.accidentDateTime': -1 })\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .lean();\r\n\r\n      return {\r\n        reports,\r\n        pagination: {\r\n          page,\r\n          limit,\r\n          total,\r\n          pages: Math.ceil(total / limit)\r\n        }\r\n      };\r\n    } catch (error) {\r\n      logger.error('Error fetching accident reports', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 3. الحصول على تقرير حادث بواسطة ID\r\n   */\r\n  async getReportById(reportId) {\r\n    try {\r\n      const report = await TrafficAccidentReport.findById(reportId)\r\n        .populate('reportedBy', 'name email phone')\r\n        .populate('investigation.investigatingOfficer', 'name email')\r\n        .populate('vehicles.vehicleId')\r\n        .populate('vehicles.driverId', 'firstName lastName email')\r\n        .populate('people.drivers.driverId', 'firstName lastName')\r\n        .populate('comments.userId', 'name email')\r\n        .populate('auditInfo.createdBy', 'name email')\r\n        .populate('auditInfo.lastModifiedBy', 'name email');\r\n\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error fetching accident report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 4. تحديث تقرير الحادث\r\n   */\r\n  async updateAccidentReport(reportId, updateData, userId) {\r\n    try {\r\n      logger.info('Updating accident report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      // تحديث البيانات المسموحة فقط\r\n      const allowedFields = [\r\n        'accidentInfo',\r\n        'description',\r\n        'vehicles',\r\n        'wounded',\r\n        'deaths',\r\n        'financialImpact',\r\n        'violations'\r\n      ];\r\n\r\n      Object.keys(updateData).forEach(key => {\r\n        if (allowedFields.includes(key)) {\r\n          report[key] = updateData[key];\r\n        }\r\n      });\r\n\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n      report.calculateTotalLoss();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Accident report updated successfully', {\r\n        reportNumber: report.reportNumber\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error updating accident report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 5. حذف تقرير الحادث (أرشفة لين)\r\n   */\r\n  async deleteAccidentReport(reportId, userId, reason) {\r\n    try {\r\n      logger.info('Deleting accident report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.archive(userId, reason);\r\n      await report.save();\r\n\r\n      logger.info('Accident report archived successfully', {\r\n        reportNumber: report.reportNumber\r\n      });\r\n\r\n      return { message: 'تم أرشفة التقرير بنجاح' };\r\n    } catch (error) {\r\n      logger.error('Error deleting accident report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 6. تحديث حالة التقرير\r\n   */\r\n  async updateReportStatus(reportId, newStatus, userId, notes = '') {\r\n    try {\r\n      logger.info('Updating report status', { reportId, newStatus, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      const oldStatus = report.status;\r\n      report.status = newStatus;\r\n\r\n      if (notes) {\r\n        report.comments.push({\r\n          userId,\r\n          userName: 'System',\r\n          comment: `تم تغيير الحالة من ${oldStatus} إلى ${newStatus}: ${notes}`\r\n        });\r\n      }\r\n\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Report status updated', {\r\n        reportNumber: report.reportNumber,\r\n        oldStatus,\r\n        newStatus\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error updating report status', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 7. بدء التحقيق\r\n   */\r\n  async startInvestigation(reportId, investigatingOfficerId, userId) {\r\n    try {\r\n      logger.info('Starting investigation', {\r\n        reportId,\r\n        investigatingOfficerId,\r\n        userId\r\n      });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.markAsUnderInvestigation(investigatingOfficerId);\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Investigation started', {\r\n        reportNumber: report.reportNumber,\r\n        investigatingOfficer: investigatingOfficerId\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error starting investigation', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 8. إكمال التحقيق\r\n   */\r\n  async completeInvestigation(\r\n    reportId,\r\n    investigationResults,\r\n    userId\r\n  ) {\r\n    try {\r\n      logger.info('Completing investigation', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      const {\r\n        findings,\r\n        rootCause,\r\n        contributingFactors,\r\n        recommendations,\r\n        primaryCause\r\n      } = investigationResults;\r\n\r\n      report.completeInvestigation(findings, rootCause, recommendations);\r\n      report.investigation.contributingFactors = contributingFactors;\r\n      report.investigation.primaryCause = primaryCause;\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Investigation completed', {\r\n        reportNumber: report.reportNumber\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error completing investigation', {\r\n        error: error.message\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 9. إضافة تعليق\r\n   */\r\n  async addComment(reportId, userId, userName, comment, attachments = []) {\r\n    try {\r\n      logger.info('Adding comment to report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.comments.push({\r\n        userId,\r\n        userName,\r\n        comment,\r\n        timestamp: new Date(),\r\n        attachments\r\n      });\r\n\r\n      await report.save();\r\n\r\n      logger.info('Comment added', { reportNumber: report.reportNumber });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error adding comment', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 10. إضافة الشهود والإفادات\r\n   */\r\n  async addWitness(reportId, witnessData, userId) {\r\n    try {\r\n      logger.info('Adding witness to report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.witnesses.push({\r\n        ...witnessData,\r\n        contactedAt: new Date()\r\n      });\r\n\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Witness added', { reportNumber: report.reportNumber });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error adding witness', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 11. إضافة مرفقات\r\n   */\r\n  async addAttachment(reportId, attachmentData, userId) {\r\n    try {\r\n      logger.info('Adding attachment to report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.attachments.push({\r\n        ...attachmentData,\r\n        uploadedAt: new Date(),\r\n        uploadedBy: userId\r\n      });\r\n\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Attachment added', { reportNumber: report.reportNumber });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error adding attachment', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 12. إضافة معلومات التأمين\r\n   */\r\n  async addInsuranceInfo(reportId, vehicleIndex, insuranceData, userId) {\r\n    try {\r\n      logger.info('Adding insurance info', {\r\n        reportId,\r\n        vehicleIndex,\r\n        userId\r\n      });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      if (\r\n        !report.vehicles[vehicleIndex] ||\r\n        vehicleIndex < 0 ||\r\n        vehicleIndex >= report.vehicles.length\r\n      ) {\r\n        throw new Error('المركبة غير موجودة');\r\n      }\r\n\r\n      report.vehicles[vehicleIndex].insurance = insuranceData;\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Insurance info added', {\r\n        reportNumber: report.reportNumber\r\n      });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error adding insurance info', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 13. تحديد المسؤولية\r\n   */\r\n  async determineLiability(\r\n    reportId,\r\n    primaryResponsiblePartyId,\r\n    responsibilityPercentage,\r\n    determination,\r\n    userId\r\n  ) {\r\n    try {\r\n      logger.info('Determining liability', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.liability = {\r\n        primaryResponsibleParty: primaryResponsiblePartyId,\r\n        responsibilityPercentage,\r\n        determination\r\n      };\r\n\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Liability determined', { reportNumber: report.reportNumber });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error determining liability', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 14. إغلاق التقرير\r\n   */\r\n  async closeReport(reportId, conclusionData, userId) {\r\n    try {\r\n      logger.info('Closing accident report', { reportId, userId });\r\n\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.close();\r\n      report.followUp.status = 'resolved';\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      logger.info('Report closed', { reportNumber: report.reportNumber });\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error closing report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 15. توليد تقرير PDF\r\n   */\r\n  async generatePDFReport(reportId, includeAttachments = false) {\r\n    try {\r\n      const report = await this.getReportById(reportId);\r\n\r\n      const doc = new PDFDocument({\r\n        size: 'A4',\r\n        margin: 50\r\n      });\r\n\r\n      // Header\r\n      doc\r\n        .fontSize(20)\r\n        .font('Helvetica-Bold')\r\n        .text('تقرير الحادثة المرورية', { align: 'center' });\r\n      doc.moveDown();\r\n\r\n      doc\r\n        .fontSize(12)\r\n        .font('Helvetica')\r\n        .text(`رقم التقرير: ${report.reportNumber}`);\r\n      doc.text(`الحالة: ${report.status}`);\r\n      doc.text(`الشدة: ${report.severity}`);\r\n      doc.text(`تاريخ الحادث: ${report.accidentInfo.accidentDateTime.toLocaleDateString()}`);\r\n      doc.moveDown();\r\n\r\n      // Location Info\r\n      doc\r\n        .fontSize(14)\r\n        .font('Helvetica-Bold')\r\n        .text('معلومات الموقع');\r\n      doc\r\n        .fontSize(11)\r\n        .font('Helvetica')\r\n        .text(`العنوان: ${report.accidentInfo.location.address}`);\r\n      doc.text(`المدينة: ${report.accidentInfo.location.city}`);\r\n      doc.text(`الوصف: ${report.accidentInfo.description}`);\r\n      doc.moveDown();\r\n\r\n      // Vehicles Info\r\n      doc\r\n        .fontSize(14)\r\n        .font('Helvetica-Bold')\r\n        .text('المركبات المتورطة');\r\n      report.vehicles.forEach((vehicle, index) => {\r\n        doc\r\n          .fontSize(11)\r\n          .font('Helvetica')\r\n          .text(`مركبة ${index + 1}:`);\r\n        doc.text(`رقم لوحة الترخيص: ${vehicle.plateNumber}`);\r\n        doc.text(`نوع المركبة: ${vehicle.vehicleType}`);\r\n        doc.text(`الضرر: ${vehicle.damage?.type}`);\r\n        doc.moveDown(0.5);\r\n      });\r\n\r\n      // Financial Impact\r\n      doc\r\n        .fontSize(14)\r\n        .font('Helvetica-Bold')\r\n        .text('التأثير المالي');\r\n      doc\r\n        .fontSize(11)\r\n        .font('Helvetica')\r\n        .text(\r\n          `إجمالي الخسائر: ${report.financialImpact.totalLoss} SAR`\r\n        );\r\n      doc.text(\r\n        `تكاليف الإصلاح: ${report.financialImpact.repairCosts} SAR`\r\n      );\r\n      doc.text(\r\n        `التكاليف الطبية: ${report.financialImpact.medicalCosts} SAR`\r\n      );\r\n      doc.moveDown();\r\n\r\n      // Investigation\r\n      if (report.investigation.findings) {\r\n        doc\r\n          .fontSize(14)\r\n          .font('Helvetica-Bold')\r\n          .text('نتائج التحقيق');\r\n        doc\r\n          .fontSize(11)\r\n          .font('Helvetica')\r\n          .text(report.investigation.findings);\r\n        doc.moveDown();\r\n      }\r\n\r\n      return doc;\r\n    } catch (error) {\r\n      logger.error('Error generating PDF report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 16. توليد تقرير Excel\r\n   */\r\n  async generateExcelReport(filters = {}) {\r\n    try {\r\n      const { reports } = await this.getAllReports(filters, 1, 10000);\r\n\r\n      const data = reports.map(report => ({\r\n        'رقم التقرير': report.reportNumber,\r\n        'تاريخ الحادث': report.accidentInfo.accidentDateTime.toLocaleDateString(\r\n          'ar-SA'\r\n        ),\r\n        'الموقع': report.accidentInfo.location.city,\r\n        'الشدة': report.severity,\r\n        'الحالة': report.status,\r\n        'عدد الجرحى': report.totalInjured,\r\n        'الوفيات': report.totalDeaths,\r\n        'إجمالي الخسائر': report.financialImpact.totalLoss,\r\n        'المحقق': report.investigation.investigatingOfficer?.name || 'N/A'\r\n      }));\r\n\r\n      const worksheet = xlsx.utils.json_to_ws(data);\r\n      const workbook = xlsx.utils.book_new();\r\n      xlsx.utils.book_append_sheet(workbook, worksheet, 'تقارير الحوادث');\r\n\r\n      return workbook;\r\n    } catch (error) {\r\n      logger.error('Error generating Excel report', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 17. الحصول على الإحصائيات\r\n   */\r\n  async getStatistics(filters = {}) {\r\n    try {\r\n      logger.info('Fetching accident statistics', { filters });\r\n\r\n      const [\r\n        statistics,\r\n        statusDistribution,\r\n        severityDistribution\r\n      ] = await Promise.all([\r\n        TrafficAccidentReport.getStatistics(filters),\r\n        TrafficAccidentReport.getStatusDistribution(filters),\r\n        TrafficAccidentReport.getSeverityDistribution(filters)\r\n      ]);\r\n\r\n      return {\r\n        summary: statistics[0] || {\r\n          totalReports: 0,\r\n          totalInjured: 0,\r\n          totalDeaths: 0,\r\n          totalFinancialLoss: 0\r\n        },\r\n        statusDistribution,\r\n        severityDistribution\r\n      };\r\n    } catch (error) {\r\n      logger.error('Error fetching statistics', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 18. البحث المتقدم\r\n   */\r\n  async searchReports(searchTerm, filters = {}, page = 1, limit = 20) {\r\n    try {\r\n      const searchRegex = new RegExp(searchTerm, 'i');\r\n\r\n      const query = {\r\n        archived: false,\r\n        $or: [\r\n          { reportNumber: searchRegex },\r\n          { 'accidentInfo.description': searchRegex },\r\n          { 'accidentInfo.location.city': searchRegex },\r\n          { 'vehicles.plateNumber': searchRegex }\r\n        ]\r\n      };\r\n\r\n      // Apply additional filters\r\n      if (filters.severity) query.severity = filters.severity;\r\n      if (filters.status) query.status = filters.status;\r\n\r\n      const skip = (page - 1) * limit;\r\n      const total = await TrafficAccidentReport.countDocuments(query);\r\n      const reports = await TrafficAccidentReport.find(query)\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .lean();\r\n\r\n      return {\r\n        reports,\r\n        pagination: {\r\n          page,\r\n          limit,\r\n          total,\r\n          pages: Math.ceil(total / limit)\r\n        }\r\n      };\r\n    } catch (error) {\r\n      logger.error('Error searching reports', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 19. الحصول على التقارير القريبة جغرافياً\r\n   */\r\n  async getNearbyAccidents(latitude, longitude, maxDistance = 5000) {\r\n    // maxDistance in meters\r\n    try {\r\n      const accidents = await TrafficAccidentReport.find({\r\n        archived: false,\r\n        'accidentInfo.location.coordinates': {\r\n          $near: {\r\n            $geometry: {\r\n              type: 'Point',\r\n              coordinates: [longitude, latitude]\r\n            },\r\n            $maxDistance: maxDistance\r\n          }\r\n        }\r\n      })\r\n        .lean();\r\n\r\n      return accidents;\r\n    } catch (error) {\r\n      logger.error('Error fetching nearby accidents', {\r\n        error: error.message\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 20. تسجيل مشاهدة التقرير\r\n   */\r\n  async recordViewHistory(reportId, userId) {\r\n    try {\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      report.recordView(userId);\r\n      await report.save();\r\n    } catch (error) {\r\n      logger.error('Error recording view history', { error: error.message });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 21. الحصول على التقارير المتأخرة في المتابعة\r\n   */\r\n  async getOverdueFollowUps(daysThreshold = 30) {\r\n    try {\r\n      const thresholdDate = new Date();\r\n      thresholdDate.setDate(thresholdDate.getDate() - daysThreshold);\r\n\r\n      const overdueReports = await TrafficAccidentReport.find({\r\n        archived: false,\r\n        'followUp.status': 'pending',\r\n        'followUp.nextFollowUpDate': { $lt: new Date() }\r\n      })\r\n        .populate('reportedBy', 'name email')\r\n        .lean();\r\n\r\n      return overdueReports;\r\n    } catch (error) {\r\n      logger.error('Error fetching overdue follow-ups', {\r\n        error: error.message\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 22. تحديث معلومات الضرر\r\n   */\r\n  async updateDamageInfo(reportId, vehicleIndex, damageData, userId) {\r\n    try {\r\n      const report = await TrafficAccidentReport.findById(reportId);\r\n      if (!report) {\r\n        throw new Error('التقرير غير موجود');\r\n      }\r\n\r\n      if (!report.vehicles[vehicleIndex]) {\r\n        throw new Error('المركبة غير موجودة');\r\n      }\r\n\r\n      report.vehicles[vehicleIndex].damage = damageData;\r\n      report.calculateTotalLoss();\r\n      report.auditInfo.lastModifiedBy = userId;\r\n      report.auditInfo.lastModifiedAt = new Date();\r\n\r\n      await report.save();\r\n\r\n      return report;\r\n    } catch (error) {\r\n      logger.error('Error updating damage info', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 23. تطبيق مرشح الأرشيف\r\n   */\r\n  async applyArchivalFilter(\r\n    reportIds,\r\n    userId,\r\n    retentionDays = 365\r\n  ) {\r\n    try {\r\n      const cutoffDate = new Date();\r\n      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\r\n\r\n      const result = await TrafficAccidentReport.updateMany(\r\n        {\r\n          _id: { $in: reportIds },\r\n          'accidentInfo.accidentDateTime': { $lt: cutoffDate }\r\n        },\r\n        {\r\n          archived: true,\r\n          archivedAt: new Date(),\r\n          archivedBy: userId,\r\n          archivedReason: 'Automatic archival based on retention policy',\r\n          status: 'archived'\r\n        }\r\n      );\r\n\r\n      return result;\r\n    } catch (error) {\r\n      logger.error('Error applying archival filter', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = new TrafficAccidentService();\r\n"],"mappings":"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","ignoreList":[]}