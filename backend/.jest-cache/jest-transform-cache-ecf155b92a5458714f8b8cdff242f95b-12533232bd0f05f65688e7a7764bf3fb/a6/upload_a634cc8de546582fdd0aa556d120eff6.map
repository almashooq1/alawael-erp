{"version":3,"names":["express","require","router","Router","multer","authenticate","authorize","path","fs","storage","diskStorage","destination","req","file","cb","uploadDir","join","__dirname","existsSync","mkdirSync","recursive","filename","uniqueName","Date","now","Math","random","toString","substring","originalname","fileFilter","allowedMimes","includes","mimetype","Error","upload","limits","fileSize","post","single","res","status","json","success","message","fileData","id","size","category","body","uploadedBy","user","uploadedAt","toISOString","isPublic","data","error","array","files","length","uploadedFiles","map","count","timestamp","get","params","delete","deletedAt","docId","title","description","createdAt","module","exports"],"sources":["upload.js"],"sourcesContent":["/**\r\n * Upload Routes\r\n * File Upload and Management API Endpoints\r\n *\r\n * Routes:\r\n * - POST /api/upload/file      - Upload single file\r\n * - POST /api/upload/bulk      - Bulk upload files\r\n * - GET  /api/upload/:id       - Get file metadata\r\n * - DELETE /api/upload/:id     - Delete file\r\n * - GET  /api/upload/documents/:docId - Get document by ID\r\n */\r\n\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst multer = require('multer');\r\nconst { authenticate, authorize } = require('../middleware/auth');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// Configure multer for file uploads\r\nconst storage = multer.diskStorage({\r\n  destination: (req, file, cb) => {\r\n    const uploadDir = path.join(__dirname, '../uploads');\r\n    if (!fs.existsSync(uploadDir)) {\r\n      fs.mkdirSync(uploadDir, { recursive: true });\r\n    }\r\n    cb(null, uploadDir);\r\n  },\r\n  filename: (req, file, cb) => {\r\n    const uniqueName = `${Date.now()}-${Math.random().toString(36).substring(7)}-${file.originalname}`;\r\n    cb(null, uniqueName);\r\n  }\r\n});\r\n\r\nconst fileFilter = (req, file, cb) => {\r\n  // Allowed file types\r\n  const allowedMimes = [\r\n    'application/pdf',\r\n    'image/jpeg',\r\n    'image/png',\r\n    'text/csv',\r\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n    'application/msword',\r\n    'image/gif',\r\n    'image/webp'\r\n  ];\r\n\r\n  if (allowedMimes.includes(file.mimetype)) {\r\n    cb(null, true);\r\n  } else {\r\n    cb(new Error(`Invalid file type: ${file.mimetype}`), false);\r\n  }\r\n};\r\n\r\nconst upload = multer({\r\n  storage,\r\n  fileFilter,\r\n  limits: { fileSize: 50 * 1024 * 1024 } // 50MB limit\r\n});\r\n\r\n/**\r\n * @route   POST /api/upload/file\r\n * @access  Private\r\n * @body    {File} file - File to upload\r\n * @param   {String} category - File category (document/image/report)\r\n * @returns {Object} File metadata\r\n */\r\nrouter.post('/file', authenticate, upload.single('file'), (req, res) => {\r\n  try {\r\n    if (!req.file) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'No file provided'\r\n      });\r\n    }\r\n\r\n    const fileData = {\r\n      id: 'file_' + Date.now(),\r\n      filename: req.file.filename,\r\n      originalname: req.file.originalname,\r\n      mimetype: req.file.mimetype,\r\n      size: req.file.size,\r\n      path: req.file.path,\r\n      category: req.body.category || 'general',\r\n      uploadedBy: req.user?.id || 'system',\r\n      uploadedAt: new Date().toISOString(),\r\n      isPublic: false\r\n    };\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      message: 'File uploaded successfully',\r\n      data: fileData\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error uploading file',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * @route   POST /api/upload/bulk\r\n * @access  Private\r\n * @body    {Array} files - Multiple files\r\n * @returns {Object} Bulk upload results\r\n */\r\nrouter.post('/bulk', authenticate, upload.array('files', 10), (req, res) => {\r\n  try {\r\n    if (!req.files || req.files.length === 0) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'No files provided'\r\n      });\r\n    }\r\n\r\n    const uploadedFiles = req.files.map(file => ({\r\n      id: 'file_' + Date.now(),\r\n      filename: file.filename,\r\n      originalname: file.originalname,\r\n      mimetype: file.mimetype,\r\n      size: file.size,\r\n      path: file.path,\r\n      category: req.body.category || 'general',\r\n      uploadedBy: req.user?.id || 'system',\r\n      uploadedAt: new Date().toISOString()\r\n    }));\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      message: `${uploadedFiles.length} files uploaded successfully`,\r\n      data: {\r\n        count: uploadedFiles.length,\r\n        files: uploadedFiles,\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error uploading files',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * @route   GET /api/upload/:id\r\n * @access  Private\r\n * @param   {String} id - File ID\r\n * @returns {Object} File metadata\r\n */\r\nrouter.get('/:id', authenticate, (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    if (!id) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'File ID is required'\r\n      });\r\n    }\r\n\r\n    // TODO: Implement file metadata retrieval\r\n    res.json({\r\n      success: true,\r\n      message: 'File metadata retrieved successfully',\r\n      data: {\r\n        id,\r\n        filename: 'document.pdf',\r\n        originalname: 'original-document.pdf',\r\n        mimetype: 'application/pdf',\r\n        size: 102400,\r\n        category: 'document',\r\n        uploadedBy: 'user123',\r\n        uploadedAt: new Date().toISOString(),\r\n        isPublic: false\r\n      }\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error retrieving file metadata',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * @route   DELETE /api/upload/:id\r\n * @access  Private\r\n * @param   {String} id - File ID\r\n * @returns {Object} Deletion confirmation\r\n */\r\nrouter.delete('/:id', authenticate, authorize(['admin', 'manager']), (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    if (!id) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'File ID is required'\r\n      });\r\n    }\r\n\r\n    // TODO: Implement file deletion with cleanup\r\n    res.json({\r\n      success: true,\r\n      message: 'File deleted successfully',\r\n      data: {\r\n        id,\r\n        deletedAt: new Date().toISOString()\r\n      }\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error deleting file',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * @route   GET /api/upload/documents/:docId\r\n * @access  Private\r\n * @param   {String} docId - Document ID\r\n * @returns {Object} Document details with file metadata\r\n */\r\nrouter.get('/documents/:docId', authenticate, (req, res) => {\r\n  try {\r\n    const { docId } = req.params;\r\n\r\n    if (!docId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Document ID is required'\r\n      });\r\n    }\r\n\r\n    // TODO: Implement document retrieval with related files\r\n    res.json({\r\n      success: true,\r\n      message: 'Document retrieved successfully',\r\n      data: {\r\n        id: docId,\r\n        title: 'Sample Document',\r\n        description: 'A sample document with attachments',\r\n        files: [\r\n          {\r\n            id: 'file_1',\r\n            filename: 'document.pdf',\r\n            size: 102400,\r\n            uploadedAt: new Date().toISOString()\r\n          }\r\n        ],\r\n        createdAt: new Date().toISOString()\r\n      }\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error retrieving document',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"mappings":"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","ignoreList":[]}