e8279e5aced604e3677405177db3985c
// backend/controllers/fcmController.js
// إدارة تسجيل توكنات FCM للمستخدمين
const User = require('../models/User');
const fcmController = {
  /**
   * إضافة أو تحديث توكن FCM للمستخدم الحالي
   * POST /api/fcm/register
   * body: { token: string }
   */
  registerToken: async (req, res) => {
    try {
      const userId = req.user._id;
      const {
        token
      } = req.body;
      if (!token) {
        return res.status(400).json({
          success: false,
          message: 'FCM token is required'
        });
      }
      const user = await User.findById(userId);
      if (!user) {
        return res.status(404).json({
          success: false,
          message: 'User not found'
        });
      }
      if (!user.fcmTokens.includes(token)) {
        user.fcmTokens.push(token);
        await user.save();
      }
      res.status(200).json({
        success: true,
        message: 'FCM token registered'
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: 'Error registering FCM token',
        error: error.message
      });
    }
  },
  /**
   * حذف توكن FCM عند تسجيل الخروج
   * POST /api/fcm/unregister
   * body: { token: string }
   */
  unregisterToken: async (req, res) => {
    try {
      const userId = req.user._id;
      const {
        token
      } = req.body;
      if (!token) {
        return res.status(400).json({
          success: false,
          message: 'FCM token is required'
        });
      }
      const user = await User.findById(userId);
      if (!user) {
        return res.status(404).json({
          success: false,
          message: 'User not found'
        });
      }
      user.fcmTokens = user.fcmTokens.filter(t => t !== token);
      await user.save();
      res.status(200).json({
        success: true,
        message: 'FCM token unregistered'
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: 'Error unregistering FCM token',
        error: error.message
      });
    }
  }
};
module.exports = fcmController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVc2VyIiwicmVxdWlyZSIsImZjbUNvbnRyb2xsZXIiLCJyZWdpc3RlclRva2VuIiwicmVxIiwicmVzIiwidXNlcklkIiwidXNlciIsIl9pZCIsInRva2VuIiwiYm9keSIsInN0YXR1cyIsImpzb24iLCJzdWNjZXNzIiwibWVzc2FnZSIsImZpbmRCeUlkIiwiZmNtVG9rZW5zIiwiaW5jbHVkZXMiLCJwdXNoIiwic2F2ZSIsImVycm9yIiwidW5yZWdpc3RlclRva2VuIiwiZmlsdGVyIiwidCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJmY21Db250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGJhY2tlbmQvY29udHJvbGxlcnMvZmNtQ29udHJvbGxlci5qc1xyXG4vLyDYpdiv2KfYsdipINiq2LPYrNmK2YQg2KrZiNmD2YbYp9iqIEZDTSDZhNmE2YXYs9iq2K7Yr9mF2YrZhlxyXG5jb25zdCBVc2VyID0gcmVxdWlyZSgnLi4vbW9kZWxzL1VzZXInKTtcclxuXHJcbmNvbnN0IGZjbUNvbnRyb2xsZXIgPSB7XHJcbiAgLyoqXHJcbiAgICog2KXYttin2YHYqSDYo9mIINiq2K3Yr9mK2Ksg2KrZiNmD2YYgRkNNINmE2YTZhdiz2KrYrtiv2YUg2KfZhNit2KfZhNmKXHJcbiAgICogUE9TVCAvYXBpL2ZjbS9yZWdpc3RlclxyXG4gICAqIGJvZHk6IHsgdG9rZW46IHN0cmluZyB9XHJcbiAgICovXHJcbiAgcmVnaXN0ZXJUb2tlbjogYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5faWQ7XHJcbiAgICAgIGNvbnN0IHsgdG9rZW4gfSA9IHJlcS5ib2R5O1xyXG4gICAgICBpZiAoIXRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdGQ00gdG9rZW4gaXMgcmVxdWlyZWQnIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XHJcbiAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghdXNlci5mY21Ub2tlbnMuaW5jbHVkZXModG9rZW4pKSB7XHJcbiAgICAgICAgdXNlci5mY21Ub2tlbnMucHVzaCh0b2tlbik7XHJcbiAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XHJcbiAgICAgIH1cclxuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnRkNNIHRva2VuIHJlZ2lzdGVyZWQnIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmVzXHJcbiAgICAgICAgLnN0YXR1cyg1MDApXHJcbiAgICAgICAgLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ0Vycm9yIHJlZ2lzdGVyaW5nIEZDTSB0b2tlbicsIGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog2K3YsNmBINiq2YjZg9mGIEZDTSDYudmG2K8g2KrYs9is2YrZhCDYp9mE2K7YsdmI2KxcclxuICAgKiBQT1NUIC9hcGkvZmNtL3VucmVnaXN0ZXJcclxuICAgKiBib2R5OiB7IHRva2VuOiBzdHJpbmcgfVxyXG4gICAqL1xyXG4gIHVucmVnaXN0ZXJUb2tlbjogYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5faWQ7XHJcbiAgICAgIGNvbnN0IHsgdG9rZW4gfSA9IHJlcS5ib2R5O1xyXG4gICAgICBpZiAoIXRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdGQ00gdG9rZW4gaXMgcmVxdWlyZWQnIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XHJcbiAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHVzZXIuZmNtVG9rZW5zID0gdXNlci5mY21Ub2tlbnMuZmlsdGVyKHQgPT4gdCAhPT0gdG9rZW4pO1xyXG4gICAgICBhd2FpdCB1c2VyLnNhdmUoKTtcclxuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnRkNNIHRva2VuIHVucmVnaXN0ZXJlZCcgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXNcclxuICAgICAgICAuc3RhdHVzKDUwMClcclxuICAgICAgICAuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnRXJyb3IgdW5yZWdpc3RlcmluZyBGQ00gdG9rZW4nLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgIH1cclxuICB9LFxyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmY21Db250cm9sbGVyO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztBQUV0QyxNQUFNQyxhQUFhLEdBQUc7RUFDcEI7QUFDRjtBQUNBO0FBQ0E7QUFDQTtFQUNFQyxhQUFhLEVBQUUsTUFBQUEsQ0FBT0MsR0FBRyxFQUFFQyxHQUFHLEtBQUs7SUFDakMsSUFBSTtNQUNGLE1BQU1DLE1BQU0sR0FBR0YsR0FBRyxDQUFDRyxJQUFJLENBQUNDLEdBQUc7TUFDM0IsTUFBTTtRQUFFQztNQUFN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