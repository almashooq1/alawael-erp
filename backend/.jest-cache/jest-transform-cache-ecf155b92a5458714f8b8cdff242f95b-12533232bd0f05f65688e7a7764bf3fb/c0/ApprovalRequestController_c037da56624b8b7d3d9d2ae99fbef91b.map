{"version":3,"names":["ApprovalRequest","require","NotificationService","ApprovalRequestController","createApprovalRequest","req","res","requestType","requestRefId","approvers","comment","body","Array","isArray","length","status","json","success","message","steps","map","userId","approver","action","approval","create","requester","user","_id","comments","text","firstApprover","sendNotification","title","name","channels","err","error","getMyApprovalRequests","approvals","find","sort","createdAt","getPendingApprovals","takeApprovalAction","approvalId","params","findById","step","currentStep","String","actedAt","Date","push","save","nextStep","module","exports"],"sources":["ApprovalRequestController.js"],"sourcesContent":["// ApprovalRequestController.js\r\nconst ApprovalRequest = require('../models/ApprovalRequest');\r\nconst NotificationService = require('../services/notificationService');\r\n// ...existing code...\r\n\r\nconst ApprovalRequestController = {\r\n  // إنشاء طلب موافقة جديد\r\n  createApprovalRequest: async (req, res) => {\r\n    try {\r\n      const { requestType, requestRefId, approvers, comment } = req.body;\r\n      if (!approvers || !Array.isArray(approvers) || approvers.length === 0) {\r\n        return res.status(400).json({ success: false, message: 'يجب تحديد سلسلة الموافقات' });\r\n      }\r\n      const steps = approvers.map(userId => ({ approver: userId, action: 'pending' }));\r\n      const approval = await ApprovalRequest.create({\r\n        requestType,\r\n        requestRefId,\r\n        requester: req.user._id,\r\n        steps,\r\n        comments: comment ? [{ user: req.user._id, text: comment }] : [],\r\n      });\r\n      // إشعار أول مسؤول\r\n      const firstApprover = approvers[0];\r\n      await NotificationService.sendNotification(firstApprover, {\r\n        title: `طلب موافقة جديد (${requestType})`,\r\n        message: `لديك طلب موافقة جديد من ${req.user.name || 'مستخدم'}`,\r\n        channels: ['in-app', 'push'],\r\n      });\r\n      res.json({ success: true, approval });\r\n    } catch (err) {\r\n      res.status(500).json({ success: false, error: err.message });\r\n    }\r\n  },\r\n\r\n  // جلب طلبات الموافقة الخاصة بالمستخدم\r\n  getMyApprovalRequests: async (req, res) => {\r\n    try {\r\n      const approvals = await ApprovalRequest.find({ requester: req.user._id }).sort({\r\n        createdAt: -1,\r\n      });\r\n      res.json({ success: true, approvals });\r\n    } catch (err) {\r\n      res.status(500).json({ success: false, error: err.message });\r\n    }\r\n  },\r\n\r\n  // جلب الطلبات المعلقة للمسؤول الحالي\r\n  getPendingApprovals: async (req, res) => {\r\n    try {\r\n      const approvals = await ApprovalRequest.find({\r\n        'steps.approver': req.user._id,\r\n        'steps.action': 'pending',\r\n        status: 'pending',\r\n      });\r\n      res.json({ success: true, approvals });\r\n    } catch (err) {\r\n      res.status(500).json({ success: false, error: err.message });\r\n    }\r\n  },\r\n\r\n  // اتخاذ إجراء (موافقة/رفض) على خطوة الموافقة\r\n  takeApprovalAction: async (req, res) => {\r\n    try {\r\n      const { approvalId } = req.params;\r\n      const { action, comment } = req.body; // action: approved/rejected\r\n      const approval = await ApprovalRequest.findById(approvalId);\r\n      if (!approval) return res.status(404).json({ success: false, message: 'الطلب غير موجود' });\r\n      const step = approval.steps[approval.currentStep];\r\n      if (!step || String(step.approver) !== String(req.user._id) || step.action !== 'pending') {\r\n        return res.status(403).json({ success: false, message: 'غير مصرح' });\r\n      }\r\n      step.action = action;\r\n      step.actedAt = new Date();\r\n      step.comment = comment;\r\n      approval.comments.push({ user: req.user._id, text: comment });\r\n      // تحديث الحالة العامة\r\n      if (action === 'rejected') {\r\n        approval.status = 'rejected';\r\n      } else if (action === 'approved') {\r\n        if (approval.currentStep < approval.steps.length - 1) {\r\n          approval.currentStep += 1;\r\n        } else {\r\n          approval.status = 'approved';\r\n        }\r\n      }\r\n      await approval.save();\r\n      // إشعار صاحب الطلب\r\n      await NotificationService.sendNotification(approval.requester, {\r\n        title: `تحديث طلب الموافقة (${approval.requestType})`,\r\n        message: `تم اتخاذ إجراء: ${action === 'approved' ? 'موافقة' : 'رفض'} على طلبك.`,\r\n        channels: ['in-app', 'push'],\r\n      });\r\n      // إشعار المسؤول التالي إذا لم تنتهِ السلسلة\r\n      if (approval.status === 'pending') {\r\n        const nextStep = approval.steps[approval.currentStep];\r\n        if (nextStep && nextStep.approver) {\r\n          await NotificationService.sendNotification(nextStep.approver, {\r\n            title: `طلب موافقة جديد بانتظارك (${approval.requestType})`,\r\n            message: `يرجى مراجعة طلب الموافقة من ${req.user.name || 'مستخدم'}`,\r\n            channels: ['in-app', 'push'],\r\n          });\r\n        }\r\n      }\r\n      res.json({ success: true, approval });\r\n    } catch (err) {\r\n      res.status(500).json({ success: false, error: err.message });\r\n    }\r\n  },\r\n};\r\n\r\nmodule.exports = ApprovalRequestController;\r\n"],"mappings":"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","ignoreList":[]}