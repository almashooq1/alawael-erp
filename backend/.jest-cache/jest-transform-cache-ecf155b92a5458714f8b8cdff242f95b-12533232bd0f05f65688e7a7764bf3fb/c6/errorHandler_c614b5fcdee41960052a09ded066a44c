5a2399ce5b3d365031bcd234c3d2ec7b
/**
 * =====================================================
 * ADVANCED ERROR HANDLER MIDDLEWARE - Phase 6
 * =====================================================
 * Global error handling with comprehensive logging
 */

const fs = require('fs');
const path = require('path');
const {
  ApiError
} = require('../utils/apiResponse');

// Ensure logs directory exists
const logsDir = path.join(__dirname, '../logs');
if (!fs.existsSync(logsDir)) {
  fs.mkdirSync(logsDir, {
    recursive: true
  });
}

// Log file path
const errorLogFile = path.join(logsDir, 'errors.log');

/**
 * Log error to file
 */
const logErrorToFile = (error, req) => {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    method: req.method,
    url: req.originalUrl,
    ip: req.ip || req.connection.remoteAddress,
    statusCode: error.statusCode || 500,
    message: error.message,
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    userAgent: req.get('user-agent'),
    userId: req.user?._id || 'anonymous'
  };
  const logMessage = `${timestamp} [${error.statusCode || 500}] ${req.method} ${req.originalUrl} - ${error.message}\n`;
  fs.appendFileSync(errorLogFile, logMessage);

  // Also write JSON for analysis
  const analyticsFile = path.join(logsDir, 'errors.json');
  const existingErrors = fs.existsSync(analyticsFile) ? JSON.parse(fs.readFileSync(analyticsFile, 'utf8')) : [];
  existingErrors.push(logEntry);
  // Keep only last 1000 errors
  const recentErrors = existingErrors.slice(-1000);
  fs.writeFileSync(analyticsFile, JSON.stringify(recentErrors, null, 2));
};

/**
 * Format error response
 */
const formatErrorResponse = (error, req, isDevelopment = false) => {
  let statusCode = error.statusCode || 500;
  let message = error.message || 'Internal Server Error';
  let errors = error.errors || [];

  // Handle different error types
  if (error.name === 'ValidationError') {
    statusCode = 400;
    errors = Object.values(error.errors || {}).map(e => e.message).join(', ');
    message = 'Validation Error';
  }
  if (error.code === 11000) {
    statusCode = 409;
    const field = Object.keys(error.keyPattern)[0];
    message = `Duplicate value for field: ${field}`;
    errors = [`${field} already exists`];
  }
  if (error.name === 'CastError') {
    statusCode = 400;
    message = 'Invalid ID format';
    errors = ['The provided ID is not valid'];
  }
  if (error.name === 'JsonWebTokenError') {
    statusCode = 401;
    message = 'Invalid token';
    errors = ['Your authentication token is invalid or expired'];
  }
  if (error.name === 'TokenExpiredError') {
    statusCode = 401;
    message = 'Token expired';
    errors = ['Your authentication token has expired. Please login again'];
  }
  let response = {
    success: false,
    statusCode,
    message,
    error: message,
    timestamp: new Date().toISOString()
  };

  // Add detailed errors in development
  if (isDevelopment) {
    response.errors = Array.isArray(errors) ? errors : [errors];
    response.path = req.originalUrl;
    response.stack = error.stack;
  } else {
    // In production, only include specific error field if exists
    if (error.errors) {
      response.errors = Array.isArray(errors) ? errors : [errors];
    }
  }
  return response;
};

/**
 * Global error handler middleware
 */
module.exports = (err, req, res, _next) => {
  const isDevelopment = process.env.NODE_ENV === 'development';

  // Ensure error is an Error instance
  if (!(err instanceof Error)) {
    err = new Error(String(err));
  }

  // Log error
  console.error(`\n‚ùå ERROR: ${err.message}`);
  console.error(`üìç Route: ${req.method} ${req.originalUrl}`);
  console.error(`üë§ User: ${req.user?._id || 'anonymous'}`);
  console.error(`üîó IP: ${req.ip || req.connection.remoteAddress}`);
  if (isDevelopment) {
    console.error(`\n${err.stack}`);
  }

  // Log to file
  try {
    logErrorToFile(err, req);
  } catch (fileError) {
    console.error('Failed to log error to file:', fileError);
  }

  // Format and send response
  const response = formatErrorResponse(err, req, isDevelopment);

  // Set response headers
  res.set('X-Error-Id', `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);
  res.set('X-Error-Timestamp', new Date().toISOString());

  // Send response
  res.status(response.statusCode).json(response);
};

/**
 * Export ApiError for throwing custom errors
 */
module.exports.ApiError = ApiError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiQXBpRXJyb3IiLCJsb2dzRGlyIiwiam9pbiIsIl9fZGlybmFtZSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJlcnJvckxvZ0ZpbGUiLCJsb2dFcnJvclRvRmlsZSIsImVycm9yIiwicmVxIiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwibG9nRW50cnkiLCJtZXRob2QiLCJ1cmwiLCJvcmlnaW5hbFVybCIsImlwIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJzdGF0dXNDb2RlIiwibWVzc2FnZSIsInN0YWNrIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwidW5kZWZpbmVkIiwidXNlckFnZW50IiwiZ2V0IiwidXNlcklkIiwidXNlciIsIl9pZCIsImxvZ01lc3NhZ2UiLCJhcHBlbmRGaWxlU3luYyIsImFuYWx5dGljc0ZpbGUiLCJleGlzdGluZ0Vycm9ycyIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsInB1c2giLCJyZWNlbnRFcnJvcnMiLCJzbGljZSIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJmb3JtYXRFcnJvclJlc3BvbnNlIiwiaXNEZXZlbG9wbWVudCIsImVycm9ycyIsIm5hbWUiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXAiLCJlIiwiY29kZSIsImZpZWxkIiwia2V5cyIsImtleVBhdHRlcm4iLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJBcnJheSIsImlzQXJyYXkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZXJyIiwicmVzIiwiX25leHQiLCJFcnJvciIsIlN0cmluZyIsImNvbnNvbGUiLCJmaWxlRXJyb3IiLCJzZXQiLCJub3ciLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHIiLCJzdGF0dXMiLCJqc29uIl0sInNvdXJjZXMiOlsiZXJyb3JIYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gKiBBRFZBTkNFRCBFUlJPUiBIQU5ETEVSIE1JRERMRVdBUkUgLSBQaGFzZSA2XHJcbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAqIEdsb2JhbCBlcnJvciBoYW5kbGluZyB3aXRoIGNvbXByZWhlbnNpdmUgbG9nZ2luZ1xyXG4gKi9cclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgeyBBcGlFcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvYXBpUmVzcG9uc2UnKTtcclxuXHJcbi8vIEVuc3VyZSBsb2dzIGRpcmVjdG9yeSBleGlzdHNcclxuY29uc3QgbG9nc0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9sb2dzJyk7XHJcbmlmICghZnMuZXhpc3RzU3luYyhsb2dzRGlyKSkge1xyXG4gIGZzLm1rZGlyU3luYyhsb2dzRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxufVxyXG5cclxuLy8gTG9nIGZpbGUgcGF0aFxyXG5jb25zdCBlcnJvckxvZ0ZpbGUgPSBwYXRoLmpvaW4obG9nc0RpciwgJ2Vycm9ycy5sb2cnKTtcclxuXHJcbi8qKlxyXG4gKiBMb2cgZXJyb3IgdG8gZmlsZVxyXG4gKi9cclxuY29uc3QgbG9nRXJyb3JUb0ZpbGUgPSAoZXJyb3IsIHJlcSkgPT4ge1xyXG4gIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcclxuICBjb25zdCBsb2dFbnRyeSA9IHtcclxuICAgIHRpbWVzdGFtcCxcclxuICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcclxuICAgIHVybDogcmVxLm9yaWdpbmFsVXJsLFxyXG4gICAgaXA6IHJlcS5pcCB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLFxyXG4gICAgc3RhdHVzQ29kZTogZXJyb3Iuc3RhdHVzQ29kZSB8fCA1MDAsXHJcbiAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgc3RhY2s6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWQsXHJcbiAgICB1c2VyQWdlbnQ6IHJlcS5nZXQoJ3VzZXItYWdlbnQnKSxcclxuICAgIHVzZXJJZDogcmVxLnVzZXI/Ll9pZCB8fCAnYW5vbnltb3VzJyxcclxuICB9O1xyXG5cclxuICBjb25zdCBsb2dNZXNzYWdlID0gYCR7dGltZXN0YW1wfSBbJHtlcnJvci5zdGF0dXNDb2RlIHx8IDUwMH1dICR7cmVxLm1ldGhvZH0gJHtyZXEub3JpZ2luYWxVcmx9IC0gJHtlcnJvci5tZXNzYWdlfVxcbmA7XHJcblxyXG4gIGZzLmFwcGVuZEZpbGVTeW5jKGVycm9yTG9nRmlsZSwgbG9nTWVzc2FnZSk7XHJcblxyXG4gIC8vIEFsc28gd3JpdGUgSlNPTiBmb3IgYW5hbHlzaXNcclxuICBjb25zdCBhbmFseXRpY3NGaWxlID0gcGF0aC5qb2luKGxvZ3NEaXIsICdlcnJvcnMuanNvbicpO1xyXG4gIGNvbnN0IGV4aXN0aW5nRXJyb3JzID0gZnMuZXhpc3RzU3luYyhhbmFseXRpY3NGaWxlKVxyXG4gICAgPyBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhhbmFseXRpY3NGaWxlLCAndXRmOCcpKVxyXG4gICAgOiBbXTtcclxuICBleGlzdGluZ0Vycm9ycy5wdXNoKGxvZ0VudHJ5KTtcclxuICAvLyBLZWVwIG9ubHkgbGFzdCAxMDAwIGVycm9yc1xyXG4gIGNvbnN0IHJlY2VudEVycm9ycyA9IGV4aXN0aW5nRXJyb3JzLnNsaWNlKC0xMDAwKTtcclxuICBmcy53cml0ZUZpbGVTeW5jKGFuYWx5dGljc0ZpbGUsIEpTT04uc3RyaW5naWZ5KHJlY2VudEVycm9ycywgbnVsbCwgMikpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEZvcm1hdCBlcnJvciByZXNwb25zZVxyXG4gKi9cclxuY29uc3QgZm9ybWF0RXJyb3JSZXNwb25zZSA9IChlcnJvciwgcmVxLCBpc0RldmVsb3BtZW50ID0gZmFsc2UpID0+IHtcclxuICBsZXQgc3RhdHVzQ29kZSA9IGVycm9yLnN0YXR1c0NvZGUgfHwgNTAwO1xyXG4gIGxldCBtZXNzYWdlID0gZXJyb3IubWVzc2FnZSB8fCAnSW50ZXJuYWwgU2VydmVyIEVycm9yJztcclxuICBsZXQgZXJyb3JzID0gZXJyb3IuZXJyb3JzIHx8IFtdO1xyXG5cclxuICAvLyBIYW5kbGUgZGlmZmVyZW50IGVycm9yIHR5cGVzXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdWYWxpZGF0aW9uRXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JzID0gT2JqZWN0LnZhbHVlcyhlcnJvci5lcnJvcnMgfHwge30pXHJcbiAgICAgIC5tYXAoKGUpID0+IGUubWVzc2FnZSlcclxuICAgICAgLmpvaW4oJywgJyk7XHJcbiAgICBtZXNzYWdlID0gJ1ZhbGlkYXRpb24gRXJyb3InO1xyXG4gIH1cclxuXHJcbiAgaWYgKGVycm9yLmNvZGUgPT09IDExMDAwKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA5O1xyXG4gICAgY29uc3QgZmllbGQgPSBPYmplY3Qua2V5cyhlcnJvci5rZXlQYXR0ZXJuKVswXTtcclxuICAgIG1lc3NhZ2UgPSBgRHVwbGljYXRlIHZhbHVlIGZvciBmaWVsZDogJHtmaWVsZH1gO1xyXG4gICAgZXJyb3JzID0gW2Ake2ZpZWxkfSBhbHJlYWR5IGV4aXN0c2BdO1xyXG4gIH1cclxuXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdDYXN0RXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgbWVzc2FnZSA9ICdJbnZhbGlkIElEIGZvcm1hdCc7XHJcbiAgICBlcnJvcnMgPSBbJ1RoZSBwcm92aWRlZCBJRCBpcyBub3QgdmFsaWQnXTtcclxuICB9XHJcblxyXG4gIGlmIChlcnJvci5uYW1lID09PSAnSnNvbldlYlRva2VuRXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgbWVzc2FnZSA9ICdJbnZhbGlkIHRva2VuJztcclxuICAgIGVycm9ycyA9IFsnWW91ciBhdXRoZW50aWNhdGlvbiB0b2tlbiBpcyBpbnZhbGlkIG9yIGV4cGlyZWQnXTtcclxuICB9XHJcblxyXG4gIGlmIChlcnJvci5uYW1lID09PSAnVG9rZW5FeHBpcmVkRXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgbWVzc2FnZSA9ICdUb2tlbiBleHBpcmVkJztcclxuICAgIGVycm9ycyA9IFsnWW91ciBhdXRoZW50aWNhdGlvbiB0b2tlbiBoYXMgZXhwaXJlZC4gUGxlYXNlIGxvZ2luIGFnYWluJ107XHJcbiAgfVxyXG5cclxuICBsZXQgcmVzcG9uc2UgPSB7XHJcbiAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgIHN0YXR1c0NvZGUsXHJcbiAgICBtZXNzYWdlLFxyXG4gICAgZXJyb3I6IG1lc3NhZ2UsXHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICB9O1xyXG5cclxuICAvLyBBZGQgZGV0YWlsZWQgZXJyb3JzIGluIGRldmVsb3BtZW50XHJcbiAgaWYgKGlzRGV2ZWxvcG1lbnQpIHtcclxuICAgIHJlc3BvbnNlLmVycm9ycyA9IEFycmF5LmlzQXJyYXkoZXJyb3JzKSA/IGVycm9ycyA6IFtlcnJvcnNdO1xyXG4gICAgcmVzcG9uc2UucGF0aCA9IHJlcS5vcmlnaW5hbFVybDtcclxuICAgIHJlc3BvbnNlLnN0YWNrID0gZXJyb3Iuc3RhY2s7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIEluIHByb2R1Y3Rpb24sIG9ubHkgaW5jbHVkZSBzcGVjaWZpYyBlcnJvciBmaWVsZCBpZiBleGlzdHNcclxuICAgIGlmIChlcnJvci5lcnJvcnMpIHtcclxuICAgICAgcmVzcG9uc2UuZXJyb3JzID0gQXJyYXkuaXNBcnJheShlcnJvcnMpID8gZXJyb3JzIDogW2Vycm9yc107XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzcG9uc2U7XHJcbn07XHJcblxyXG4vKipcclxuICogR2xvYmFsIGVycm9yIGhhbmRsZXIgbWlkZGxld2FyZVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSAoZXJyLCByZXEsIHJlcywgX25leHQpID0+IHtcclxuICBjb25zdCBpc0RldmVsb3BtZW50ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCc7XHJcblxyXG4gIC8vIEVuc3VyZSBlcnJvciBpcyBhbiBFcnJvciBpbnN0YW5jZVxyXG4gIGlmICghKGVyciBpbnN0YW5jZW9mIEVycm9yKSkge1xyXG4gICAgZXJyID0gbmV3IEVycm9yKFN0cmluZyhlcnIpKTtcclxuICB9XHJcblxyXG4gIC8vIExvZyBlcnJvclxyXG4gIGNvbnNvbGUuZXJyb3IoYFxcbuKdjCBFUlJPUjogJHtlcnIubWVzc2FnZX1gKTtcclxuICBjb25zb2xlLmVycm9yKGDwn5ONIFJvdXRlOiAke3JlcS5tZXRob2R9ICR7cmVxLm9yaWdpbmFsVXJsfWApO1xyXG4gIGNvbnNvbGUuZXJyb3IoYPCfkaQgVXNlcjogJHtyZXEudXNlcj8uX2lkIHx8ICdhbm9ueW1vdXMnfWApO1xyXG4gIGNvbnNvbGUuZXJyb3IoYPCflJcgSVA6ICR7cmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3N9YCk7XHJcblxyXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGBcXG4ke2Vyci5zdGFja31gKTtcclxuICB9XHJcblxyXG4gIC8vIExvZyB0byBmaWxlXHJcbiAgdHJ5IHtcclxuICAgIGxvZ0Vycm9yVG9GaWxlKGVyciwgcmVxKTtcclxuICB9IGNhdGNoIChmaWxlRXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2cgZXJyb3IgdG8gZmlsZTonLCBmaWxlRXJyb3IpO1xyXG4gIH1cclxuXHJcbiAgLy8gRm9ybWF0IGFuZCBzZW5kIHJlc3BvbnNlXHJcbiAgY29uc3QgcmVzcG9uc2UgPSBmb3JtYXRFcnJvclJlc3BvbnNlKGVyciwgcmVxLCBpc0RldmVsb3BtZW50KTtcclxuXHJcbiAgLy8gU2V0IHJlc3BvbnNlIGhlYWRlcnNcclxuICByZXMuc2V0KCdYLUVycm9yLUlkJywgYCR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCk7XHJcbiAgcmVzLnNldCgnWC1FcnJvci1UaW1lc3RhbXAnLCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkpO1xyXG5cclxuICAvLyBTZW5kIHJlc3BvbnNlXHJcbiAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5qc29uKHJlc3BvbnNlKTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBFeHBvcnQgQXBpRXJyb3IgZm9yIHRocm93aW5nIGN1c3RvbSBlcnJvcnNcclxuICovXHJcbm1vZHVsZS5leHBvcnRzLkFwaUVycm9yID0gQXBpRXJyb3I7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUksQ0FBQztBQUN4QixNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDNUIsTUFBTTtFQUFFRTtBQUFTLENBQUMsR0FBR0YsT0FBTyxDQUFDLHNCQUFzQixDQUFDOztBQUVwRDtBQUNBLE1BQU1HLE9BQU8sR0FBR0YsSUFBSSxDQUFDRyxJQUFJLENBQUNDLFNBQVMsRUFBRSxTQUFTLENBQUM7QUFDL0MsSUFBSSxDQUFDTixFQUFFLENBQUNPLFVBQVUsQ0FBQ0gsT0FBTyxDQUFDLEVBQUU7RUFDM0JKLEVBQUUsQ0FBQ1EsU0FBUyxDQUFDSixPQUFPLEVBQUU7SUFBRUssU0FBUyxFQUFFO0VBQUssQ0FBQyxDQUFDO0FBQzVDOztBQUVBO0FBQ0EsTUFBTUMsWUFBWSxHQUFHUixJQUFJLENBQUNHLElBQUksQ0FBQ0Qs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