508cea7394215d4ca37bf0bbc42ca745
const ScheduledNotification = require('../models/ScheduledNotification');
const Notification = require('../models/Notification');
const User = require('../models/User');

/**
 * خدمة تنفيذ الإشعارات المجدولة (تشغيل دوري)
 */
async function processScheduledNotifications() {
  const now = new Date();
  // جلب الإشعارات المجدولة غير المرسلة والتي حان وقتها
  const due = await ScheduledNotification.find({
    sent: false,
    scheduleTime: {
      $lte: now
    }
  });
  for (const sched of due) {
    // تحقق من المستخدم
    const user = await User.findById(sched.userId);
    if (!user) continue;
    // إنشاء إشعار فعلي
    await Notification.create({
      userId: sched.userId,
      title: sched.title,
      message: sched.message,
      type: 'reminder',
      priority: sched.metadata?.priority || 'normal',
      senderId: sched.createdBy,
      metadata: sched.metadata || {},
      category: 'reminder'
    });
    // تحديث حالة الإرسال
    sched.sent = true;
    sched.sentAt = new Date();
    await sched.save();
    // يمكن إضافة إرسال عبر القنوات الأخرى هنا
  }
}
module.exports = processScheduledNotifications;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY2hlZHVsZWROb3RpZmljYXRpb24iLCJyZXF1aXJlIiwiTm90aWZpY2F0aW9uIiwiVXNlciIsInByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zIiwibm93IiwiRGF0ZSIsImR1ZSIsImZpbmQiLCJzZW50Iiwic2NoZWR1bGVUaW1lIiwiJGx0ZSIsInNjaGVkIiwidXNlciIsImZpbmRCeUlkIiwidXNlcklkIiwiY3JlYXRlIiwidGl0bGUiLCJtZXNzYWdlIiwidHlwZSIsInByaW9yaXR5IiwibWV0YWRhdGEiLCJzZW5kZXJJZCIsImNyZWF0ZWRCeSIsImNhdGVnb3J5Iiwic2VudEF0Iiwic2F2ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJwcm9jZXNzU2NoZWR1bGVkTm90aWZpY2F0aW9ucy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBTY2hlZHVsZWROb3RpZmljYXRpb24gPSByZXF1aXJlKCcuLi9tb2RlbHMvU2NoZWR1bGVkTm90aWZpY2F0aW9uJyk7XHJcbmNvbnN0IE5vdGlmaWNhdGlvbiA9IHJlcXVpcmUoJy4uL21vZGVscy9Ob3RpZmljYXRpb24nKTtcclxuY29uc3QgVXNlciA9IHJlcXVpcmUoJy4uL21vZGVscy9Vc2VyJyk7XHJcblxyXG4vKipcclxuICog2K7Yr9mF2Kkg2KrZhtmB2YrYsCDYp9mE2KXYtNi52KfYsdin2Kog2KfZhNmF2KzYr9mI2YTYqSAo2KrYtNi62YrZhCDYr9mI2LHZiilcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zKCkge1xyXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgLy8g2KzZhNioINin2YTYpdi02LnYp9ix2KfYqiDYp9mE2YXYrNiv2YjZhNipINi62YrYsSDYp9mE2YXYsdiz2YTYqSDZiNin2YTYqtmKINit2KfZhiDZiNmC2KrZh9inXHJcbiAgY29uc3QgZHVlID0gYXdhaXQgU2NoZWR1bGVkTm90aWZpY2F0aW9uLmZpbmQoeyBzZW50OiBmYWxzZSwgc2NoZWR1bGVUaW1lOiB7ICRsdGU6IG5vdyB9IH0pO1xyXG4gIGZvciAoY29uc3Qgc2NoZWQgb2YgZHVlKSB7XHJcbiAgICAvLyDYqtit2YLZgiDZhdmGINin2YTZhdiz2KrYrtiv2YVcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHNjaGVkLnVzZXJJZCk7XHJcbiAgICBpZiAoIXVzZXIpIGNvbnRpbnVlO1xyXG4gICAgLy8g2KXZhti02KfYoSDYpdi02LnYp9ixINmB2LnZhNmKXHJcbiAgICBhd2FpdCBOb3RpZmljYXRpb24uY3JlYXRlKHtcclxuICAgICAgdXNlcklkOiBzY2hlZC51c2VySWQsXHJcbiAgICAgIHRpdGxlOiBzY2hlZC50aXRsZSxcclxuICAgICAgbWVzc2FnZTogc2NoZWQubWVzc2FnZSxcclxuICAgICAgdHlwZTogJ3JlbWluZGVyJyxcclxuICAgICAgcHJpb3JpdHk6IHNjaGVkLm1ldGFkYXRhPy5wcmlvcml0eSB8fCAnbm9ybWFsJyxcclxuICAgICAgc2VuZGVySWQ6IHNjaGVkLmNyZWF0ZWRCeSxcclxuICAgICAgbWV0YWRhdGE6IHNjaGVkLm1ldGFkYXRhIHx8IHt9LFxyXG4gICAgICBjYXRlZ29yeTogJ3JlbWluZGVyJyxcclxuICAgIH0pO1xyXG4gICAgLy8g2KrYrdiv2YrYqyDYrdin2YTYqSDYp9mE2KXYsdiz2KfZhFxyXG4gICAgc2NoZWQuc2VudCA9IHRydWU7XHJcbiAgICBzY2hlZC5zZW50QXQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgYXdhaXQgc2NoZWQuc2F2ZSgpO1xyXG4gICAgLy8g2YrZhdmD2YYg2KXYttin2YHYqSDYpdix2LPYp9mEINi52KjYsSDYp9mE2YLZhtmI2KfYqiDYp9mE2KPYrtix2Ykg2YfZhtinXHJcbiAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLHFCQUFxQixHQUFHQyxPQUFPLENBQUMsaUNBQWlDLENBQUM7QUFDeEUsTUFBTUMsWUFBWSxHQUFHRCxPQUFPLENBQUMsd0JBQXdCLENBQUM7QUFDdEQsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsZ0JBQWdCLENBQUM7O0FBRXRDO0FBQ0E7QUFDQTtBQUNBLGVBQWVHLDZCQUE2QkEsQ0FBQSxFQUFHO0VBQzdDLE1BQU1DLEdBQUcsR0FBRyxJQUFJQyxJQUFJLENBQUMsQ0FBQztFQUN0QjtFQUNBLE1BQU1DLEdBQUcsR0FBRyxNQUFNUCxxQkFBcUIsQ0FBQ1EsSUFBSSxDQUFDO0lBQUVDLElBQUksRUFBRSxLQUFLO0lBQUVDLFlBQVksRUFBRTtNQUFFQyxJQUFJLEVBQUVOO0lBQUk7RUFBRSxDQUFDLENBQUM7RUFDMUYsS0FBSyxNQUFNTyxLQUFLLElBQUlMLEdBQUcsRUFBRTtJQUN2QjtJQUNBLE1BQU1NLElBQUksR0FBRyxNQUFNVixJQUFJLENBQUNXLFFBQVEsQ0FBQ0YsS0FBSyxDQUFDRyxNQUFNLENBQUM7SUFDOUMsSUFBSSxDQUFDRixJQUFJLEVBQUU7SUFDWDtJQUNBLE1BQU1YLFlBQVksQ0FBQ2MsTUFBTSxDQUFDO01BQ3hCRCxNQUFNLEVBQUVILEtBQUssQ0FBQ0csTUFBTTtNQUNwQkUsS0FBSyxFQUFFTCxLQUFLLENBQUNLLEtBQUs7TUFDbEJDLE9BQU8sRUFBRU4sS0FBSyxDQUFDTSxPQUFPO01BQ3RCQyxJQUFJLEVBQUUsVUFBVTtNQUNoQkMsUUFBUSxFQUFFUixLQUFLLENBQUNTLFFBQVEsRUFBRUQsUUFBUSxJQUFJLFFBQVE7TUFDOUNFLFFBQVEsRUFBRVYsS0FBSyxDQUFDVyxTQUFTO01BQ3pCRixRQUFRLEVBQUVULEtBQUssQ0FBQ1MsUUFBUSxJQUFJLENBQUMsQ0FBQztNQUM5QkcsUUFBUSxFQUFFO0lBQ1osQ0FBQyxDQUFDO0lBQ0Y7SUFDQVosS0FBSyxDQUFDSCxJQUFJLEdBQUcsSUFBSTtJQUNqQkcsS0FBSyxDQUFDYSxNQUFNLEdBQUcsSUFBSW5CLElBQUksQ0FBQyxDQUFDO0lBQ3pCLE1BQU1NLEtBQUssQ0FBQ2MsSUFBSSxDQUFDLENBQUM7SUFDbEI7RUFDRjtBQUNGO0FBRUFDLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHeEIsNkJBQTZCIiwiaWdub3JlTGlzdCI6W119