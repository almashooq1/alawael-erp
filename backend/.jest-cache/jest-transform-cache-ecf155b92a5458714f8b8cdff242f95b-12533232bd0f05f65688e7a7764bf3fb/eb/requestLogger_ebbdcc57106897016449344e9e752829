fc48ddc94d0883f6108691bfff669e4e
/**
 * =====================================================
 * ADVANCED REQUEST LOGGER MIDDLEWARE - Phase 6
 * =====================================================
 * Comprehensive request/response logging and tracking
 */

const fs = require('fs');
const path = require('path');

// Ensure logs directory exists
const logsDir = path.join(__dirname, '../logs');
if (!fs.existsSync(logsDir)) {
  fs.mkdirSync(logsDir, {
    recursive: true
  });
}

// Log file paths
const requestLogFile = path.join(logsDir, 'requests.log');
const metricsFile = path.join(logsDir, 'metrics.json');

/**
 * Color codes for terminal output
 */
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

/**
 * Get status color based on HTTP status code
 */
const getStatusColor = status => {
  if (status < 300) return colors.green;
  if (status < 400) return colors.blue;
  if (status < 500) return colors.yellow;
  return colors.red;
};

/**
 * Get HTTP method color
 */
const getMethodColor = method => {
  const methodColors = {
    GET: colors.blue,
    POST: colors.green,
    PUT: colors.yellow,
    PATCH: colors.cyan,
    DELETE: colors.red,
    OPTIONS: colors.reset
  };
  return methodColors[method] || colors.reset;
};

/**
 * Format bytes to human readable
 */
const formatBytes = bytes => {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
};

/**
 * Log request to file
 */
const logRequestToFile = (req, res, duration) => {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    method: req.method,
    url: req.originalUrl,
    path: req.path,
    query: req.query,
    statusCode: res.statusCode,
    duration: `${duration}ms`,
    ip: req.ip || req.connection.remoteAddress,
    userAgent: req.get('user-agent'),
    userId: req.user?._id || 'anonymous',
    contentLength: req.get('content-length') || 0,
    responseTime: new Date().toISOString()
  };
  const logMessage = `${timestamp} ${req.method} ${req.originalUrl} - ${res.statusCode} - ${duration}ms - ${req.ip || 'unknown'}\n`;
  fs.appendFileSync(requestLogFile, logMessage);

  // Write metrics
  const metricsExist = fs.existsSync(metricsFile);
  const metrics = metricsExist ? JSON.parse(fs.readFileSync(metricsFile, 'utf8')) : [];
  metrics.push(logEntry);
  // Keep only last 5000 entries
  const recentMetrics = metrics.slice(-5000);
  fs.writeFileSync(metricsFile, JSON.stringify(recentMetrics, null, 2));
};

/**
 * Parse request body size
 */
const getRequestSize = req => {
  const contentLength = req.get('content-length');
  return contentLength ? parseInt(contentLength) : 0;
};

/**
 * Advanced request logger middleware
 */
module.exports = (req, res, next) => {
  // Record start time
  const startTime = Date.now();
  const startHrTime = process.hrtime();

  // Store original send method
  const originalSend = res.send;
  let responseSize = 0;

  // Override send to capture response details
  res.send = function (data) {
    // Calculate response size
    if (data) {
      responseSize = Buffer.byteLength(JSON.stringify(data));
    }

    // Call original send
    res.send = originalSend;
    return res.send(data);
  };

  // Listen to finish event
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const [seconds, nanoseconds] = process.hrtime(startHrTime);
    const nanosecondDuration = seconds * 1000000000 + nanoseconds;
    const milliseconds = nanosecondDuration / 1000000;
    const method = req.method;
    const url = req.originalUrl;
    const status = res.statusCode;
    const requestSize = getRequestSize(req);
    const totalSize = requestSize + responseSize;

    // Console logging with colors
    const methodColor = getMethodColor(method);
    const statusColor = getStatusColor(status);
    const logMessage = `${colors.cyan}[${new Date().toLocaleTimeString()}]${colors.reset} ` + `${methodColor}${method}${colors.reset} ` + `${colors.reset}${url}${colors.reset} ` + `${statusColor}${status}${colors.reset} ` + `${colors.yellow}${Math.round(milliseconds)}ms${colors.reset} ` + `${colors.blue}${formatBytes(totalSize)}${colors.reset}`;

    // Different logging level based on status
    if (status >= 500) {
      console.error(`❌ ${logMessage}`);
    } else if (status >= 400) {
      console.warn(`⚠️  ${logMessage}`);
    } else {
      console.log(`✓  ${logMessage}`);
    }

    // Log to file
    try {
      logRequestToFile(req, res, Math.round(milliseconds));
    } catch (err) {
      console.error('Failed to log request to file:', err);
    }

    // Add custom headers
    res.set('X-Response-Time', `${Math.round(milliseconds)}ms`);
    res.set('X-Response-Size', formatBytes(responseSize));
    res.set('X-Request-Time', new Date().toISOString());
  });
  next();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwibG9nc0RpciIsImpvaW4iLCJfX2Rpcm5hbWUiLCJleGlzdHNTeW5jIiwibWtkaXJTeW5jIiwicmVjdXJzaXZlIiwicmVxdWVzdExvZ0ZpbGUiLCJtZXRyaWNzRmlsZSIsImNvbG9ycyIsInJlc2V0IiwiZ3JlZW4iLCJ5ZWxsb3ciLCJyZWQiLCJibHVlIiwiY3lhbiIsImdldFN0YXR1c0NvbG9yIiwic3RhdHVzIiwiZ2V0TWV0aG9kQ29sb3IiLCJtZXRob2QiLCJtZXRob2RDb2xvcnMiLCJHRVQiLCJQT1NUIiwiUFVUIiwiUEFUQ0giLCJERUxFVEUiLCJPUFRJT05TIiwiZm9ybWF0Qnl0ZXMiLCJieXRlcyIsImsiLCJzaXplcyIsImkiLCJNYXRoIiwiZmxvb3IiLCJsb2ciLCJyb3VuZCIsInBvdyIsImxvZ1JlcXVlc3RUb0ZpbGUiLCJyZXEiLCJyZXMiLCJkdXJhdGlvbiIsInRpbWVzdGFtcCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsImxvZ0VudHJ5IiwidXJsIiwib3JpZ2luYWxVcmwiLCJxdWVyeSIsInN0YXR1c0NvZGUiLCJpcCIsImNvbm5lY3Rpb24iLCJyZW1vdGVBZGRyZXNzIiwidXNlckFnZW50IiwiZ2V0IiwidXNlcklkIiwidXNlciIsIl9pZCIsImNvbnRlbnRMZW5ndGgiLCJyZXNwb25zZVRpbWUiLCJsb2dNZXNzYWdlIiwiYXBwZW5kRmlsZVN5bmMiLCJtZXRyaWNzRXhpc3QiLCJtZXRyaWNzIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwicHVzaCIsInJlY2VudE1ldHJpY3MiLCJzbGljZSIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJnZXRSZXF1ZXN0U2l6ZSIsInBhcnNlSW50IiwibW9kdWxlIiwiZXhwb3J0cyIsIm5leHQiLCJzdGFydFRpbWUiLCJub3ciLCJzdGFydEhyVGltZSIsInByb2Nlc3MiLCJocnRpbWUiLCJvcmlnaW5hbFNlbmQiLCJzZW5kIiwicmVzcG9uc2VTaXplIiwiZGF0YSIsIkJ1ZmZlciIsImJ5dGVMZW5ndGgiLCJvbiIsInNlY29uZHMiLCJuYW5vc2Vjb25kcyIsIm5hbm9zZWNvbmREdXJhdGlvbiIsIm1pbGxpc2Vjb25kcyIsInJlcXVlc3RTaXplIiwidG90YWxTaXplIiwibWV0aG9kQ29sb3IiLCJzdGF0dXNDb2xvciIsInRvTG9jYWxlVGltZVN0cmluZyIsImNvbnNvbGUiLCJlcnJvciIsIndhcm4iLCJlcnIiLCJzZXQiXSwic291cmNlcyI6WyJyZXF1ZXN0TG9nZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gKiBBRFZBTkNFRCBSRVFVRVNUIExPR0dFUiBNSURETEVXQVJFIC0gUGhhc2UgNlxyXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gKiBDb21wcmVoZW5zaXZlIHJlcXVlc3QvcmVzcG9uc2UgbG9nZ2luZyBhbmQgdHJhY2tpbmdcclxuICovXHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcblxyXG4vLyBFbnN1cmUgbG9ncyBkaXJlY3RvcnkgZXhpc3RzXHJcbmNvbnN0IGxvZ3NEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbG9ncycpO1xyXG5pZiAoIWZzLmV4aXN0c1N5bmMobG9nc0RpcikpIHtcclxuICBmcy5ta2RpclN5bmMobG9nc0RpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XHJcbn1cclxuXHJcbi8vIExvZyBmaWxlIHBhdGhzXHJcbmNvbnN0IHJlcXVlc3RMb2dGaWxlID0gcGF0aC5qb2luKGxvZ3NEaXIsICdyZXF1ZXN0cy5sb2cnKTtcclxuY29uc3QgbWV0cmljc0ZpbGUgPSBwYXRoLmpvaW4obG9nc0RpciwgJ21ldHJpY3MuanNvbicpO1xyXG5cclxuLyoqXHJcbiAqIENvbG9yIGNvZGVzIGZvciB0ZXJtaW5hbCBvdXRwdXRcclxuICovXHJcbmNvbnN0IGNvbG9ycyA9IHtcclxuICByZXNldDogJ1xceDFiWzBtJyxcclxuICBncmVlbjogJ1xceDFiWzMybScsXHJcbiAgeWVsbG93OiAnXFx4MWJbMzNtJyxcclxuICByZWQ6ICdcXHgxYlszMW0nLFxyXG4gIGJsdWU6ICdcXHgxYlszNG0nLFxyXG4gIGN5YW46ICdcXHgxYlszNm0nLFxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEdldCBzdGF0dXMgY29sb3IgYmFzZWQgb24gSFRUUCBzdGF0dXMgY29kZVxyXG4gKi9cclxuY29uc3QgZ2V0U3RhdHVzQ29sb3IgPSAoc3RhdHVzKSA9PiB7XHJcbiAgaWYgKHN0YXR1cyA8IDMwMCkgcmV0dXJuIGNvbG9ycy5ncmVlbjtcclxuICBpZiAoc3RhdHVzIDwgNDAwKSByZXR1cm4gY29sb3JzLmJsdWU7XHJcbiAgaWYgKHN0YXR1cyA8IDUwMCkgcmV0dXJuIGNvbG9ycy55ZWxsb3c7XHJcbiAgcmV0dXJuIGNvbG9ycy5yZWQ7XHJcbn07XHJcblxyXG4vKipcclxuICogR2V0IEhUVFAgbWV0aG9kIGNvbG9yXHJcbiAqL1xyXG5jb25zdCBnZXRNZXRob2RDb2xvciA9IChtZXRob2QpID0+IHtcclxuICBjb25zdCBtZXRob2RDb2xvcnMgPSB7XHJcbiAgICBHRVQ6IGNvbG9ycy5ibHVlLFxyXG4gICAgUE9TVDogY29sb3JzLmdyZWVuLFxyXG4gICAgUFVUOiBjb2xvcnMueWVsbG93LFxyXG4gICAgUEFUQ0g6IGNvbG9ycy5jeWFuLFxyXG4gICAgREVMRVRFOiBjb2xvcnMucmVkLFxyXG4gICAgT1BUSU9OUzogY29sb3JzLnJlc2V0LFxyXG4gIH07XHJcbiAgcmV0dXJuIG1ldGhvZENvbG9yc1ttZXRob2RdIHx8IGNvbG9ycy5yZXNldDtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBGb3JtYXQgYnl0ZXMgdG8gaHVtYW4gcmVhZGFibGVcclxuICovXHJcbmNvbnN0IGZvcm1hdEJ5dGVzID0gKGJ5dGVzKSA9PiB7XHJcbiAgaWYgKGJ5dGVzID09PSAwKSByZXR1cm4gJzAgQic7XHJcbiAgY29uc3QgayA9IDEwMjQ7XHJcbiAgY29uc3Qgc2l6ZXMgPSBbJ0InLCAnS0InLCAnTUInLCAnR0InXTtcclxuICBjb25zdCBpID0gTWF0aC5mbG9vcihNYXRoLmxvZyhieXRlcykgLyBNYXRoLmxvZyhrKSk7XHJcbiAgcmV0dXJuIE1hdGgucm91bmQoKGJ5dGVzIC8gTWF0aC5wb3coaywgaSkpICogMTAwKSAvIDEwMCArICcgJyArIHNpemVzW2ldO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIExvZyByZXF1ZXN0IHRvIGZpbGVcclxuICovXHJcbmNvbnN0IGxvZ1JlcXVlc3RUb0ZpbGUgPSAocmVxLCByZXMsIGR1cmF0aW9uKSA9PiB7XHJcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xyXG4gIGNvbnN0IGxvZ0VudHJ5ID0ge1xyXG4gICAgdGltZXN0YW1wLFxyXG4gICAgbWV0aG9kOiByZXEubWV0aG9kLFxyXG4gICAgdXJsOiByZXEub3JpZ2luYWxVcmwsXHJcbiAgICBwYXRoOiByZXEucGF0aCxcclxuICAgIHF1ZXJ5OiByZXEucXVlcnksXHJcbiAgICBzdGF0dXNDb2RlOiByZXMuc3RhdHVzQ29kZSxcclxuICAgIGR1cmF0aW9uOiBgJHtkdXJhdGlvbn1tc2AsXHJcbiAgICBpcDogcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MsXHJcbiAgICB1c2VyQWdlbnQ6IHJlcS5nZXQoJ3VzZXItYWdlbnQnKSxcclxuICAgIHVzZXJJZDogcmVxLnVzZXI/Ll9pZCB8fCAnYW5vbnltb3VzJyxcclxuICAgIGNvbnRlbnRMZW5ndGg6IHJlcS5nZXQoJ2NvbnRlbnQtbGVuZ3RoJykgfHwgMCxcclxuICAgIHJlc3BvbnNlVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGxvZ01lc3NhZ2UgPSBgJHt0aW1lc3RhbXB9ICR7cmVxLm1ldGhvZH0gJHtyZXEub3JpZ2luYWxVcmx9IC0gJHtyZXMuc3RhdHVzQ29kZX0gLSAke2R1cmF0aW9ufW1zIC0gJHtyZXEuaXAgfHwgJ3Vua25vd24nfVxcbmA7XHJcblxyXG4gIGZzLmFwcGVuZEZpbGVTeW5jKHJlcXVlc3RMb2dGaWxlLCBsb2dNZXNzYWdlKTtcclxuXHJcbiAgLy8gV3JpdGUgbWV0cmljc1xyXG4gIGNvbnN0IG1ldHJpY3NFeGlzdCA9IGZzLmV4aXN0c1N5bmMobWV0cmljc0ZpbGUpO1xyXG4gIGNvbnN0IG1ldHJpY3MgPSBtZXRyaWNzRXhpc3QgPyBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhtZXRyaWNzRmlsZSwgJ3V0ZjgnKSkgOiBbXTtcclxuICBtZXRyaWNzLnB1c2gobG9nRW50cnkpO1xyXG4gIC8vIEtlZXAgb25seSBsYXN0IDUwMDAgZW50cmllc1xyXG4gIGNvbnN0IHJlY2VudE1ldHJpY3MgPSBtZXRyaWNzLnNsaWNlKC01MDAwKTtcclxuICBmcy53cml0ZUZpbGVTeW5jKG1ldHJpY3NGaWxlLCBKU09OLnN0cmluZ2lmeShyZWNlbnRNZXRyaWNzLCBudWxsLCAyKSk7XHJcbn07XHJcblxyXG4vKipcclxuICogUGFyc2UgcmVxdWVzdCBib2R5IHNpemVcclxuICovXHJcbmNvbnN0IGdldFJlcXVlc3RTaXplID0gKHJlcSkgPT4ge1xyXG4gIGNvbnN0IGNvbnRlbnRMZW5ndGggPSByZXEuZ2V0KCdjb250ZW50LWxlbmd0aCcpO1xyXG4gIHJldHVybiBjb250ZW50TGVuZ3RoID8gcGFyc2VJbnQoY29udGVudExlbmd0aCkgOiAwO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEFkdmFuY2VkIHJlcXVlc3QgbG9nZ2VyIG1pZGRsZXdhcmVcclxuICovXHJcbm1vZHVsZS5leHBvcnRzID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgLy8gUmVjb3JkIHN0YXJ0IHRpbWVcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gIGNvbnN0IHN0YXJ0SHJUaW1lID0gcHJvY2Vzcy5ocnRpbWUoKTtcclxuXHJcbiAgLy8gU3RvcmUgb3JpZ2luYWwgc2VuZCBtZXRob2RcclxuICBjb25zdCBvcmlnaW5hbFNlbmQgPSByZXMuc2VuZDtcclxuICBsZXQgcmVzcG9uc2VTaXplID0gMDtcclxuXHJcbiAgLy8gT3ZlcnJpZGUgc2VuZCB0byBjYXB0dXJlIHJlc3BvbnNlIGRldGFpbHNcclxuICByZXMuc2VuZCA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAvLyBDYWxjdWxhdGUgcmVzcG9uc2Ugc2l6ZVxyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgcmVzcG9uc2VTaXplID0gQnVmZmVyLmJ5dGVMZW5ndGgoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGwgb3JpZ2luYWwgc2VuZFxyXG4gICAgcmVzLnNlbmQgPSBvcmlnaW5hbFNlbmQ7XHJcbiAgICByZXR1cm4gcmVzLnNlbmQoZGF0YSk7XHJcbiAgfTtcclxuXHJcbiAgLy8gTGlzdGVuIHRvIGZpbmlzaCBldmVudFxyXG4gIHJlcy5vbignZmluaXNoJywgKCkgPT4ge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG4gICAgY29uc3QgW3NlY29uZHMsIG5hbm9zZWNvbmRzXSA9IHByb2Nlc3MuaHJ0aW1lKHN0YXJ0SHJUaW1lKTtcclxuICAgIGNvbnN0IG5hbm9zZWNvbmREdXJhdGlvbiA9IHNlY29uZHMgKiAxMDAwMDAwMDAwICsgbmFub3NlY29uZHM7XHJcbiAgICBjb25zdCBtaWxsaXNlY29uZHMgPSBuYW5vc2Vjb25kRHVyYXRpb24gLyAxMDAwMDAwO1xyXG5cclxuICAgIGNvbnN0IG1ldGhvZCA9IHJlcS5tZXRob2Q7XHJcbiAgICBjb25zdCB1cmwgPSByZXEub3JpZ2luYWxVcmw7XHJcbiAgICBjb25zdCBzdGF0dXMgPSByZXMuc3RhdHVzQ29kZTtcclxuICAgIGNvbnN0IHJlcXVlc3RTaXplID0gZ2V0UmVxdWVzdFNpemUocmVxKTtcclxuICAgIGNvbnN0IHRvdGFsU2l6ZSA9IHJlcXVlc3RTaXplICsgcmVzcG9uc2VTaXplO1xyXG5cclxuICAgIC8vIENvbnNvbGUgbG9nZ2luZyB3aXRoIGNvbG9yc1xyXG4gICAgY29uc3QgbWV0aG9kQ29sb3IgPSBnZXRNZXRob2RDb2xvcihtZXRob2QpO1xyXG4gICAgY29uc3Qgc3RhdHVzQ29sb3IgPSBnZXRTdGF0dXNDb2xvcihzdGF0dXMpO1xyXG5cclxuICAgIGNvbnN0IGxvZ01lc3NhZ2UgPVxyXG4gICAgICBgJHtjb2xvcnMuY3lhbn1bJHtuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygpfV0ke2NvbG9ycy5yZXNldH0gYCArXHJcbiAgICAgIGAke21ldGhvZENvbG9yfSR7bWV0aG9kfSR7Y29sb3JzLnJlc2V0fSBgICtcclxuICAgICAgYCR7Y29sb3JzLnJlc2V0fSR7dXJsfSR7Y29sb3JzLnJlc2V0fSBgICtcclxuICAgICAgYCR7c3RhdHVzQ29sb3J9JHtzdGF0dXN9JHtjb2xvcnMucmVzZXR9IGAgK1xyXG4gICAgICBgJHtjb2xvcnMueWVsbG93fSR7TWF0aC5yb3VuZChtaWxsaXNlY29uZHMpfW1zJHtjb2xvcnMucmVzZXR9IGAgK1xyXG4gICAgICBgJHtjb2xvcnMuYmx1ZX0ke2Zvcm1hdEJ5dGVzKHRvdGFsU2l6ZSl9JHtjb2xvcnMucmVzZXR9YDtcclxuXHJcbiAgICAvLyBEaWZmZXJlbnQgbG9nZ2luZyBsZXZlbCBiYXNlZCBvbiBzdGF0dXNcclxuICAgIGlmIChzdGF0dXMgPj0gNTAwKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCAke2xvZ01lc3NhZ2V9YCk7XHJcbiAgICB9IGVsc2UgaWYgKHN0YXR1cyA+PSA0MDApIHtcclxuICAgICAgY29uc29sZS53YXJuKGDimqDvuI8gICR7bG9nTWVzc2FnZX1gKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDinJMgICR7bG9nTWVzc2FnZX1gKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBMb2cgdG8gZmlsZVxyXG4gICAgdHJ5IHtcclxuICAgICAgbG9nUmVxdWVzdFRvRmlsZShyZXEsIHJlcywgTWF0aC5yb3VuZChtaWxsaXNlY29uZHMpKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9nIHJlcXVlc3QgdG8gZmlsZTonLCBlcnIpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFkZCBjdXN0b20gaGVhZGVyc1xyXG4gICAgcmVzLnNldCgnWC1SZXNwb25zZS1UaW1lJywgYCR7TWF0aC5yb3VuZChtaWxsaXNlY29uZHMpfW1zYCk7XHJcbiAgICByZXMuc2V0KCdYLVJlc3BvbnNlLVNpemUnLCBmb3JtYXRCeXRlcyhyZXNwb25zZVNpemUpKTtcclxuICAgIHJlcy5zZXQoJ1gtUmVxdWVzdC1UaW1lJywgbmV3IERhdGUoKS50b0lTT1N0cmluZygpKTtcclxuICB9KTtcclxuXHJcbiAgbmV4dCgpO1xyXG59O1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDeEIsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBTSxDQUFDOztBQUU1QjtBQUNBLE1BQU1FLE9BQU8sR0FBR0QsSUFBSSxDQUFDRSxJQUFJLENBQUNDLFNBQVMsRUFBRSxTQUFTLENBQUM7QUFDL0MsSUFBSSxDQUFDTCxFQUFFLENBQUNNLFVBQVUsQ0FBQ0gsT0FBTyxDQUFDLEVBQUU7RUFDM0JILEVBQUUsQ0FBQ08sU0FBUyxDQUFDSixPQUFPLEVBQUU7SUFBRUssU0FBUyxFQUFFO0VBQUssQ0FBQyxDQUFDO0FBQzVDOztBQUVBO0FBQ0EsTUFBTUMsY0FBYyxHQUFHUCxJQUFJLENBQUNFLElBQUksQ0FBQ0QsT0FBTyxFQUFFLGNBQWMsQ0FBQztBQUN6RCxNQUFNTyxXQUFXLEdBQUdSLElBQUksQ0FB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