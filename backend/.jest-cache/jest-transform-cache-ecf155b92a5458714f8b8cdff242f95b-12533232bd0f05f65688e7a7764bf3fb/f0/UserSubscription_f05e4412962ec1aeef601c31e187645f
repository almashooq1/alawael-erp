21f22cd904d7060cf4a82f0cde7e7c9d
const mongoose = require('mongoose');
const userSubscriptionSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  planId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'SubscriptionPlan',
    required: true
  },
  status: {
    type: String,
    enum: ['active', 'inactive', 'suspended', 'cancelled', 'expired'],
    default: 'inactive'
  },
  subscriptionType: {
    type: String,
    enum: ['monthly', 'annual', 'lifetime'],
    required: true
  },
  startDate: {
    type: Date,
    default: Date.now
  },
  endDate: {
    type: Date,
    required: true
  },
  renewalDate: Date,
  autoRenew: {
    type: Boolean,
    default: true
  },
  price: {
    original: Number,
    discountedPrice: Number,
    appliedDiscount: {
      type: Number,
      default: 0
    },
    currency: {
      type: String,
      default: 'SAR'
    }
  },
  paymentMethod: {
    type: String,
    enum: ['credit_card', 'debit_card', 'bank_transfer', 'wallet', 'other']
  },
  paymentHistory: [{
    date: {
      type: Date,
      default: Date.now
    },
    amount: Number,
    status: {
      type: String,
      enum: ['pending', 'completed', 'failed', 'refunded']
    },
    transactionId: String,
    notes: String
  }],
  usageStatistics: {
    sessionsAttended: {
      type: Number,
      default: 0
    },
    resourcesDownloaded: {
      type: Number,
      default: 0
    },
    resourcesSaved: {
      type: Number,
      default: 0
    },
    hoursWatched: {
      type: Number,
      default: 0
    },
    lastAccessDate: Date
  },
  supportTickets: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'SupportTicket'
  }],
  customizations: {
    notificationPreferences: {
      email: Boolean,
      sms: Boolean,
      inApp: Boolean
    },
    contentPreferences: {
      disabilityFocus: String,
      preferredLanguage: String,
      contentTypes: [String]
    }
  },
  cancellationReason: String,
  cancellationDate: Date,
  notes: String,
  isTrialUser: {
    type: Boolean,
    default: false
  },
  trialStartDate: Date,
  trialEndDate: Date,
  upgradedFromPlan: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'SubscriptionPlan'
  },
  referralCode: {
    type: String,
    unique: true
  },
  referredBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'UserSubscription'
  },
  referralBonuses: {
    referralsCount: {
      type: Number,
      default: 0
    },
    bonusCredits: {
      type: Number,
      default: 0
    }
  }
}, {
  timestamps: true,
  toJSON: {
    virtuals: true
  },
  toObject: {
    virtuals: true
  }
});

// Indexes
userSubscriptionSchema.index({
  userId: 1
});
userSubscriptionSchema.index({
  planId: 1
});
userSubscriptionSchema.index({
  status: 1,
  endDate: 1
});
userSubscriptionSchema.index({
  renewalDate: 1
});

// Virtual for is active
userSubscriptionSchema.virtual('isActive').get(function () {
  const now = new Date();
  return this.status === 'active' && this.endDate > now;
});

// Virtual for days remaining
userSubscriptionSchema.virtual('daysRemaining').get(function () {
  const now = new Date();
  const diff = this.endDate - now;
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
});

// Virtual for is expiring soon
userSubscriptionSchema.virtual('expiringInDays').get(function () {
  return this.daysRemaining <= 7 && this.daysRemaining > 0;
});

// Static method to get active subscriptions
userSubscriptionSchema.statics.getActiveSubscriptions = function () {
  const now = new Date();
  return this.find({
    status: 'active',
    endDate: {
      $gt: now
    }
  }).populate('userId', 'name email').populate('planId', 'name features');
};

// Static method to get expiring subscriptions
userSubscriptionSchema.statics.getExpiringSubscriptions = function (daysThreshold = 7) {
  const now = new Date();
  const threshold = new Date(now.getTime() + daysThreshold * 24 * 60 * 60 * 1000);
  return this.find({
    status: 'active',
    endDate: {
      $lte: threshold,
      $gt: now
    }
  }).populate('userId', 'name email').populate('planId', 'name');
};

// Instance method to upgrade plan
userSubscriptionSchema.methods.upgradePlan = function (newPlanId, newPrice) {
  this.upgradedFromPlan = this.planId;
  this.planId = newPlanId;
  this.price.discountedPrice = newPrice;
  this.status = 'active';
  return this.save();
};

// Instance method to cancel subscription
userSubscriptionSchema.methods.cancelSubscription = function (reason) {
  this.status = 'cancelled';
  this.cancellationReason = reason;
  this.cancellationDate = new Date();
  return this.save();
};
module.exports = mongoose.model('UserSubscription', userSubscriptionSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJ1c2VyU3Vic2NyaXB0aW9uU2NoZW1hIiwiU2NoZW1hIiwidXNlcklkIiwidHlwZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCJyZWYiLCJyZXF1aXJlZCIsInBsYW5JZCIsInN0YXR1cyIsIlN0cmluZyIsImVudW0iLCJkZWZhdWx0Iiwic3Vic2NyaXB0aW9uVHlwZSIsInN0YXJ0RGF0ZSIsIkRhdGUiLCJub3ciLCJlbmREYXRlIiwicmVuZXdhbERhdGUiLCJhdXRvUmVuZXciLCJCb29sZWFuIiwicHJpY2UiLCJvcmlnaW5hbCIsIk51bWJlciIsImRpc2NvdW50ZWRQcmljZSIsImFwcGxpZWREaXNjb3VudCIsImN1cnJlbmN5IiwicGF5bWVudE1ldGhvZCIsInBheW1lbnRIaXN0b3J5IiwiZGF0ZSIsImFtb3VudCIsInRyYW5zYWN0aW9uSWQiLCJub3RlcyIsInVzYWdlU3RhdGlzdGljcyIsInNlc3Npb25zQXR0ZW5kZWQiLCJyZXNvdXJjZXNEb3dubG9hZGVkIiwicmVzb3VyY2VzU2F2ZWQiLCJob3Vyc1dhdGNoZWQiLCJsYXN0QWNjZXNzRGF0ZSIsInN1cHBvcnRUaWNrZXRzIiwiY3VzdG9taXphdGlvbnMiLCJub3RpZmljYXRpb25QcmVmZXJlbmNlcyIsImVtYWlsIiwic21zIiwiaW5BcHAiLCJjb250ZW50UHJlZmVyZW5jZXMiLCJkaXNhYmlsaXR5Rm9jdXMiLCJwcmVmZXJyZWRMYW5ndWFnZSIsImNvbnRlbnRUeXBlcyIsImNhbmNlbGxhdGlvblJlYXNvbiIsImNhbmNlbGxhdGlvbkRhdGUiLCJpc1RyaWFsVXNlciIsInRyaWFsU3RhcnREYXRlIiwidHJpYWxFbmREYXRlIiwidXBncmFkZWRGcm9tUGxhbiIsInJlZmVycmFsQ29kZSIsInVuaXF1ZSIsInJlZmVycmVkQnkiLCJyZWZlcnJhbEJvbnVzZXMiLCJyZWZlcnJhbHNDb3VudCIsImJvbnVzQ3JlZGl0cyIsInRpbWVzdGFtcHMiLCJ0b0pTT04iLCJ2aXJ0dWFscyIsInRvT2JqZWN0IiwiaW5kZXgiLCJ2aXJ0dWFsIiwiZ2V0IiwiZGlmZiIsIk1hdGgiLCJjZWlsIiwiZGF5c1JlbWFpbmluZyIsInN0YXRpY3MiLCJnZXRBY3RpdmVTdWJzY3JpcHRpb25zIiwiZmluZCIsIiRndCIsInBvcHVsYXRlIiwiZ2V0RXhwaXJpbmdTdWJzY3JpcHRpb25zIiwiZGF5c1RocmVzaG9sZCIsInRocmVzaG9sZCIsImdldFRpbWUiLCIkbHRlIiwibWV0aG9kcyIsInVwZ3JhZGVQbGFuIiwibmV3UGxhbklkIiwibmV3UHJpY2UiLCJzYXZlIiwiY2FuY2VsU3Vic2NyaXB0aW9uIiwicmVhc29uIiwibW9kdWxlIiwiZXhwb3J0cyIsIm1vZGVsIl0sInNvdXJjZXMiOlsiVXNlclN1YnNjcmlwdGlvbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XHJcblxyXG5jb25zdCB1c2VyU3Vic2NyaXB0aW9uU2NoZW1hID0gbmV3IG1vbmdvb3NlLlNjaGVtYShcclxuICB7XHJcbiAgICB1c2VySWQ6IHtcclxuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLFxyXG4gICAgICByZWY6ICdVc2VyJyxcclxuICAgICAgcmVxdWlyZWQ6IHRydWUsXHJcbiAgICB9LFxyXG4gICAgcGxhbklkOiB7XHJcbiAgICAgIHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCxcclxuICAgICAgcmVmOiAnU3Vic2NyaXB0aW9uUGxhbicsXHJcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIHN0YXR1czoge1xyXG4gICAgICB0eXBlOiBTdHJpbmcsXHJcbiAgICAgIGVudW06IFsnYWN0aXZlJywgJ2luYWN0aXZlJywgJ3N1c3BlbmRlZCcsICdjYW5jZWxsZWQnLCAnZXhwaXJlZCddLFxyXG4gICAgICBkZWZhdWx0OiAnaW5hY3RpdmUnLFxyXG4gICAgfSxcclxuICAgIHN1YnNjcmlwdGlvblR5cGU6IHtcclxuICAgICAgdHlwZTogU3RyaW5nLFxyXG4gICAgICBlbnVtOiBbJ21vbnRobHknLCAnYW5udWFsJywgJ2xpZmV0aW1lJ10sXHJcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIHN0YXJ0RGF0ZToge1xyXG4gICAgICB0eXBlOiBEYXRlLFxyXG4gICAgICBkZWZhdWx0OiBEYXRlLm5vdyxcclxuICAgIH0sXHJcbiAgICBlbmREYXRlOiB7XHJcbiAgICAgIHR5cGU6IERhdGUsXHJcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIHJlbmV3YWxEYXRlOiBEYXRlLFxyXG4gICAgYXV0b1JlbmV3OiB7XHJcbiAgICAgIHR5cGU6IEJvb2xlYW4sXHJcbiAgICAgIGRlZmF1bHQ6IHRydWUsXHJcbiAgICB9LFxyXG4gICAgcHJpY2U6IHtcclxuICAgICAgb3JpZ2luYWw6IE51bWJlcixcclxuICAgICAgZGlzY291bnRlZFByaWNlOiBOdW1iZXIsXHJcbiAgICAgIGFwcGxpZWREaXNjb3VudDoge1xyXG4gICAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgICBkZWZhdWx0OiAwLFxyXG4gICAgICB9LFxyXG4gICAgICBjdXJyZW5jeToge1xyXG4gICAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgICBkZWZhdWx0OiAnU0FSJyxcclxuICAgICAgfSxcclxuICAgIH0sXHJcbiAgICBwYXltZW50TWV0aG9kOiB7XHJcbiAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgZW51bTogWydjcmVkaXRfY2FyZCcsICdkZWJpdF9jYXJkJywgJ2JhbmtfdHJhbnNmZXInLCAnd2FsbGV0JywgJ290aGVyJ10sXHJcbiAgICB9LFxyXG4gICAgcGF5bWVudEhpc3Rvcnk6IFtcclxuICAgICAge1xyXG4gICAgICAgIGRhdGU6IHtcclxuICAgICAgICAgIHR5cGU6IERhdGUsXHJcbiAgICAgICAgICBkZWZhdWx0OiBEYXRlLm5vdyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGFtb3VudDogTnVtYmVyLFxyXG4gICAgICAgIHN0YXR1czoge1xyXG4gICAgICAgICAgdHlwZTogU3RyaW5nLFxyXG4gICAgICAgICAgZW51bTogWydwZW5kaW5nJywgJ2NvbXBsZXRlZCcsICdmYWlsZWQnLCAncmVmdW5kZWQnXSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRyYW5zYWN0aW9uSWQ6IFN0cmluZyxcclxuICAgICAgICBub3RlczogU3RyaW5nLFxyXG4gICAgICB9LFxyXG4gICAgXSxcclxuICAgIHVzYWdlU3RhdGlzdGljczoge1xyXG4gICAgICBzZXNzaW9uc0F0dGVuZGVkOiB7XHJcbiAgICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICAgIGRlZmF1bHQ6IDAsXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlc291cmNlc0Rvd25sb2FkZWQ6IHtcclxuICAgICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgICAgZGVmYXVsdDogMCxcclxuICAgICAgfSxcclxuICAgICAgcmVzb3VyY2VzU2F2ZWQ6IHtcclxuICAgICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgICAgZGVmYXVsdDogMCxcclxuICAgICAgfSxcclxuICAgICAgaG91cnNXYXRjaGVkOiB7XHJcbiAgICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICAgIGRlZmF1bHQ6IDAsXHJcbiAgICAgIH0sXHJcbiAgICAgIGxhc3RBY2Nlc3NEYXRlOiBEYXRlLFxyXG4gICAgfSxcclxuICAgIHN1cHBvcnRUaWNrZXRzOiBbXHJcbiAgICAgIHtcclxuICAgICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsXHJcbiAgICAgICAgcmVmOiAnU3VwcG9ydFRpY2tldCcsXHJcbiAgICAgIH0sXHJcbiAgICBdLFxyXG4gICAgY3VzdG9taXphdGlvbnM6IHtcclxuICAgICAgbm90aWZpY2F0aW9uUHJlZmVyZW5jZXM6IHtcclxuICAgICAgICBlbWFpbDogQm9vbGVhbixcclxuICAgICAgICBzbXM6IEJvb2xlYW4sXHJcbiAgICAgICAgaW5BcHA6IEJvb2xlYW4sXHJcbiAgICAgIH0sXHJcbiAgICAgIGNvbnRlbnRQcmVmZXJlbmNlczoge1xyXG4gICAgICAgIGRpc2FiaWxpdHlGb2N1czogU3RyaW5nLFxyXG4gICAgICAgIHByZWZlcnJlZExhbmd1YWdlOiBTdHJpbmcsXHJcbiAgICAgICAgY29udGVudFR5cGVzOiBbU3RyaW5nXSxcclxuICAgICAgfSxcclxuICAgIH0sXHJcbiAgICBjYW5jZWxsYXRpb25SZWFzb246IFN0cmluZyxcclxuICAgIGNhbmNlbGxhdGlvbkRhdGU6IERhdGUsXHJcbiAgICBub3RlczogU3RyaW5nLFxyXG4gICAgaXNUcmlhbFVzZXI6IHtcclxuICAgICAgdHlwZTogQm9vbGVhbixcclxuICAgICAgZGVmYXVsdDogZmFsc2UsXHJcbiAgICB9LFxyXG4gICAgdHJpYWxTdGFydERhdGU6IERhdGUsXHJcbiAgICB0cmlhbEVuZERhdGU6IERhdGUsXHJcbiAgICB1cGdyYWRlZEZyb21QbGFuOiB7XHJcbiAgICAgIHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCxcclxuICAgICAgcmVmOiAnU3Vic2NyaXB0aW9uUGxhbicsXHJcbiAgICB9LFxyXG4gICAgcmVmZXJyYWxDb2RlOiB7XHJcbiAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgdW5pcXVlOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIHJlZmVycmVkQnk6IHtcclxuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLFxyXG4gICAgICByZWY6ICdVc2VyU3Vic2NyaXB0aW9uJyxcclxuICAgIH0sXHJcbiAgICByZWZlcnJhbEJvbnVzZXM6IHtcclxuICAgICAgcmVmZXJyYWxzQ291bnQ6IHtcclxuICAgICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgICAgZGVmYXVsdDogMCxcclxuICAgICAgfSxcclxuICAgICAgYm9udXNDcmVkaXRzOiB7XHJcbiAgICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICAgIGRlZmF1bHQ6IDAsXHJcbiAgICAgIH0sXHJcbiAgICB9LFxyXG4gIH0sXHJcbiAge1xyXG4gICAgdGltZXN0YW1wczogdHJ1ZSxcclxuICAgIHRvSlNPTjogeyB2aXJ0dWFsczogdHJ1ZSB9LFxyXG4gICAgdG9PYmplY3Q6IHsgdmlydHVhbHM6IHRydWUgfSxcclxuICB9XHJcbik7XHJcblxyXG4vLyBJbmRleGVzXHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEuaW5kZXgoeyB1c2VySWQ6IDEgfSk7XHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEuaW5kZXgoeyBwbGFuSWQ6IDEgfSk7XHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEuaW5kZXgoeyBzdGF0dXM6IDEsIGVuZERhdGU6IDEgfSk7XHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEuaW5kZXgoeyByZW5ld2FsRGF0ZTogMSB9KTtcclxuXHJcbi8vIFZpcnR1YWwgZm9yIGlzIGFjdGl2ZVxyXG51c2VyU3Vic2NyaXB0aW9uU2NoZW1hLnZpcnR1YWwoJ2lzQWN0aXZlJykuZ2V0KGZ1bmN0aW9uICgpIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gJ2FjdGl2ZScgJiYgdGhpcy5lbmREYXRlID4gbm93O1xyXG59KTtcclxuXHJcbi8vIFZpcnR1YWwgZm9yIGRheXMgcmVtYWluaW5nXHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEudmlydHVhbCgnZGF5c1JlbWFpbmluZycpLmdldChmdW5jdGlvbiAoKSB7XHJcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICBjb25zdCBkaWZmID0gdGhpcy5lbmREYXRlIC0gbm93O1xyXG4gIHJldHVybiBNYXRoLmNlaWwoZGlmZiAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7XHJcbn0pO1xyXG5cclxuLy8gVmlydHVhbCBmb3IgaXMgZXhwaXJpbmcgc29vblxyXG51c2VyU3Vic2NyaXB0aW9uU2NoZW1hLnZpcnR1YWwoJ2V4cGlyaW5nSW5EYXlzJykuZ2V0KGZ1bmN0aW9uICgpIHtcclxuICByZXR1cm4gdGhpcy5kYXlzUmVtYWluaW5nIDw9IDcgJiYgdGhpcy5kYXlzUmVtYWluaW5nID4gMDtcclxufSk7XHJcblxyXG4vLyBTdGF0aWMgbWV0aG9kIHRvIGdldCBhY3RpdmUgc3Vic2NyaXB0aW9uc1xyXG51c2VyU3Vic2NyaXB0aW9uU2NoZW1hLnN0YXRpY3MuZ2V0QWN0aXZlU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gIHJldHVybiB0aGlzLmZpbmQoe1xyXG4gICAgc3RhdHVzOiAnYWN0aXZlJyxcclxuICAgIGVuZERhdGU6IHsgJGd0OiBub3cgfSxcclxuICB9KVxyXG4gICAgLnBvcHVsYXRlKCd1c2VySWQnLCAnbmFtZSBlbWFpbCcpXHJcbiAgICAucG9wdWxhdGUoJ3BsYW5JZCcsICduYW1lIGZlYXR1cmVzJyk7XHJcbn07XHJcblxyXG4vLyBTdGF0aWMgbWV0aG9kIHRvIGdldCBleHBpcmluZyBzdWJzY3JpcHRpb25zXHJcbnVzZXJTdWJzY3JpcHRpb25TY2hlbWEuc3RhdGljcy5nZXRFeHBpcmluZ1N1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZGF5c1RocmVzaG9sZCA9IDcpIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gIGNvbnN0IHRocmVzaG9sZCA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgKyBkYXlzVGhyZXNob2xkICogMjQgKiA2MCAqIDYwICogMTAwMCk7XHJcbiAgcmV0dXJuIHRoaXMuZmluZCh7XHJcbiAgICBzdGF0dXM6ICdhY3RpdmUnLFxyXG4gICAgZW5kRGF0ZTogeyAkbHRlOiB0aHJlc2hvbGQsICRndDogbm93IH0sXHJcbiAgfSlcclxuICAgIC5wb3B1bGF0ZSgndXNlcklkJywgJ25hbWUgZW1haWwnKVxyXG4gICAgLnBvcHVsYXRlKCdwbGFuSWQnLCAnbmFtZScpO1xyXG59O1xyXG5cclxuLy8gSW5zdGFuY2UgbWV0aG9kIHRvIHVwZ3JhZGUgcGxhblxyXG51c2VyU3Vic2NyaXB0aW9uU2NoZW1hLm1ldGhvZHMudXBncmFkZVBsYW4gPSBmdW5jdGlvbiAobmV3UGxhbklkLCBuZXdQcmljZSkge1xyXG4gIHRoaXMudXBncmFkZWRGcm9tUGxhbiA9IHRoaXMucGxhbklkO1xyXG4gIHRoaXMucGxhbklkID0gbmV3UGxhbklkO1xyXG4gIHRoaXMucHJpY2UuZGlzY291bnRlZFByaWNlID0gbmV3UHJpY2U7XHJcbiAgdGhpcy5zdGF0dXMgPSAnYWN0aXZlJztcclxuICByZXR1cm4gdGhpcy5zYXZlKCk7XHJcbn07XHJcblxyXG4vLyBJbnN0YW5jZSBtZXRob2QgdG8gY2FuY2VsIHN1YnNjcmlwdGlvblxyXG51c2VyU3Vic2NyaXB0aW9uU2NoZW1hLm1ldGhvZHMuY2FuY2VsU3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKHJlYXNvbikge1xyXG4gIHRoaXMuc3RhdHVzID0gJ2NhbmNlbGxlZCc7XHJcbiAgdGhpcy5jYW5jZWxsYXRpb25SZWFzb24gPSByZWFzb247XHJcbiAgdGhpcy5jYW5jZWxsYXRpb25EYXRlID0gbmV3IERhdGUoKTtcclxuICByZXR1cm4gdGhpcy5zYXZlKCk7XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IG1vbmdvb3NlLm1vZGVsKCdVc2VyU3Vic2NyaXB0aW9uJywgdXNlclN1YnNjcmlwdGlvblNjaGVtYSk7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsUUFBUSxHQUFHQyxPQUFPLENBQUMsVUFBVSxDQUFDO0FBRXBDLE1BQU1DLHNCQUFzQixHQUFHLElBQUlGLFFBQVEsQ0FBQ0csTUFBTSxDQUNoRDtFQUNFQyxNQUFNLEVBQUU7SUFDTkMsSUFBSSxFQUFFTCxRQUFRLENBQUNHLE1BQU0sQ0FBQ0csS0FBSyxDQUFDQyxRQUFRO0lBQ3BDQyxHQUFHLEVBQUUsTUFBTTtJQUNYQyxRQUFRLEVBQUU7RUFDWixDQUFDO0VBQ0RDLE1BQU0sRUFBRTtJQUNOTCxJQUFJLEVB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