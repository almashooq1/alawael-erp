{"version":3,"names":["mongoose","require","userSubscriptionSchema","Schema","userId","type","Types","ObjectId","ref","required","planId","status","String","enum","default","subscriptionType","startDate","Date","now","endDate","renewalDate","autoRenew","Boolean","price","original","Number","discountedPrice","appliedDiscount","currency","paymentMethod","paymentHistory","date","amount","transactionId","notes","usageStatistics","sessionsAttended","resourcesDownloaded","resourcesSaved","hoursWatched","lastAccessDate","supportTickets","customizations","notificationPreferences","email","sms","inApp","contentPreferences","disabilityFocus","preferredLanguage","contentTypes","cancellationReason","cancellationDate","isTrialUser","trialStartDate","trialEndDate","upgradedFromPlan","referralCode","unique","referredBy","referralBonuses","referralsCount","bonusCredits","timestamps","toJSON","virtuals","toObject","index","virtual","get","diff","Math","ceil","daysRemaining","statics","getActiveSubscriptions","find","$gt","populate","getExpiringSubscriptions","daysThreshold","threshold","getTime","$lte","methods","upgradePlan","newPlanId","newPrice","save","cancelSubscription","reason","module","exports","model"],"sources":["UserSubscription.js"],"sourcesContent":["const mongoose = require('mongoose');\r\n\r\nconst userSubscriptionSchema = new mongoose.Schema(\r\n  {\r\n    userId: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'User',\r\n      required: true,\r\n    },\r\n    planId: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'SubscriptionPlan',\r\n      required: true,\r\n    },\r\n    status: {\r\n      type: String,\r\n      enum: ['active', 'inactive', 'suspended', 'cancelled', 'expired'],\r\n      default: 'inactive',\r\n    },\r\n    subscriptionType: {\r\n      type: String,\r\n      enum: ['monthly', 'annual', 'lifetime'],\r\n      required: true,\r\n    },\r\n    startDate: {\r\n      type: Date,\r\n      default: Date.now,\r\n    },\r\n    endDate: {\r\n      type: Date,\r\n      required: true,\r\n    },\r\n    renewalDate: Date,\r\n    autoRenew: {\r\n      type: Boolean,\r\n      default: true,\r\n    },\r\n    price: {\r\n      original: Number,\r\n      discountedPrice: Number,\r\n      appliedDiscount: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      currency: {\r\n        type: String,\r\n        default: 'SAR',\r\n      },\r\n    },\r\n    paymentMethod: {\r\n      type: String,\r\n      enum: ['credit_card', 'debit_card', 'bank_transfer', 'wallet', 'other'],\r\n    },\r\n    paymentHistory: [\r\n      {\r\n        date: {\r\n          type: Date,\r\n          default: Date.now,\r\n        },\r\n        amount: Number,\r\n        status: {\r\n          type: String,\r\n          enum: ['pending', 'completed', 'failed', 'refunded'],\r\n        },\r\n        transactionId: String,\r\n        notes: String,\r\n      },\r\n    ],\r\n    usageStatistics: {\r\n      sessionsAttended: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      resourcesDownloaded: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      resourcesSaved: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      hoursWatched: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      lastAccessDate: Date,\r\n    },\r\n    supportTickets: [\r\n      {\r\n        type: mongoose.Schema.Types.ObjectId,\r\n        ref: 'SupportTicket',\r\n      },\r\n    ],\r\n    customizations: {\r\n      notificationPreferences: {\r\n        email: Boolean,\r\n        sms: Boolean,\r\n        inApp: Boolean,\r\n      },\r\n      contentPreferences: {\r\n        disabilityFocus: String,\r\n        preferredLanguage: String,\r\n        contentTypes: [String],\r\n      },\r\n    },\r\n    cancellationReason: String,\r\n    cancellationDate: Date,\r\n    notes: String,\r\n    isTrialUser: {\r\n      type: Boolean,\r\n      default: false,\r\n    },\r\n    trialStartDate: Date,\r\n    trialEndDate: Date,\r\n    upgradedFromPlan: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'SubscriptionPlan',\r\n    },\r\n    referralCode: {\r\n      type: String,\r\n      unique: true,\r\n    },\r\n    referredBy: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'UserSubscription',\r\n    },\r\n    referralBonuses: {\r\n      referralsCount: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      bonusCredits: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n    },\r\n  },\r\n  {\r\n    timestamps: true,\r\n    toJSON: { virtuals: true },\r\n    toObject: { virtuals: true },\r\n  }\r\n);\r\n\r\n// Indexes\r\nuserSubscriptionSchema.index({ userId: 1 });\r\nuserSubscriptionSchema.index({ planId: 1 });\r\nuserSubscriptionSchema.index({ status: 1, endDate: 1 });\r\nuserSubscriptionSchema.index({ renewalDate: 1 });\r\n\r\n// Virtual for is active\r\nuserSubscriptionSchema.virtual('isActive').get(function () {\r\n  const now = new Date();\r\n  return this.status === 'active' && this.endDate > now;\r\n});\r\n\r\n// Virtual for days remaining\r\nuserSubscriptionSchema.virtual('daysRemaining').get(function () {\r\n  const now = new Date();\r\n  const diff = this.endDate - now;\r\n  return Math.ceil(diff / (1000 * 60 * 60 * 24));\r\n});\r\n\r\n// Virtual for is expiring soon\r\nuserSubscriptionSchema.virtual('expiringInDays').get(function () {\r\n  return this.daysRemaining <= 7 && this.daysRemaining > 0;\r\n});\r\n\r\n// Static method to get active subscriptions\r\nuserSubscriptionSchema.statics.getActiveSubscriptions = function () {\r\n  const now = new Date();\r\n  return this.find({\r\n    status: 'active',\r\n    endDate: { $gt: now },\r\n  })\r\n    .populate('userId', 'name email')\r\n    .populate('planId', 'name features');\r\n};\r\n\r\n// Static method to get expiring subscriptions\r\nuserSubscriptionSchema.statics.getExpiringSubscriptions = function (daysThreshold = 7) {\r\n  const now = new Date();\r\n  const threshold = new Date(now.getTime() + daysThreshold * 24 * 60 * 60 * 1000);\r\n  return this.find({\r\n    status: 'active',\r\n    endDate: { $lte: threshold, $gt: now },\r\n  })\r\n    .populate('userId', 'name email')\r\n    .populate('planId', 'name');\r\n};\r\n\r\n// Instance method to upgrade plan\r\nuserSubscriptionSchema.methods.upgradePlan = function (newPlanId, newPrice) {\r\n  this.upgradedFromPlan = this.planId;\r\n  this.planId = newPlanId;\r\n  this.price.discountedPrice = newPrice;\r\n  this.status = 'active';\r\n  return this.save();\r\n};\r\n\r\n// Instance method to cancel subscription\r\nuserSubscriptionSchema.methods.cancelSubscription = function (reason) {\r\n  this.status = 'cancelled';\r\n  this.cancellationReason = reason;\r\n  this.cancellationDate = new Date();\r\n  return this.save();\r\n};\r\n\r\nmodule.exports = mongoose.model('UserSubscription', userSubscriptionSchema);\r\n"],"mappings":"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","ignoreList":[]}