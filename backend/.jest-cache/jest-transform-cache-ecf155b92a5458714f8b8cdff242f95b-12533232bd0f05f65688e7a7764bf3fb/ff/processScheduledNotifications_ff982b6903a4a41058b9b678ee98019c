cf99d71eea0d1f5875715dc0120fbe7d
const ScheduledNotification = require('../models/ScheduledNotification');
const Notification = require('../models/Notification');
const User = require('../models/User');

/**
 * خدمة تنفيذ الإشعارات المجدولة (تشغيل دوري)
 * مع معالجة أفضل للأخطاء والـ timeouts
 */
async function processScheduledNotifications() {
  try {
    // تحديد timeout لعملية البحث (8 ثواني بدلاً من الافتراضي)
    const now = new Date();

    // جلب الإشعارات المجدولة غير المرسلة والتي حان وقتها
    // مع تعطيل buffer timeout
    const due = await ScheduledNotification.find({
      sent: false,
      scheduleTime: {
        $lte: now
      }
    }).maxTimeMS(8000).limit(100) // حد أقصى 100 إشعار في كل مرة
    .exec();
    if (!due || due.length === 0) {
      return; // لا توجد إشعارات مجدولة
    }
    for (const sched of due) {
      try {
        // تحقق من المستخدم
        const user = await User.findById(sched.userId).maxTimeMS(5000);
        if (!user) {
          // تحديث الحالة حتى لو لم يوجد المستخدم
          sched.sent = true;
          sched.sentAt = new Date();
          await sched.save();
          continue;
        }

        // إنشاء إشعار فعلي
        await Notification.create({
          userId: sched.userId,
          title: sched.title,
          message: sched.message,
          type: 'reminder',
          priority: sched.metadata?.priority || 'normal',
          senderId: sched.createdBy,
          metadata: sched.metadata || {},
          category: 'reminder'
        });

        // تحديث حالة الإرسال
        sched.sent = true;
        sched.sentAt = new Date();
        await sched.save();
      } catch (itemErr) {
        console.warn(`⚠️  Error processing scheduled notification ${sched._id}:`, itemErr.message);
        // تابع مع الإشعارات التالية
        continue;
      }
    }
  } catch (err) {
    if (err.name === 'MongooseError' || err.message?.includes('buffering timed out')) {
      // لا تطبع رسائل error على stderr للـ timeout errors
      return;
    }
    console.error('Error in processScheduledNotifications:', err.message);
  }
}
module.exports = processScheduledNotifications;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY2hlZHVsZWROb3RpZmljYXRpb24iLCJyZXF1aXJlIiwiTm90aWZpY2F0aW9uIiwiVXNlciIsInByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zIiwibm93IiwiRGF0ZSIsImR1ZSIsImZpbmQiLCJzZW50Iiwic2NoZWR1bGVUaW1lIiwiJGx0ZSIsIm1heFRpbWVNUyIsImxpbWl0IiwiZXhlYyIsImxlbmd0aCIsInNjaGVkIiwidXNlciIsImZpbmRCeUlkIiwidXNlcklkIiwic2VudEF0Iiwic2F2ZSIsImNyZWF0ZSIsInRpdGxlIiwibWVzc2FnZSIsInR5cGUiLCJwcmlvcml0eSIsIm1ldGFkYXRhIiwic2VuZGVySWQiLCJjcmVhdGVkQnkiLCJjYXRlZ29yeSIsIml0ZW1FcnIiLCJjb25zb2xlIiwid2FybiIsIl9pZCIsImVyciIsIm5hbWUiLCJpbmNsdWRlcyIsImVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFNjaGVkdWxlZE5vdGlmaWNhdGlvbiA9IHJlcXVpcmUoJy4uL21vZGVscy9TY2hlZHVsZWROb3RpZmljYXRpb24nKTtcclxuY29uc3QgTm90aWZpY2F0aW9uID0gcmVxdWlyZSgnLi4vbW9kZWxzL05vdGlmaWNhdGlvbicpO1xyXG5jb25zdCBVc2VyID0gcmVxdWlyZSgnLi4vbW9kZWxzL1VzZXInKTtcclxuXHJcbi8qKlxyXG4gKiDYrtiv2YXYqSDYqtmG2YHZitiwINin2YTYpdi02LnYp9ix2KfYqiDYp9mE2YXYrNiv2YjZhNipICjYqti02LrZitmEINiv2YjYsdmKKVxyXG4gKiDZhdi5INmF2LnYp9mE2KzYqSDYo9mB2LbZhCDZhNmE2KPYrti32KfYoSDZiNin2YTZgCB0aW1lb3V0c1xyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1NjaGVkdWxlZE5vdGlmaWNhdGlvbnMoKSB7XHJcbiAgdHJ5IHtcclxuICAgIC8vINiq2K3Yr9mK2K8gdGltZW91dCDZhNi52YXZhNmK2Kkg2KfZhNio2K3YqyAoOCDYq9mI2KfZhtmKINio2K/ZhNin2Ysg2YXZhiDYp9mE2KfZgdiq2LHYp9i22YopXHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgXHJcbiAgICAvLyDYrNmE2Kgg2KfZhNil2LTYudin2LHYp9iqINin2YTZhdis2K/ZiNmE2Kkg2LrZitixINin2YTZhdix2LPZhNipINmI2KfZhNiq2Yog2K3Yp9mGINmI2YLYqtmH2KdcclxuICAgIC8vINmF2Lkg2KrYudi32YrZhCBidWZmZXIgdGltZW91dFxyXG4gICAgY29uc3QgZHVlID0gYXdhaXQgU2NoZWR1bGVkTm90aWZpY2F0aW9uLmZpbmQoXHJcbiAgICAgIHsgc2VudDogZmFsc2UsIHNjaGVkdWxlVGltZTogeyAkbHRlOiBub3cgfSB9XHJcbiAgICApXHJcbiAgICAgIC5tYXhUaW1lTVMoODAwMClcclxuICAgICAgLmxpbWl0KDEwMCkgLy8g2K3YryDYo9mC2LXZiSAxMDAg2KXYtNi52KfYsSDZgdmKINmD2YQg2YXYsdipXHJcbiAgICAgIC5leGVjKCk7XHJcblxyXG4gICAgaWYgKCFkdWUgfHwgZHVlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47IC8vINmE2Kcg2KrZiNis2K8g2KXYtNi52KfYsdin2Kog2YXYrNiv2YjZhNipXHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBzY2hlZCBvZiBkdWUpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICAvLyDYqtit2YLZgiDZhdmGINin2YTZhdiz2KrYrtiv2YVcclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZChzY2hlZC51c2VySWQpLm1heFRpbWVNUyg1MDAwKTtcclxuICAgICAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgICAgIC8vINiq2K3Yr9mK2Ksg2KfZhNit2KfZhNipINit2KrZiSDZhNmIINmE2YUg2YrZiNis2K8g2KfZhNmF2LPYqtiu2K/ZhVxyXG4gICAgICAgICAgc2NoZWQuc2VudCA9IHRydWU7XHJcbiAgICAgICAgICBzY2hlZC5zZW50QXQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgYXdhaXQgc2NoZWQuc2F2ZSgpO1xyXG4gICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDYpdmG2LTYp9ihINil2LTYudin2LEg2YHYudmE2YpcclxuICAgICAgICBhd2FpdCBOb3RpZmljYXRpb24uY3JlYXRlKHtcclxuICAgICAgICAgIHVzZXJJZDogc2NoZWQudXNlcklkLFxyXG4gICAgICAgICAgdGl0bGU6IHNjaGVkLnRpdGxlLFxyXG4gICAgICAgICAgbWVzc2FnZTogc2NoZWQubWVzc2FnZSxcclxuICAgICAgICAgIHR5cGU6ICdyZW1pbmRlcicsXHJcbiAgICAgICAgICBwcmlvcml0eTogc2NoZWQubWV0YWRhdGE/LnByaW9yaXR5IHx8ICdub3JtYWwnLFxyXG4gICAgICAgICAgc2VuZGVySWQ6IHNjaGVkLmNyZWF0ZWRCeSxcclxuICAgICAgICAgIG1ldGFkYXRhOiBzY2hlZC5tZXRhZGF0YSB8fCB7fSxcclxuICAgICAgICAgIGNhdGVnb3J5OiAncmVtaW5kZXInLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDYqtit2K/ZitirINit2KfZhNipINin2YTYpdix2LPYp9mEXHJcbiAgICAgICAgc2NoZWQuc2VudCA9IHRydWU7XHJcbiAgICAgICAgc2NoZWQuc2VudEF0ID0gbmV3IERhdGUoKTtcclxuICAgICAgICBhd2FpdCBzY2hlZC5zYXZlKCk7XHJcbiAgICAgIH0gY2F0Y2ggKGl0ZW1FcnIpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyAgRXJyb3IgcHJvY2Vzc2luZyBzY2hlZHVsZWQgbm90aWZpY2F0aW9uICR7c2NoZWQuX2lkfTpgLCBpdGVtRXJyLm1lc3NhZ2UpO1xyXG4gICAgICAgIC8vINiq2KfYqNi5INmF2Lkg2KfZhNil2LTYudin2LHYp9iqINin2YTYqtin2YTZitipXHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGlmIChlcnIubmFtZSA9PT0gJ01vbmdvb3NlRXJyb3InIHx8IGVyci5tZXNzYWdlPy5pbmNsdWRlcygnYnVmZmVyaW5nIHRpbWVkIG91dCcpKSB7XHJcbiAgICAgIC8vINmE2Kcg2KrYt9io2Lkg2LHYs9in2KbZhCBlcnJvciDYudmE2Ykgc3RkZXJyINmE2YTZgCB0aW1lb3V0IGVycm9yc1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBwcm9jZXNzU2NoZWR1bGVkTm90aWZpY2F0aW9uczonLCBlcnIubWVzc2FnZSk7XHJcbiAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLHFCQUFxQixHQUFHQyxPQUFPLENBQUMsaUNBQWlDLENBQUM7QUFDeEUsTUFBTUMsWUFBWSxHQUFHRCxPQUFPLENBQUMsd0JBQXdCLENBQUM7QUFDdEQsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsZ0JBQWdCLENBQUM7O0FBRXRDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZUcsNkJBQTZCQSxDQUFBLEVBQUc7RUFDN0MsSUFBSTtJQUNGO0lBQ0EsTUFBTUMsR0FBRyxHQUFHLElBQUlDLElBQUksQ0FBQyxDQUFDOztJQUV0QjtJQUNBO0lBQ0EsTUFBTUMsR0FBRyxHQUFHLE1BQU1QLHFCQUFxQixDQUFDUSxJQUFJLENBQzFDO01BQUVDLElBQUksRUFBRSxLQUFLO01BQUVDLFlBQVksRUFBRTtRQUFFQyxJQUFJLEVBQUVOO01BQUk7SUFBRSxDQUM3QyxDQUFDLENBQ0VPLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FDZkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQUEsQ0FDWEMsSUFBSSxDQUFDLENBQUM7SUFFVCxJQUFJLENBQUNQLEdBQUcsSUFBSUEsR0FBRyxDQUFDUSxNQUFNLEtBQUssQ0FBQyxFQUFFO01BQzVCLE9BQU8sQ0FBQztJQUNWO0lBRUEsS0FBSyxNQUFNQyxLQUFLLElBQUlULEdBQUcsRUFBRTtNQUN2QixJQUFJO1FBQ0Y7UUFDQSxNQUFNVSxJQUFJLEdBQUcsTUFBTWQsSUFBSSxDQUFDZSxRQUFRLENBQUNGLEtBQUssQ0FBQ0csTUFBTSxDQUFDLENBQUNQLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDOUQsSUFBSSxDQUFDSyxJQUFJLEVBQUU7VUFDVDtVQUNBRCxLQUFLLENBQUNQLElBQUksR0FBRyxJQUFJO1VBQ2pCTyxLQUFLLENBQUNJLE1BQU0sR0FBRyxJQUFJZCxJQUFJLENBQUMsQ0FBQztVQUN6QixNQUFNVSxLQUFLLENBQUNLLElBQUksQ0FBQyxDQUFDO1VBQ2xCO1FBQ0Y7O1FBRUE7UUFDQSxNQUFNbkIsWUFBWSxDQUFDb0IsTUFBTSxDQUFDO1VBQ3hCSCxNQUFNLEVBQUVILEtBQUssQ0FBQ0csTUFBTTtVQUNwQkksS0FBSyxFQUFFUCxLQUFLLENBQUNPLEtBQUs7VUFDbEJDLE9BQU8sRUFBRVIsS0FBSyxDQUFDUSxPQUFPO1VBQ3RCQyxJQUFJLEVBQUUsVUFBVTtVQUNoQkMsUUFBUSxFQUFFVixLQUFLLENBQUNXLFFBQVEsRUFBRUQsUUFBUSxJQUFJLFFBQVE7VUFDOUNFLFFBQVEsRUFBRVosS0FBSyxDQUFDYSxTQUFTO1VBQ3pCRixRQUFRLEVBQUVYLEtBQUssQ0FBQ1csUUFBUSxJQUFJLENBQUMsQ0FBQztVQUM5QkcsUUFBUSxFQUFFO1FBQ1osQ0FBQyxDQUFDOztRQUVGO1FBQ0FkLEtBQUssQ0FBQ1AsSUFBSSxHQUFHLElBQUk7UUFDakJPLEtBQUssQ0FBQ0ksTUFBTSxHQUFHLElBQUlkLElBQUksQ0FBQyxDQUFDO1FBQ3pCLE1BQU1VLEtBQUssQ0FBQ0ssSUFBSSxDQUFDLENBQUM7TUFDcEIsQ0FBQyxDQUFDLE9BQU9VLE9BQU8sRUFBRTtRQUNoQkMsT0FBTyxDQUFDQyxJQUFJLENBQUMsK0NBQStDakIsS0FBSyxDQUFDa0IsR0FBRyxHQUFHLEVBQUVILE9BQU8sQ0FBQ1AsT0FBTyxDQUFDO1FBQzFGO1FBQ0E7TUFDRjtJQUNGO0VBQ0YsQ0FBQyxDQUFDLE9BQU9XLEdBQUcsRUFBRTtJQUNaLElBQUlBLEdBQUcsQ0FBQ0MsSUFBSSxLQUFLLGVBQWUsSUFBSUQsR0FBRyxDQUFDWCxPQUFPLEVBQUVhLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFO01BQ2hGO01BQ0E7SUFDRjtJQUNBTCxPQUFPLENBQUNNLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRUgsR0FBRyxDQUFDWCxPQUFPLENBQUM7RUFDdkU7QUFDRjtBQUVBZSxNQUFNLENBQUNDLE9BQU8sR0FBR3BDLDZCQUE2QiIsImlnbm9yZUxpc3QiOltdfQ==