{"version":3,"names":["ScheduledNotification","require","Notification","User","processScheduledNotifications","now","Date","due","find","sent","scheduleTime","$lte","maxTimeMS","limit","exec","length","sched","user","findById","userId","sentAt","save","create","title","message","type","priority","metadata","senderId","createdBy","category","itemErr","console","warn","_id","err","name","includes","error","module","exports"],"sources":["processScheduledNotifications.js"],"sourcesContent":["const ScheduledNotification = require('../models/ScheduledNotification');\r\nconst Notification = require('../models/Notification');\r\nconst User = require('../models/User');\r\n\r\n/**\r\n * خدمة تنفيذ الإشعارات المجدولة (تشغيل دوري)\r\n * مع معالجة أفضل للأخطاء والـ timeouts\r\n */\r\nasync function processScheduledNotifications() {\r\n  try {\r\n    // تحديد timeout لعملية البحث (8 ثواني بدلاً من الافتراضي)\r\n    const now = new Date();\r\n    \r\n    // جلب الإشعارات المجدولة غير المرسلة والتي حان وقتها\r\n    // مع تعطيل buffer timeout\r\n    const due = await ScheduledNotification.find(\r\n      { sent: false, scheduleTime: { $lte: now } }\r\n    )\r\n      .maxTimeMS(8000)\r\n      .limit(100) // حد أقصى 100 إشعار في كل مرة\r\n      .exec();\r\n\r\n    if (!due || due.length === 0) {\r\n      return; // لا توجد إشعارات مجدولة\r\n    }\r\n\r\n    for (const sched of due) {\r\n      try {\r\n        // تحقق من المستخدم\r\n        const user = await User.findById(sched.userId).maxTimeMS(5000);\r\n        if (!user) {\r\n          // تحديث الحالة حتى لو لم يوجد المستخدم\r\n          sched.sent = true;\r\n          sched.sentAt = new Date();\r\n          await sched.save();\r\n          continue;\r\n        }\r\n\r\n        // إنشاء إشعار فعلي\r\n        await Notification.create({\r\n          userId: sched.userId,\r\n          title: sched.title,\r\n          message: sched.message,\r\n          type: 'reminder',\r\n          priority: sched.metadata?.priority || 'normal',\r\n          senderId: sched.createdBy,\r\n          metadata: sched.metadata || {},\r\n          category: 'reminder',\r\n        });\r\n\r\n        // تحديث حالة الإرسال\r\n        sched.sent = true;\r\n        sched.sentAt = new Date();\r\n        await sched.save();\r\n      } catch (itemErr) {\r\n        console.warn(`⚠️  Error processing scheduled notification ${sched._id}:`, itemErr.message);\r\n        // تابع مع الإشعارات التالية\r\n        continue;\r\n      }\r\n    }\r\n  } catch (err) {\r\n    if (err.name === 'MongooseError' || err.message?.includes('buffering timed out')) {\r\n      // لا تطبع رسائل error على stderr للـ timeout errors\r\n      return;\r\n    }\r\n    console.error('Error in processScheduledNotifications:', err.message);\r\n  }\r\n}\r\n\r\nmodule.exports = processScheduledNotifications;\r\n"],"mappings":"AAAA,MAAMA,qBAAqB,GAAGC,OAAO,CAAC,iCAAiC,CAAC;AACxE,MAAMC,YAAY,GAAGD,OAAO,CAAC,wBAAwB,CAAC;AACtD,MAAME,IAAI,GAAGF,OAAO,CAAC,gBAAgB,CAAC;;AAEtC;AACA;AACA;AACA;AACA,eAAeG,6BAA6BA,CAAA,EAAG;EAC7C,IAAI;IACF;IACA,MAAMC,GAAG,GAAG,IAAIC,IAAI,CAAC,CAAC;;IAEtB;IACA;IACA,MAAMC,GAAG,GAAG,MAAMP,qBAAqB,CAACQ,IAAI,CAC1C;MAAEC,IAAI,EAAE,KAAK;MAAEC,YAAY,EAAE;QAAEC,IAAI,EAAEN;MAAI;IAAE,CAC7C,CAAC,CACEO,SAAS,CAAC,IAAI,CAAC,CACfC,KAAK,CAAC,GAAG,CAAC,CAAC;IAAA,CACXC,IAAI,CAAC,CAAC;IAET,IAAI,CAACP,GAAG,IAAIA,GAAG,CAACQ,MAAM,KAAK,CAAC,EAAE;MAC5B,OAAO,CAAC;IACV;IAEA,KAAK,MAAMC,KAAK,IAAIT,GAAG,EAAE;MACvB,IAAI;QACF;QACA,MAAMU,IAAI,GAAG,MAAMd,IAAI,CAACe,QAAQ,CAACF,KAAK,CAACG,MAAM,CAAC,CAACP,SAAS,CAAC,IAAI,CAAC;QAC9D,IAAI,CAACK,IAAI,EAAE;UACT;UACAD,KAAK,CAACP,IAAI,GAAG,IAAI;UACjBO,KAAK,CAACI,MAAM,GAAG,IAAId,IAAI,CAAC,CAAC;UACzB,MAAMU,KAAK,CAACK,IAAI,CAAC,CAAC;UAClB;QACF;;QAEA;QACA,MAAMnB,YAAY,CAACoB,MAAM,CAAC;UACxBH,MAAM,EAAEH,KAAK,CAACG,MAAM;UACpBI,KAAK,EAAEP,KAAK,CAACO,KAAK;UAClBC,OAAO,EAAER,KAAK,CAACQ,OAAO;UACtBC,IAAI,EAAE,UAAU;UAChBC,QAAQ,EAAEV,KAAK,CAACW,QAAQ,EAAED,QAAQ,IAAI,QAAQ;UAC9CE,QAAQ,EAAEZ,KAAK,CAACa,SAAS;UACzBF,QAAQ,EAAEX,KAAK,CAACW,QAAQ,IAAI,CAAC,CAAC;UAC9BG,QAAQ,EAAE;QACZ,CAAC,CAAC;;QAEF;QACAd,KAAK,CAACP,IAAI,GAAG,IAAI;QACjBO,KAAK,CAACI,MAAM,GAAG,IAAId,IAAI,CAAC,CAAC;QACzB,MAAMU,KAAK,CAACK,IAAI,CAAC,CAAC;MACpB,CAAC,CAAC,OAAOU,OAAO,EAAE;QAChBC,OAAO,CAACC,IAAI,CAAC,+CAA+CjB,KAAK,CAACkB,GAAG,GAAG,EAAEH,OAAO,CAACP,OAAO,CAAC;QAC1F;QACA;MACF;IACF;EACF,CAAC,CAAC,OAAOW,GAAG,EAAE;IACZ,IAAIA,GAAG,CAACC,IAAI,KAAK,eAAe,IAAID,GAAG,CAACX,OAAO,EAAEa,QAAQ,CAAC,qBAAqB,CAAC,EAAE;MAChF;MACA;IACF;IACAL,OAAO,CAACM,KAAK,CAAC,yCAAyC,EAAEH,GAAG,CAACX,OAAO,CAAC;EACvE;AACF;AAEAe,MAAM,CAACC,OAAO,GAAGpC,6BAA6B","ignoreList":[]}