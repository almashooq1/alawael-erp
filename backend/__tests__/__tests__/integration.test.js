/**\n * Integration Tests\n * Tests interactions between multiple services\n */\n\nconst DashboardService = require('../services/dashboardService');\nconst ReportService = require('../services/reportService');\nconst MetricsService = require('../services/metricsService');\nconst AuthService = require('../services/authService');\nconst RBACService = require('../services/rbacService');\nconst EncryptionService = require('../services/encryptionService');\n\nclass IntegrationTestSuite {\n  constructor() {\n    this.dashboardService = new DashboardService();\n    this.reportService = new ReportService();\n    this.metricsService = new MetricsService();\n    this.authService = new AuthService();\n    this.rbacService = new RBACService();\n    this.encryptionService = new EncryptionService();\n\n    this.testsPassed = 0;\n    this.testsFailed = 0;\n  }\n\n  /**\n   * Run all integration tests\n   */\n  async runAllTests() {\n    console.log('\\nðŸ§ª Running Integration Test Suite...\\n');\n\n    // Auth + RBAC Integration\n    await this.test('User registration and role assignment', () => {\n      const user = this.authService.registerUser({\n        username: 'testuser',\n        email: 'test@example.com',\n        password: 'TestPassword123!'\n      });\n\n      const admin = this.rbacService.getRole('admin');\n      this.rbacService.assignRoleToUser(user.id, admin.id);\n\n      const roles = this.rbacService.getUserRoles(user.id);\n      if (!roles.find(r => r.id === admin.id)) {\n        throw new Error('User role assignment failed');\n      }\n    });\n\n    // Auth + Encryption Integration\n    await this.test('Password encryption during registration', () => {\n      const user = this.authService.registerUser({\n        username: 'enctest',\n        email: 'enc@example.com',\n        password: 'SecurePass123!'\n      });\n\n      if (!user.salt || !user.passwordHash) {\n        throw new Error('Password not properly encrypted');\n      }\n    });\n\n    // Dashboard + Metrics Integration\n    await this.test('Create dashboard and add metric widgets', () => {\n      const dashboard = this.dashboardService.createDashboard('user-123', {\n        name: 'Sales Dashboard'\n      });\n\n      this.metricsService.recordMetric('revenue', 50000, {\n        dashboard: dashboard.id\n      });\n\n      const metricWidget = this.dashboardService.addWidget(dashboard.id, {\n        type: 'metric-card',\n        title: 'Total Revenue',\n        config: { metric: 'revenue' }\n      });\n\n      if (metricWidget.type !== 'metric-card') {\n        throw new Error('Metric widget not added to dashboard');\n      }\n    });\n\n    // Report + Metrics Integration\n    await this.test('Generate report from metrics', () => {\n      this.metricsService.recordMetric('sales_volume', 1000);\n      this.metricsService.recordMetric('customer_count', 500);\n\n      const report = this.reportService.createReport('user-123', {\n        name: 'Metrics Report',\n        type: 'metrics',\n        columns: ['metric', 'value', 'timestamp']\n      });\n\n      if (!report.id) {\n        throw new Error('Report creation failed');\n      }\n    });\n\n    // RBAC + Encryption Integration\n    await this.test('Encrypt sensitive data based on role', () => {\n      const user = this.authService.registerUser({\n        username: 'sensitive',\n        email: 'sensitive@example.com',\n        password: 'Pass123!'\n      });\n\n      const userPerms = this.rbacService.getUserPermissions(user.id);\n\n      const sensitiveData = 'SSN: 123-45-6789';\n      const encrypted = this.encryptionService.encrypt(sensitiveData);\n\n      if (!encrypted.id || !encrypted.ciphertext) {\n        throw new Error('Encryption failed');\n      }\n    });\n\n    // Dashboard + RBAC Integration\n    await this.test('Dashboard access control with roles', () => {\n      const dashboard = this.dashboardService.createDashboard('user-456', {\n        name: 'Admin Dashboard'\n      });\n\n      const adminRole = this.rbacService.getRole('admin');\n      const hasAccess = this.rbacService.checkResourceAccess(\n        'user-456',\n        'read:dashboard',\n        dashboard.id\n      );\n\n      if (!hasAccess) {\n        throw new Error('User access check failed');\n      }\n    });\n\n    // Multi-service workflow\n    await this.test('Complete user workflow: auth â†’ dashboard â†’ report', () => {\n      // Register user\n      const user = this.authService.registerUser({\n        username: 'workflow',\n        email: 'workflow@example.com',\n        password: 'WorkPass123!'\n      });\n\n      // Assign role\n      const managerRole = this.rbacService.getRole('manager');\n      this.rbacService.assignRoleToUser(user.id, managerRole.id);\n\n      // Create dashboard\n      const dashboard = this.dashboardService.createDashboard(user.id, {\n        name: 'Manager Dashboard'\n      });\n\n      // Add metrics to dashboard\n      this.metricsService.recordMetric('performance', 85);\n\n      // Create report\n      const report = this.reportService.createReport(user.id, {\n        name: 'Performance Report',\n        type: 'metrics'\n      });\n\n      if (!user.id || !dashboard.id || !report.id) {\n        throw new Error('Multi-service workflow failed');\n      }\n    });\n\n    // Encryption + Report Integration\n    await this.test('Export encrypted report data', () => {\n      this.metricsService.recordMetric('profit', 100000);\n\n      const report = this.reportService.createReport('user-789', {\n        name: 'Profit Report',\n        type: 'financial'\n      });\n\n      const sensitiveValue = '100000';\n      const encrypted = this.encryptionService.encrypt(sensitiveValue);\n\n      const exported = this.reportService.exportReport(report.id, 'pdf');\n\n      if (!exported) {\n        throw new Error('Report export failed');\n      }\n    });\n\n    // Dashboard sharing with RBAC\n    await this.test('Share dashboard respecting RBAC', () => {\n      const dashboard = this.dashboardService.createDashboard('owner-123', {\n        name: 'Shared Dashboard'\n      });\n\n      const viewer = { id: 'viewer-123' };\n      this.dashboardService.shareDashboard(dashboard.id, [viewer.id]);\n\n      // Verify viewer can read\n      const canRead = this.rbacService.hasPermission(viewer.id, 'read:dashboard');\n      // Note: In real implementation, would check resource-level access\n    });\n\n    // Data validation across services\n    await this.test('Data validation across multiple services', () => {\n      // Record metrics with validation\n      this.metricsService.recordMetric('temperature', 27.5, {\n        unit: 'celsius'\n      });\n\n      // Create report with validated data\n      const report = this.reportService.createReport('user-999', {\n        name: 'Temperature Report',\n        columns: ['timestamp', 'temperature']\n      });\n\n      // Verify data integrity\n      const getReport = this.reportService.getReport(report.id);\n      if (getReport.name !== 'Temperature Report') {\n        throw new Error('Data integrity check failed');\n      }\n    });\n\n    // Error handling integration\n    await this.test('Error handling across service boundaries', () => {\n      try {\n        // Try to get non-existent dashboard\n        this.dashboardService.getDashboard('non-existent-id');\n        throw new Error('Should have thrown error for non-existent dashboard');\n      } catch (error) {\n        if (!error.message.includes('not found')) {\n          throw error;\n        }\n      }\n    });\n\n    // Performance test: bulk operations\n    await this.test('Bulk metric recording performance', () => {\n      const startTime = Date.now();\n      for (let i = 0; i < 100; i++) {\n        this.metricsService.recordMetric(`metric_${i}`, Math.random() * 100);\n      }\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      if (duration > 5000) {\n        throw new Error(`Bulk operation too slow: ${duration}ms`);\n      }\n    });\n\n    // Concurrent operations simulation\n    await this.test('Simulate concurrent dashboard operations', () => {\n      const dashboards = [];\n      for (let i = 0; i < 10; i++) {\n        const dashboard = this.dashboardService.createDashboard(`user-${i}`, {\n          name: `Concurrent Dashboard ${i}`\n        });\n        dashboards.push(dashboard);\n      }\n\n      if (dashboards.length !== 10) {\n        throw new Error('Concurrent dashboard creation failed');\n      }\n    });\n\n    // Print summary\n    this.printSummary();\n  }\n\n  /**\n   * Run a single test\n   */\n  async test(description, testFn) {\n    try {\n      await testFn();\n      console.log(`âœ… ${description}`);\n      this.testsPassed++;\n    } catch (error) {\n      console.log(`âŒ ${description}`);\n      console.log(`   Error: ${error.message}`);\n      this.testsFailed++;\n    }\n  }\n\n  /**\n   * Print test summary\n   */\n  printSummary() {\n    const total = this.testsPassed + this.testsFailed;\n    const percentage = Math.round((this.testsPassed / total) * 100);\n\n    console.log('\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n    console.log('Test Summary:');\n    console.log(`  Total Tests: ${total}`);\n    console.log(`  âœ… Passed: ${this.testsPassed}`);\n    console.log(`  âŒ Failed: ${this.testsFailed}`);\n    console.log(`  Success Rate: ${percentage}%`);\n    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n');\n  }\n}\n\n// Run tests if executed directly\nif (require.main === module) {\n  const suite = new IntegrationTestSuite();\n  suite.runAllTests().catch(console.error);\n}\n\nmodule.exports = IntegrationTestSuite;\n