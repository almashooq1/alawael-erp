/**\n * Phase 11 Security Services Tests\n * Comprehensive test suite for Authentication, RBAC, and Encryption services\n */\n\nconst authService = require('../services/security/authService');\nconst rbacService = require('../services/security/rbacService');\nconst encryptionService = require('../services/security/encryptionService');\n\nclass SecurityTestSuite {\n  constructor() {\n    this.testResults = [];\n    this.testCount = 0;\n    this.passCount = 0;\n    this.failCount = 0;\n  }\n\n  runAllTests() {\n    console.log('\\n' + '='.repeat(70));\n    console.log('  PHASE 11 - SECURITY SERVICES TEST SUITE');\n    console.log('='.repeat(70) + '\\n');\n\n    this.testAuthService();\n    this.testRBACService();\n    this.testEncryptionService();\n\n    this.printSummary();\n  }\n\n  testAuthService() {\n    console.log('\\nüîê AUTHENTICATION SERVICE TESTS\\n');\n\n    // Test 1: Register user\n    this.test('Register new user', () => {\n      const user = authService.registerUser({\n        username: 'testuser',\n        email: 'test@example.com',\n        password: 'SecurePass123!'\n      });\n      return user.id && user.username === 'testuser';\n    });\n\n    // Test 2: Authenticate successful\n    this.test('Authenticate user successfully', () => {\n      authService.registerUser({\n        username: 'user1',\n        email: 'user1@example.com',\n        password: 'Password123!'\n      });\n      const result = authService.authenticateUser('user1', 'Password123!');\n      return result.success && result.accessToken !== undefined;\n    });\n\n    // Test 3: Authenticate wrong password\n    this.test('Reject authentication with wrong password', () => {\n      authService.registerUser({\n        username: 'user2',\n        email: 'user2@example.com',\n        password: 'Correct123!'\n      });\n      const result = authService.authenticateUser('user2', 'Wrong123!');\n      return !result.success;\n    });\n\n    // Test 4: Verify token\n    this.test('Verify valid token', () => {\n      authService.registerUser({\n        username: 'user3',\n        email: 'user3@example.com',\n        password: 'Pass123!'\n      });\n      const auth = authService.authenticateUser('user3', 'Pass123!');\n      const verify = authService.verifyToken(auth.accessToken);\n      return verify.valid && verify.userId !== undefined;\n    });\n\n    // Test 5: Refresh token\n    this.test('Refresh access token', () => {\n      authService.registerUser({\n        username: 'user4',\n        email: 'user4@example.com',\n        password: 'Pass123!'\n      });\n      const auth = authService.authenticateUser('user4', 'Pass123!');\n      const refresh = authService.refreshAccessToken(auth.refreshToken);\n      return refresh.success && refresh.accessToken !== auth.accessToken;\n    });\n\n    // Test 6: Logout user\n    this.test('Logout user', () => {\n      authService.registerUser({\n        username: 'user5',\n        email: 'user5@example.com',\n        password: 'Pass123!'\n      });\n      const auth = authService.authenticateUser('user5', 'Pass123!');\n      const logout = authService.logoutUser(auth.sessionId);\n      return logout === true;\n    });\n\n    // Test 7: Enable 2FA\n    this.test('Enable two-factor authentication', () => {\n      const user = authService.registerUser({\n        username: 'user6',\n        email: 'user6@example.com',\n        password: 'Pass123!'\n      });\n      const twoFA = authService.enableTwoFactor(user.id);\n      return twoFA.secret !== undefined && twoFA.qrCode !== undefined;\n    });\n\n    // Test 8: Reset password\n    this.test('Reset password', () => {\n      authService.registerUser({\n        username: 'user7',\n        email: 'user7@example.com',\n        password: 'Pass123!'\n      });\n      const reset = authService.resetPassword('user7@example.com');\n      return reset.success && reset.resetToken !== undefined;\n    });\n\n    // Test 9: Update password\n    this.test('Update user password', () => {\n      const user = authService.registerUser({\n        username: 'user8',\n        email: 'user8@example.com',\n        password: 'OldPass123!'\n      });\n      const update = authService.updatePassword(user.id, 'OldPass123!', 'NewPass456!');\n      return update.success;\n    });\n\n    // Test 10: Lock account after failed attempts\n    this.test('Lock account after failed login attempts', () => {\n      authService.registerUser({\n        username: 'user9',\n        email: 'user9@example.com',\n        password: 'Pass123!'\n      });\n      // Simulate failed attempts\n      for (let i = 0; i < 5; i++) {\n        authService.authenticateUser('user9', 'WrongPass!');\n      }\n      const result = authService.authenticateUser('user9', 'Pass123!');\n      return !result.success && result.error.includes('locked');\n    });\n  }\n\n  testRBACService() {\n    console.log('\\nüëÆ RBAC SERVICE TESTS\\n');\n\n    // Test 1: Create role\n    this.test('Create role', () => {\n      const role = rbacService.createRole({\n        name: 'Editor',\n        description: 'Can edit content'\n      });\n      return role.id && role.name === 'Editor';\n    });\n\n    // Test 2: Get role\n    this.test('Get role by ID', () => {\n      const role = rbacService.createRole({ name: 'Viewer' });\n      const retrieved = rbacService.getRole(role.id);\n      return retrieved.id === role.id;\n    });\n\n    // Test 3: List roles\n    this.test('List all roles', () => {\n      const roles = rbacService.listRoles();\n      return roles.length >= 4; // Admin, Manager, Employee, Viewer by default\n    });\n\n    // Test 4: Create permission\n    this.test('Create permission', () => {\n      const perm = rbacService.createPermission({\n        key: 'post:create',\n        name: 'Create Post'\n      });\n      return perm.id && perm.key === 'post:create';\n    });\n\n    // Test 5: Assign role to user\n    this.test('Assign role to user', () => {\n      const role = rbacService.createRole({ name: 'Publisher' });\n      const assignment = rbacService.assignRoleToUser('user123', role.id);\n      return assignment.assigned === true;\n    });\n\n    // Test 6: Revoke role from user\n    this.test('Revoke role from user', () => {\n      const role = rbacService.createRole({ name: 'Commentor' });\n      rbacService.assignRoleToUser('user456', role.id);\n      const revoke = rbacService.revokeRoleFromUser('user456', role.id);\n      return revoke.success === true;\n    });\n\n    // Test 7: Get user roles\n    this.test('Get user roles', () => {\n      const role1 = rbacService.createRole({ name: 'Role1' });\n      const role2 = rbacService.createRole({ name: 'Role2' });\n      rbacService.assignRoleToUser('user789', role1.id);\n      rbacService.assignRoleToUser('user789', role2.id);\n      const roles = rbacService.getUserRoles('user789');\n      return roles.length >= 2;\n    });\n\n    // Test 8: Check permission\n    this.test('Check user has permission', () => {\n      const role = rbacService.createRole({ name: 'ContentCreator' });\n      const perm = rbacService.createPermission({ key: 'content:publish' });\n      rbacService.addPermissionToRole(role.id, perm.id);\n      rbacService.assignRoleToUser('user999', role.id);\n      const hasPermission = rbacService.hasPermission('user999', 'content:publish');\n      return hasPermission === true;\n    });\n\n    // Test 9: Check any permission\n    this.test('Check user has any permission', () => {\n      const role = rbacService.createRole({ name: 'TestRole' });\n      const perm1 = rbacService.createPermission({ key: 'read:all' });\n      rbacService.addPermissionToRole(role.id, perm1.id);\n      rbacService.assignRoleToUser('user1000', role.id);\n      const hasAny = rbacService.hasAnyPermission('user1000', ['read:all', 'write:all']);\n      return hasAny === true;\n    });\n\n    // Test 10: Check all permissions\n    this.test('Check user has all permissions', () => {\n      const role = rbacService.createRole({ name: 'SuperRole' });\n      const perm1 = rbacService.createPermission({ key: 'read:all' });\n      const perm2 = rbacService.createPermission({ key: 'write:all' });\n      rbacService.addPermissionToRole(role.id, perm1.id);\n      rbacService.addPermissionToRole(role.id, perm2.id);\n      rbacService.assignRoleToUser('user1001', role.id);\n      const hasAll = rbacService.hasAllPermissions('user1001', ['read:all', 'write:all']);\n      return hasAll === true;\n    });\n  }\n\n  testEncryptionService() {\n    console.log('\\nüîí ENCRYPTION SERVICE TESTS\\n');\n\n    // Test 1: Encrypt data\n    this.test('Encrypt data', () => {\n      const plaintext = 'Sensitive Information';\n      const encrypted = encryptionService.encrypt(plaintext);\n      return encrypted.encryptedId && encrypted.ciphertext && encrypted.iv;\n    });\n\n    // Test 2: Decrypt data\n    this.test('Decrypt data', () => {\n      const plaintext = 'Secret Message';\n      const encrypted = encryptionService.encrypt(plaintext);\n      const decrypted = encryptionService.decrypt(encrypted.encryptedId);\n      return decrypted === plaintext;\n    });\n\n    // Test 3: Hash data\n    this.test('Hash data one-way', () => {\n      const hash1 = encryptionService.hash('password123');\n      const hash2 = encryptionService.hash('password123');\n      return hash1 === hash2 && hash1.length === 64; // SHA256\n    });\n\n    // Test 4: Hash with salt\n    this.test('Hash with salt', () => {\n      const result = encryptionService.hashWithSalt('mypassword');\n      return result.hashed && result.salt && result.hashed.length === 64;\n    });\n\n    // Test 5: Verify hash\n    this.test('Verify hashed value', () => {\n      const data = 'original_data';\n      const { hashed, salt } = encryptionService.hashWithSalt(data);\n      const verified = encryptionService.verifyHash(data, hashed, salt);\n      return verified === true;\n    });\n\n    // Test 6: Generate key\n    this.test('Generate random key', () => {\n      const key1 = encryptionService.generateKey(32);\n      const key2 = encryptionService.generateKey(32);\n      return key1 && key2 && key1 !== key2;\n    });\n\n    // Test 7: Store key\n    this.test('Store encryption key', () => {\n      const key = encryptionService.generateKey(32);\n      const success = encryptionService.storeKey('test-key-1', key);\n      return success === true;\n    });\n\n    // Test 8: Rotate key\n    this.test('Rotate encryption key', () => {\n      encryptionService.storeKey('rotating-key', encryptionService.generateKey(32));\n      const rotation = encryptionService.rotateKey('rotating-key');\n      return rotation.keyId === 'rotating-key' && rotation.archivedKeyId.includes('archived');\n    });\n\n    // Test 9: Sign data\n    this.test('Sign data with HMAC', () => {\n      const data = 'Important Data';\n      const signature = encryptionService.sign(data);\n      return signature && signature.length > 0;\n    });\n\n    // Test 10: Verify signature\n    this.test('Verify data signature', () => {\n      const data = 'Signed Data';\n      const signature = encryptionService.sign(data);\n      const verified = encryptionService.verifySignature(data, signature);\n      return verified === true;\n    });\n\n    // Test 11: Encrypt field (PII)\n    this.test('Encrypt sensitive field', () => {\n      const encrypted = encryptionService.encryptField('email', 'user@example.com');\n      return encrypted.field === 'email' && encrypted.encrypted === true;\n    });\n\n    // Test 12: Decrypt field\n    this.test('Decrypt sensitive field', () => {\n      const encrypted = encryptionService.encryptField('ssn', '123-45-6789');\n      const decrypted = encryptionService.decryptField(encrypted.encryptedId);\n      return decrypted === '123-45-6789';\n    });\n  }\n\n  test(description, testFn) {\n    this.testCount++;\n    try {\n      const result = testFn();\n      if (result) {\n        this.passCount++;\n        console.log(`  ‚úÖ ${description}`);\n      } else {\n        this.failCount++;\n        console.log(`  ‚ùå ${description} - Assertion failed`);\n      }\n    } catch (error) {\n      this.failCount++;\n      console.log(`  ‚ùå ${description} - ${error.message}`);\n    }\n  }\n\n  printSummary() {\n    const successRate = ((this.passCount / this.testCount) * 100).toFixed(1);\n    console.log('\\n' + '='.repeat(70));\n    console.log('  TEST SUMMARY');\n    console.log('='.repeat(70));\n    console.log(`\\n  Total Tests: ${this.testCount}`);\n    console.log(`  ‚úÖ Passed: ${this.passCount}`);\n    console.log(`  ‚ùå Failed: ${this.failCount}`);\n    console.log(`\\n  Success Rate: ${successRate}%`);\n    console.log(`\\n  Status: ${this.failCount === 0 ? '‚úÖ ALL TESTS PASSED' : '‚ùå SOME TESTS FAILED'}`);\n    console.log('\\n' + '='.repeat(70) + '\\n');\n  }\n}\n\nif (require.main === module) {\n  const testSuite = new SecurityTestSuite();\n  testSuite.runAllTests();\n}\n\nmodule.exports = SecurityTestSuite;\n