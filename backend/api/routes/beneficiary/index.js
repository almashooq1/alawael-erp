// backend/api/routes/beneficiary/index.js\n\n/**\n * مسارات API نظام إدارة المستفيدين\n * Beneficiary Management System API Routes\n */\n\nconst express = require('express');\nconst router = express.Router();\nconst BeneficiaryService = require('../../services/BeneficiaryManagement/BeneficiaryService');\nconst AcademicService = require('../../services/BeneficiaryManagement/AcademicService');\nconst GradeService = require('../../services/BeneficiaryManagement/GradeService');\n\n// Middleware للمصادقة\nconst authenticate = (req, res, next) => {\n  // التحقق من JWT token\n  const token = req.headers.authorization?.split(' ')[1];\n  if (!token) return res.status(401).json({ status: 'error', message: 'Unauthorized' });\n  next();\n};\n\n// Initialize Services\nlet beneficiaryService;\nlet academicService;\nlet gradeService;\n\n// Middleware لتهيئة الخدمات\nrouter.use((req, res, next) => {\n  if (!beneficiaryService && req.app.locals.db) {\n    beneficiaryService = new BeneficiaryService(req.app.locals.db);\n    academicService = new AcademicService(req.app.locals.db);\n    gradeService = new GradeService(req.app.locals.db);\n  }\n  next();\n});\n\n/**\n * ============================================\n * BENEFICIARY MANAGEMENT ROUTES\n * ============================================\n */\n\n/**\n * GET / - Health Check\n * فحص صحة النظام\n */\nrouter.get('/health', authenticate, (req, res) => {\n  res.json({\n    status: 'success',\n    message: 'Beneficiary Management System is operational',\n    timestamp: new Date(),\n    modules: {\n      beneficiary: 'active',\n      academic: 'active',\n      grades: 'active',\n      attendance: 'active',\n      scholarships: 'active',\n      achievements: 'active',\n      support: 'active',\n      analytics: 'active'\n    }\n  });\n});\n\n/**\n * POST /create - Create New Beneficiary\n * إنشاء مستفيد جديد\n */\nrouter.post('/create', authenticate, async (req, res) => {\n  try {\n    const beneficiaryData = req.body;\n    \n    // Validation\n    if (!beneficiaryData.personalData?.firstName) {\n      return res.status(400).json({\n        status: 'error',\n        message: 'First name is required | الاسم الأول مطلوب'\n      });\n    }\n    \n    const beneficiaryId = await beneficiaryService.createBeneficiary(beneficiaryData);\n    \n    res.status(201).json({\n      status: 'success',\n      message: 'Beneficiary created successfully',\n      data: { beneficiaryId },\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /:id - Get Beneficiary Profile\n * الحصول على ملف المستفيد الكامل\n */\nrouter.get('/:id', authenticate, async (req, res) => {\n  try {\n    const profile = await beneficiaryService.getBeneficiaryProfile(req.params.id);\n    \n    res.json({\n      status: 'success',\n      message: 'Beneficiary profile retrieved successfully',\n      data: profile,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(404).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * PUT /:id - Update Beneficiary\n * تحديث بيانات المستفيد\n */\nrouter.put('/:id', authenticate, async (req, res) => {\n  try {\n    const result = await beneficiaryService.updateBeneficiary(req.params.id, req.body);\n    \n    res.json({\n      status: 'success',\n      message: 'Beneficiary updated successfully',\n      data: result,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(400).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * POST /search - Search Beneficiaries\n * البحث عن المستفيدين\n */\nrouter.post('/search', authenticate, async (req, res) => {\n  try {\n    const filters = req.body;\n    const results = await beneficiaryService.searchBeneficiaries(filters);\n    \n    res.json({\n      status: 'success',\n      message: 'Search completed successfully',\n      data: results,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /:id/status - Evaluate Beneficiary Status\n * تقييم حالة المستفيد الأكاديمية\n */\nrouter.get('/:id/status', authenticate, async (req, res) => {\n  try {\n    const status = await beneficiaryService.evaluateBeneficiaryStatus(req.params.id);\n    \n    res.json({\n      status: 'success',\n      message: 'Status evaluation completed',\n      data: status,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * POST /:id/report - Generate Report\n * استخراج التقارير الشاملة\n */\nrouter.post('/:id/report', authenticate, async (req, res) => {\n  try {\n    const { reportType = 'comprehensive' } = req.body;\n    const report = await beneficiaryService.generateBeneficiaryReport(req.params.id, reportType);\n    \n    res.json({\n      status: 'success',\n      message: 'Report generated successfully',\n      data: report,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * ============================================\n * ACADEMIC ROUTES\n * ============================================\n */\n\n/**\n * POST /academic/enroll - Enroll in Program\n * تسجيل البرنامج الدراسي\n */\nrouter.post('/academic/enroll', authenticate, async (req, res) => {\n  try {\n    const { beneficiaryId, programId } = req.body;\n    \n    if (!beneficiaryId || !programId) {\n      return res.status(400).json({\n        status: 'error',\n        message: 'beneficiaryId and programId are required'\n      });\n    }\n    \n    const enrollmentId = await academicService.enrollInProgram(beneficiaryId, programId);\n    \n    res.status(201).json({\n      status: 'success',\n      message: 'Enrollment successful',\n      data: { enrollmentId },\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(400).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * POST /academic/courses - Manage Courses\n * إدارة المقررات الدراسية\n */\nrouter.post('/academic/courses', authenticate, async (req, res) => {\n  try {\n    const { enrollmentId, courses } = req.body;\n    \n    const result = await academicService.manageProgramCourses(enrollmentId, courses);\n    \n    res.json({\n      status: 'success',\n      message: 'Courses managed successfully',\n      data: result,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(400).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /academic/:beneficiaryId/progress - Track Progress\n * تتبع التقدم الأكاديمي\n */\nrouter.get('/academic/:beneficiaryId/progress', authenticate, async (req, res) => {\n  try {\n    const progress = await academicService.trackAcademicProgress(req.params.beneficiaryId);\n    \n    res.json({\n      status: 'success',\n      message: 'Progress tracked successfully',\n      data: progress,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /academic/:beneficiaryId/advice - Academic Advice\n * الاستشارة الأكاديمية\n */\nrouter.get('/academic/:beneficiaryId/advice', authenticate, async (req, res) => {\n  try {\n    const advice = await academicService.provideAcademicAdvice(req.params.beneficiaryId);\n    \n    res.json({\n      status: 'success',\n      message: 'Academic advice provided',\n      data: advice,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * ============================================\n * GRADE ROUTES\n * ============================================\n */\n\n/**\n * POST /grades/record - Record Grade\n * تسجيل الدرجات\n */\nrouter.post('/grades/record', authenticate, async (req, res) => {\n  try {\n    const { enrollmentId, courseId, gradeData } = req.body;\n    \n    const gradeId = await gradeService.recordGrade(enrollmentId, courseId, gradeData);\n    \n    res.status(201).json({\n      status: 'success',\n      message: 'Grade recorded successfully',\n      data: { gradeId },\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(400).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /grades/:beneficiaryId/gpa - Calculate GPA\n * حساب المعدل التراكمي\n */\nrouter.get('/grades/:beneficiaryId/gpa', authenticate, async (req, res) => {\n  try {\n    const { period = 'cumulative' } = req.query;\n    const gpaInfo = await gradeService.calculateGPA(req.params.beneficiaryId, period);\n    \n    res.json({\n      status: 'success',\n      message: 'GPA calculated successfully',\n      data: gpaInfo,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /grades/:beneficiaryId/transcript - Generate Transcript\n * إصدار النسخة الأكاديمية\n */\nrouter.get('/grades/:beneficiaryId/transcript', authenticate, async (req, res) => {\n  try {\n    const transcript = await gradeService.generateTranscript(req.params.beneficiaryId);\n    \n    res.json({\n      status: 'success',\n      message: 'Transcript generated successfully',\n      data: transcript,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * GET /grades/:beneficiaryId/analysis - Analyze Pattern\n * تحليل النمط الأكاديمي\n */\nrouter.get('/grades/:beneficiaryId/analysis', authenticate, async (req, res) => {\n  try {\n    const analysis = await gradeService.analyzeAcademicPattern(req.params.beneficiaryId);\n    \n    res.json({\n      status: 'success',\n      message: 'Academic pattern analyzed',\n      data: analysis,\n      timestamp: new Date()\n    });\n    \n  } catch (error) {\n    res.status(500).json({\n      status: 'error',\n      message: error.message,\n      timestamp: new Date()\n    });\n  }\n});\n\n/**\n * Statistics & Analytics\n */\nrouter.get('/statistics/overview', authenticate, (req, res) => {\n  res.json({\n    status: 'success',\n    message: 'System statistics retrieved',\n    data: {\n      totalBeneficiaries: 0,\n      activeEnrollments: 0,\n      averageGPA: 0,\n      attendanceRate: 0,\n      scholarshipRecipients: 0,\n      academicAlerts: 0\n    },\n    timestamp: new Date()\n  });\n});\n\nmodule.exports = router;\n
