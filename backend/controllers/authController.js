/**
 * Authentication Controller
 * Handles user authentication and session management
 * Maps requests to AuthService methods
 */

const AuthService = require('../services/authService');\n\nclass AuthController {\n  constructor() {\n    this.authService = new AuthService();\n  }\n\n  /**\n   * Register a new user\n   * POST /api/v1/auth/register\n   */\n  async register(req, res, next) {\n    try {\n      const { username, email, password } = req.body;\n\n      // Validation\n      if (!username || !email || !password) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Username, email, and password are required',\n          code: 'MISSING_FIELDS'\n        });\n      }\n\n      // Validate email format\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      if (!emailRegex.test(email)) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Invalid email format',\n          code: 'INVALID_EMAIL'\n        });\n      }\n\n      // Validate password strength\n      if (password.length < 8) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Password must be at least 8 characters long',\n          code: 'WEAK_PASSWORD'\n        });\n      }\n\n      const user = this.authService.registerUser({\n        username,\n        email,\n        password\n      });\n\n      res.status(201).json({\n        success: true,\n        data: user\n      });\n    } catch (error) {\n      if (error.message.includes('already exists')) {\n        return res.status(409).json({\n          error: 'conflict',\n          message: error.message,\n          code: 'USER_EXISTS'\n        });\n      }\n      next(error);\n    }\n  }\n\n  /**\n   * Login user\n   * POST /api/v1/auth/login\n   */\n  async login(req, res, next) {\n    try {\n      const { username, password } = req.body;\n\n      if (!username || !password) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Username and password are required',\n          code: 'MISSING_CREDENTIALS'\n        });\n      }\n\n      const result = this.authService.authenticateUser(username, password);\n\n      if (!result.success) {\n        return res.status(401).json({\n          error: 'authentication_failed',\n          message: result.error,\n          code: 'INVALID_CREDENTIALS'\n        });\n      }\n\n      res.json({\n        success: true,\n        data: {\n          sessionId: result.sessionId,\n          accessToken: result.accessToken,\n          refreshToken: result.refreshToken,\n          expiresIn: 3600\n        }\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Verify token\n   * GET /api/v1/auth/verify\n   */\n  async verifyToken(req, res, next) {\n    try {\n      const token = req.headers.authorization?.split(' ')[1];\n\n      if (!token) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: 'No token provided',\n          code: 'MISSING_TOKEN'\n        });\n      }\n\n      const result = this.authService.verifyToken(token);\n\n      if (!result.valid) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: 'Invalid token',\n          code: 'INVALID_TOKEN'\n        });\n      }\n\n      res.json({\n        success: true,\n        data: {\n          valid: true,\n          userId: result.userId,\n          username: result.username\n        }\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Refresh access token\n   * POST /api/v1/auth/refresh\n   */\n  async refreshToken(req, res, next) {\n    try {\n      const { refreshToken } = req.body;\n\n      if (!refreshToken) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Refresh token is required',\n          code: 'MISSING_TOKEN'\n        });\n      }\n\n      const result = this.authService.refreshAccessToken(refreshToken);\n\n      res.json({\n        success: true,\n        data: {\n          accessToken: result.accessToken,\n          refreshToken: result.refreshToken,\n          expiresIn: 3600\n        }\n      });\n    } catch (error) {\n      if (error.message.includes('Invalid')) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: error.message,\n          code: 'INVALID_REFRESH_TOKEN'\n        });\n      }\n      next(error);\n    }\n  }\n\n  /**\n   * Logout user\n   * POST /api/v1/auth/logout\n   */\n  async logout(req, res, next) {\n    try {\n      const { sessionId } = req.body;\n\n      if (!sessionId) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Session ID is required',\n          code: 'MISSING_SESSION_ID'\n        });\n      }\n\n      this.authService.logoutUser(sessionId);\n\n      res.json({\n        success: true,\n        message: 'Logged out successfully'\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Enable 2FA\n   * POST /api/v1/auth/2fa/setup\n   */\n  async enableTwoFactor(req, res, next) {\n    try {\n      const userId = req.user?.id;\n\n      if (!userId) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: 'User not authenticated',\n          code: 'NOT_AUTHENTICATED'\n        });\n      }\n\n      const result = this.authService.enableTwoFactor(userId);\n\n      res.json({\n        success: true,\n        data: {\n          secret: result.secret,\n          qrCode: result.qrCode,\n          backupCodes: result.backupCodes\n        }\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Verify 2FA code\n   * POST /api/v1/auth/2fa/verify\n   */\n  async verifyTwoFactor(req, res, next) {\n    try {\n      const userId = req.user?.id;\n      const { code } = req.body;\n\n      if (!userId) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: 'User not authenticated',\n          code: 'NOT_AUTHENTICATED'\n        });\n      }\n\n      if (!code) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: '2FA code is required',\n          code: 'MISSING_CODE'\n        });\n      }\n\n      const result = this.authService.verifyTwoFactor(userId, code);\n\n      res.json({\n        success: true,\n        data: {\n          verified: result.verified\n        }\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Reset password\n   * POST /api/v1/auth/password/reset\n   */\n  async resetPassword(req, res, next) {\n    try {\n      const { email } = req.body;\n\n      if (!email) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Email is required',\n          code: 'MISSING_EMAIL'\n        });\n      }\n\n      const result = this.authService.resetPassword(email);\n\n      res.json({\n        success: true,\n        message: 'Password reset email sent',\n        resetToken: result.token // Would be sent via email in production\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Update password\n   * POST /api/v1/auth/password/update\n   */\n  async updatePassword(req, res, next) {\n    try {\n      const userId = req.user?.id;\n      const { currentPassword, newPassword } = req.body;\n\n      if (!userId) {\n        return res.status(401).json({\n          error: 'unauthorized',\n          message: 'User not authenticated',\n          code: 'NOT_AUTHENTICATED'\n        });\n      }\n\n      if (!currentPassword || !newPassword) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Current and new password are required',\n          code: 'MISSING_PASSWORDS'\n        });\n      }\n\n      const result = this.authService.updatePassword(\n        userId,\n        currentPassword,\n        newPassword\n      );\n\n      res.json({\n        success: true,\n        message: 'Password updated successfully'\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n}\n\nmodule.exports = AuthController;\n