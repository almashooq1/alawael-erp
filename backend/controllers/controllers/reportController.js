/**\n * Report Controller\n * Handles HTTP requests for report operations\n * Maps requests to ReportService methods\n */\n\nconst ReportService = require('../services/reportService');\n\nclass ReportController {\n  constructor() {\n    this.reportService = new ReportService();\n  }\n\n  /**\n   * Create a new report\n   * POST /api/v1/reports\n   */\n  async createReport(req, res, next) {\n    try {\n      const { name, type, format, filters, columns, sortBy } = req.body;\n\n      // Validation\n      if (!name || !type) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Report name and type are required',\n          code: 'MISSING_FIELDS'\n        });\n      }\n\n      const report = this.reportService.createReport(req.user.id, {\n        name,\n        type,\n        format: format || 'pdf',\n        filters: filters || {},\n        columns: columns || [],\n        sortBy: sortBy || {}\n      });\n\n      res.status(201).json({\n        success: true,\n        data: report\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Get report by ID\n   * GET /api/v1/reports/:id\n   */\n  async getReport(req, res, next) {\n    try {\n      const { id } = req.params;\n\n      const report = this.reportService.getReport(id);\n\n      res.json({\n        success: true,\n        data: report\n      });\n    } catch (error) {\n      if (error.message.includes('not found')) {\n        return res.status(404).json({\n          error: 'not_found',\n          message: error.message,\n          code: 'REPORT_NOT_FOUND'\n        });\n      }\n      next(error);\n    }\n  }\n\n  /**\n   * List user's reports\n   * GET /api/v1/reports\n   */\n  async listReports(req, res, next) {\n    try {\n      const { type, limit = 10, offset = 0 } = req.query;\n\n      const filters = {};\n      if (type) {\n        filters.type = type;\n      }\n\n      const reports = this.reportService.listReports(req.user.id, filters);\n\n      const paginated = reports.slice(\n        parseInt(offset),\n        parseInt(offset) + parseInt(limit)\n      );\n\n      res.json({\n        success: true,\n        data: paginated,\n        total: reports.length,\n        limit: parseInt(limit),\n        offset: parseInt(offset)\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Generate report\n   * POST /api/v1/reports/:id/generate\n   */\n  async generateReport(req, res, next) {\n    try {\n      const { id } = req.params;\n      const { dataSource } = req.body;\n\n      // Simulate data source (would come from database)\n      const sampleData = this._getSampleData();\n\n      const result = this.reportService.generateReport(id, sampleData);\n\n      res.json({\n        success: true,\n        data: result,\n        message: 'Report generated successfully'\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Schedule report\n   * POST /api/v1/reports/:id/schedule\n   */\n  async scheduleReport(req, res, next) {\n    try {\n      const { id } = req.params;\n      const { frequency, dayOfMonth, time, recipients, emailSubject } = req.body;\n\n      if (!frequency || !recipients) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Frequency and recipients are required',\n          code: 'MISSING_SCHEDULE_FIELDS'\n        });\n      }\n\n      const schedule = this.reportService.scheduleReport(id, {\n        frequency,\n        dayOfMonth,\n        time: time || '09:00',\n        recipients,\n        emailSubject: emailSubject || `Scheduled Report`\n      });\n\n      res.status(201).json({\n        success: true,\n        data: schedule\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Update report\n   * PUT /api/v1/reports/:id\n   */\n  async updateReport(req, res, next) {\n    try {\n      const { id } = req.params;\n      const updates = req.body;\n\n      const updated = this.reportService.updateReport(id, {\n        ...updates,\n        updatedAt: new Date()\n      });\n\n      res.json({\n        success: true,\n        data: updated\n      });\n    } catch (error) {\n      if (error.message.includes('not found')) {\n        return res.status(404).json({\n          error: 'not_found',\n          message: error.message,\n          code: 'REPORT_NOT_FOUND'\n        });\n      }\n      next(error);\n    }\n  }\n\n  /**\n   * Delete report\n   * DELETE /api/v1/reports/:id\n   */\n  async deleteReport(req, res, next) {\n    try {\n      const { id } = req.params;\n\n      this.reportService.deleteReport(id);\n\n      res.status(204).send();\n    } catch (error) {\n      if (error.message.includes('not found')) {\n        return res.status(404).json({\n          error: 'not_found',\n          message: error.message,\n          code: 'REPORT_NOT_FOUND'\n        });\n      }\n      next(error);\n    }\n  }\n\n  /**\n   * Get report templates\n   * GET /api/v1/reports/templates\n   */\n  async getTemplates(req, res, next) {\n    try {\n      const templates = this.reportService.getTemplates();\n\n      res.json({\n        success: true,\n        data: templates\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Export report\n   * GET /api/v1/reports/:id/export?format=excel\n   */\n  async exportReport(req, res, next) {\n    try {\n      const { id } = req.params;\n      const { format = 'pdf' } = req.query;\n\n      if (!['csv', 'excel', 'pdf', 'json'].includes(format)) {\n        return res.status(400).json({\n          error: 'validation_error',\n          message: 'Invalid export format',\n          code: 'INVALID_FORMAT'\n        });\n      }\n\n      const result = this.reportService.exportReport(id, format);\n\n      // Set appropriate content type\n      const contentTypes = {\n        csv: 'text/csv',\n        excel: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        pdf: 'application/pdf',\n        json: 'application/json'\n      };\n\n      res.setHeader('Content-Type', contentTypes[format]);\n      res.setHeader('Content-Disposition', `attachment; filename=\"report.${format}\"`);\n\n      res.json({\n        success: true,\n        data: result,\n        format\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  /**\n   * Helper: Get sample data for report generation\n   */\n  _getSampleData() {\n    return [\n      { product: 'Product A', quantity: 100, revenue: 10000, region: 'US', date: '2026-02-18' },\n      { product: 'Product B', quantity: 150, revenue: 22500, region: 'EU', date: '2026-02-18' },\n      { product: 'Product C', quantity: 75, revenue: 11250, region: 'ASIA', date: '2026-02-18' },\n      { product: 'Product D', quantity: 200, revenue: 40000, region: 'US', date: '2026-02-17' },\n      { product: 'Product A', quantity: 120, revenue: 12000, region: 'EU', date: '2026-02-17' }\n    ];\n  }\n}\n\nmodule.exports = ReportController;\n