// backend/services/BeneficiaryManagement/AcademicService.js\n\n/**\n * خدمة إدارة البيانات الأكاديمية\n * Academic Management Service\n */\n\nconst mongoose = require('mongoose');\n\nclass AcademicService {\n  \n  constructor(db) {\n    this.db = db;\n  }\n\n  /**\n   * تسجيل البرنامج الدراسي\n   */\n  async enrollInProgram(beneficiaryId, programId) {\n    try {\n      const beneficiaryObjectId = new mongoose.Types.ObjectId(beneficiaryId);\n      const programObjectId = new mongoose.Types.ObjectId(programId);\n      \n      // التحقق من the program\n      const program = await this.db.collection('programs').findOne({ _id: programObjectId });\n      if (!program) throw new Error('Program not found');\n      \n      // التحقق من الشروط المسبقة\n      const beneficiary = await this.db.collection('beneficiaries').findOne({ _id: beneficiaryObjectId });\n      if (!beneficiary) throw new Error('Beneficiary not found');\n      \n      // إنشاء تسجيل جديد\n      const enrollment = {\n        beneficiaryId: beneficiaryObjectId,\n        programId: programObjectId,\n        enrollmentDate: new Date(),\n        status: 'active',\n        currentYear: 1,\n        semesters: [\n          { number: 1, year: 1, status: 'current', courses: [] },\n          { number: 2, year: 1, status: 'upcoming', courses: [] }\n        ],\n        advisorId: program.defaultAdvisor || null,\n        expectedGraduationDate: this.calculateGraduationDate(1, program.durationYears),\n        specialization: null,\n        createdAt: new Date(),\n        updatedAt: new Date()\n      };\n      \n      // حفظ التسجيل\n      const result = await this.db.collection('enrollments').insertOne(enrollment);\n      \n      // تحديث بيانات المستفيد\n      await this.db.collection('beneficiaries').updateOne(\n        { _id: beneficiaryObjectId },\n        {\n          $set: {\n            'academicInfo.currentProgram': programObjectId,\n            'academicInfo.yearOfEntry': new Date().getFullYear(),\n            'academicInfo.status': 'active'\n          }\n        }\n      );\n      \n      return result.insertedId;\n      \n    } catch (error) {\n      throw new Error(`Enrollment failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * إدارة البرامج الدراسية\n   */\n  async manageProgramCourses(enrollmentId, courses = []) {\n    try {\n      const enrollmentObjectId = new mongoose.Types.ObjectId(enrollmentId);\n      \n      // جلب التسجيل\n      const enrollment = await this.db.collection('enrollments').findOne({\n        _id: enrollmentObjectId\n      });\n      \n      if (!enrollment) throw new Error('Enrollment not found');\n      \n      // الحصول على المقررات المطلوبة والاختيارية\n      const program = await this.db.collection('programs').findOne({\n        _id: enrollment.programId\n      });\n      \n      const requiredCourses = program.requiredCourses || [];\n      const electiveCourses = program.electiveCourses || [];\n      \n      // التحقق من تضارب المقررات\n      const conflictingCourses = this.checkCourseConflicts(courses);\n      \n      // تحديث المقررات في التسجيل\n      const currentSemester = enrollment.semesters.find(s => s.status === 'current');\n      \n      // حساب عدد الساعات\n      let totalCredits = 0;\n      const selectedCourses = courses.map(courseId => {\n        const course = requiredCourses.find(c => c._id.toString() === courseId)\n                    || electiveCourses.find(c => c._id.toString() === courseId);\n        if (course) {\n          totalCredits += course.credits;\n        }\n        return courseId;\n      });\n      \n      // تحديث في قاعدة البيانات\n      await this.db.collection('enrollments').updateOne(\n        { _id: enrollmentObjectId },\n        {\n          $set: {\n            'semesters.courses': selectedCourses,\n            'semesters.totalCredits': totalCredits,\n            updatedAt: new Date()\n          }\n        }\n      );\n      \n      return {\n        enrollmentId,\n        selectedCourses,\n        totalCredits,\n        conflictingCourses,\n        warnings: conflictingCourses.length > 0 ? 'Some courses have conflicts' : null\n      };\n      \n    } catch (error) {\n      throw new Error(`Course management failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * تتبع التقدم الأكاديمي\n   */\n  async trackAcademicProgress(beneficiaryId) {\n    try {\n      const beneficiaryObjectId = new mongoose.Types.ObjectId(beneficiaryId);\n      \n      // جلب التسجيل\n      const enrollment = await this.db.collection('enrollments').findOne({\n        beneficiaryId: beneficiaryObjectId\n      });\n      \n      if (!enrollment) throw new Error('No enrollment found');\n      \n      // جلب الدرجات\n      const grades = await this.db.collection('grades').find({\n        beneficiaryId: beneficiaryObjectId\n      }).toArray();\n      \n      // GET PROGRAM INFO\n      const program = await this.db.collection('programs').findOne({\n        _id: enrollment.programId\n      });\n      \n      // حساب المتقدمات\n      const completedCourses = grades.filter(g => g.status === 'completed').length;\n      const totalRequired = program.requiredCourses.length;\n      const completionPercentage = Math.round((completedCourses / totalRequired) * 100);\n      \n      // حساب الساعات\n      const completedCredits = grades\n        .filter(g => g.status === 'completed')\n        .reduce((sum, g) => sum + g.credits, 0);\n      \n      // تاريخ التخرج المتوقع\n      const yearsRemaining = Math.ceil(\n        (program.totalCreditsRequired - completedCredits) / program.creditsPerYear\n      );\n      const expectedGraduationDate = new Date();\n      expectedGraduationDate.setFullYear(expectedGraduationDate.getFullYear() + yearsRemaining);\n      \n      return {\n        beneficiaryId,\n        currentYear: enrollment.currentYear,\n        completedCourses,\n        totalRequired,\n        completionPercentage,\n        completedCredits,\n        totalCreditsRequired: program.totalCreditsRequired,\n        expectedGraduationDate,\n        yearsRemaining,\n        status: 'on_track'\n      };\n      \n    } catch (error) {\n      throw new Error(`Progress tracking failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * الاستشارة الأكاديمية\n   */\n  async provideAcademicAdvice(beneficiaryId) {\n    try {\n      const beneficiaryObjectId = new mongoose.Types.ObjectId(beneficiaryId);\n      \n      const beneficiary = await this.db.collection('beneficiaries').findOne({\n        _id: beneficiaryObjectId\n      });\n      \n      const advice = {\n        beneficiaryId,\n        generatedAt: new Date(),\n        recommendations: [],\n        strengths: [],\n        weaknesses: [],\n        actions: []\n      };\n      \n      // تحليل نقاط الضعف\n      const grades = await this.db.collection('grades').find({\n        beneficiaryId: beneficiaryObjectId\n      }).toArray();\n      \n      const weakCourses = grades.filter(g => g.grade < 2.0);\n      const strongCourses = grades.filter(g => g.grade >= 3.5);\n      \n      if (weakCourses.length > 0) {\n        advice.weaknesses.push(`Struggling with: ${weakCourses.map(c => c.courseName).join(', ')}`);\n        advice.recommendations.push('Consider enrolling in tutoring sessions');\n        advice.recommendations.push('Form study groups with peers');\n        advice.actions.push('Schedule meeting with advisor');\n      }\n      \n      if (strongCourses.length > 0) {\n        advice.strengths.push(`Excelling in: ${strongCourses.map(c => c.courseName).join(', ')}`);\n        advice.recommendations.push('Consider advanced courses in strong areas');\n      }\n      \n      // توصيات الدراسة\n      if (beneficiary.performanceMetrics.cumulativeGPA < 2.5) {\n        advice.actions.push('Mandatory academic counseling');\n        advice.actions.push('Possible course load reduction');\n      }\n      \n      return advice;\n      \n    } catch (error) {\n      throw new Error(`Academic advice generation failed: ${error.message}`);\n    }\n  }\n\n  // Helper Methods\n  checkCourseConflicts(courses) {\n    const conflicts = [];\n    // Logic to check for timetable conflicts\n    return conflicts;\n  }\n\n  calculateGraduationDate(currentYear, durationYears) {\n    const date = new Date();\n    date.setFullYear(date.getFullYear() + (durationYears - currentYear));\n    return date;\n  }\n}\n\nmodule.exports = AcademicService;\n
