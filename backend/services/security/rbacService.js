/**\n * RBAC Service - Role-Based Access Control\n * Manages roles, permissions, and access control\n */\n\nconst crypto = require('crypto');\n\nclass RBACService {\n  constructor() {\n    this.roles = new Map();\n    this.permissions = new Map();\n    this.userRoles = new Map(); // userId -> [roleIds]\n    this.rolePermissions = new Map(); // roleId -> [permissionIds]\n    this._initializeDefaultRoles();\n  }\n\n  /**\n   * Create role\n   * @param {Object} roleData - Role data\n   * @returns {Object} Created role\n   */\n  createRole(roleData) {\n    const roleId = crypto.randomUUID();\n    const role = {\n      id: roleId,\n      name: roleData.name,\n      description: roleData.description || '',\n      permissions: roleData.permissions || [],\n      isSystem: roleData.isSystem || false,\n      created_at: new Date(),\n      updated_at: new Date()\n    };\n\n    this.roles.set(roleId, role);\n    this.rolePermissions.set(roleId, roleData.permissions || []);\n\n    return role;\n  }\n\n  /**\n   * Get role by ID\n   * @param {string} roleId - Role ID\n   * @returns {Object} Role\n   */\n  getRole(roleId) {\n    const role = this.roles.get(roleId);\n    if (!role) throw new Error(`Role ${roleId} not found`);\n    return role;\n  }\n\n  /**\n   * List all roles\n   * @returns {Array} List of roles\n   */\n  listRoles() {\n    return Array.from(this.roles.values());\n  }\n\n  /**\n   * Update role\n   * @param {string} roleId - Role ID\n   * @param {Object} updates - Update data\n   * @returns {Object} Updated role\n   */\n  updateRole(roleId, updates) {\n    const role = this.getRole(roleId);\n    Object.assign(role, updates, { updated_at: new Date() });\n    return role;\n  }\n\n  /**\n   * Delete role\n   * @param {string} roleId - Role ID\n   * @returns {boolean} Success\n   */\n  deleteRole(roleId) {\n    return this.roles.delete(roleId);\n  }\n\n  /**\n   * Create permission\n   * @param {Object} permissionData - Permission data\n   * @returns {Object} Created permission\n   */\n  createPermission(permissionData) {\n    const permissionId = crypto.randomUUID();\n    const permission = {\n      id: permissionId,\n      key: permissionData.key,\n      name: permissionData.name,\n      description: permissionData.description || '',\n      category: permissionData.category || 'general',\n      created_at: new Date()\n    };\n\n    this.permissions.set(permissionId, permission);\n    return permission;\n  }\n\n  /**\n   * Assign role to user\n   * @param {string} userId - User ID\n   * @param {string} roleId - Role ID\n   * @returns {Object} Assignment result\n   */\n  assignRoleToUser(userId, roleId) {\n    if (!this.roles.has(roleId)) {\n      throw new Error(`Role ${roleId} not found`);\n    }\n\n    if (!this.userRoles.has(userId)) {\n      this.userRoles.set(userId, []);\n    }\n\n    const userRolesList = this.userRoles.get(userId);\n    if (!userRolesList.includes(roleId)) {\n      userRolesList.push(roleId);\n    }\n\n    return {\n      userId,\n      roleId,\n      assigned: true\n    };\n  }\n\n  /**\n   * Revoke role from user\n   * @param {string} userId - User ID\n   * @param {string} roleId - Role ID\n   * @returns {Object} Revocation result\n   */\n  revokeRoleFromUser(userId, roleId) {\n    const userRolesList = this.userRoles.get(userId);\n    if (!userRolesList) return { success: false };\n\n    const index = userRolesList.indexOf(roleId);\n    if (index > -1) {\n      userRolesList.splice(index, 1);\n      return { success: true };\n    }\n    return { success: false };\n  }\n\n  /**\n   * Get user roles\n   * @param {string} userId - User ID\n   * @returns {Array} User roles\n   */\n  getUserRoles(userId) {\n    const roleIds = this.userRoles.get(userId) || [];\n    return roleIds.map(roleId => this.roles.get(roleId)).filter(Boolean);\n  }\n\n  /**\n   * Get user permissions\n   * @param {string} userId - User ID\n   * @returns {Array} User permissions\n   */\n  getUserPermissions(userId) {\n    const roleIds = this.userRoles.get(userId) || [];\n    const permissionIds = new Set();\n\n    roleIds.forEach(roleId => {\n      const perms = this.rolePermissions.get(roleId) || [];\n      perms.forEach(p => permissionIds.add(p));\n    });\n\n    return Array.from(permissionIds).map(pId => this.permissions.get(pId)).filter(Boolean);\n  }\n\n  /**\n   * Check if user has permission\n   * @param {string} userId - User ID\n   * @param {string} permissionKey - Permission key\n   * @returns {boolean} Has permission\n   */\n  hasPermission(userId, permissionKey) {\n    const userPermissions = this.getUserPermissions(userId);\n    return userPermissions.some(p => p.key === permissionKey);\n  }\n\n  /**\n   * Check if user has any of permissions\n   * @param {string} userId - User ID\n   * @param {Array} permissionKeys - Permission keys\n   * @returns {boolean} Has any permission\n   */\n  hasAnyPermission(userId, permissionKeys) {\n    return permissionKeys.some(key => this.hasPermission(userId, key));\n  }\n\n  /**\n   * Check if user has all permissions\n   * @param {string} userId - User ID\n   * @param {Array} permissionKeys - Permission keys\n   * @returns {boolean} Has all permissions\n   */\n  hasAllPermissions(userId, permissionKeys) {\n    return permissionKeys.every(key => this.hasPermission(userId, key));\n  }\n\n  /**\n   * Add permission to role\n   * @param {string} roleId - Role ID\n   * @param {string} permissionId - Permission ID\n   * @returns {boolean} Success\n   */\n  addPermissionToRole(roleId, permissionId) {\n    const perms = this.rolePermissions.get(roleId);\n    if (!perms) return false;\n\n    if (!perms.includes(permissionId)) {\n      perms.push(permissionId);\n    }\n    return true;\n  }\n\n  /**\n   * Remove permission from role\n   * @param {string} roleId - Role ID\n   * @param {string} permissionId - Permission ID\n   * @returns {boolean} Success\n   */\n  removePermissionFromRole(roleId, permissionId) {\n    const perms = this.rolePermissions.get(roleId);\n    if (!perms) return false;\n\n    const index = perms.indexOf(permissionId);\n    if (index > -1) {\n      perms.splice(index, 1);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Get role permissions\n   * @param {string} roleId - Role ID\n   * @returns {Array} Role permissions\n   */\n  getRolePermissions(roleId) {\n    const permIds = this.rolePermissions.get(roleId) || [];\n    return permIds.map(pId => this.permissions.get(pId)).filter(Boolean);\n  }\n\n  /**\n   * Check resource access (ABAC)\n   * @param {string} userId - User ID\n   * @param {string} action - Action (read, write, delete)\n   * @param {Object} resource - Resource object\n   * @returns {boolean} Has access\n   */\n  checkResourceAccess(userId, action, resource) {\n    const userRoles = this.getUserRoles(userId);\n    const requiredPermission = `${resource.type}:${action}`;\n\n    // Check if user has permission via roles\n    for (const role of userRoles) {\n      const rolePerms = this.getRolePermissions(role.id);\n      if (rolePerms.some(p => p.key === requiredPermission)) {\n        // Check resource-level access\n        if (resource.owner === userId || resource.isPublic) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Initialize default roles\n   * @private\n   */\n  _initializeDefaultRoles() {\n    const adminRole = this.createRole({\n      name: 'Administrator',\n      description: 'Full system access',\n      isSystem: true,\n      permissions: ['*'] // All permissions\n    });\n\n    const managerRole = this.createRole({\n      name: 'Manager',\n      description: 'Management access',\n      isSystem: true,\n      permissions: ['read', 'create', 'update', 'approve']\n    });\n\n    const employeeRole = this.createRole({\n      name: 'Employee',\n      description: 'Regular employee access',\n      isSystem: true,\n      permissions: ['read:own', 'create:own']\n    });\n\n    const viewerRole = this.createRole({\n      name: 'Viewer',\n      description: 'Read-only access',\n      isSystem: true,\n      permissions: ['read']\n    });\n  }\n}\n\nmodule.exports = new RBACService();\n