/**\n * Accessibility Service\n * فئة إدارة ميزات إمكانية الوصول\n * \n * Features:\n * - Theme Management (Light, Dark, High Contrast)\n * - Font Customization\n * - Text-to-Speech\n * - Multi-Language Support\n * - ARIA Labels Management\n * - Keyboard Navigation\n */\n\nclass AccessibilityService {\n  constructor() {\n    this.userPreferences = this.loadPreferences();\n    this.currentTheme = 'light';\n    this.currentLanguage = 'en';\n    this.isTextToSpeechActive = false;\n    this.speakingRate = 1.0;\n    this.supportedLanguages = ['ar', 'en', 'fr', 'es', 'de'];\n    \n    // Theme definitions\n    this.themes = {\n      light: {\n        name: 'Light Theme',\n        colors: {\n          background: '#FFFFFF',\n          text: '#333333',\n          primary: '#0066CC',\n          secondary: '#666666',\n          contrast: '4.5:1'\n        }\n      },\n      dark: {\n        name: 'Dark Theme',\n        colors: {\n          background: '#1A1A1A',\n          text: '#FFFFFF',\n          primary: '#66B3FF',\n          secondary: '#CCCCCC',\n          contrast: '4.5:1'\n        }\n      },\n      highContrastDark: {\n        name: 'High Contrast Dark',\n        colors: {\n          background: '#000000',\n          text: '#FFFF00',\n          primary: '#00FF00',\n          secondary: '#00FFFF',\n          contrast: '19.56:1'\n        }\n      },\n      highContrastLight: {\n        name: 'High Contrast Light',\n        colors: {\n          background: '#FFFFFF',\n          text: '#000000',\n          primary: '#0000FF',\n          secondary: '#FF0000',\n          contrast: '21.0:1'\n        }\n      },\n      yellowOnBlack: {\n        name: 'Yellow on Black (Dyslexia)',\n        colors: {\n          background: '#000000',\n          text: '#FFFF00',\n          primary: '#66FF66',\n          secondary: '#FFFF99',\n          contrast: '19.56:1'\n        }\n      }\n    };\n\n    // Font definitions\n    this.fonts = {\n      standard: { name: 'Inter', family: 'Inter, sans-serif' },\n      dyslexia: { name: 'OpenDyslexic', family: 'OpenDyslexic, sans-serif' },\n      serif: { name: 'Georgia', family: 'Georgia, serif' },\n      sans: { name: 'Arial', family: 'Arial, sans-serif' }\n    };\n\n    this.initialize();\n  }\n\n  /**\n   * Initialize accessibility features\n   */\n  initialize() {\n    this.applyStoredPreferences();\n    this.setupKeyboardNavigation();\n    this.setupARIALabels();\n    this.initializeTextToSpeech();\n    console.log('♿ Accessibility Service Initialized');\n  }\n\n  /**\n   * Load user preferences from localStorage\n   * @returns {Object} User preferences\n   */\n  loadPreferences() {\n    const stored = localStorage.getItem('accessibilityPreferences');\n    return stored ? JSON.parse(stored) : this.getDefaultPreferences();\n  }\n\n  /**\n   * Get default accessibility preferences\n   * @returns {Object} Default preferences\n   */\n  getDefaultPreferences() {\n    return {\n      theme: 'light',\n      fontSize: 16,\n      fontFamily: 'standard',\n      lineHeight: 1.5,\n      letterSpacing: 0.12,\n      language: 'en',\n      textToSpeech: false,\n      speakingRate: 1.0,\n      reduceMotion: false,\n      reduceTransparency: false,\n      underlineLinks: false,\n      boldText: false,\n      highContrast: false\n    };\n  }\n\n  /**\n   * Apply stored preferences to the page\n   */\n  applyStoredPreferences() {\n    const prefs = this.userPreferences;\n    \n    // Apply theme\n    this.setTheme(prefs.theme);\n    \n    // Apply font settings\n    this.setFontSize(prefs.fontSize);\n    this.setFontFamily(prefs.fontFamily);\n    this.setLineHeight(prefs.lineHeight);\n    this.setLetterSpacing(prefs.letterSpacing);\n    \n    // Apply text options\n    if (prefs.boldText) this.toggleBoldText(true);\n    if (prefs.underlineLinks) this.underlineAllLinks(true);\n    if (prefs.reduceMotion) this.reduceMotion(true);\n    if (prefs.reduceTransparency) this.reduceTransparency(true);\n    \n    // Set language\n    this.setLanguage(prefs.language);\n  }\n\n  /**\n   * Set theme and apply colors\n   * @param {string} themeName - Theme name to apply\n   */\n  setTheme(themeName) {\n    if (!this.themes[themeName]) {\n      console.error('Theme not found:', themeName);\n      return;\n    }\n\n    const theme = this.themes[themeName];\n    const root = document.documentElement;\n\n    // Apply CSS variables\n    root.style.setProperty('--bg-color', theme.colors.background);\n    root.style.setProperty('--text-color', theme.colors.text);\n    root.style.setProperty('--primary-color', theme.colors.primary);\n    root.style.setProperty('--secondary-color', theme.colors.secondary);\n\n    // Apply to body\n    document.body.style.backgroundColor = theme.colors.background;\n    document.body.style.color = theme.colors.text;\n\n    this.currentTheme = themeName;\n    this.updatePreference('theme', themeName);\n    console.log(`✅ Theme set to: ${theme.name}`);\n  }\n\n  /**\n   * Set font size for entire page\n   * @param {number} size - Font size in pixels\n   */\n  setFontSize(size) {\n    if (size < 12 || size > 32) {\n      console.warn('Font size out of range (12-32px)');\n      return;\n    }\n\n    const root = document.documentElement;\n    root.style.fontSize = `${size}px`;\n    \n    // Also set for body and all elements\n    document.body.style.fontSize = `${size}px`;\n    document.querySelectorAll('*').forEach(el => {\n      const computed = window.getComputedStyle(el).fontSize;\n      const ratio = parseInt(computed) / 16; // base 16px\n      el.style.fontSize = `${size * ratio}px`;\n    });\n\n    this.updatePreference('fontSize', size);\n    console.log(`✅ Font size set to: ${size}px`);\n  }\n\n  /**\n   * Set font family\n   * @param {string} fontName - Font name from fonts object\n   */\n  setFontFamily(fontName) {\n    if (!this.fonts[fontName]) {\n      console.error('Font not found:', fontName);\n      return;\n    }\n\n    const font = this.fonts[fontName];\n    document.documentElement.style.fontFamily = font.family;\n    document.body.style.fontFamily = font.family;\n\n    this.updatePreference('fontFamily', fontName);\n    console.log(`✅ Font set to: ${font.name}`);\n  }\n\n  /**\n   * Set line height\n   * @param {number} height - Line height multiplier (1.5 - 3.0)\n   */\n  setLineHeight(height) {\n    if (height < 1.5 || height > 3.0) {\n      console.warn('Line height out of range (1.5-3.0)');\n      return;\n    }\n\n    document.documentElement.style.lineHeight = height;\n    document.body.style.lineHeight = height;\n\n    this.updatePreference('lineHeight', height);\n    console.log(`✅ Line height set to: ${height}`);\n  }\n\n  /**\n   * Set letter spacing\n   * @param {number} spacing - Letter spacing in em units\n   */\n  setLetterSpacing(spacing) {\n    if (spacing < 0.12 || spacing > 0.24) {\n      console.warn('Letter spacing out of range (0.12-0.24em)');\n      return;\n    }\n\n    document.documentElement.style.letterSpacing = `${spacing}em`;\n    document.body.style.letterSpacing = `${spacing}em`;\n\n    this.updatePreference('letterSpacing', spacing);\n    console.log(`✅ Letter spacing set to: ${spacing}em`);\n  }\n\n  /**\n   * Toggle bold text across page\n   * @param {boolean} enabled - Enable or disable\n   */\n  toggleBoldText(enabled) {\n    if (enabled) {\n      document.documentElement.style.fontWeight = '700';\n    } else {\n      document.documentElement.style.fontWeight = 'normal';\n    }\n\n    this.updatePreference('boldText', enabled);\n    console.log(`✅ Bold text ${enabled ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Underline all links\n   * @param {boolean} enabled - Enable or disable\n   */\n  underlineAllLinks(enabled) {\n    const links = document.querySelectorAll('a');\n    links.forEach(link => {\n      link.style.textDecoration = enabled ? 'underline' : '';\n    });\n\n    this.updatePreference('underlineLinks', enabled);\n    console.log(`✅ Link underlining ${enabled ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Reduce motion for animations\n   * @param {boolean} enabled - Enable or disable\n   */\n  reduceMotion(enabled) {\n    if (enabled) {\n      document.documentElement.style.setProperty('--animation-duration', '0.01ms');\n      document.documentElement.style.setProperty('--transition-duration', '0.01ms');\n    } else {\n      document.documentElement.style.setProperty('--animation-duration', '0.3s');\n      document.documentElement.style.setProperty('--transition-duration', '0.3s');\n    }\n\n    this.updatePreference('reduceMotion', enabled);\n    console.log(`✅ Motion reduction ${enabled ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Reduce transparency\n   * @param {boolean} enabled - Enable or disable\n   */\n  reduceTransparency(enabled) {\n    if (enabled) {\n      // Find all elements with opacity/transparency\n      document.querySelectorAll('[style*=\"opacity\"]').forEach(el => {\n        el.style.opacity = '1';\n      });\n      \n      // Set CSS rule\n      const style = document.createElement('style');\n      style.textContent = `\n        ::before, ::after { filter: none !important; }\n        * { background-color: opaque !important; }\n      `;\n      document.head.appendChild(style);\n    }\n\n    this.updatePreference('reduceTransparency', enabled);\n    console.log(`✅ Transparency reduction ${enabled ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Setup keyboard navigation\n   */\n  setupKeyboardNavigation() {\n    document.addEventListener('keydown', (e) => {\n      // Alt + D: Dashboard\n      if (e.altKey && e.key === 'd') {\n        window.location.href = '/dashboard';\n        e.preventDefault();\n      }\n      // Alt + F: Files\n      if (e.altKey && e.key === 'f') {\n        window.location.href = '/files';\n        e.preventDefault();\n      }\n      // Alt + S: Search\n      if (e.altKey && e.key === 's') {\n        document.querySelector('#search-input')?.focus();\n        e.preventDefault();\n      }\n      // Alt + H: Help\n      if (e.altKey && e.key === 'h') {\n        this.showAccessibilityHelp();\n        e.preventDefault();\n      }\n      // Alt + T: Toggle Text-to-Speech\n      if (e.altKey && e.key === 't') {\n        this.toggleTextToSpeech();\n        e.preventDefault();\n      }\n      // Alt + +: Increase font size\n      if (e.altKey && e.key === '+') {\n        const current = this.userPreferences.fontSize || 16;\n        if (current < 32) this.setFontSize(current + 2);\n        e.preventDefault();\n      }\n      // Alt + -: Decrease font size\n      if (e.altKey && e.key === '-') {\n        const current = this.userPreferences.fontSize || 16;\n        if (current > 12) this.setFontSize(current - 2);\n        e.preventDefault();\n      }\n    });\n\n    console.log('✅ Keyboard navigation setup complete');\n  }\n\n  /**\n   * Setup ARIA labels for all interactive elements\n   */\n  setupARIALabels() {\n    // Add role and aria labels to buttons\n    document.querySelectorAll('button').forEach((btn, index) => {\n      if (!btn.getAttribute('aria-label')) {\n        btn.setAttribute('aria-label', btn.textContent || `Button ${index}`);\n      }\n      btn.setAttribute('role', 'button');\n    });\n\n    // Add role to links\n    document.querySelectorAll('a').forEach(link => {\n      if (!link.getAttribute('aria-label')) {\n        link.setAttribute('aria-label', link.textContent || 'Link');\n      }\n    });\n\n    // Add ARIA live region for dynamic content\n    const liveRegion = document.createElement('div');\n    liveRegion.setAttribute('aria-live', 'polite');\n    liveRegion.setAttribute('aria-atomic', 'true');\n    liveRegion.id = 'aria-live-region';\n    liveRegion.style.display = 'none';\n    document.body.appendChild(liveRegion);\n\n    console.log('✅ ARIA labels setup complete');\n  }\n\n  /**\n   * Initialize Text-to-Speech\n   */\n  initializeTextToSpeech() {\n    if ('speechSynthesis' in window) {\n      this.synth = window.speechSynthesis;\n      console.log('✅ Text-to-Speech available');\n    } else {\n      console.warn('⚠️ Text-to-Speech not supported in this browser');\n    }\n  }\n\n  /**\n   * Toggle Text-to-Speech\n   */\n  toggleTextToSpeech() {\n    if (!this.synth) {\n      alert('Text-to-Speech not supported in your browser');\n      return;\n    }\n\n    this.isTextToSpeechActive = !this.isTextToSpeechActive;\n    \n    if (this.isTextToSpeechActive) {\n      this.speakElementContent(document.body);\n    } else {\n      this.synth.cancel();\n    }\n\n    this.updatePreference('textToSpeech', this.isTextToSpeechActive);\n    console.log(`✅ Text-to-Speech ${this.isTextToSpeechActive ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Speak element content\n   * @param {Element} element - DOM element to speak\n   */\n  speakElementContent(element) {\n    if (!this.synth) return;\n\n    const text = element.innerText || element.textContent;\n    if (!text) return;\n\n    const utterance = new SpeechSynthesisUtterance(text);\n    utterance.rate = this.speakingRate;\n    utterance.lang = this.currentLanguage === 'ar' ? 'ar-SA' : 'en-US';\n    \n    this.synth.speak(utterance);\n  }\n\n  /**\n   * Set language\n   * @param {string} lang - Language code (ar, en, fr, etc.)\n   */\n  setLanguage(lang) {\n    if (!this.supportedLanguages.includes(lang)) {\n      console.warn('Language not supported:', lang);\n      return;\n    }\n\n    this.currentLanguage = lang;\n    document.documentElement.lang = lang;\n    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';\n\n    // Reload page content for language change\n    // This would typically trigger a backend API call\n    this.updatePreference('language', lang);\n    console.log(`✅ Language set to: ${lang}`);\n  }\n\n  /**\n   * Update user preference\n   * @param {string} key - Preference key\n   * @param {any} value - Preference value\n   */\n  updatePreference(key, value) {\n    this.userPreferences[key] = value;\n    localStorage.setItem('accessibilityPreferences', JSON.stringify(this.userPreferences));\n  }\n\n  /**\n   * Show accessibility help dialog\n   */\n  showAccessibilityHelp() {\n    const help = `\n♿ ACCESSIBILITY HELP\n\nKeyboard Shortcuts:\n- Alt+D: Dashboard\n- Alt+F: Files\n- Alt+S: Search\n- Alt+H: Help\n- Alt+T: Toggle Text-to-Speech\n- Alt++: Increase Font Size\n- Alt+-: Decrease Font Size\n- Tab: Navigate Elements\n- Enter: Activate Button\n- Space: Toggle Checkbox\n\nScreen Reader:\n- Use Tab to navigate\n- Use Enter to activate\n- All content is labeled\n\nText-to-Speech:\n- Alt+T to start/stop\n- Content read aloud\n- Highlight synchronized\n\nFor more help, contact support.\n    `;\n    alert(help);\n  }\n\n  /**\n   * Get all available themes\n   * @returns {Object} All themes\n   */\n  getThemes() {\n    return this.themes;\n  }\n\n  /**\n   * Get all available fonts\n   * @returns {Object} All fonts\n   */\n  getFonts() {\n    return this.fonts;\n  }\n\n  /**\n   * Export preferences as JSON\n   * @returns {string} JSON string of preferences\n   */\n  exportPreferences() {\n    return JSON.stringify(this.userPreferences, null, 2);\n  }\n\n  /**\n   * Import preferences from JSON\n   * @param {string} json - JSON string of preferences\n   */\n  importPreferences(json) {\n    try {\n      const imported = JSON.parse(json);\n      this.userPreferences = { ...this.userPreferences, ...imported };\n      this.applyStoredPreferences();\n      localStorage.setItem('accessibilityPreferences', json);\n      console.log('✅ Preferences imported successfully');\n    } catch (error) {\n      console.error('❌ Invalid preferences JSON:', error);\n    }\n  }\n}\n\n// Export for use in other modules\nif (typeof module !== 'undefined' && module.exports) {\n  module.exports = AccessibilityService;\n}\n\n// Initialize on page load\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', () => {\n    window.accessibilityService = new AccessibilityService();\n  });\n} else {\n  window.accessibilityService = new AccessibilityService();\n}\n