'use strict';\n\n/**\n * ðŸ’¡ Smart Recommendations Engine\n * \n * Provides intelligent recommendations based on:\n * - Historical behavior\n * - User patterns\n * - Business rules\n * - Predictive analytics\n * \n * @module recommendations.service\n * @version 1.0.0\n */\n\nclass RecommendationsService {\n  constructor() {\n    this.name = 'RecommendationsService';\n    this.version = '1.0.0';\n    this.recommendations = new Map();\n    this.userProfiles = new Map();\n    this.feedbackHistory = [];\n    this.initialized = false;\n\n    this.init();\n  }\n\n  /**\n   * Initialize service\n   */\n  init() {\n    try {\n      // Load saved data\n      const saved = localStorage.getItem('recommendations-data');\n      if (saved) {\n        const data = JSON.parse(saved);\n        this.recommendations = new Map(data.recommendations || []);\n        this.userProfiles = new Map(data.userProfiles || []);\n        this.feedbackHistory = data.feedbackHistory || [];\n      }\n\n      this.initialized = true;\n      this.log('âœ… Recommendations Service initialized');\n    } catch (error) {\n      this.error('Initialization failed:', error);\n    }\n  }\n\n  /**\n   * Get recommendations for user\n   * @param {String} userId - User ID\n   * @param {String} category - Recommendation category\n   * @param {Number} limit - Number of recommendations\n   * @returns {Array} Recommendations with confidence scores\n   */\n  getRecommendations(userId, category = 'general', limit = 5) {\n    const recommendations = [];\n\n    // Get or create user profile\n    let profile = this.userProfiles.get(userId);\n    if (!profile) {\n      profile = this.createUserProfile(userId);\n    }\n\n    switch (category) {\n      case 'leaves':\n        recommendations.push(...this.recommendLeaves(profile));\n        break;\n      case 'payroll':\n        recommendations.push(...this.recommendPayroll(profile));\n        break;\n      case 'attendance':\n        recommendations.push(...this.recommendAttendance(profile));\n        break;\n      case 'performance':\n        recommendations.push(...this.recommendPerformance(profile));\n        break;\n      case 'salary':\n        recommendations.push(...this.recommendSalary(profile));\n        break;\n      case 'training':\n        recommendations.push(...this.recommendTraining(profile));\n        break;\n      default:\n        recommendations.push(...this.recommendGeneral(profile));\n    }\n\n    return recommendations\n      .sort((a, b) => b.confidence - a.confidence)\n      .slice(0, limit);\n  }\n\n  /**\n   * Create user profile\n   * @private\n   */\n  createUserProfile(userId) {\n    const profile = {\n      userId,\n      created: new Date().toISOString(),\n      leaveBalance: 21,\n      attendanceRate: 95,\n      performanceScore: 85,\n      salary: 5000,\n      department: 'HR',\n      yearsEmployed: 2,\n      lastRecommendation: null,\n      preferences: {}\n    };\n\n    this.userProfiles.set(userId, profile);\n    this.save();\n    return profile;\n  }\n\n  /**\n   * Recommend leaves\n   * @private\n   */\n  recommendLeaves(profile) {\n    const recommendations = [];\n    const leaveBalance = profile.leaveBalance || 0;\n\n    if (leaveBalance > 10) {\n      recommendations.push({\n        id: 'leave-1',\n        type: 'leave',\n        title: 'Plan Annual Leave',\n        description: 'You have ' + leaveBalance + ' days remaining. Consider planning your annual leave.',\n        action: '/leaves',\n        priority: 'medium',\n        confidence: 78,\n        reason: 'High leave balance remains'\n      });\n    }\n\n    if (leaveBalance < 5) {\n      recommendations.push({\n        id: 'leave-2',\n        type: 'leave',\n        title: 'Use Remaining Leave',\n        description: 'Only ' + leaveBalance + ' days left. Use before expiration.',\n        action: '/leaves',\n        priority: 'high',\n        confidence: 92,\n        reason: 'Low leave balance'\n      });\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Recommend payroll actions\n   * @private\n   */\n  recommendPayroll(profile) {\n    const recommendations = [];\n\n    // Check if salary review is due\n    const yearsEmployed = profile.yearsEmployed || 0;\n    if (yearsEmployed > 0 && yearsEmployed % 2 === 0) {\n      recommendations.push({\n        id: 'payroll-1',\n        type: 'payroll',\n        title: 'Salary Review Due',\n        description: `Employee has been with company for ${yearsEmployed} years. Time for salary review.`,\n        action: '/payroll/review',\n        priority: 'high',\n        confidence: 85,\n        reason: 'Years milestone reached'\n      });\n    }\n\n    // Performance-based bonus\n    const performanceScore = profile.performanceScore || 0;\n    if (performanceScore > 90) {\n      recommendations.push({\n        id: 'payroll-2',\n        type: 'payroll',\n        title: 'Performance Bonus Eligible',\n        description: 'High performance score qualifies for bonus.',\n        action: '/payroll/bonus',\n        priority: 'high',\n        confidence: 88,\n        reason: 'Excellent performance score'\n      });\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Recommend attendance actions\n   * @private\n   */\n  recommendAttendance(profile) {\n    const recommendations = [];\n    const attendanceRate = profile.attendanceRate || 0;\n\n    if (attendanceRate < 85) {\n      recommendations.push({\n        id: 'attendance-1',\n        type: 'attendance',\n        title: 'Attendance Improvement Needed',\n        description: `Current attendance: ${attendanceRate}%. Target is 95%.`,\n        action: '/attendance',\n        priority: 'high',\n        confidence: 90,\n        reason: 'Below target attendance'\n      });\n    }\n\n    if (attendanceRate > 98) {\n      recommendations.push({\n        id: 'attendance-2',\n        type: 'attendance',\n        title: 'Excellent Attendance',\n        description: 'Maintain this excellent attendance record.',\n        action: '/rewards',\n        priority: 'low',\n        confidence: 87,\n        reason: 'Outstanding attendance'\n      });\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Recommend performance actions\n   * @private\n   */\n  recommendPerformance(profile) {\n    const recommendations = [];\n    const perfScore = profile.performanceScore || 0;\n\n    if (perfScore < 70) {\n      recommendations.push({\n        id: 'performance-1',\n        type: 'performance',\n        title: 'Performance Improvement Plan',\n        description: 'Schedule meetings to discuss performance goals.',\n        action: '/performance/goals',\n        priority: 'high',\n        confidence: 85,\n        reason: 'Below expected performance'\n      });\n    } else if (perfScore > 85) {\n      recommendations.push({\n        id: 'performance-2',\n        type: 'performance',\n        title: 'Career Development Opportunity',\n        description: 'Consider promotion or advanced role.',\n        action: '/performance/growth',\n        priority: 'medium',\n        confidence: 80,\n        reason: 'High performance level'\n      });\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Recommend salary actions\n   * @private\n   */\n  recommendSalary(profile) {\n    const recommendations = [];\n    const salary = profile.salary || 0;\n\n    // Cost of living adjustment\n    recommendations.push({\n      id: 'salary-1',\n      type: 'salary',\n      title: 'COLA Adjustment Review',\n      description: 'Consider cost of living adjustment for employees.',\n      action: '/salary/cola',\n      priority: 'medium',\n      confidence: 72,\n      reason: 'Annual review cycle'\n    });\n\n    return recommendations;\n  }\n\n  /**\n   * Recommend training\n   * @private\n   */\n  recommendTraining(profile) {\n    const recommendations = [];\n    const department = profile.department || 'General';\n\n    // Skills gap analysis\n    recommendations.push({\n      id: 'training-1',\n      type: 'training',\n      title: 'Recommended Training Courses',\n      description: `Courses available for ${department} department.`,\n      action: '/training',\n      priority: 'medium',\n      confidence: 75,\n      reason: 'Professional development'\n    });\n\n    // Soft skills training\n    recommendations.push({\n      id: 'training-2',\n      type: 'training',\n      title: 'Leadership Development',\n      description: 'Upcoming leadership training program.',\n      action: '/training/leadership',\n      priority: 'low',\n      confidence: 68,\n      reason: 'Career growth opportunity'\n    });\n\n    return recommendations;\n  }\n\n  /**\n   * General recommendations\n   * @private\n   */\n  recommendGeneral(profile) {\n    return [\n      {\n        id: 'general-1',\n        type: 'general',\n        title: 'Complete Your Profile',\n        description: 'Update your profile information for better recommendations.',\n        action: '/profile',\n        priority: 'low',\n        confidence: 65,\n        reason: 'Profile improvement'\n      },\n      {\n        id: 'general-2',\n        type: 'general',\n        title: 'Review Leave Policy',\n        description: 'Familiarize yourself with updated leave policies.',\n        action: '/policies',\n        priority: 'low',\n        confidence: 60,\n        reason: 'Policy update'\n      }\n    ];\n  }\n\n  /**\n   * Submit feedback on recommendation\n   * @param {String} userId - User ID\n   * @param {String} recommendationId - Recommendation ID\n   * @param {String} feedback - 'helpful', 'not-helpful', 'already-did'\n   * @returns {Object} Feedback receipt\n   */\n  submitFeedback(userId, recommendationId, feedback) {\n    const entry = {\n      userId,\n      recommendationId,\n      feedback,\n      timestamp: new Date().toISOString()\n    };\n\n    this.feedbackHistory.push(entry);\n    this.save();\n\n    return {\n      success: true,\n      message: 'Feedback recorded',\n      entry\n    };\n  }\n\n  /**\n   * Get feedback stats\n   */\n  getFeedbackStats() {\n    const helpful = this.feedbackHistory.filter(f => f.feedback === 'helpful').length;\n    const notHelpful = this.feedbackHistory.filter(f => f.feedback === 'not-helpful').length;\n    const alreadyDid = this.feedbackHistory.filter(f => f.feedback === 'already-did').length;\n\n    return {\n      total: this.feedbackHistory.length,\n      helpful,\n      notHelpful,\n      alreadyDid,\n      helpfulRate: this.feedbackHistory.length > 0 \n        ? ((helpful / this.feedbackHistory.length) * 100).toFixed(2) + '%'\n        : 'N/A'\n    };\n  }\n\n  /**\n   * Get personalized recommendations\n   * @param {String} userId - User ID\n   * @param {Number} limit - Maximum recommendations\n   * @returns {Array} All personalized recommendations\n   */\n  getPersonalizedRecommendations(userId, limit = 10) {\n    const categories = ['leaves', 'payroll', 'attendance', 'performance', 'salary', 'training'];\n    const allRecommendations = [];\n\n    categories.forEach(category => {\n      const recs = this.getRecommendations(userId, category, 2);\n      allRecommendations.push(...recs);\n    });\n\n    return allRecommendations\n      .sort((a, b) => b.confidence - a.confidence)\n      .slice(0, limit);\n  }\n\n  /**\n   * Update user profile\n   * @param {String} userId - User ID\n   * @param {Object} updates - Data to update\n   */\n  updateUserProfile(userId, updates) {\n    let profile = this.userProfiles.get(userId);\n    if (!profile) {\n      profile = this.createUserProfile(userId);\n    }\n\n    Object.assign(profile, updates);\n    this.userProfiles.set(userId, profile);\n    this.save();\n\n    return { success: true, profile };\n  }\n\n  /**\n   * Get user profile\n   */\n  getUserProfile(userId) {\n    let profile = this.userProfiles.get(userId);\n    if (!profile) {\n      profile = this.createUserProfile(userId);\n    }\n    return profile;\n  }\n\n  /**\n   * Clear old recommendations (cache)\n   */\n  clearOldRecommendations() {\n    this.recommendations.clear();\n    this.save();\n    return { message: 'Cache cleared' };\n  }\n\n  /**\n   * Save data to localStorage\n   * @private\n   */\n  save() {\n    try {\n      const data = {\n        recommendations: Array.from(this.recommendations.entries()),\n        userProfiles: Array.from(this.userProfiles.entries()),\n        feedbackHistory: this.feedbackHistory\n      };\n      localStorage.setItem('recommendations-data', JSON.stringify(data));\n    } catch (error) {\n      this.error('Failed to save:', error);\n    }\n  }\n\n  /**\n   * Get service status\n   */\n  getStatus() {\n    return {\n      service: this.name,\n      version: this.version,\n      initialized: this.initialized,\n      usersTracked: this.userProfiles.size,\n      feedbackCount: this.feedbackHistory.length,\n      timestamp: new Date().toISOString()\n    };\n  }\n\n  // ===== Logging =====\n  log(...args) {\n    console.log(`[${this.name}]`, ...args);\n  }\n\n  error(...args) {\n    console.error(`[${this.name}]`, ...args);\n  }\n}\n\n// Create singleton instance\nif (!window.recommendationsService) {\n  window.recommendationsService = new RecommendationsService();\n}\n\n// Export for module environments\nif (typeof module !== 'undefined' && module.exports) {\n  module.exports = RecommendationsService;\n}\n"