<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Transport Logistics</title>
    <style>
      :root {
        --primary: #c0392b;
        --secondary: #e74c3c;
        --dark: #2c3e50;
        --light: #ecf0f1;
      }
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #f4f7f6;
        margin: 0;
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 250px;
        background: var(--dark);
        color: white;
        padding: 20px;
      }
      .sidebar h2 {
        border-bottom: 2px solid var(--secondary);
        padding-bottom: 15px;
      }
      .main {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      .grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      h2 {
        color: var(--dark);
      }
      .vehicle-list,
      .trip-list {
        list-style: none;
        padding: 0;
      }
      .vehicle-item,
      .trip-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
      }
      .status.AVAILABLE {
        background: #27ae60;
        color: white;
      }
      .status.BUSY {
        background: #e67e22;
        color: white;
      }
      .status.MAINTENANCE {
        background: #c0392b;
        color: white;
      }
      button.action-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>ðŸš‘ Logistics Core</h2>
      <p>Manage ambulance fleet, patient shuttles, and supply vehicles.</p>
      <div style="margin-top: 40px">
        <h3>Quick Stats</h3>
        <p>Active Vehicles: <span id="activeCount">0</span></p>
        <p>Pending Trips: <span id="pendingCount">0</span></p>
      </div>
    </div>

    <div class="main">
      <h1>Transport Operations Center</h1>

      <div class="grid">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center">
            <h2>Active Trips</h2>
            <button class="action-btn" onclick="requestTrip()">+ New Request</button>
          </div>
          <ul class="trip-list" id="tripList">
            <li>Loading...</li>
          </ul>
        </div>

        <div class="card">
          <h2>Fleet Status</h2>
          <ul class="vehicle-list" id="vehicleList">
            <li>Loading...</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = '/api/transport-smart';

      async function loadDashboard() {
        // Load Vehicles
        const vRes = await fetch(`${API_BASE}/vehicles`);
        const vData = await vRes.json();
        renderVehicles(vData.data);

        // Load Trips
        const tRes = await fetch(`${API_BASE}/trips`);
        const tData = await tRes.json();
        renderTrips(tData.data);

        // Stats
        document.getElementById('activeCount').innerText = vData.data.filter(v => v.status === 'BUSY').length;
      }

      function renderVehicles(list) {
        const el = document.getElementById('vehicleList');
        el.innerHTML = list
          .map(
            v => `
                <li class="vehicle-item">
                    <div>
                        <strong>${v.plateNumber}</strong> (${v.type})
                        <div style="font-size:0.8em; color:#777">Loc: ${v.location.lat}, ${v.location.lng}</div>
                    </div>
                    <span class="status ${v.status}">${v.status}</span>
                </li>
            `,
          )
          .join('');
      }

      function renderTrips(list) {
        const el = document.getElementById('tripList');
        el.innerHTML = list.length
          ? list
              .map(
                t => `
                <li class="trip-item">
                    <div>
                        <strong>TRIP #${t.id}</strong> (Priority: ${t.priority})<br/>
                        To: ${t.dropoff} | Patient: ${t.patientId}
                    </div>
                    <div>
                        <span class="status">${t.status}</span>
                        ${
                          t.status === 'DISPATCHED'
                            ? `<button onclick="completeTrip('${t.id}')" style="margin-left:5px; padding:2px 5px; cursor:pointer">Done</button>`
                            : ''
                        }
                    </div>
                </li>
            `,
              )
              .join('')
          : '<p>No active trips.</p>';
      }

      async function requestTrip() {
        // Mock Request
        await fetch(`${API_BASE}/trips/request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId: 'PT-1005',
            pickup: 'Home',
            dropoff: 'Clinic Block A',
            priority: 'NORMAL',
          }),
        });
        loadDashboard();
      }

      async function completeTrip(id) {
        await fetch(`${API_BASE}/trips/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'COMPLETED' }),
        });
        loadDashboard();
      }

      loadDashboard();
      setInterval(loadDashboard, 5000); // Live update
    </script>
  </body>
</html>
