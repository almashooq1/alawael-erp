# Logstash Pipeline Configuration for Application Logs

input {
  # Docker container logs via TCP
  tcp {
    port => 5000
    codec => json
    type => "docker"
  }

  # File input for application logs
  file {
    path => "/var/log/application/*.log"
    type => "application"
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
    }
  }

  # Metrics from application
  tcp {
    port => 5001
    codec => json
    type => "metrics"
  }
}

filter {
  # Parse JSON logs from application
  if [type] == "application" {
    json {
      source => "message"
    }

    # Extract timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }

    # Parse log level
    mutate {
      rename => { "level" => "log_level" }
    }

    # Add tags based on log level
    if [log_level] =~ /ERROR|FATAL/ {
      mutate { add_tag => [ "error" ] }
    }

    if [log_level] == "WARN" {
      mutate { add_tag => [ "warning" ] }
    }
  }

  # Parse Docker logs
  if [type] == "docker" {
    mutate {
      add_field => { "container" => "%{[container_name]}" }
    }
  }

  # Add environment context
  mutate {
    add_field => {
      "environment" => "${ENVIRONMENT:-production}"
      "service" => "%{[service_name]:-backend}"
      "host.name" => "${HOSTNAME}"
    }
  }

  # Enrich with geolocation if IP available
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Parse HTTP request details
  if [http_request] {
    mutate {
      add_field => {
        "http.method" => "%{[http_method]}"
        "http.path" => "%{[http_path]}"
        "http.status" => "%{[http_status]}"
        "http.duration_ms" => "%{[response_time]}"
      }
    }
  }

  # Add correlation IDs for tracing
  if [trace_id] {
    mutate {
      add_field => { "tracing.trace_id" => "%{[trace_id]}" }
    }
  }

  if [span_id] {
    mutate {
      add_field => { "tracing.span_id" => "%{[span_id]}" }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{[type]}-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "changeme"
  }

  # Also output to stdout for debugging (disable in production)
  if [@metadata][debug] {
    stdout {
      codec => rubydebug
    }
  }

  # Alert on errors
  if "error" in [tags] {
    exec {
      command => "logger -t logstash 'ERROR logged: %{message}'"
    }
  }
}
