<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير العام - مراكز الأوائل</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/branding.css" rel="stylesheet">
    <link href="/static/css/pwa-styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
        }
        .kpi-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .kpi-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .quick-actions {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: #007bff;
            color: white;
            transform: translateX(-5px);
        }
        .alert-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 0.8rem;
        }
        .system-status {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        .status-online { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-offline { background: #dc3545; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="/static/images/awail-logo.svg" alt="الأوائل" height="40">
                لوحة المدير العام
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/reports">
                            <i class="fas fa-chart-bar"></i> التقارير
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/settings">
                            <i class="fas fa-cog"></i> الإعدادات
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> المدير العام
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user-edit"></i> الملف الشخصي</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Welcome Section -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-crown"></i> مرحباً بك في لوحة المدير العام</h2>
                            <p class="mb-0">نظرة شاملة على أداء مراكز الأوائل للتأهيل الشامل</p>
                            <small>آخر تحديث: <span id="lastUpdate"></span></small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="system-status">
                                <h5><i class="fas fa-server"></i> حالة النظام</h5>
                                <div>
                                    <span class="status-indicator status-online"></span> قاعدة البيانات
                                    <span class="status-indicator status-online"></span> الخوادم
                                    <span class="status-indicator status-warning"></span> النسخ الاحتياطي
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-number" id="totalStudents">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-users"></i> إجمالي المستفيدين
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-number" id="activePrograms">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-graduation-cap"></i> البرامج النشطة
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-number" id="totalStaff">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-user-tie"></i> إجمالي الموظفين
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-number" id="monthlyRevenue">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-dollar-sign"></i> الإيرادات الشهرية
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-xl-8">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line"></i> تطور المستفيدين خلال العام</h5>
                    <canvas id="studentsChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie"></i> توزيع البرامج</h5>
                    <canvas id="programsChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row">
            <div class="col-xl-6">
                <div class="chart-container">
                    <h5><i class="fas fa-trophy"></i> مؤشرات الأداء الرئيسية</h5>
                    <canvas id="performanceChart" height="150"></canvas>
                </div>
            </div>
            <div class="col-xl-6">
                <div class="chart-container">
                    <h5><i class="fas fa-money-bill-wave"></i> التحليل المالي</h5>
                    <canvas id="financialChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="row">
            <div class="col-xl-4">
                <div class="quick-actions">
                    <h5><i class="fas fa-bolt"></i> الإجراءات السريعة</h5>
                    <a href="/students/new" class="action-btn">
                        <i class="fas fa-user-plus"></i> إضافة مستفيد جديد
                    </a>
                    <a href="/programs/new" class="action-btn">
                        <i class="fas fa-plus-circle"></i> إنشاء برنامج جديد
                    </a>
                    <a href="/staff/new" class="action-btn">
                        <i class="fas fa-user-tie"></i> إضافة موظف
                    </a>
                    <a href="/reports/generate" class="action-btn">
                        <i class="fas fa-file-alt"></i> إنشاء تقرير
                    </a>
                    <a href="/backup/create" class="action-btn">
                        <i class="fas fa-database"></i> نسخة احتياطية
                    </a>
                </div>
            </div>
            
            <div class="col-xl-4">
                <div class="recent-activity">
                    <h5><i class="fas fa-clock"></i> النشاطات الأخيرة</h5>
                    <div id="recentActivities">
                        <!-- سيتم تحميل النشاطات ديناميكياً -->
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4">
                <div class="recent-activity">
                    <h5><i class="fas fa-exclamation-triangle"></i> التنبيهات المهمة</h5>
                    <div id="importantAlerts">
                        <!-- سيتم تحميل التنبيهات ديناميكياً -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-analytics"></i> إحصائيات مفصلة</h5>
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h3 class="text-primary" id="completionRate">0%</h3>
                            <p>معدل إكمال البرامج</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-success" id="satisfactionRate">0%</h3>
                            <p>معدل رضا المستفيدين</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-info" id="attendanceRate">0%</h3>
                            <p>معدل الحضور</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-warning" id="efficiencyRate">0%</h3>
                            <p>كفاءة الموارد</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/pwa-installer.js"></script>
    
    <script>
        // تحديث الوقت
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('ar-SA');
        }
        updateTime();
        setInterval(updateTime, 60000);

        // تحميل البيانات
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard-data');
                const data = await response.json();
                
                // تحديث KPIs
                document.getElementById('totalStudents').textContent = data.totalStudents || 0;
                document.getElementById('activePrograms').textContent = data.activePrograms || 0;
                document.getElementById('totalStaff').textContent = data.totalStaff || 0;
                document.getElementById('monthlyRevenue').textContent = (data.monthlyRevenue || 0).toLocaleString('ar-SA');
                
                // تحديث المعدلات
                document.getElementById('completionRate').textContent = (data.completionRate || 0) + '%';
                document.getElementById('satisfactionRate').textContent = (data.satisfactionRate || 0) + '%';
                document.getElementById('attendanceRate').textContent = (data.attendanceRate || 0) + '%';
                document.getElementById('efficiencyRate').textContent = (data.efficiencyRate || 0) + '%';
                
                // تحديث الرسوم البيانية
                updateCharts(data);
                
                // تحديث النشاطات
                updateRecentActivities(data.recentActivities || []);
                
                // تحديث التنبيهات
                updateAlerts(data.alerts || []);
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
            }
        }

        // الرسوم البيانية
        let studentsChart, programsChart, performanceChart, financialChart;

        function initCharts() {
            // رسم تطور المستفيدين
            const studentsCtx = document.getElementById('studentsChart').getContext('2d');
            studentsChart = new Chart(studentsCtx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'المستفيدين الجدد',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: { family: 'Arial' }
                            }
                        }
                    }
                }
            });

            // رسم توزيع البرامج
            const programsCtx = document.getElementById('programsChart').getContext('2d');
            programsChart = new Chart(programsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['التأهيل الحركي', 'النطق والتخاطب', 'التأهيل المعرفي', 'التدريب المهني'],
                    datasets: [{
                        data: [30, 25, 20, 25],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // رسم مؤشرات الأداء
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'radar',
                data: {
                    labels: ['الجودة', 'الكفاءة', 'الرضا', 'الحضور', 'الإنجاز'],
                    datasets: [{
                        label: 'الأداء الحالي',
                        data: [85, 78, 92, 88, 76],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // الرسم المالي
            const financialCtx = document.getElementById('financialChart').getContext('2d');
            financialChart = new Chart(financialCtx, {
                type: 'bar',
                data: {
                    labels: ['الإيرادات', 'المصروفات', 'الربح'],
                    datasets: [{
                        data: [150000, 120000, 30000],
                        backgroundColor: ['#28a745', '#dc3545', '#007bff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateCharts(data) {
            if (data.studentsData && studentsChart) {
                studentsChart.data.datasets[0].data = data.studentsData;
                studentsChart.update();
            }
            
            if (data.programsData && programsChart) {
                programsChart.data.datasets[0].data = data.programsData;
                programsChart.update();
            }
        }

        function updateRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            container.innerHTML = '';
            
            activities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'activity-item';
                activityElement.innerHTML = `
                    <div class="activity-icon bg-primary text-white">
                        <i class="fas ${activity.icon || 'fa-info'}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${activity.title}</div>
                        <small class="text-muted">${activity.time}</small>
                    </div>
                `;
                container.appendChild(activityElement);
            });
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('importantAlerts');
            container.innerHTML = '';
            
            alerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = 'alert-item';
                alertElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas ${alert.icon || 'fa-exclamation-triangle'} text-warning me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${alert.title}</div>
                            <small>${alert.message}</small>
                        </div>
                    </div>
                `;
                container.appendChild(alertElement);
            });
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
            
            // تحديث البيانات كل 5 دقائق
            setInterval(loadDashboardData, 300000);
        });

        // تحديث البيانات عند النقر على زر التحديث
        function refreshDashboard() {
            loadDashboardData();
        }
    </script>
</body>
</html>
