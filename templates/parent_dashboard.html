<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الأهالي - مراكز الأوائل</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/branding.css" rel="stylesheet">
    <link href="/static/css/pwa-styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .parent-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 20px;
        }
        .child-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .child-card:hover {
            transform: translateY(-5px);
        }
        .child-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 15px;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .progress-ring-circle {
            stroke: #e9ecef;
            stroke-width: 8;
            fill: transparent;
            r: 52;
            cx: 60;
            cy: 60;
        }
        .progress-ring-progress {
            stroke: #28a745;
            stroke-width: 8;
            stroke-linecap: round;
            fill: transparent;
            r: 52;
            cx: 60;
            cy: 60;
            stroke-dasharray: 326.73;
            stroke-dashoffset: 326.73;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .session-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .achievement-badge {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin: 5px;
            display: inline-block;
        }
        .notification-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #17a2b8;
        }
        .quick-action-btn {
            background: white;
            border: 2px solid #007bff;
            color: #007bff;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .quick-action-btn:hover {
            background: #007bff;
            color: white;
        }
        .welcome-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body class="parent-dashboard">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/images/awail-logo.svg" alt="الأوائل" height="40">
                لوحة الأهالي
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/parent/dashboard">
                            <i class="fas fa-home"></i> الرئيسية
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/progress">
                            <i class="fas fa-chart-line"></i> التقدم
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/sessions">
                            <i class="fas fa-calendar"></i> الجلسات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/communication">
                            <i class="fas fa-comments"></i> التواصل
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="parentName">ولي الأمر</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/parent/profile"><i class="fas fa-user-edit"></i> الملف الشخصي</a></li>
                            <li><a class="dropdown-item" href="/parent/settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2><i class="fas fa-heart"></i> مرحباً بك في لوحة متابعة طفلك</h2>
                    <p class="mb-0">تابع تقدم طفلك وإنجازاته في مراكز الأوائل للتأهيل الشامل</p>
                    <small>آخر تحديث: <span id="lastUpdate"></span></small>
                </div>
                <div class="col-md-4 text-center">
                    <div class="quick-actions">
                        <a href="/parent/book-session" class="quick-action-btn">
                            <i class="fas fa-calendar-plus"></i> حجز جلسة
                        </a>
                        <a href="/parent/contact-therapist" class="quick-action-btn">
                            <i class="fas fa-phone"></i> التواصل
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Children Overview -->
        <div class="row" id="childrenContainer">
            <!-- سيتم تحميل بيانات الأطفال ديناميكياً -->
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="text-muted">إجمالي الجلسات</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="completedGoals">0</div>
                    <div class="text-muted">الأهداف المحققة</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="attendanceRate">0%</div>
                    <div class="text-muted">معدل الحضور</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="progressScore">0%</div>
                    <div class="text-muted">نسبة التقدم</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Upcoming Sessions -->
            <div class="col-xl-6">
                <div class="child-card">
                    <h5><i class="fas fa-calendar-alt text-primary"></i> الجلسات القادمة</h5>
                    <div id="upcomingSessions">
                        <!-- سيتم تحميل الجلسات ديناميكياً -->
                    </div>
                </div>
            </div>

            <!-- Recent Achievements -->
            <div class="col-xl-6">
                <div class="child-card">
                    <h5><i class="fas fa-trophy text-warning"></i> الإنجازات الأخيرة</h5>
                    <div id="recentAchievements">
                        <!-- سيتم تحميل الإنجازات ديناميكياً -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Tracking -->
        <div class="row">
            <div class="col-xl-8">
                <div class="child-card">
                    <h5><i class="fas fa-chart-line text-success"></i> تتبع التقدم</h5>
                    <canvas id="progressChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="child-card">
                    <h5><i class="fas fa-bell text-info"></i> الإشعارات</h5>
                    <div id="notifications" style="max-height: 300px; overflow-y: auto;">
                        <!-- سيتم تحميل الإشعارات ديناميكياً -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Therapist Communication -->
        <div class="row">
            <div class="col-12">
                <div class="child-card">
                    <h5><i class="fas fa-comments text-primary"></i> رسائل من الأخصائيين</h5>
                    <div id="therapistMessages">
                        <!-- سيتم تحميل الرسائل ديناميكياً -->
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="openMessageModal()">
                            <i class="fas fa-paper-plane"></i> إرسال رسالة جديدة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إرسال رسالة للأخصائي</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <div class="mb-3">
                            <label class="form-label">اختر الطفل</label>
                            <select class="form-select" id="childSelect" required>
                                <option value="">اختر الطفل</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الموضوع</label>
                            <input type="text" class="form-control" id="messageSubject" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الرسالة</label>
                            <textarea class="form-control" id="messageContent" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessage()">إرسال</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/pwa-installer.js"></script>
    
    <script>
        let progressChart;

        // تحديث الوقت
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('ar-SA');
        }
        updateTime();
        setInterval(updateTime, 60000);

        // تحميل بيانات لوحة التحكم
        async function loadParentDashboard() {
            try {
                const response = await fetch('/api/parent/dashboard-data');
                const data = await response.json();
                
                // تحديث اسم ولي الأمر
                document.getElementById('parentName').textContent = data.parentName || 'ولي الأمر';
                
                // تحديث الإحصائيات
                document.getElementById('totalSessions').textContent = data.totalSessions || 0;
                document.getElementById('completedGoals').textContent = data.completedGoals || 0;
                document.getElementById('attendanceRate').textContent = (data.attendanceRate || 0) + '%';
                document.getElementById('progressScore').textContent = (data.progressScore || 0) + '%';
                
                // تحديث بيانات الأطفال
                updateChildrenCards(data.children || []);
                
                // تحديث الجلسات القادمة
                updateUpcomingSessions(data.upcomingSessions || []);
                
                // تحديث الإنجازات
                updateAchievements(data.achievements || []);
                
                // تحديث الإشعارات
                updateNotifications(data.notifications || []);
                
                // تحديث رسائل الأخصائيين
                updateTherapistMessages(data.messages || []);
                
                // تحديث الرسم البياني
                updateProgressChart(data.progressData || []);
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
            }
        }

        function updateChildrenCards(children) {
            const container = document.getElementById('childrenContainer');
            container.innerHTML = '';
            
            children.forEach(child => {
                const childCard = document.createElement('div');
                childCard.className = 'col-xl-6 mb-4';
                childCard.innerHTML = `
                    <div class="child-card">
                        <div class="row align-items-center">
                            <div class="col-md-4 text-center">
                                <div class="child-avatar">
                                    ${child.name.charAt(0)}
                                </div>
                                <h5>${child.name}</h5>
                                <small class="text-muted">${child.program}</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <svg class="progress-ring">
                                    <circle class="progress-ring-circle"></circle>
                                    <circle class="progress-ring-progress" 
                                            style="stroke-dashoffset: ${326.73 - (326.73 * child.progress / 100)}"></circle>
                                </svg>
                                <div class="mt-2">
                                    <strong>${child.progress}%</strong>
                                    <div class="text-muted">التقدم العام</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <small class="text-muted">الجلسة القادمة:</small>
                                    <div class="fw-bold">${child.nextSession || 'لا توجد'}</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">الأخصائي:</small>
                                    <div class="fw-bold">${child.therapist}</div>
                                </div>
                                <a href="/parent/child/${child.id}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> عرض التفاصيل
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(childCard);
            });
        }

        function updateUpcomingSessions(sessions) {
            const container = document.getElementById('upcomingSessions');
            container.innerHTML = '';
            
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">لا توجد جلسات قادمة</p>';
                return;
            }
            
            sessions.forEach(session => {
                const sessionElement = document.createElement('div');
                sessionElement.className = 'session-card';
                sessionElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${session.childName} - ${session.type}</div>
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> ${session.date}
                                <i class="fas fa-clock ms-2"></i> ${session.time}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-primary">${session.therapist}</span>
                        </div>
                    </div>
                `;
                container.appendChild(sessionElement);
            });
        }

        function updateAchievements(achievements) {
            const container = document.getElementById('recentAchievements');
            container.innerHTML = '';
            
            if (achievements.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">لا توجد إنجازات حديثة</p>';
                return;
            }
            
            achievements.forEach(achievement => {
                const achievementElement = document.createElement('div');
                achievementElement.innerHTML = `
                    <div class="achievement-badge">
                        <i class="fas ${achievement.icon}"></i> ${achievement.title}
                    </div>
                `;
                container.appendChild(achievementElement);
            });
        }

        function updateNotifications(notifications) {
            const container = document.getElementById('notifications');
            container.innerHTML = '';
            
            if (notifications.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">لا توجد إشعارات جديدة</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = 'notification-item';
                notificationElement.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="fas ${notification.icon} text-info me-2 mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${notification.title}</div>
                            <small class="text-muted">${notification.message}</small>
                            <div class="text-muted mt-1">
                                <small><i class="fas fa-clock"></i> ${notification.time}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(notificationElement);
            });
        }

        function updateTherapistMessages(messages) {
            const container = document.getElementById('therapistMessages');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">لا توجد رسائل جديدة</p>';
                return;
            }
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'notification-item';
                messageElement.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div class="fw-bold">${message.therapistName}</div>
                                <small class="text-muted">${message.date}</small>
                            </div>
                            <div class="text-primary fw-bold">${message.subject}</div>
                            <div class="mt-2">${message.content}</div>
                            <div class="mt-2">
                                <small class="text-muted">بخصوص: ${message.childName}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(messageElement);
            });
        }

        function updateProgressChart(progressData) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: progressData.labels || [],
                    datasets: progressData.datasets || []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: { family: 'Arial' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function openMessageModal() {
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            modal.show();
        }

        async function sendMessage() {
            const form = document.getElementById('messageForm');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/parent/send-message', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('تم إرسال الرسالة بنجاح');
                    bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
                    form.reset();
                    loadParentDashboard(); // إعادة تحميل البيانات
                } else {
                    alert('حدث خطأ في إرسال الرسالة');
                }
            } catch (error) {
                console.error('خطأ في إرسال الرسالة:', error);
                alert('حدث خطأ في إرسال الرسالة');
            }
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadParentDashboard();
            
            // تحديث البيانات كل 5 دقائق
            setInterval(loadParentDashboard, 300000);
        });
    </script>
</body>
</html>
