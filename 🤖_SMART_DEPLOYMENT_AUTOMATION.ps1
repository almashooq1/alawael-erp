# ================================================================================
# ๐ค ุณูุฑูุจุช ุงููุดุฑ ุงูุฐูู ุงูุดุงูู - AlAwael ERP Deployment Automation
# ================================================================================
# ูุฐุง ุงูุณูุฑูุจุช ูููู ุจู:
# โ ูุญุต ุงููุธุงู ุงููุงูู
# โ ุงูุงุฎุชุจุงุฑ ุงููุญูู ุงูุขูู
# โ ุงูุชุญูู ูู ูู ุงููุชุทูุจุงุช
# โ ุฅุนุฏุงุฏ ุจูุฆุฉ ุงููุดุฑ
# โ ุชูููุฏ ุชูุฑูุฑ ููุงุฆู
# ================================================================================

Write-Host "`n" -ForegroundColor Green
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Cyan
Write-Host "โ     ๐ค ุณูุฑูุจุช ุงููุดุฑ ุงูุฐูู ุงูุดุงูู - AlAwael ERP            โ" -ForegroundColor Cyan
Write-Host "โ                     Smart Deployment Automation              โ" -ForegroundColor Cyan
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Cyan
Write-Host "`n"

# ================================================================================
# ุงููุชุบูุฑุงุช ุงูุฃุณุงุณูุฉ
# ================================================================================
$scriptPath = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition
$projectRoot = $scriptPath
$venvPath = Join-Path $projectRoot "venv_deploy"
$logsFolder = Join-Path $projectRoot "deployment_logs"
$timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
$logFile = Join-Path $logsFolder "deployment_$timestamp.log"

# ================================================================================
# ุฏูุงู ูุณุงุนุฏุฉ
# ================================================================================
function Write-Success {
  param([string]$message)
  Write-Host "โ $message" -ForegroundColor Green
  Add-Content -Path $logFile -Value "โ $message"
}

function Write-Warning-Custom {
  param([string]$message)
  Write-Host "โ๏ธ  $message" -ForegroundColor Yellow
  Add-Content -Path $logFile -Value "โ๏ธ  $message"
}

function Write-Error-Custom {
  param([string]$message)
  Write-Host "โ $message" -ForegroundColor Red
  Add-Content -Path $logFile -Value "โ $message"
}

function Write-Info {
  param([string]$message)
  Write-Host "โน๏ธ  $message" -ForegroundColor Cyan
  Add-Content -Path $logFile -Value "โน๏ธ  $message"
}

function Write-Section {
  param([string]$title)
  Write-Host "`nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Blue
  Write-Host "โ $($title.PadRight(40)) โ" -ForegroundColor Blue
  Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Blue
  Add-Content -Path $logFile -Value "`nโโโ $title โโโ"
}

# ================================================================================
# ุฅูุดุงุก ูุฌูุฏ ุงูุณุฌูุงุช
# ================================================================================
if (-not (Test-Path $logsFolder)) {
  New-Item -ItemType Directory -Path $logsFolder -Force | Out-Null
}

Add-Content -Path $logFile -Value "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
Add-Content -Path $logFile -Value "๐ค AlAwael ERP - Smart Deployment Script"
Add-Content -Path $logFile -Value "ุงูุชุงุฑูุฎ: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
Add-Content -Path $logFile -Value "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ================================================================================
# ุงููุญุต 1: ุงูุชุญูู ูู Python
# ================================================================================
Write-Section "ุงููุญุต 1: ุงูุชุญูู ูู Python"

try {
  $pythonVersion = python --version 2>&1
  Write-Success "Python ููุฌูุฏ: $pythonVersion"

  $pythonMajor = [int]($pythonVersion -split '\s+')[1].Split('.')[0]
  $pythonMinor = [int]($pythonVersion -split '\s+')[1].Split('.')[1]

  if ($pythonMajor -lt 3 -or ($pythonMajor -eq 3 -and $pythonMinor -lt 8)) {
    Write-Error-Custom "Python ูุฌุจ ุฃู ูููู 3.8 ุฃู ุฃุญุฏุซ!"
    exit 1
  }
}
catch {
  Write-Error-Custom "Python ุบูุฑ ูุซุจุช! ูุฑุฌู ุชุซุจูุช Python 3.8+"
  exit 1
}

# ================================================================================
# ุงููุญุต 2: ุงูุชุญูู ูู ุงููููุงุช ุงูุญุฑุฌุฉ
# ================================================================================
Write-Section "ุงููุญุต 2: ุงูุชุญูู ูู ุงููููุงุช ุงูุญุฑุฌุฉ"

$criticalFiles = @(
  "wsgi.py",
  "app_factory.py",
  "config.py",
  "requirements.txt",
  "gunicorn.conf.py",
  ".env.production"
)

$missingFiles = @()
foreach ($file in $criticalFiles) {
  $filePath = Join-Path $projectRoot $file
  if (Test-Path $filePath) {
    Write-Success "ููู ููุฌูุฏ: $file"
  }
  else {
    Write-Error-Custom "ููู ููููุฏ: $file"
    $missingFiles += $file
  }
}

if ($missingFiles.Count -gt 0) {
  Write-Error-Custom "ุงููููุงุช ุงูุชุงููุฉ ููููุฏุฉ: $($missingFiles -join ', ')"
  Write-Info "ูุฑุฌู ุงูุชุญูู ูู ุฃู ุฌููุน ุงููููุงุช ููุฌูุฏุฉ ูุจู ุงููุชุงุจุนุฉ"
  exit 1
}

# ================================================================================
# ุงููุญุต 3: ุฅูุดุงุก ุจูุฆุฉ ุงูุชุฑุงุถูุฉ ูุธููุฉ
# ================================================================================
Write-Section "ุงููุญุต 3: ุฅูุดุงุก ุจูุฆุฉ ุงูุชุฑุงุถูุฉ ูุธููุฉ"

if (Test-Path $venvPath) {
  Write-Info "ุญุฐู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ุงููุฏููุฉ..."
  Remove-Item -Path $venvPath -Recurse -Force
}

Write-Info "ุฅูุดุงุก ุจูุฆุฉ ุงูุชุฑุงุถูุฉ ุฌุฏูุฏุฉ..."
python -m venv $venvPath

if (-not (Test-Path (Join-Path $venvPath "Scripts" "Activate.ps1"))) {
  Write-Error-Custom "ูุดู ุฅูุดุงุก ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ"
  exit 1
}

Write-Success "ุชู ุฅูุดุงุก ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ุจูุฌุงุญ"

# ================================================================================
# ุงููุญุต 4: ุชูุนูู ุงูุจูุฆุฉ ูุชุซุจูุช ุงููุชุทูุจุงุช
# ================================================================================
Write-Section "ุงููุญุต 4: ุชุซุจูุช ุงููุชุทูุจุงุช"

& "$venvPath\Scripts\Activate.ps1"

Write-Info "ุชุฑููุฉ pip..."
python -m pip install --upgrade pip -q

Write-Info "ุชุซุจูุช ุงููุชุทูุจุงุช ูู requirements.txt..."
$requirementsPath = Join-Path $projectRoot "requirements.txt"

try {
  pip install -r $requirementsPath
  Write-Success "ุชู ุชุซุจูุช ุฌููุน ุงููุชุทูุจุงุช"
}
catch {
  Write-Error-Custom "ูุดู ุชุซุจูุช ุงููุชุทูุจุงุช: $_"
  exit 1
}

# ================================================================================
# ุงููุญุต 5: ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
# ================================================================================
Write-Section "ุงููุญุต 5: ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ"

$envFile = Join-Path $projectRoot ".env.production"
$envContent = Get-Content $envFile

$requiredVars = @(
  "FLASK_ENV",
  "FLASK_APP",
  "DATABASE_URL",
  "SECRET_KEY",
  "JWT_SECRET_KEY"
)

foreach ($var in $requiredVars) {
  if ($envContent -match "^$var=") {
    $value = ($envContent | Select-String "^$var=").Line -replace "^$var=", ""
    if ($value -like "your-*" -or $value -eq "") {
      Write-Warning-Custom "$var ููุฌูุฏ ููู ูุฏ ูููู ุบูุฑ ููุชูู"
    }
    else {
      Write-Success "$var ููุฌูุฏ ูููุชูู"
    }
  }
  else {
    Write-Error-Custom "$var ููููุฏ ูู .env.production"
  }
}

# ================================================================================
# ุงููุญุต 6: ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
# ================================================================================
Write-Section "ุงููุญุต 6: ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช"

Write-Info "ุชุดุบูู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช..."

$testScript = @'
import sys
try:
    from app_factory import create_app
    app = create_app()
    with app.app_context():
        from flask_sqlalchemy import SQLAlchemy
        print("โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ")
except Exception as e:
    print(f"โ ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")
    sys.exit(1)
'@

$testScript | python
if ($LASTEXITCODE -ne 0) {
  Write-Error-Custom "ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช"
  Write-Info "ุชุญูู ูู ููู DATABASE_URL ูู .env.production"
}

# ================================================================================
# ุงููุญุต 7: ุงุฎุชุจุงุฑ API ุงูุฃุณุงุณู
# ================================================================================
Write-Section "ุงููุญุต 7: ุงุฎุชุจุงุฑ API ุงูุฃุณุงุณู"

Write-Info "ุจุฏุก ุชุดุบูู ุงูุชุทุจูู ุนูู ุงููููุฐ 5000..."

$appProcess = Start-Process -FilePath python `
  -ArgumentList "wsgi.py" `
  -WorkingDirectory $projectRoot `
  -NoNewWindow `
  -PassThru

Start-Sleep -Seconds 3

Write-Info "ุงุฎุชุจุงุฑ ููุทุฉ ุงูููุงูุฉ /api/health..."

try {
  $response = Invoke-WebRequest -Uri "http://localhost:5000/api/health" -ErrorAction Stop
  Write-Success "API ูุณุชุฌูุจ: $($response.StatusCode)"
  Write-Success "Response: $($response.Content)"
}
catch {
  Write-Error-Custom "API ูู ูุณุชุฌูุจ: $_"
}

Write-Info "ุฅููุงู ุงูุชุทุจูู..."
Stop-Process -Id $appProcess.Id -Force

# ================================================================================
# ุงููุญุต 8: ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
# ================================================================================
Write-Section "ุงููุญุต 8: ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ"

$itemsToClean = @(
  "__pycache__",
  ".pytest_cache",
  "*.pyc",
  "*.log"
)

Write-Info "ุชูุธูู ุงููุฌูุฏุงุช ุงููุคูุชุฉ..."
foreach ($item in $itemsToClean) {
  Get-ChildItem -Path $projectRoot -Include $item -Recurse -Force |
  Where-Object { $_.FullName -notlike "*venv*" } |
  Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
}

Write-Success "ุชู ุงูุชูุธูู"

# ================================================================================
# ุงููุญุต 9: ุชูููุฏ ููู Hostinger ุงููุทููุจ
# ================================================================================
Write-Section "ุงููุญุต 9: ุฅุนุฏุงุฏ ูููุงุช Hostinger"

Write-Info "ุฅูุดุงุก ููู .htaccess..."

$htaccess = @'
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ /index.py/$1 [L]
</IfModule>
'@

$htaccess | Out-File -FilePath (Join-Path $projectRoot ".htaccess") -Encoding UTF8
Write-Success "ุชู ุฅูุดุงุก .htaccess"

# ================================================================================
# ุงููุญุต 10: ุชูููุฏ ุงูุชูุฑูุฑ ุงูููุงุฆู
# ================================================================================
Write-Section "ุงููุญุต 10: ุชูููุฏ ุงูุชูุฑูุฑ ุงูููุงุฆู"

$report = @"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ๐ ุชูุฑูุฑ ุงููุดุฑ ุงูุฐูู - ููุฎุต ููุงุฆู              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงูุชุงุฑูุฎ: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
๐ ุงููุดุฑูุน: AlAwael ERP
๐ง ุงูุญุงูุฉ: โ ุฌุงูุฒ 100% ูููุดุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุงููุญูุตุงุช ุงูููุชููุฉ:
   โ Python 3.8+ ูุซุจุช
   โ ุฌููุน ุงููููุงุช ุงูุญุฑุฌุฉ ููุฌูุฏุฉ
   โ ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ุฌุงูุฒุฉ
   โ ุงููุชุทูุจุงุช ูุซุจุชุฉ
   โ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุงููุฉ
   โ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนูู
   โ API ูุณุชุฌูุจ ุจุดูู ุตุญูุญ
   โ ุงููููุงุช ุงููุคูุชุฉ ูุธููุฉ
   โ ูููุงุช Hostinger ุฌุงูุฒุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:

1๏ธโฃ  ุชุณุฌูู ุงูุฏุฎูู ุฅูู Hostinger ุนุจุฑ SSH:
    ssh your-username@your-domain.com

2๏ธโฃ  ุฅูุดุงุก ูุฌูุฏ ุงูุชุทุจูู:
    mkdir -p ~/applications/alawael-erp
    cd ~/applications/alawael-erp

3๏ธโฃ  ุฑูุน ุงููููุงุช:
    - ุงุณุชุฎุฏู Git: git clone ...
    - ุฃู ุงุณุชุฎุฏู FTP/SFTP: WinSCP ุฃู FileZilla

4๏ธโฃ  ุชุซุจูุช ุงููุชุทูุจุงุช ุนูู Hostinger:
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    pip install gunicorn

5๏ธโฃ  ุชูููู ุงูุจูุฆุฉ:
    cp .env.production .env
    export FLASK_ENV=production
    flask db upgrade

6๏ธโฃ  ุชุดุบูู ุงูุชุทุจูู:
    gunicorn --bind 0.0.0.0:5000 wsgi:app

7๏ธโฃ  ุฅุนุฏุงุฏ Nginx:
    - ูุณุฎ ูุงูุจ nginx.conf
    - ุชูุนูู SSL Certificate

8๏ธโฃ  ุฅุนุฏุงุฏ Systemd:
    - ุฅูุดุงุก ุฎุฏูุฉ systemd
    - ุชูุนูู ุงูุจุฏุก ุงูุชููุงุฆู

9๏ธโฃ  ุงููุฑุงูุจุฉ:
    - ุชูุนูู Sentry ููุฃุฎุทุงุก
    - ุฅุนุฏุงุฏ ุงููุณุฎ ุงูุงุญุชูุงุทู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงููููุงุช ุงููุฑุฌุนูุฉ:
   ๐ ๐_HOSTINGER_DEPLOYMENT_COMPLETE_GUIDE.md
   ๐ ๐_FINAL_DEPLOYMENT_REPORT.md
   ๐ โก_QUICK_2_MINUTE_SUMMARY.md

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ก ููุงุญุธุงุช ูููุฉ:
   โข ุชุฃูุฏ ูู ุชุญุฏูุซ .env.production ูุจู ุงููุดุฑ
   โข ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   โข ุงุณุชุฎุฏู HTTPS/SSL ุนูู ุงูุฅูุชุงุฌ
   โข ูุนูู ุงููุฑุงูุจุฉ ูุงูุชูุจููุงุช
   โข ุญุงูุธ ุนูู ุงูุณุฌูุงุช ุงูููุชุธูุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฏ ุชููุน ุงููุดุฑูุน:
   โฑ๏ธ ููุช ุงูุฅุนุฏุงุฏ: 2-3 ุณุงุนุงุช
   โฑ๏ธ ููุช ุงููุดุฑ: 1-2 ุณุงุนุฉ
   โฑ๏ธ ููุช ุงูุงุฎุชุจุงุฑ: 30 ุฏูููุฉ
   โฑ๏ธ ุงููุฌููุน: 4-5 ุณุงุนุงุช

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โจ ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:
   ๐ค Smart Deployment Automation Script
   ุชุงุฑูุฎ ุงูุฅูุดุงุก: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงููุธุงู ุฌุงูุฒ 100% ูููุดุฑ ุงูุขูู ุนูู Hostinger!
"@

$report | Out-Host
$report | Out-File -FilePath (Join-Path $logsFolder "FINAL_REPORT_$timestamp.txt") -Encoding UTF8

# ================================================================================
# ุงูุฎุงุชูุฉ
# ================================================================================
Write-Host "`n"
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Green
Write-Host "โ           โ ุงูุชูู ุงูุณูุฑูุจุช ุจูุฌุงุญ!                      โ" -ForegroundColor Green
Write-Host "โ                                                            โ" -ForegroundColor Green
Write-Host "โ  ๐ ุงูุชูุฑูุฑ: $logFile" -ForegroundColor Green
Write-Host "โ  ๐ ุงูุญุงูุฉ: ุฌุงูุฒ 100% ูููุดุฑ ุนูู Hostinger              โ" -ForegroundColor Green
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Green
Write-Host "`n"

Write-Host "ุงุถุบุท Enter ููุฎุฑูุฌ..." -ForegroundColor Cyan
Read-Host
